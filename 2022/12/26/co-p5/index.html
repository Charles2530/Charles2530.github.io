<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Charles">
    <meta name="description" content="This is Charles&#39;s Castle">
    <meta name="author" content="Charles">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-redefine.png">
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://charles2530.github.io/2022/12/26/co-p5/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    <meta property="og:type" content="article">
    <meta property="og:title" content="CO_P5">
    <meta property="og:description" content="This is Charles&#39;s Castle">
    <meta property="og:url" content="http://charles2530.github.io2022/12/26/co-p5/">
    <meta property="og:image" content="https://charles2530.github.io/image/background/favicon.png">
    <meta property="og:site_name" content="Charles&#39;s Castle">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="CO_P5">
    <meta name="twitter:description" content="This is Charles&#39;s Castle">
    <meta name="twitter:image" content="https://charles2530.github.io/image/background/favicon.png">
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="https://charles2530.github.io/image/background/favicon.png" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="https://charles2530.github.io/image/background/favicon.png">
    <meta name="theme-color" content="#005080">
    <link rel="shortcut icon" href="https://charles2530.github.io/image/background/favicon.png">
    
    <title>
        
            CO_P5 -
        
        Charles&#39;s Castle
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/assets/fonts.css">

    
    
    
        
            
    
            
    
            
                
                    <script data-pjax src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script>
                
    
    
    <script id="hexo-configurations">
    let REDEFINE = window.REDEFINE || {};
    REDEFINE.hexo_config = {"hostname":"charles2530.github.io","root":"/","language":"en","path":"search.xml"};
    REDEFINE.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#005080","avatar":"https://charles2530.github.io/image/background/logo.jpg","favicon":"https://charles2530.github.io/image/background/favicon.png","article_img_align":"center","right_side_width":"210px","content_max_width":"1000px","nav_color":{"left":"#f78736","right":"#367df7","transparency":35},"hover":{"shadow":true,"scale":true},"first_screen":{"enable":true,"background_image":{"light":"https://charles2530.github.io/image/background/background-light1.jpg","dark":"https://charles2530.github.io/image/background/background-dark1.jpg"},"title_color":{"light":"#fff","dark":"#d1d1b6"},"description":"Happiness is best","custom_font":{"enable":false,"font_family":null,"font_url":null}},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":true},"code_block":{"copy":true,"style":"mac","custom_font":{"enable":false,"font_family":null,"font_url":null}},"pjax":{"enable":true},"lazyload":{"enable":true},"version":"1.1.2","friend_links":{"columns":2},"home_article":{"date_format":"auto","category":{"enable":true,"limit":3},"tag":{"enable":true,"limit":3}}};
    REDEFINE.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
    
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Charles's Castle" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>



<body>
  <div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="menu-wrapper">
    
    <div class="menu-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                Charles&#39;s Castle
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="pc">
                <ul class="menu-list">
                    
                        
                            <li class="menu-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/"  >
                                    
                                        
                                            <i class="fa-regular fa-house"></i>
                                        
                                        HOME
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="menu-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/archives"  >
                                    
                                        
                                            <i class="fa-regular fa-archive"></i>
                                        
                                        ARCHIVES
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="menu-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/categories"  >
                                    
                                        
                                            <i class="fas fa-bookmark"></i>
                                        
                                        CATEGORIES
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="menu-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/tags"  >
                                    
                                        
                                            <i class="fas fa-tags"></i>
                                        
                                        TAGS
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="menu-item">
                                <!-- Menu -->
                                <a class="has-dropdown" 
                                    href="#" onClick="return false;">
                                    
                                        
                                            <i class="fa-regular fa-user"></i>
                                        
                                        ABOUT&nbsp;<i class="fa-solid fa-chevron-down"></i>
                                    
                                </a>
                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                    
                                        <li>
                                        <a href="/about">ME
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://github.com/Charles2530/">GITHUB
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a href="https://charles2530.github.io">BLOG
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a href="/friends">FRIENDS
                                        </a>
                                        </li>
                                    
                                    </ul>
                                
                            </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="menu-drawer">
        <ul class="drawer-menu-list">
            
                
                    <li class="drawer-menu-item flex-center">
                        <a class="" 
                        href="/"  >
                             
                                
                                    <i class="fa-regular fa-house"></i>
                                
                                HOME
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-menu-item flex-center">
                        <a class="" 
                        href="/archives"  >
                             
                                
                                    <i class="fa-regular fa-archive"></i>
                                
                                ARCHIVES
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-menu-item flex-center">
                        <a class="" 
                        href="/categories"  >
                             
                                
                                    <i class="fas fa-bookmark"></i>
                                
                                CATEGORIES
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-menu-item flex-center">
                        <a class="" 
                        href="/tags"  >
                             
                                
                                    <i class="fas fa-tags"></i>
                                
                                TAGS
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-menu-item flex-center">
                        <a class="has-dropdown" 
                        href="#" onClick="return false;">
                            
                                
                                    <i class="fa-regular fa-user"></i>
                                
                                ABOUT&nbsp;<i class="fa-solid fa-chevron-down"></i>
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                              
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" href="/about">ME</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" target="_blank" rel="noopener" href="https://github.com/Charles2530/">GITHUB</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" href="https://charles2530.github.io">BLOG</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" href="/friends">FRIENDS</a>
                            </li>
                        
                    
            

        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            
                      
                <div class="article-title">
                    <img src="https://charles2530.github.io/image/background/p2.jfif" alt="CO_P5" />
                    <h1 class="article-title-cover">CO_P5</h1>
                </div>
            
                
            

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="https://charles2530.github.io/image/background/logo.jpg">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">Charles</span>
                            
                                <span class="author-label">Lv6</span>
                            
                        </div>
                        <div class="meta-info">
                            <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="pc">2022-12-26 20:56:01</span>
        <span class="mobile">2022-12-26 20:56</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="pc">2023-02-09 17:40:37</span>
            <span class="mobile">2023-02-09 17:40</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/Lesson/">Lesson</a>&nbsp;
                    </li>
                
                    <li>
                        &gt; <a href="/categories/Lesson/CO/">CO</a>&nbsp;
                    </li>
                
                    <li>
                        &gt; <a href="/categories/Lesson/CO/CO-tips/">CO-tips</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/CO/">CO</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fa-regular fa-file-word"></i>&nbsp;<span>6.2k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fa-regular fa-clock"></i>&nbsp;<span>24 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content markdown-body">
                <h1 id="P5总结"><a href="#P5总结" class="headerlink" title="P5总结"></a>P5总结</h1><h3 id="（一）-控制和冒险简述"><a href="#（一）-控制和冒险简述" class="headerlink" title="（一）.控制和冒险简述"></a>（一）.控制和冒险简述</h3><ul>
<li><p>对于控制冒险，本实验要求大家实现<strong>比较过程前移至 D 级</strong>，并<strong>采用延迟槽</strong>。</p>
</li>
<li><p>对于数据冒险，两大策略及其应用：</p>
</li>
</ul>
<blockquote>
</blockquote>
<p>  假设当前我需要的数据，其实已经计算出来，只是还没有进入寄存器堆，那么我们可以用<strong>转发</strong>( Forwarding )来解决，即不引用寄存器堆的值，而是直接从后面的流水级的供给者把计算结果发送到前面流水级的需求者来引用。如果我们需要的数据还没有算出来。则我们就只能<strong>暂停</strong>( Stall )，让流水线停止工作，等到我们需要的数据计算完毕，再开始下面的工作。</p>
<h3 id="二）-冒险处理"><a href="#二）-冒险处理" class="headerlink" title="(二）.冒险处理"></a>(二）.冒险处理</h3><p>冒险处理我们均通过“A_T”法实现——</p>
<h4 id="转发（forward）"><a href="#转发（forward）" class="headerlink" title="转发（forward）"></a>转发（forward）</h4><p>当前面的指令要写寄存器但还未写入，而后面的指令需要用到没有被写入的值时，这时候会产生<strong>数据冒险</strong>，我们首先考虑进行转发。我们<strong>假设所有的数据冒险均可通过转发解决</strong>。也就是说，当某一指令前进到必须使用某一寄存器的值的流水阶段时，这个寄存器的值一定已经产生，并<strong>存储于后续某个流水线寄存器中</strong>。</p>
<p>在这一阶段，我们不管需要的值有没由计算出，都要进行转发，即暴力转发。为实现这一机制，我们要清楚哪些模块需要转发后的数据（<strong>需求者</strong>）和保存着写入值的流水寄存器（<strong>供应者</strong>）</p>
<ul>
<li><strong>供应者及其产生的数据</strong></li>
</ul>
<table>
<thead>
<tr>
<th align="left">流水级</th>
<th align="left">产生数据</th>
<th align="left">MUX名&amp;选择信号名</th>
<th align="left">MUX输出名</th>
</tr>
</thead>
<tbody><tr>
<td align="left">E</td>
<td align="left">E_imm32，<br/>E_PC8</td>
<td align="left">直接流水线传递</td>
<td align="left">直接流水线传递</td>
</tr>
<tr>
<td align="left">M</td>
<td align="left">M_ALUout，<br/>M_PC8</td>
<td align="left">直接流水线传递</td>
<td align="left">直接流水线传递</td>
</tr>
<tr>
<td align="left">W</td>
<td align="left">w_res，<br/>w_RD，<br/>w_imm32,<br>W_PC8</td>
<td align="left">w_WhichtoReg</td>
<td align="left">WD</td>
</tr>
</tbody></table>
<p>  注：当M级指令为读hi和lo的指令时， M_AO中的结果是从上一周期在乘除槽中读取的hi或lo的值；如果是其他指令，M_AO是上一周期ALU的计算结果。</p>
<ul>
<li><strong>需求者及其产生的数据</strong></li>
</ul>
<table>
<thead>
<tr>
<th align="left">接收端口</th>
<th align="left">选择数据</th>
<th align="left">HMUX名&amp;选择信号名</th>
<th align="left">MUX输出名</th>
</tr>
</thead>
<tbody><tr>
<td align="left">B_transfer_D1</td>
<td align="left">D_V1,<br/>M_out,<br/>E_out</td>
<td align="left">SelB_D1</td>
<td align="left">d_b_transfer1</td>
</tr>
<tr>
<td align="left">B_transfer_D2</td>
<td align="left">d_RD2,<br>m_res,<br>e_res</td>
<td align="left">SelB_D2</td>
<td align="left">d_b_transfer2</td>
</tr>
<tr>
<td align="left">ALU_A</td>
<td align="left">e_RD1，<br/> WD，<br/>m_res</td>
<td align="left">SelALU_A</td>
<td align="left">e_A</td>
</tr>
<tr>
<td align="left">ALU_B</td>
<td align="left">e_RD2，<br/>WD，<br/>m_res</td>
<td align="left">SelALU_B</td>
<td align="left">e_B</td>
</tr>
<tr>
<td align="left">DM_WD</td>
<td align="left">m_RD2，<br/> WD</td>
<td align="left">SelDM</td>
<td align="left">M_WD_f</td>
</tr>
<tr>
<td align="left">NPC_ra</td>
<td align="left">D_V1_f ,<br/> E_PC8 ,<br/> M_PC8</td>
<td align="left">SelJr</td>
<td align="left">ra</td>
</tr>
</tbody></table>
<p>从上表可以看出，W级中的数据没有转发到D级，原因是我们在GRF内实现了内部转发机制，将GRF输入端的数据（还未写入）及时反映到RD1或这RD2，判断条件为<code>A3 == A2</code>或者<code>A3 == A1</code>。</p>
<p>此时为了生成HMUX的选择信号，我们需要向HCU（冒险控制器）输入”A”数据，然后进行选择信号的计算，执行转发的条件为——</p>
<ul>
<li><p><strong>前位点的读取寄存器地址和某转发输入来源的写入寄存器地址相等且不为 0</strong></p>
</li>
<li><p><strong>写使能信号有效</strong></p>
<h4 id="转发的构造"><a href="#转发的构造" class="headerlink" title="转发的构造"></a>转发的构造</h4><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/../image/4.png"
                     
                ></p>
</li>
</ul>
<h4 id="暂停（stall）"><a href="#暂停（stall）" class="headerlink" title="暂停（stall）"></a>暂停（stall）</h4><p>接下来，我们来处理通过转发不能处理的数据冒险。在这种情况下，新的数据还未来得及产生。我们只能暂停流水线，等待新的数据产生。为了方便处理，我们仅仅为D级的指令进行暂停处理。</p>
<p>我们把Tuse和Tnew作为暂停的判断依据——</p>
<ul>
<li>Tuse：指令进入 <strong>D 级</strong>后，其后的某个功能部件<strong>再</strong>经过多少时钟周期就<strong>必须</strong>要使用寄存器值。对于有两个操作数的指令，其<strong>每个操作数的 Tuse 值可能不等</strong>（如 store 型指令 rs、rt 的 Tuse 分别为 1 和 2 ）。</li>
<li>Tnew：位于 <strong>E 级及其后各级</strong>的指令，再经过多少周期就能够产生要写入寄存器的结果。在我们目前的 CPU 中，W 级的指令Tnew 恒为 0；对于同一条指令，Tnew@M &#x3D; max(Tnew@E - 1, 0)、</li>
</ul>
<p>在这一阶段，我们找到D级生成的Tuse_rs和Tuse_rt和在E,M,W级寄存器中流水的Tnew_D，Tnew_M，Tnew_W，如下表所示</p>
<ul>
<li><strong>Tuse表和计算表达式</strong></li>
</ul>
<table>
<thead>
<tr>
<th align="left">指令类型</th>
<th align="left">Tuse_rs</th>
<th align="left">Tuse_rt</th>
</tr>
</thead>
<tbody><tr>
<td align="left">calc_R</td>
<td align="left">1</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">calc_I</td>
<td align="left">1</td>
<td align="left">X</td>
</tr>
<tr>
<td align="left">shift</td>
<td align="left">X</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">shiftv</td>
<td align="left">1</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">load</td>
<td align="left">1</td>
<td align="left">X</td>
</tr>
<tr>
<td align="left">store</td>
<td align="left">1</td>
<td align="left">2</td>
</tr>
<tr>
<td align="left">md</td>
<td align="left">1</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">mt</td>
<td align="left">1</td>
<td align="left">X</td>
</tr>
<tr>
<td align="left">mf</td>
<td align="left">X</td>
<td align="left">X</td>
</tr>
<tr>
<td align="left">branch</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">j &#x2F; jr</td>
<td align="left">X</td>
<td align="left">X</td>
</tr>
<tr>
<td align="left">jal &#x2F; jalr</td>
<td align="left">0</td>
<td align="left">X</td>
</tr>
<tr>
<td align="left">lui</td>
<td align="left">X</td>
<td align="left">X</td>
</tr>
</tbody></table>
<ul>
<li><strong>Tnew表和计算表达式</strong></li>
</ul>
<table>
<thead>
<tr>
<th align="left">指令类型</th>
<th align="left">Tnew_D</th>
<th align="left">Tnew_E</th>
<th align="left">Tnew_M</th>
<th align="left">Tnew_W</th>
</tr>
</thead>
<tbody><tr>
<td align="left">calc_R</td>
<td align="left">2</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">calc_I</td>
<td align="left">2</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">shift</td>
<td align="left">2</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">shiftv</td>
<td align="left">2</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">load</td>
<td align="left">3</td>
<td align="left">2</td>
<td align="left">1</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">store</td>
<td align="left">X</td>
<td align="left">X</td>
<td align="left">X</td>
<td align="left">X</td>
</tr>
<tr>
<td align="left">md</td>
<td align="left">X</td>
<td align="left">X</td>
<td align="left">X</td>
<td align="left">X</td>
</tr>
<tr>
<td align="left">mt</td>
<td align="left">X</td>
<td align="left">X</td>
<td align="left">X</td>
<td align="left">X</td>
</tr>
<tr>
<td align="left">mf</td>
<td align="left">2</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">branch</td>
<td align="left">X</td>
<td align="left">X</td>
<td align="left">X</td>
<td align="left">X</td>
</tr>
<tr>
<td align="left">jal &#x2F; jalr</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">j &#x2F; jr</td>
<td align="left">X</td>
<td align="left">X</td>
<td align="left">X</td>
<td align="left">X</td>
</tr>
<tr>
<td align="left">lui</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
</tbody></table>
<p>然后我们Tnew和Tuse传入HCU（冒险控制器中），然后进行stall信号的计算。如果满足以下条件则stall有效——</p>
<ul>
<li><p><strong>Tnew &gt; Tuse</strong></p>
</li>
<li><p><strong>前位点的读取寄存器地址和某转发输入来源的写入寄存器地址相等且不为 0</strong></p>
</li>
<li><p><strong>写使能信号有效</strong></p>
</li>
<li><p><strong>当E级延迟槽在进行运算（<code>start | busy</code>）时，D级为md、mt、mf指令</strong></p>
</li>
<li><h4 id="阻塞的构造（D级）"><a href="#阻塞的构造（D级）" class="headerlink" title="阻塞的构造（D级）"></a><strong>阻塞的构造（D级）</strong></h4><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/../image/5.png"
                     
                ></p>
</li>
</ul>
<hr>
<h3 id="三）-其他要点"><a href="#三）-其他要点" class="headerlink" title="(三）.其他要点"></a>(三）.其他要点</h3><p>根据流水线的思想，我们将指令的整个执行过程分割为五个部分，各个部分独立完成不同指令相应过程的工作。然而会存在某些<strong>寄存器</strong>的值<strong>虽然被算出来了</strong>但是还<strong>没来得及写回去</strong>便<strong>被下一条指令读入</strong>的情况。这时，便需要我们修一条数据通路将算出来的值连接到读入的地方对错误的值进行修正。</p>
<p>根据上面的理解，我们可以得出如下结论：</p>
<ul>
<li>转发是针对<strong>GRF</strong>的行为。（由于lw类指令要到M级才会读到数据，即使上一条紧跟着sw指令。sw类指令会在M级将数据写到DM中，此时lw类指令还在E级是完全来得及的）</li>
<li><strong>已经算出来值的</strong>寄存器可以被转发。</li>
<li>即将被写回的寄存器和被读入的寄存器是相同的。</li>
</ul>
<p>自然，我们需要关注的是：</p>
<ul>
<li><p>读入寄存器（rs、rt都要考虑)、写回寄存器（上面的WriteReg）是什么？（决定了要不要转发、同时要注意$zero）</p>
</li>
<li><p>要转发的值是什么？（决定了MUX的选择信号是什么)</p>
</li>
<li><p>写回寄存器的值在哪一级被算出来？（决定了在哪一级提供转发)</p>
<blockquote>
<p>如果写回寄存器在某一级被算出来，则这个值在后面的流水级都可能需要被转发。</p>
</blockquote>
</li>
<li><p>这一级需不需要用到读寄存器的值？(决定了在哪一级接收转发)</p>
<blockquote>
<p>事实上、只有D级和E级需要接收转发，因为在M级ALUOut都有了。</p>
</blockquote>
</li>
<li><p>这一级对应的指令改不改变寄存器的值？(决定了要不要转发)</p>
<blockquote>
<p>这里我还是对<strong>无脑转发机制</strong>感觉不是很放心，所以多加了一个判断</p>
<p>同时强烈建议大家<strong>把pc和instr沿着流水线传下去</strong>、方便debug也方便之后加指令</p>
</blockquote>
</li>
</ul>
<ol>
<li><p>在E级有关写寄存器的信号：</p>
<blockquote>
<p>SignImm_E 、PC_E</p>
</blockquote>
</li>
<li><p>在M级有关写寄存器的信号：</p>
<blockquote>
<p>SignImm_M 、PC_M、ALUOut_M</p>
</blockquote>
</li>
<li><p>在W级有关写寄存器的信号：</p>
<blockquote>
<p>Result_W ( 之前的 SignImm、PC和 ALUOut 都被集成到这里面去了 )</p>
</blockquote>
</li>
</ol>
<p>想好了上面几个问题之后，我们就可以正式考虑转发辣！（这里分D级、E级两种情况考虑）</p>
<h3 id="1-D级"><a href="#1-D级" class="headerlink" title="1.D级"></a>1.D级</h3><p>首先，由于beq、jr这两条指令，我们是需要读寄存器的值并且<strong>立即使用的</strong> ( 即T_use &#x3D; 0 ) 。</p>
<p>由于jal、lui这两条指令在D级就被算出来了，因此这两个值 ( SignImm 和 PC ) 都应该可以作为被转发的值。这两个值在E级（ SignImm_E 、PC_E ）和M级（SignImm_M、PC_M ）对应的值应该被记录下来作为可能被转发的值。（ 为什么没有W级？ ）</p>
<blockquote>
<p>由于GRF内部转发的机制，如果写回-读入寄存器相同的话（且不为$zero），读取写入的值</p>
</blockquote>
<p>而在E级ALUOut被算出来了，所以要记录 ALUOut_M （ 为什么不是ALU_E）</p>
<blockquote>
<p>转发的数据来源必须是某级流水线寄存器、不允许对功能部件的输出直接进行转发。(可能是为了维护时序的稳定？求大佬解答)</p>
</blockquote>
<p>所以、以RD1为例我们可以如下定义D级的转发信号（ForwardAD）</p>
<div class="highlight-container" data-rel="Verilog"><figure class="iseeu highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">assign</span> ForwardAD = ((Rs_D != <span class="number">0</span>) &amp;&amp; (Rs_D == WriteReg_E) &amp;&amp; RegWrite_E &amp;&amp; WriteSel_E == <span class="number">2&#x27;b01</span>) ? <span class="number">3&#x27;b101</span> : </span><br><span class="line">							   	        									 <span class="comment">//转发E级 SignImm</span></span><br><span class="line">                  ......                                                      <span class="comment">//转发E级 PC+8</span></span><br><span class="line">                  ......                                                      <span class="comment">//转发M级 ALUout</span></span><br><span class="line">                  ......                                                      <span class="comment">//转发M级 PC+8</span></span><br><span class="line">                  ......                                                      <span class="comment">//转发M级 SignImm</span></span><br><span class="line">	  ......                                                      <span class="comment">//不转发</span></span><br></pre></td></tr></table></figure></div>

<h3 id="2-E级"><a href="#2-E级" class="headerlink" title="2.E级"></a>2.E级</h3><p>由于我们的ALU需要 SrcA 和 SrcB 这两个需要 “读” 的值、也需要接收转发 ( T_use &#x3D; 1 )</p>
<p>和D级一样，我们需要M级的 SignImm_M 、PC_M、ALUOut_M 、同时还需要 W 级的 Result_W 作为转发的来源</p>
<p>所以、以SrcA为例我们可以如下定义E级的转发信号 (ForwardAE)</p>
<div class="highlight-container" data-rel="Verilog"><figure class="iseeu highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">assign</span> ForwardAE = ((Rs_E != <span class="number">0</span>) &amp;&amp; (Rs_E == WriteReg_M) &amp;&amp; RegWrite_M===<span class="number">1&#x27;b1</span> &amp;&amp; WriteSel_M == <span class="number">2&#x27;b00</span>) ? <span class="number">3&#x27;b100</span> : 					</span><br><span class="line">               	    	        											<span class="comment">//转发M级 ALUOut</span></span><br><span class="line">	......														<span class="comment">//转发M级 PC+8               </span></span><br><span class="line">		......				 										<span class="comment">//转发M级 SignImm             </span></span><br><span class="line">                ......		 		   	 								  <span class="comment">//转发W级 Result_W</span></span><br><span class="line">                ......                                                   <span class="comment">//不转发</span></span><br></pre></td></tr></table></figure></div>

<p>这样的话、所有的转发控制我们就都考虑好啦。</p>
<p>除此之外，由于某些不可抗力的因素，只用转发有些问题我们是解决不了的。比如有一些指令写入的操作太慢了（ 如lw类 ) ,还有一些指令需要用的时候太早了 （ 如 beq 类，含 jr ) 。这时我们就需要用阻塞去解决。</p>
<p>根据上面的分析，我们大概可以将阻塞的类型分为两种:</p>
<h3 id="lw-类型阻塞（定义lwstall端口）"><a href="#lw-类型阻塞（定义lwstall端口）" class="headerlink" title="lw 类型阻塞（定义lwstall端口）"></a>lw 类型阻塞（定义lwstall端口）</h3><p> 那我们是在什么时候发现需要用lw类型阻塞的呢？</p>
<p> 事实上，在E级我们就已经接收到了D级的CU翻译出来的控制信号了，而MemtoReg&#x3D;&#x3D;1则代表了像 lw 这样从DM中读出数据给寄存器的指令。如果这个信号为1，则可能需要阻塞。同时记得条件还有这时要读出的寄存器 ( Rs或Rt ) 和 lw 读取的寄存器 ( Rt ) 是同一个寄存器。</p>
<p>这样我们就可以给出 lwstall 控制信号，可以思考为什么是D级的Rs，Rt 和 E级的 Rt ？</p>
<div class="highlight-container" data-rel="Verilog"><figure class="iseeu highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">assign</span> lwstall = ((Rs_D == Rt_E) || (Rt_D == Rt_E)) &amp;&amp; MemtoReg_E;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>Rs_D 、 Rt_D 对应D级读出的寄存器、而Rt_E则对应了 lw 类指令要写回的寄存器</p>
</blockquote>
<h3 id="beq-类型的阻塞-定义-branchstall端口"><a href="#beq-类型的阻塞-定义-branchstall端口" class="headerlink" title="beq 类型的阻塞 ( 定义 branchstall端口 )"></a>beq 类型的阻塞 ( 定义 branchstall端口 )</h3><p> 由于 beq 类指令比较特殊（T_use &#x3D; 0），需要考虑和ALU计算类型指令的冲突 (T_new &#x3D; 1) , 还有和 lw 类型指令的冲突 (T_new &#x3D; 2 )。</p>
<p> 对于ALU计算类型、可以分析出当写回的寄存器与 Rs 、Rt 相同时需要阻塞 （同时这个指令需要写回，也就是 RegWrite &#x3D; 1）。</p>
<p> 对于lw类型、可以分析出当读取的寄存器与 Rs、Rt 相同时需要阻塞 ( lw类 对应MemtoReg_M)</p>
<p> 这样，我们就可以给出 branchstall 控制信号，可以思考以下为什么是E级的 RegWrite 和M级的 MemtoReg ？</p>
<div class="highlight-container" data-rel="Verilog"><figure class="iseeu highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">assign</span> branchstall = (Branch_D &amp;&amp; RegWrite_E &amp;&amp; (WriteReg_E == Rs_D || WriteReg_E == Rt_D)) || </span><br><span class="line">														  <span class="comment">//解决beq类和ALU计算类指令的冲突</span></span><br><span class="line">                     (Branch_D &amp;&amp; MemtoReg_M &amp;&amp; (WriteReg_M == Rs_D || WriteReg_M == Rt_D));   </span><br><span class="line">                     										<span class="comment">//解决beq类和lw类指令的冲突</span></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p> E级的 RegWrite 对应的是 ALU 计算类指令要写回的寄存器，应和 beq 指令需要的寄存器进行比较。</p>
<p> 事实上，在 lw 指令后面紧跟 beq 指令时，是需要阻塞两周期的。当 lw 指令在E级、beq指令在D级时满足 lwstall 条件，此时阻塞一周期。lw 指令到M级而 beq 指令还在D级。所以这里需要判断的是M级的MemtoReg。如果满足条件的话由 branchstall 指令给出第二次阻塞。</p>
</blockquote>
<h3 id="jr-类型的阻塞（定义jrstall端口）"><a href="#jr-类型的阻塞（定义jrstall端口）" class="headerlink" title="jr 类型的阻塞（定义jrstall端口）"></a>jr 类型的阻塞（定义jrstall端口）</h3><p>和beq类型的阻塞相似.</p>
<h3 id="四-p5上机技巧"><a href="#四-p5上机技巧" class="headerlink" title="(四).p5上机技巧"></a>(四).p5上机技巧</h3><h2 id="增添指令一般步骤"><a href="#增添指令一般步骤" class="headerlink" title="增添指令一般步骤"></a>增添指令一般步骤</h2><h3 id="明确指令RTL"><a href="#明确指令RTL" class="headerlink" title="明确指令RTL"></a>明确指令RTL</h3><ul>
<li>该步骤需要结合题目弄懂指令行为，包括<strong>明确指令类型</strong>（R型？I型？J型？即明确读和写的目标）、<strong>opcode和funct域数据</strong>、<strong>执行功能</strong>（计算？跳转？访存？）</li>
<li>最好可以先用MARS模拟下，以免对指令行为理解不到位。</li>
</ul>
<h3 id="明确非转发数据通路"><a href="#明确非转发数据通路" class="headerlink" title="明确非转发数据通路"></a>明确非转发数据通路</h3><ul>
<li>在该步骤中，可以在<strong>单周期</strong>中思考新指令的行为，构思出该新指令的数据通路，然后修改控制器中的相关控制信号——包括<strong>使能信号</strong>（P5中的DM和GRF的写使能、P6中的GRF写使能和新加的byteen）、<strong>功能MUX的选择信号</strong>（GRF写入地址的选择、ALU的B端口数据的选择、GRF写入数据的选择等等）和<strong>模块功能的选择信号</strong>（ALU功能选择、NPC功能选择）。</li>
</ul>
<h3 id="考虑转发"><a href="#考虑转发" class="headerlink" title="考虑转发"></a>考虑转发</h3><ul>
<li>考虑新指令作为提供者：<ul>
<li>首先考虑它是否及时将已经计算出来的将要被写入GRF的数据转发；<ul>
<li>例如，<strong>计算类指令</strong>在E级ALU会生成<strong>GRF写入数据</strong>，那么需要在后面的M级、W级的流水寄存器设置接口这个数据转发</li>
<li>例如，<strong>跳转并链接类指令</strong>在D级就可以生成<strong>GRF写入数据</strong><code>pc+8</code>,那么需要E级、M级和W级的流水寄存器设置接口将这个数据转发</li>
</ul>
</li>
<li>然后考虑GRF的5位写入地址是否正确。<ul>
<li>一般在第2步已经调整完毕，但是像<code>lwer</code>、<code>lhso</code>等条件存储类指令只有在M级从DM中取出数据后才能明确写入地址，需要在<strong>M级</strong>将GRF写入地址再次修改</li>
</ul>
</li>
</ul>
</li>
<li>考虑新指令作为<strong>接受者</strong>：明确需要使用<code>GPR[rs]</code>、<code>GPR[rt]</code>的功能部件和相应接口（CMP的D1和D2？ALU的A和B？乘除模块的A和B？DM的WD？），课上可能需要设置新的接口。</li>
</ul>
<h3 id="考虑暂停"><a href="#考虑暂停" class="headerlink" title="考虑暂停"></a>考虑暂停</h3><ul>
<li>明确新指令的<code>Tuse_rs</code>、<code>Tuse_rt</code>以及在各级流水的<code>Tnew</code>，直接在主控制器中修改即可（<strong>千万不要忘记</strong>）。</li>
</ul>
<hr>
<h2 id="课上测试题型分析"><a href="#课上测试题型分析" class="headerlink" title="课上测试题型分析"></a>课上测试题型分析</h2><p>注：笔者课下cpu设计采用的是<strong>集中式译码</strong>和<strong>暴力转发</strong>。</p>
<h3 id="计算类"><a href="#计算类" class="headerlink" title="计算类"></a>计算类</h3><p><strong>P5中一般只需要增加ALU的功能，但一定要看清楚新指令的计算行为，最好在MARS里先模拟一下。</strong></p>
<ul>
<li><p>一般来说新指令的计算行为会稍微复杂一点，用<code>always @（*）</code>写会比较简单，用<code>assign</code>的话可以定义一个<code>function</code>。</p>
</li>
<li><p>一般情况下，<code>Tnew</code>和<code>Tuse</code>与<strong>calc_R型指令</strong>保持一致即可。</p>
</li>
<li><p>循环移位可以采用以下写法——</p>
<div class="highlight-container" data-rel="Verilog"><figure class="iseeu highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//以循环左移为例</span></span><br><span class="line"><span class="keyword">if</span>(B[<span class="number">4</span>:<span class="number">0</span>] == <span class="number">5&#x27;d0</span>) out = A;</span><br><span class="line"><span class="keyword">else</span> out = A &lt;&lt; B[<span class="number">4</span>:<span class="number">0</span>] | A &gt;&gt; (<span class="number">5&#x27;d31</span> - B[<span class="number">4</span>:<span class="number">0</span>] + <span class="number">5&#x27;d1</span>);</span><br></pre></td></tr></table></figure></div></li>
</ul>
<p><strong>P6的计算会涉及到乘除模块，也相对比较简单。需要注意madd、maddu、msub、msubu等指令（roife博客[<a class="link"   target="_blank" rel="noopener" href="https://hyggge.github.io/2021/12/06/CO_P5&P6%E8%AF%BE%E4%B8%8A%E6%B5%8B%E8%AF%95%E6%80%BB%E7%BB%93/#fn1" >1] <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>有讲到）。</strong></p>
<ul>
<li><p>以madd为例（将两个数有符号相乘，计算结果与之前的HI、LO寄存器中的值相加，而不是覆盖），如果是以下写法会出现问题</p>
<div class="highlight-container" data-rel="Verilog"><figure class="iseeu highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//错误写法1</span></span><br><span class="line">&#123;HI_temp, LO_temp&#125; &lt;= &#123;HI, LO&#125; + <span class="built_in">$signed</span>(A) * <span class="built_in">$signed</span>(B);</span><br><span class="line"><span class="comment">//错误写法2</span></span><br><span class="line">&#123;HI_temp, LO_temp&#125; &lt;= &#123;HI, LO&#125; + <span class="built_in">$signed</span>(<span class="built_in">$signed</span>(A) * <span class="built_in">$signed</span>(B));</span><br></pre></td></tr></table></figure></div>

<ul>
<li><strong>错误写法1</strong>出现问题的原因是： 位拼接<code>&#123;HI, LO&#125;</code>默认被当做无符号数， <strong>无符号性</strong>传递到<code>$signed(A) * $signed(B)</code>，因此即使使用了<code>$signed()</code>还是会被当成无符号数进行乘法运算</li>
<li><strong>错误写法2</strong>出现问题的原因是：虽然使用了<code>$signed()</code>屏蔽了外界符号性的传入，但是也屏蔽了<strong>位宽</strong>信息的传入，所以<code>$signed($signed(A) * $signed(B))</code>的结果实际上是32位(因为<code>$signed(A)</code>和<code>$signed(B)</code>都是32位，又没有外界位宽信息的传入，因此结果被强制规定为32位)，即<strong>高32位的数据被截去</strong>，在参与后续运算时自然会出现问题。</li>
</ul>
</li>
<li><p>为了避免上述情况，我们需要在错误写法2的最外层$signed()中人为传入64位位宽信息，学长博客的写法如下——</p>
<div class="highlight-container" data-rel="Verilog"><figure class="iseeu highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//正确写法1</span></span><br><span class="line">&#123;HI_temp, LO_temp&#125; &lt;= &#123;HI, LO&#125; + <span class="built_in">$signed</span>(<span class="built_in">$signed</span>(<span class="number">64&#x27;d0</span>) + <span class="built_in">$signed</span>(A) * <span class="built_in">$signed</span>(B));</span><br><span class="line"><span class="comment">//正确写法2</span></span><br><span class="line">&#123;HI_temp, LO_temp&#125; &lt;= &#123;HI, LO&#125; + <span class="built_in">$signed</span>(<span class="built_in">$signed</span>(&#123;&#123;<span class="number">32</span>&#123;A[<span class="number">31</span>]&#125;&#125;, A[<span class="number">31</span>]&#125;) * <span class="built_in">$signed</span>(&#123;&#123;<span class="number">32</span>&#123;B[<span class="number">31</span>]&#125;&#125;, B[<span class="number">31</span>]&#125;));</span><br></pre></td></tr></table></figure></div>

<p>我认为还可以对错误写法1进行修改——</p>
<div class="highlight-container" data-rel="Verilog"><figure class="iseeu highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//正确写法3</span></span><br><span class="line">&#123;HI_temp, LO_temp&#125; &lt;= $sigend(&#123;HI, LO&#125;) + <span class="built_in">$signed</span>(A) * <span class="built_in">$signed</span>(B);</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h3 id="条件跳转类"><a href="#条件跳转类" class="headerlink" title="条件跳转类"></a>条件跳转类</h3><p>一般跳转类指令有以下几种要求——</p>
<ol>
<li><strong>条件跳转+无条件链接</strong></li>
<li><strong>条件跳转+条件链接</strong></li>
<li><strong>条件跳转+条件（无条件）链接+不跳转时清空延迟槽</strong></li>
</ol>
<ul>
<li><p><strong>条件跳转</strong>比较好做，一般只需增加<strong>CMP模块</strong>中的判断功能即可。</p>
</li>
<li><p>如果是<strong>无条件链接</strong>的话也比较简单，可以直接在D级将<code>RFWrite</code>（GRF写入使能）置<strong>1</strong>并让它流水，并更改一下<code>A3</code>(GRF写入地址，一般是要链接到31号寄存器)，最后在W级将GRF写入数据选择成<strong>PC+8</strong>即可。</p>
</li>
<li><p>如果是条件链接，则需要在D级根据CMP模块的输出结果判断RFWrite是否有效，写法如下——</p>
</li>
</ul>
<div class="highlight-container" data-rel="Verilog"><figure class="iseeu highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//为了确定当前指令是新指令，我们设置一个check信号随新指令一起流水，check有效则表示当前指令是新指令</span></span><br><span class="line">  <span class="comment">//D_RFWrite是从D级主控制器输出的信号</span></span><br><span class="line"><span class="keyword">wire</span> D_RFWrite_new = check_D ? (D_CMP_out ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>) : D_RFWrite;</span><br><span class="line">  <span class="comment">//这时我们流水到下一级的就是D_RFWrite_new，而不是D_RFWrite</span></span><br><span class="line">  E_Reg  u_E_Reg (<span class="comment">//input</span></span><br><span class="line">                  <span class="comment">//…………………………………………</span></span><br><span class="line">                  <span class="variable">.RFWrite_D</span>               ( RFWrite_D_new      ),</span><br><span class="line"></span><br><span class="line">                  <span class="comment">//output</span></span><br><span class="line">                  <span class="comment">//…………………………………………</span></span><br><span class="line">                  <span class="variable">.RFWrite_E</span>               ( RFWrite_E          ),</span><br><span class="line">                  );</span><br></pre></td></tr></table></figure></div>

<ul>
<li><p>如果题目要求不跳转时清空延迟槽，则需要根据当前CMP模块输出结果判断是否清空D级流水寄存器。</p>
<p>需要注意的是，如果当前正在处于stall状态时，不能清空延迟槽（stall说明前面指令的Tnew大于新指令的Tuse，即需要传入CMP模块的两个值的最新值还没有计算出来，因此还无法转发到CMP中）。写法如下——</p>
<div class="highlight-container" data-rel="Verilog"><figure class="iseeu highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">wire</span> D_Reg_clr = check_D &amp; ~D_CMP_out &amp; ~stall;</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h3 id="条件存储类"><a href="#条件存储类" class="headerlink" title="条件存储类"></a>条件存储类</h3><p><strong>条件存储，也就是从DM取出值之后，根据这个值是否满足某个condition，再判断要往哪个寄存器写。</strong> 和前两种题型相比更复杂，但是总结下来也就只有以下<strong>三种类型</strong>——</p>
<ol>
<li><strong>condition成立：</strong> 将DM中的值写入<strong>A号</strong>寄存器<br><strong>condition不成立：</strong> 写入<strong>B号</strong>寄存器</li>
<li><strong>condition成立：</strong> 将DM中的值写入<strong>A号</strong>寄存器<br><strong>condition不成立：</strong> 不写入</li>
<li><strong>写入目标完全取决于DM的读取值</strong>（如将DM读取值的低5位作为写入目标）</li>
</ol>
<p>对于第二种不写入的情况，我们可以将写入地址<strong>设置为0号寄存器</strong>。因此这三种类型本质上是一种。</p>
<p><strong>对于条件存储类指令，我们只有到M级才知道写入目标是什么</strong>，这对会我们的转发和暂停造成影响。我们需要对 <strong><code>stall</code>信号的生成逻辑</strong>进行修改，引用学长的话说就是——<strong>“如果 D 级的指令要读寄存器，而且后面的新指令</strong> <em><strong>可能</strong></em> <strong>要写这个寄存器，那么就 <code>stall</code>”</strong>。代码如下——</p>
  <div class="highlight-container" data-rel="Verilog"><figure class="iseeu highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//笔者采用的命名方法是——A1和A2表示该流水级指令的GRF读地址,A3表示指令的GRF写地址</span></span><br><span class="line"><span class="comment">//例如，如果E级指令为addu，则E_A1为rs域数据，E_A2为rt域数据，E_A3为rd域数据</span></span><br><span class="line"><span class="comment">//RFWrite表示GRF写入使能信号</span></span><br><span class="line"><span class="comment">//check信号有效则表示该流水级指令为新指令</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">//第一种题型(eg：condition满足向rt号写，否则写31号)</span></span><br><span class="line">    <span class="keyword">assign</span>   stall_rs_E = (D_A1 != <span class="number">5&#x27;d0</span>) &amp; (check_E ? (D_A1 == E_A3 | D_A1 == <span class="number">5&#x27;d31</span>) : D_A1 == E_A3) &amp; (RFWrite_E) &amp; (Tuse_rs &lt; Tnew_E);</span><br><span class="line">    <span class="keyword">assign</span>   stall_rs_M = (D_A1 != <span class="number">5&#x27;d0</span>) &amp; (check_M ? (D_A1 == M_A3 | D_A1 == <span class="number">5&#x27;d31</span>) : D_A1 == M_A3) &amp; (RFWrite_M) &amp; (Tuse_rs &lt; Tnew_M);</span><br><span class="line">    <span class="keyword">assign</span>   stall_rt_E = (D_A2 != <span class="number">5&#x27;d0</span>) &amp; (check_E ? (D_A2 == E_A3 | D_A2 == <span class="number">5&#x27;d31</span>) : D_A2 == E_A3) &amp; (RFWrite_E) &amp; (Tuse_rt &lt; Tnew_E);</span><br><span class="line">    <span class="keyword">assign</span>   stall_rt_M = (D_A2 != <span class="number">5&#x27;d0</span>) &amp; (check_M ? (D_A2 == M_A3 | D_A2 == <span class="number">5&#x27;d31</span>) : D_A2 == M_A3) &amp; (RFWrite_M) &amp; (Tuse_rt &lt; Tnew_M);</span><br><span class="line"><span class="comment">//第二种题型 (eg：condition满足向31号写，否则不写) </span></span><br><span class="line"><span class="comment">//按照第一种题型以写成  (check_M ? (D_A2 == 5&#x27;d31 | D_A2 == 5&#x27;d0): D_A2 == M_A3),因为前面有条件 D_A2 != 5&#x27;d0，所以可以简化</span></span><br><span class="line">    <span class="keyword">assign</span>   stall_rt_M = (D_A2 != <span class="number">5&#x27;d0</span>) &amp; (check_M ? D_A2 == <span class="number">5&#x27;d31</span> : D_A2 == M_A3) &amp; (RFWrite_M) &amp; (Tuse_rt &lt; Tnew_M);</span><br><span class="line"><span class="comment">//第三种题型 (eg：condition满足时写入位置为DM的读取值的低五位)   </span></span><br><span class="line">    <span class="keyword">assign</span>   stall_rt_M = (D_A2 != <span class="number">5&#x27;d0</span>) &amp; (check_M ? <span class="number">1&#x27;b1</span> : D_A2 == M_A3) &amp; (RFWrite_M) &amp; (Tuse_rt &lt; Tnew_M);</span><br></pre></td></tr></table></figure></div>

<p>此外我们还需要在M级根据DM取出的值修改<code>A3</code>(GRF写入地址),代码如下——</p>
<div class="highlight-container" data-rel="Verilog"><figure class="iseeu highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第一种题型(eg：condition满足向rt号写，否则写31号)</span></span><br><span class="line">    <span class="keyword">wire</span> M_A3_new = check_M ? (condition ? `rt : <span class="number">5&#x27;d31</span>) : M_A3; </span><br><span class="line"><span class="comment">//第二种题型 (eg：condition满足向31号写，否则不写) </span></span><br><span class="line">    <span class="keyword">wire</span> M_A3_new = check_M ? (condition ? <span class="number">5&#x27;d31</span> : <span class="number">5&#x27;d0</span>) : M_A3; </span><br><span class="line"><span class="comment">//第三种题型 (eg：写入位置为DM的读取值的低五位)  </span></span><br><span class="line">    <span class="keyword">wire</span> M_A3_new = check_M ? DM_out[<span class="number">4</span>:<span class="number">0</span>] : M_A3; </span><br></pre></td></tr></table></figure></div>

<p>这样一来，我们在M级就将可以将正确的GRF写入地址修改，然后再传入下一级流水寄存器(W_Reg)和冒险控制器(HCU)即可。</p>
<div class="highlight-container" data-rel="Verilog"><figure class="iseeu highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">W_Reg  u_W_Reg (<span class="comment">//input</span></span><br><span class="line">              <span class="comment">//…………………………………………</span></span><br><span class="line">              <span class="variable">.M_A3</span>               ( M_A3_new      ),</span><br><span class="line"></span><br><span class="line">              <span class="comment">//output</span></span><br><span class="line">              <span class="comment">//…………………………………………</span></span><br><span class="line">              <span class="variable">.W_A3</span>               ( W_A3          ),</span><br><span class="line">              );</span><br><span class="line"></span><br><span class="line">  HCU  u_HCU (<span class="comment">//input</span></span><br><span class="line">              <span class="comment">//…………………………………………</span></span><br><span class="line">              <span class="variable">.M_A3</span>                 ( M_A3_new         ),</span><br><span class="line">              </span><br><span class="line">              <span class="comment">//output</span></span><br><span class="line">              <span class="variable">.FwdCMPD1</span>             ( FwdCMPD1   [<span class="number">1</span>:<span class="number">0</span>] ),</span><br><span class="line">              <span class="variable">.FwdCMPD2</span>             ( FwdCMPD2   [<span class="number">1</span>:<span class="number">0</span>] ),</span><br><span class="line">              <span class="variable">.FwdALUA</span>              ( FwdALUA    [<span class="number">1</span>:<span class="number">0</span>] ),</span><br><span class="line">              <span class="variable">.FwdALUB</span>              ( FwdALUB    [<span class="number">1</span>:<span class="number">0</span>] ),</span><br><span class="line">              <span class="variable">.FwdDM</span>                ( FwdDM            ),</span><br><span class="line">              <span class="variable">.stall</span>                ( stall            )</span><br><span class="line">            );</span><br></pre></td></tr></table></figure></div>

<p><strong>如果你是到W级才修改写入地址（也就是说，<code>M_A3_new</code>只传入了W_Reg而没有传入HCU，HCU的输入端仍然是<code>M_A3</code>）, 这样会有一定问题</strong>。通过下面的例子说明——</p>
<div class="highlight-container" data-rel="Markdown"><figure class="iseeu highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lhso    $s1, 1024($0) </span><br><span class="line">sw      $s1, 4096($0)</span><br></pre></td></tr></table></figure></div>

<p>当<code>lhso</code>在M级的时候，M级写入地址还没有被及时更新。因此这时候<strong>冒险控制器</strong>中<code>lhso</code>的写地址（<code>$s1</code>）和sw的读地址（<code>$s1</code>）还是相等的，所以会向处于E级的sw指令转发一个数据（即教程中采用的暴力转发）。<strong>下一时钟上升沿来临时</strong>，<code>lhso</code>进入W级，如果这时候lhso的写入地址不再是<code>$s1</code>, 而是根据<strong>condition</strong>修改成了<code>31</code>号寄存器，那么我们在上一周期向sw指令转发的值就是一个错误值。</p>
<p>为了避免这种情况，我们需要<strong>对转发信号做一些调整</strong>，策略是：<strong>既然我们在<code>lhso</code>进入W级之前不知道要往哪个寄存器写值，那么我们就不向前转发</strong>。转发信号的调整如下——</p>
<div class="highlight-container" data-rel="Verilog"><figure class="iseeu highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">assign</span> FwdCMPD1 = ((D_A1 != <span class="number">5&#x27;d0</span>) &amp; (D_A1 == E_A3) &amp; (RFWrite_E) &amp; ~check_E) ? <span class="number">2&#x27;d2</span> :</span><br><span class="line">                  ((D_A1 != <span class="number">5&#x27;d0</span>) &amp; (D_A1 == M_A3) &amp; (RFWrite_M) &amp; ~check_M) ? <span class="number">2&#x27;d1</span> : </span><br><span class="line">                                                                    <span class="number">2&#x27;d0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">assign</span> FwdCMPD2 = ((D_A2 != <span class="number">5&#x27;d0</span>) &amp; (D_A2 == E_A3) &amp; (RFWrite_E) &amp; ~check_E) ? <span class="number">2&#x27;d2</span> :</span><br><span class="line">                  ((D_A2 != <span class="number">5&#x27;d0</span>) &amp; (D_A2 == M_A3) &amp; (RFWrite_M) &amp; ~check_M) ? <span class="number">2&#x27;d1</span> :</span><br><span class="line">                                                                    <span class="number">2&#x27;d0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">assign</span> FwdALUA  = ((E_A1 != <span class="number">5&#x27;d0</span>) &amp; (E_A1 == M_A3) &amp; (RFWrite_M) &amp; ~check_M) ? <span class="number">2&#x27;d2</span> :</span><br><span class="line">                  ((E_A1 != <span class="number">5&#x27;d0</span>) &amp; (E_A1 == W_A3) &amp; (RFWrite_W)) ? <span class="number">2&#x27;d1</span> :</span><br><span class="line">                                                                    <span class="number">2&#x27;d0</span>;    </span><br><span class="line"></span><br><span class="line"><span class="keyword">assign</span> FwdALUB  = ((E_A2 != <span class="number">5&#x27;d0</span>) &amp; (E_A2 == M_A3) &amp; (RFWrite_M) &amp; ~check_M) ? <span class="number">2&#x27;d2</span> :</span><br><span class="line">                  ((E_A2 != <span class="number">5&#x27;d0</span>) &amp; (E_A2 == W_A3) &amp; (RFWrite_W)) ? <span class="number">2&#x27;d1</span> :</span><br><span class="line">                                                                    <span class="number">2&#x27;d0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">assign</span> FwdDM    = ((M_A2 != <span class="number">5&#x27;d0</span>) &amp; (M_A2 == W_A3) &amp; (RFWrite_W)) ? <span class="number">1&#x27;d1</span> : </span><br><span class="line">                                                                    <span class="number">1&#x27;d0</span>;</span><br></pre></td></tr></table></figure></div>

<p>这样对于新指令，我们就不再是<strong>暴力转发</strong>，而是<strong>条件转发</strong>。我个人还是建议采用第2种方法，我认为这种方法的正确性比第一种更容易证明。另外，建议在课下可以提前设置好一个<strong>check信号</strong>并让它流水，这样在课上会节省很多时间。</p>
<p>实际上，我们也可以把所有指令的转发都更改为<strong>条件转发</strong>——即<strong>所有的指令只有得到要写入寄存器的结果后才会向前转发</strong>，这样只需要将<code>Tnew == 0</code>加入判断条件即可。</p>
<div class="highlight-container" data-rel="Verilog"><figure class="iseeu highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Tnew == 0 表示当前指令已经产生要写入寄存器的结果</span></span><br><span class="line"><span class="comment">//因为W级指令的Tnew都为0，因此不需要再添加(Tnew_W == 0)</span></span><br><span class="line"><span class="keyword">assign</span> FwdCMPD1 = ((D_A1 != <span class="number">5&#x27;d0</span>) &amp; (D_A1 == E_A3) &amp; (RFWrite_E) &amp; (Tnew_E == <span class="number">0</span>)) ? <span class="number">2&#x27;d2</span> :</span><br><span class="line">                  ((D_A1 != <span class="number">5&#x27;d0</span>) &amp; (D_A1 == M_A3) &amp; (RFWrite_M) &amp; (Tnew_M == <span class="number">0</span>)) ? <span class="number">2&#x27;d1</span> : </span><br><span class="line">                                                                    <span class="number">2&#x27;d0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">assign</span> FwdCMPD2 = ((D_A2 != <span class="number">5&#x27;d0</span>) &amp; (D_A2 == E_A3) &amp; (RFWrite_E) &amp; (Tnew_E == <span class="number">0</span>)) ? <span class="number">2&#x27;d2</span> :</span><br><span class="line">                  ((D_A2 != <span class="number">5&#x27;d0</span>) &amp; (D_A2 == M_A3) &amp; (RFWrite_M) &amp; (Tnew_M == <span class="number">0</span>)) ? <span class="number">2&#x27;d1</span> :</span><br><span class="line">                                                                    <span class="number">2&#x27;d0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">assign</span> FwdALUA  = ((E_A1 != <span class="number">5&#x27;d0</span>) &amp; (E_A1 == M_A3) &amp; (RFWrite_M) &amp; (Tnew_M == <span class="number">0</span>)) ? <span class="number">2&#x27;d2</span> :</span><br><span class="line">                  ((E_A1 != <span class="number">5&#x27;d0</span>) &amp; (E_A1 == W_A3) &amp; (RFWrite_W)) ? <span class="number">2&#x27;d1</span> :</span><br><span class="line">                                                                    <span class="number">2&#x27;d0</span>;    </span><br><span class="line"></span><br><span class="line"><span class="keyword">assign</span> FwdALUB  = ((E_A2 != <span class="number">5&#x27;d0</span>) &amp; (E_A2 == M_A3) &amp; (RFWrite_M) &amp; (Tnew_M == <span class="number">0</span>)) ? <span class="number">2&#x27;d2</span> :</span><br><span class="line">                  ((E_A2 != <span class="number">5&#x27;d0</span>) &amp; (E_A2 == W_A3) &amp; (RFWrite_W)) ? <span class="number">2&#x27;d1</span> :</span><br><span class="line">                                                                    <span class="number">2&#x27;d0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">assign</span> FwdDM    = ((M_A2 != <span class="number">5&#x27;d0</span>) &amp; (M_A2 == W_A3) &amp; (RFWrite_W)) ? <span class="number">1&#x27;d1</span> : </span><br><span class="line">                                                                    <span class="number">1&#x27;d0</span>;</span><br></pre></td></tr></table></figure></div>

<p><strong>Q:条件转发会有问题吗？</strong></p>
<p><strong>A:不会。</strong> 因为有<strong>暂停机制</strong>把关，保证了指令<strong>获得要写入寄存器的值</strong>之前，前面的正常执行的（<strong>即不被stall的</strong>）指令都不会用到相关寄存器的值，或恰好将要使用，即<strong>Tnew &lt;&#x3D; Tuse</strong>，因此不会带来新的问题。</p>

            </div>

            
                <div class="post-copyright-info">
                    <div class="article-copyright-info-container">
    <ul>
        <li>Post title：CO_P5</li>
        <li>Post author：Charles</li>
        <li>Create time：2022-12-26 20:56:01</li>
        <li>
            Post link：https://charles2530.github.io/2022/12/26/co-p5/
        </li>
        <li>
            Copyright Notice：All articles in this blog are licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> unless stating additionally.
        </li>
    </ul>
</div>

                </div>
            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/tags/CO/">#CO</a>&nbsp;
                        </li>
                    
                </ul>
            

            <div class="recommended-article">
  <div class="recommended-article-header">
    <i class="fa-solid fa-bookmark fa-fw" aria-hidden="true"></i><span>recommend_articles</span>
  </div>
  <div class="recommended-article-group"><a class="recommended-article-item" href="/2022/12/27/co-mips/" title="CO-Mips" rel="bookmark">
  <img src="https://charles2530.github.io/image/background/p1.jfif" alt="CO-Mips">
  <span class="title">CO-Mips</span>
</a><a class="recommended-article-item" href="/2022/12/28/cpp-part4/" title="Cpp_part4" rel="bookmark">
  <img src="https://charles2530.github.io/image/background/p4.jfif" alt="Cpp_part4">
  <span class="title">Cpp_part4</span>
</a><a class="recommended-article-item" href="/2023/02/02/javascript-note-5/" title="JavaScript_note_5" rel="bookmark">
  <img src="https://charles2530.github.io/image/background/p4.jfif" alt="JavaScript_note_5">
  <span class="title">JavaScript_note_5</span>
</a></div>
</div>

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                            rel="prev"
                            href="/2022/12/26/p3-design-documents/"
                            >
                                <span class="left arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-left"></i>
                                </span>
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">P3 Design documents</span>
                                    <span class="post-nav-item">Prev posts</span>
                                </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                            rel="next"
                            href="/2022/12/26/co-p7/"
                            >
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">CO_P7</span>
                                    <span class="post-nav-item">Next posts</span>
                                </span>
                                <span class="right arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-right"></i>
                                </span>
                            </a>
                        </div>
                    
                </div>
            


            
                <div class="comment-container">
                    <div class="comments-container">
  <div id="comment-anchor"></div>
  <div class="comment-area-title">
    <i class="fa-solid fa-comments">&nbsp;Comments</i>
  </div>
  

  <!-- 
            
    <div id="gitalk-container"></div>
    <script data-pjax
            src="//cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js"></script>
    <script data-pjax>

        function loadGitalk() {
            let __gitalk__pathname = decodeURI(location.pathname);
            const __gitalk__pathnameLength = __gitalk__pathname.length;
            const __gitalk__pathnameMaxLength = 50;
            if (__gitalk__pathnameLength > __gitalk__pathnameMaxLength) {
                __gitalk__pathname = __gitalk__pathname.substring(0, __gitalk__pathnameMaxLength - 3) + '...';
            }

            try {
                Gitalk && new Gitalk({
                    clientID: '8083299a8ee2aaf23879',
                    clientSecret: 'a8161e81d4872181e884fdb69f7be24916b6a9d0',
                    repo: 'charles2530_issues',
                    owner: 'Charles2530',
                    admin: ['Charles2530'],
                    id: __gitalk__pathname,
                    language: 'en'
                }).render('gitalk-container');

            } catch (e) {
                window.Gitalk = null;
            }
        }

        if ('true') {
            const loadGitalkTimeout = setTimeout(() => {
                loadGitalk();
                clearTimeout(loadGitalkTimeout);
            }, 1000);
        } else {
            window.addEventListener('DOMContentLoaded', loadGitalk);
        }
    </script>



         -->
  <script src="https://utteranc.es/client.js" repo="Charles2530/Charles2530.github.io" issue-term="pathname"
    label="Comment" theme="preferred-color-scheme" crossorigin="anonymous" async>
  </script>

  
</div>

                </div>
            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">CO_P5</div>
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#P5%E6%80%BB%E7%BB%93"><span class="nav-text">P5总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%88%E4%B8%80%EF%BC%89-%E6%8E%A7%E5%88%B6%E5%92%8C%E5%86%92%E9%99%A9%E7%AE%80%E8%BF%B0"><span class="nav-text">（一）.控制和冒险简述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C%EF%BC%89-%E5%86%92%E9%99%A9%E5%A4%84%E7%90%86"><span class="nav-text">(二）.冒险处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BD%AC%E5%8F%91%EF%BC%88forward%EF%BC%89"><span class="nav-text">转发（forward）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BD%AC%E5%8F%91%E7%9A%84%E6%9E%84%E9%80%A0"><span class="nav-text">转发的构造</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9A%82%E5%81%9C%EF%BC%88stall%EF%BC%89"><span class="nav-text">暂停（stall）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%98%BB%E5%A1%9E%E7%9A%84%E6%9E%84%E9%80%A0%EF%BC%88D%E7%BA%A7%EF%BC%89"><span class="nav-text">阻塞的构造（D级）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%EF%BC%89-%E5%85%B6%E4%BB%96%E8%A6%81%E7%82%B9"><span class="nav-text">(三）.其他要点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-D%E7%BA%A7"><span class="nav-text">1.D级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-E%E7%BA%A7"><span class="nav-text">2.E级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lw-%E7%B1%BB%E5%9E%8B%E9%98%BB%E5%A1%9E%EF%BC%88%E5%AE%9A%E4%B9%89lwstall%E7%AB%AF%E5%8F%A3%EF%BC%89"><span class="nav-text">lw 类型阻塞（定义lwstall端口）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#beq-%E7%B1%BB%E5%9E%8B%E7%9A%84%E9%98%BB%E5%A1%9E-%E5%AE%9A%E4%B9%89-branchstall%E7%AB%AF%E5%8F%A3"><span class="nav-text">beq 类型的阻塞 ( 定义 branchstall端口 )</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jr-%E7%B1%BB%E5%9E%8B%E7%9A%84%E9%98%BB%E5%A1%9E%EF%BC%88%E5%AE%9A%E4%B9%89jrstall%E7%AB%AF%E5%8F%A3%EF%BC%89"><span class="nav-text">jr 类型的阻塞（定义jrstall端口）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9B-p5%E4%B8%8A%E6%9C%BA%E6%8A%80%E5%B7%A7"><span class="nav-text">(四).p5上机技巧</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E6%B7%BB%E6%8C%87%E4%BB%A4%E4%B8%80%E8%88%AC%E6%AD%A5%E9%AA%A4"><span class="nav-text">增添指令一般步骤</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%98%8E%E7%A1%AE%E6%8C%87%E4%BB%A4RTL"><span class="nav-text">明确指令RTL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%98%8E%E7%A1%AE%E9%9D%9E%E8%BD%AC%E5%8F%91%E6%95%B0%E6%8D%AE%E9%80%9A%E8%B7%AF"><span class="nav-text">明确非转发数据通路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%80%83%E8%99%91%E8%BD%AC%E5%8F%91"><span class="nav-text">考虑转发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%80%83%E8%99%91%E6%9A%82%E5%81%9C"><span class="nav-text">考虑暂停</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%BE%E4%B8%8A%E6%B5%8B%E8%AF%95%E9%A2%98%E5%9E%8B%E5%88%86%E6%9E%90"><span class="nav-text">课上测试题型分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A1%E7%AE%97%E7%B1%BB"><span class="nav-text">计算类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%A1%E4%BB%B6%E8%B7%B3%E8%BD%AC%E7%B1%BB"><span class="nav-text">条件跳转类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%A1%E4%BB%B6%E5%AD%98%E5%82%A8%E7%B1%BB"><span class="nav-text">条件存储类</span></a></li></ol></li></ol></li></ol>

    </div>
</div>
            </div>
        
    </div>
</div>


                

            </div>



        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info">
            &copy;
            
              <span>2022</span>
              -
            
            2023&nbsp;&nbsp;<i class="fa-regular fa-computer-classic"></i>&nbsp;&nbsp;<a href="/">Charles</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv" class="busuanzi_container_site_uv">
                        Visitor Count&nbsp;<span id="busuanzi_value_site_uv" class="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="busuanzi_container_site_pv">
                        Total Page Views&nbsp;<span id="busuanzi_value_site_pv" class="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            <span class="powered-by-container">Powered by Charles</span>
                <br> 
            <span class="theme-version-container">Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v1.1.2</a>
        </div>
        
        
        
            <div id="start_time_div" style="display:none">
                2022/12/27 00:00:00
            </div>
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
        
            <script async data-pjax>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
            
                
        
                
        
                

                    
                        <script data-pjax type="text/javascript" src="/js/love.js"></script>
                    
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fa-regular fa-comments"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="unfolded-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-expand-width flex-center">
            <i class="fa-regular fa-expand"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="right-bottom-tools rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                <i class="fa-regular fa-rss"></i>
                </a>
            </li>
        

        
            <li class="right-bottom-tools tool-scroll-to-top flex-center">
                <i class="fa-regular fa-arrow-up"></i>
            </li>
        

        <li class="right-bottom-tools tool-scroll-to-bottom flex-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="folded-tools-list">
        <li class="right-bottom-tools tool-toggle-show flex-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    


</main>



  
<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/layouts/menu-shrink.js"></script>

<script src="/js/tools/go-top-bottom.js"></script>

<script src="/js/tools/dark-light-toggle.js"></script>



    
<script src="/js/tools/local-search.js"></script>




    
<script src="/js/tools/code-block.js"></script>




    
<script src="/js/layouts/lazyload.js"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/layouts/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">



<div class="post-scripts pjax">
    
        
<script src="/js/tools/toc-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/layouts/toc.js"></script>

<script src="/js/plugins/tabs.js"></script>

    
    
        
<script src="/js/libs/mermaid.min.js"></script>

        
<script src="/js/plugins/mermaid.js"></script>

    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            REDEFINE.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            REDEFINE.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            REDEFINE.refresh();
        });
    });
</script>



</body>

</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/love.js"></script>
