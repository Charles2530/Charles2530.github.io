<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Charles">
    
    <meta name="author" content="Charles">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://charles2530.github.io/2022/12/26/p8-design-documents/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="post by Charles in 2022-12-26 21:12:55">
<meta property="og:type" content="article">
<meta property="og:title" content="P8 Design documents">
<meta property="og:url" content="http://charles2530.github.io/2022/12/26/p8-design-documents/index.html">
<meta property="og:site_name" content="Charles&#39;s Castle">
<meta property="og:description" content="post by Charles in 2022-12-26 21:12:55">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://charles2530.github.io/image/simple_cpu.png">
<meta property="og:image" content="https://charles2530.github.io/image/4.png">
<meta property="og:image" content="https://charles2530.github.io/image/5.png">
<meta property="og:image" content="https://hyggge.github.io/2021/12/25/CO_P8_MIPS%E5%BE%AE%E7%B3%BB%E7%BB%9F%EF%BC%88%E6%9D%BF%E7%BA%A7%E9%AA%8C%E8%AF%81%EF%BC%89/%E5%85%AB%E6%AE%B5%E6%95%B0%E7%A0%81%E7%AE%A1png.png">
<meta property="article:published_time" content="2022-12-26T13:12:55.000Z">
<meta property="article:modified_time" content="2023-06-17T06:13:59.316Z">
<meta property="article:author" content="Du Jinyang">
<meta property="article:tag" content="CO">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://charles2530.github.io/image/simple_cpu.png">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="https://charles2530.github.io/image/background/favicon.png" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="https://charles2530.github.io/image/background/favicon.png">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="https://charles2530.github.io/image/background/favicon.png">
    <!--- Page Info-->
    
    <title>
        
            P8 Design documents -
        
        Charles&#39;s Castle
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/fonts/fonts.css">

    
<link rel="stylesheet" href="/fonts/Satoshi/satoshi.css">

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">

    <!--- Font Part-->
    
    
    
    

    <!--- Inject Part-->
    
    <script id="hexo-configurations">
    let Global = window.Global || {};
    Global.hexo_config = {"hostname":"charles2530.github.io","root":"/","language":"en","path":"search.xml"};
    Global.theme_config = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":true,"list":["lol","Neo","God"]},"code_block":{"copy":true,"style":"mac","font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":6,"number":false,"expand":true,"init_open":true},"copyright":true,"lazyload":true,"recommendation":{"enable":false,"title":"recommend_articles","limit":3,"mobile_limit":2,"placeholder":"https://charles2530.github.io/image/background/p3.jfif","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":"#1890ff"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":true},"scroll_progress":{"bar":true,"percentage":true},"website_counter":{"url":"https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"https://charles2530.github.io/image/background/background-light1.jpg","dark":"https://charles2530.github.io/image/background/background-dark1.jpg"},"title":"Charles's Castle","subtitle":{"text":["Happiness is best!","Never give up!","Everyday is a gift!"],"hitokoto":{"enable":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#000000","dark":"#d1d1b6"},"text_style":{"title_size":"3.2rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":true,"links":{"github":"https://github.com/Charles2530/","zhihu":"https://www.zhihu.com/people/yang-guang-xiao-zi-55-55","email":"charles2530@163.com"},"qrs":{"weixin":"https://charles2530.github.io/image/background/Wechat_icon.png"}}},"plugins":{"feed":{"enable":true},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null},{"name":null,"artist":null,"url":null,"cover":null}]},"mermaid":{"enable":true,"version":"9.3.0"}},"version":"2.3.0","navbar":{"auto_hide":true,"color":{"left":"#f78736","right":"#367df7","transparency":35},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Categories":{"path":"/categories","icon":"fas fa-bookmark"},"Tags":{"path":"/tags","icon":"fas fa-tags"},"About":{"icon":"fa-regular fa-user","submenus":{"Me":"/about","Github":"https://github.com/Charles2530/","Blog":"https://charles2530.github.io"}}},"search":{"enable":true,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":"This is Charles's Castle","links":{"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Photos":{"icon":"fa-solid fa-image","path":"/masonry/"},"Essays":{"icon":"fa-solid fa-message-lines","path":"/essay/"},"Friends":{"icon":"fa-solid fa-user-group","path":"/friends/"}}},"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2022/12/27 00:00:00"};
    Global.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    Global.data_config = {"masonry":true};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Charles's Castle" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>



<body>
  <div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="swup-progress-icon">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container" id="swup">
    

    

    <div class="main-content-container">
        

        <div class="main-content-header">
            <header class="navbar-container">
    
    <div class="navbar-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                Charles&#39;s Castle
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/"  >
                                    
                                        
                                            <i class="fa-regular fa-house"></i>
                                        
                                        HOME
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/categories"  >
                                    
                                        
                                            <i class="fas fa-bookmark"></i>
                                        
                                        CATEGORIES
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/tags"  >
                                    
                                        
                                            <i class="fas fa-tags"></i>
                                        
                                        TAGS
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown" 
                                    href="#" onClick="return false;">
                                    
                                        
                                            <i class="fa-regular fa-user"></i>
                                        
                                        ABOUT&nbsp;<i class="fa-solid fa-chevron-down"></i>
                                    
                                </a>
                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                    
                                        <li>
                                        <a href="/about">ME
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://github.com/Charles2530/">GITHUB
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a href="https://charles2530.github.io">BLOG
                                        </a>
                                        </li>
                                    
                                    </ul>
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="navbar-drawer">
        <ul class="drawer-navbar-list">
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/"  >
                             
                                
                                    <i class="fa-regular fa-house"></i>
                                
                                HOME
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/categories"  >
                             
                                
                                    <i class="fas fa-bookmark"></i>
                                
                                CATEGORIES
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/tags"  >
                             
                                
                                    <i class="fas fa-tags"></i>
                                
                                TAGS
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="has-dropdown" 
                        href="#" onClick="return false;">
                            
                                
                                    <i class="fa-regular fa-user"></i>
                                
                                ABOUT&nbsp;<i class="fa-solid fa-chevron-down"></i>
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                              
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" href="/about">ME</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" target="_blank" rel="noopener" href="https://github.com/Charles2530/">GITHUB</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" href="https://charles2530.github.io">BLOG</a>
                            </li>
                        
                    
            

        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="post-page-container">
    <div class="article-content-container">

        <div class="article-title">
            
                
                
                <img src="https://charles2530.github.io/image/background/p3.jpg" alt="P8 Design documents" />
                
                <h1 class="article-title-cover">P8 Design documents</h1>
            
            </div>
            
                    
        
        
            <div class="article-header">
                <div class="avatar">
                    <img src="https://charles2530.github.io/image/background/logo.jpg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Charles</span>
                        
                            <span class="author-label">Lv6</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2022-12-26 21:12:55</span>
        <span class="mobile">2022-12-26 21:12:55</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2023-06-17 14:13:59</span>
            <span class="mobile">2023-06-17 14:13:59</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/Lesson/">Lesson</a>&nbsp;
                        </li>
                    
                    
                
                    
                        
                            <li>></li>
                        
                        <li>
                            <a href="/categories/Lesson/CO/">CO</a>&nbsp;
                        </li>
                    
                    
                
                    
                        
                            <li>></li>
                        
                        <li>
                            <a href="/categories/Lesson/CO/CO-files/">CO-files</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/CO/">CO</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fa-regular fa-typewriter"></i>&nbsp;<span>11.8k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fa-regular fa-clock"></i>&nbsp;<span>53 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h1 id="verilog流水线cpu设计文档"><a class="markdownIt-Anchor" href="#verilog流水线cpu设计文档"></a> Verilog流水线CPU设计文档</h1>
<h3 id="一-cpu设计方案综述"><a class="markdownIt-Anchor" href="#一-cpu设计方案综述"></a> 一、 CPU设计方案综述</h3>
<h4 id="一-总体设计概述"><a class="markdownIt-Anchor" href="#一-总体设计概述"></a> （一） 总体设计概述</h4>
<p>使用Verilog开发一个简单的流水线CPU，总体概述如下：</p>
<ol>
<li>
<p>此CPU为32位CPU</p>
</li>
<li>
<p>此CPU为流水线设计</p>
</li>
<li>
<p>此CPU支持的指令集为：</p>
<p>mips-c指令集所有指令</p>
</li>
</ol>
<h4 id="二-关键模块定义"><a class="markdownIt-Anchor" href="#二-关键模块定义"></a> （二） 关键模块定义</h4>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://charles2530.github.io/image/simple_cpu.png"
                      alt="img" 
                ></p>
<h4 id="宏的定义"><a class="markdownIt-Anchor" href="#宏的定义"></a> 宏的定义</h4>
<details class="blue" data-header-exclude><summary><i class="fa-solid fa-chevron-right"></i>Folding coding </summary>
              <div class='content'>
              <div class="highlight-container" data-rel="Verilog"><figure class="iseeu highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">timescale</span> 1ns / 1ps</span></span><br><span class="line"><span class="comment">//alu</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> _ADD    12&#x27;b000000000001</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> _SUB    12&#x27;b000000000010</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> _AND    12&#x27;b000000000100</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> _OR     12&#x27;b000000001000</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> _XOR    12&#x27;b000000010000</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> _NOR    12&#x27;b000000100000</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> _SLL    12&#x27;b000001000000</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> _SRA    12&#x27;b000010000000</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> _SRL    12&#x27;b000100000000</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> _SLT    12&#x27;b001000000000</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> _SLTU   12&#x27;b010000000000</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> _ALUNew 12&#x27;b100000000000</span></span><br><span class="line"><span class="comment">//ifu</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> PC_Initial 32&#x27;h0000_3000</span></span><br><span class="line"><span class="comment">//ext</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Zero_Ext 3&#x27;b001</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Sign_Ext 3&#x27;b010</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Lui_Ext  3&#x27;b100</span></span><br><span class="line"><span class="comment">//NPC</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> PC4_NPC         5&#x27;b00001</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> B_transfer_NPC  5&#x27;b00010</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> J_transfer_NPC  5&#x27;b00100</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Jr_NPC          5&#x27;b01000</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> NEW_NPC         5&#x27;b10000</span></span><br><span class="line"><span class="comment">//Controller_for_Reg</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> ALUop_Initial       7&#x27;b0000001</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> AluSrc1_Initial     4&#x27;b0001</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> AluSrc2_Initial     4&#x27;b0001</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> WhichtoReg_Initial  8&#x27;b00000001</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> RegDst_Initial      4&#x27;b0001</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> DM_type_Initial     6&#x27;b000001</span></span><br><span class="line"><span class="comment">//DM</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Word_DM           6&#x27;b000001</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Half_DM           6&#x27;b000010</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Byte_DM           6&#x27;b000100</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Unsigned_Half_DM  6&#x27;b001000</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Unsigned_Byte_DM  6&#x27;b010000</span></span><br><span class="line"><span class="comment">//B_transfer</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> nop_B_trans   4&#x27;b0000</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> beq_B_trans   4&#x27;b0001</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> bgez_B_trans  4&#x27;b0010</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> bgtz_B_trans  4&#x27;b0011</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> blez_B_trans  4&#x27;b0100</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> bltz_B_trans  4&#x27;b0101</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> bne_B_trans   4&#x27;b0110</span></span><br><span class="line"><span class="comment">//MD_Unit</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> nop_MDU   4&#x27;b0000</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> mult_MDU  4&#x27;b0001</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> multu_MDU 4&#x27;b0010</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> div_MDU   4&#x27;b0011</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> divu_MDU  4&#x27;b0100</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> mfhi_MDU  4&#x27;b0101</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> mflo_MDU  4&#x27;b0110</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> mthi_MDU  4&#x27;b0111</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> mtlo_MDU  4&#x27;b1000</span></span><br><span class="line"><span class="comment">//MulDivUnit</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span>  IDLE 2&#x27;b00</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span>  MUL  2&#x27;b01</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span>  DIV  2&#x27;b10</span></span><br><span class="line"><span class="comment">//TC</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> IDLE 2&#x27;b00</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> LOAD 2&#x27;b01</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> CNT  2&#x27;b10</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INT  2&#x27;b11</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> ctrl   mem[0]</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> preset mem[1]</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> count  mem[2]</span></span><br><span class="line"><span class="comment">//CP0</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> IM      SR[15:10]</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> EXL     SR[1]</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> IE      SR[0]</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> BD      Cause[31]</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> IP      Cause[15:10]</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> ExcCode Cause[6:2]</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> SR_Address    5&#x27;d12</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Cause_Address 5&#x27;d13</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> EPC_Address   5&#x27;d14</span></span><br><span class="line"><span class="comment">//Bridge</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Error_Entry   32&#x27;h0000_4180</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Data_Begin    32&#x27;h0000_0000</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Data_End      32&#x27;h0000_2fff</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Text_Begin    32&#x27;h0000_3000</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Text_End      32&#x27;h0000_6fff</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Timer_Begin   32&#x27;h0000_7f00</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Timer_End     32&#x27;h0000_7f0b</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Echo_Begin    32&#x27;h0000_7f20</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Echo_End      32&#x27;h0000_7f23</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> UART_Begin    32&#x27;h0000_7f30</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> UART_End      32&#x27;h0000_7f3f</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Tube_Begin    32&#x27;h0000_7f50</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Tube_End      32&#x27;h0000_7f57</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> SWITCH_Begin  32&#x27;h0000_7f60</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> SWITCH_End    32&#x27;h0000_7f67</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> KEY_Begin     32&#x27;h0000_7f68</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> KEY_End       32&#x27;h0000_7f6b</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> LED_Begin     32&#x27;h0000_7f70</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> LED_End       32&#x27;h0000_7f73</span></span><br><span class="line"><span class="comment">//GPIO</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> SWITCH_1_Begin    32&#x27;h0000_7f60</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> SWITCH_1_End      32&#x27;h0000_7f63</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> SWITCH_2_Begin    32&#x27;h0000_7f64</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> SWITCH_2_End      32&#x27;h0000_7f67</span></span><br><span class="line"><span class="comment">//Tube</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Tube_1_Begin    32&#x27;h0000_7f50</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Tube_1_End      32&#x27;h0000_7f53</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Tube_2_Begin    32&#x27;h0000_7f54</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Tube_2_End      32&#x27;h0000_7f57    </span></span><br><span class="line"><span class="comment">//Error_Stream</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Error_None    5&#x27;d0</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Error_Int     5&#x27;d0</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Error_AdEL    5&#x27;d4</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Error_AdES    5&#x27;d5</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Error_Syscall 5&#x27;d8</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Error_RI      5&#x27;d10</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> Error_Ov      5&#x27;d12</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//UART</span></span><br><span class="line"><span class="comment">//`define LINE_H      1&#x27;b1</span></span><br><span class="line"><span class="comment">//`define LINE_L      1&#x27;b0</span></span><br><span class="line"><span class="comment">//`define LINE_IDLE   1&#x27;b1</span></span><br><span class="line"><span class="comment">//`define LINE_START  1&#x27;b0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> OFF_UART_DATA       3&#x27;h0</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> OFF_UART_LSR        3&#x27;h1</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> OFF_UART_DIVR       3&#x27;h2</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> OFF_UART_DIVT       3&#x27;h3</span></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> PERIOD_BAUD_9600    16&#x27;d2604    </span><span class="comment">// 25M / 9600</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> PERIOD_BAUD_38400   16&#x27;d651</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> PERIOD_BAUD_57600   16&#x27;d434</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> PERIOD_BAUD_115200  16&#x27;d217</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
              </div>
            </details>
<h4 id="cpu模块"><a class="markdownIt-Anchor" href="#cpu模块"></a> CPU模块</h4>
<h2 id="一f级流水线"><a class="markdownIt-Anchor" href="#一f级流水线"></a> &lt;一&gt;.F级流水线</h2>
<h4 id="1-pc"><a class="markdownIt-Anchor" href="#1-pc"></a> 1. PC</h4>
<p>（1） 端口说明</p>
<center>表1-IFU端口说明</center>
<table>
<thead>
<tr>
<th>序号</th>
<th>信号名</th>
<th>方向</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>clk</td>
<td>I</td>
<td>时钟信号</td>
</tr>
<tr>
<td>2</td>
<td>reset</td>
<td>I</td>
<td>同步复位信号，将PC值置为0x0000_3000：<br>0：无效<br>1：复位</td>
</tr>
<tr>
<td>3</td>
<td>en</td>
<td>I</td>
<td>使能信号，决定是否阻塞</td>
</tr>
<tr>
<td>4</td>
<td>NPC[31:0]</td>
<td>I</td>
<td>下一周期PC的地址</td>
</tr>
<tr>
<td>6</td>
<td>PC[31:0]</td>
<td>O</td>
<td>当前执行的PC</td>
</tr>
</tbody>
</table>
<p>（2） 功能定义</p>
<center>表2-IFU功能定义</center>
<table>
<thead>
<tr>
<th>序号</th>
<th>功能</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>复位</td>
<td>reset有效时，PC置为0x00003000</td>
</tr>
<tr>
<td>2</td>
<td>更新PC的值</td>
<td>将PC赋值为NPC</td>
</tr>
</tbody>
</table>
<h2 id="二d级流水线"><a class="markdownIt-Anchor" href="#二d级流水线"></a> &lt;二&gt;.D级流水线</h2>
<h4 id="1-grf"><a class="markdownIt-Anchor" href="#1-grf"></a> 1. GRF</h4>
<p>（1） 端口说明</p>
<center>表3-GRF端口说明</center>
<table>
<thead>
<tr>
<th>序号</th>
<th>信号名</th>
<th>方向</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>clk</td>
<td>I</td>
<td>时钟信号</td>
</tr>
<tr>
<td>2</td>
<td>reset</td>
<td>I</td>
<td>同步复位信号，将32个寄存器中全部清零<br>1：清零<br>0：无效</td>
</tr>
<tr>
<td>3</td>
<td>WE</td>
<td>I</td>
<td>写使能信号<br>1：可向GRF中写入数据<br>0：不能向GRF中写入数据</td>
</tr>
<tr>
<td>4</td>
<td>A1[4:0]</td>
<td>I</td>
<td>5位地址输入信号，指定32个寄存器中的一个，将其中存储的数据读出到RD1</td>
</tr>
<tr>
<td>5</td>
<td>A2[4:0]</td>
<td>I</td>
<td>5位地址输入信号，指定32个寄存器中的一个，将其中存储的数据读出到RD2</td>
</tr>
<tr>
<td>6</td>
<td>A3[4:0]</td>
<td>I</td>
<td>5位地址输入信号，指定32个寄存器中的一个，作为RD的写入地址</td>
</tr>
<tr>
<td>7</td>
<td>WD[31:0]</td>
<td>I</td>
<td>32位写入数据</td>
</tr>
<tr>
<td>8</td>
<td>WPC[31:0]</td>
<td>I</td>
<td>当前写入GRF的PC</td>
</tr>
<tr>
<td>9</td>
<td>RD1[31:0]</td>
<td>O</td>
<td>输出A1指定的寄存器的32位数据</td>
</tr>
<tr>
<td>10</td>
<td>RD2[31:0]</td>
<td>O</td>
<td>输出A2指定的寄存器的32位数据</td>
</tr>
</tbody>
</table>
<p>（2） 功能定义</p>
<center>表4-GRF功能定义</center>
<table>
<thead>
<tr>
<th>序号</th>
<th>功能</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>同步复位</td>
<td>reset为1时，将所有寄存器清零</td>
</tr>
<tr>
<td>2</td>
<td>读数据</td>
<td>将A1和A2地址对应的寄存器的值分别通过RD1和RD2读出</td>
</tr>
<tr>
<td>3</td>
<td>写数据</td>
<td>当WE为1且时钟上升沿来临时，将WD写入到A3对应的寄存器内部</td>
</tr>
<tr>
<td>4</td>
<td>内部转发</td>
<td>当A1和A2之一与A3相等且写入信号为1时，用WD代替RD1或RD2的输出</td>
</tr>
</tbody>
</table>
<h4 id="2-ext"><a class="markdownIt-Anchor" href="#2-ext"></a> 2. EXT</h4>
<p>(1) 端口说明</p>
<center>表9-EXT端口说明</center>
<table>
<thead>
<tr>
<th>序号</th>
<th>信号名</th>
<th>方向</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>imm16[15:0]</td>
<td>I</td>
<td>代扩展的16位信号</td>
</tr>
<tr>
<td>2</td>
<td>sign[2:0]</td>
<td>I</td>
<td>无符号或符号扩展选择信号<br/>3’b001：无符号扩展<br/>3’b010：符号扩展<br>3’b100:   寄存到高位</td>
</tr>
<tr>
<td>3</td>
<td>imm32[31:0]</td>
<td>O</td>
<td>扩展后的32位的信号</td>
</tr>
</tbody>
</table>
<p>(2) 功能定义</p>
<center>表10-EXT功能定义</center>
<table>
<thead>
<tr>
<th>序号</th>
<th>功能</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>无符号扩展</td>
<td>当sign为3’b001时，将imm16无符号扩展输出</td>
</tr>
<tr>
<td>2</td>
<td>符号扩展</td>
<td>当sign为3‘b010时，将imm16符号扩展输出</td>
</tr>
<tr>
<td>3</td>
<td>存储到高位</td>
<td>当sign为3’100时，将imm16存在高16位</td>
</tr>
</tbody>
</table>
<h4 id="3-controller"><a class="markdownIt-Anchor" href="#3-controller"></a> 3. Controller</h4>
<p>(1) 端口说明</p>
<center>表11-Controller端口说明</center>
<table>
<thead>
<tr>
<th>序号</th>
<th>信号名</th>
<th>方向</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>op[5:0]</td>
<td>I</td>
<td>instr[31:26]6位控制信号</td>
</tr>
<tr>
<td>2</td>
<td>func[5:0]</td>
<td>I</td>
<td>instr[5:0]6位控制信号</td>
</tr>
<tr>
<td>3</td>
<td>rt[4:0]</td>
<td>I</td>
<td>instr[20:16]5位控制信号</td>
</tr>
<tr>
<td>4</td>
<td>AluOp[11:0]</td>
<td>O</td>
<td>ALU的控制信号</td>
</tr>
<tr>
<td>5</td>
<td>WeGrf</td>
<td>O</td>
<td>GRF写使能信号<br/>0：禁止写入<br/>1：允许写入</td>
</tr>
<tr>
<td>6</td>
<td>WeDm</td>
<td>O</td>
<td>DM的写入信号<br/>0：禁止写入<br/>1：允许写入</td>
</tr>
<tr>
<td>7</td>
<td>branch[3:0]</td>
<td>O</td>
<td>PC转移位置选择信号<br>4’b0001:其他情况<br>4’b0010:beq<br>4’b0100:j||jal<br>4’b1000:jr;</td>
</tr>
<tr>
<td>8</td>
<td>AluSrc1[3:0]</td>
<td>O</td>
<td>参与ALU运算的第一个数<br/>4’b0001：RD1<br/>4’b0010：RD2</td>
</tr>
<tr>
<td>9</td>
<td>AluSrc2[3:0]</td>
<td>O</td>
<td>参与ALU运算的第二个数，来自GRF还是imm<br/>4’b0001：RD2<br/>4’b0010：imm32<br/>4’b0100: offset</td>
</tr>
<tr>
<td>10</td>
<td>WhichtoReg[7:0]</td>
<td>O</td>
<td>将何种数据写入GRF？<br/>8’b0000_0001：ALU计算结果<br/>8’b0000_0010：DM读出信号<br/>8’b0000_0100：upperImm<br/>8’b0000_1000: PC+4</td>
</tr>
<tr>
<td>11</td>
<td>RegDst[3:0]</td>
<td>O</td>
<td>写入GRF的哪个寄存器？<br>4’b0001:rd<br>4’b0010:rt<br>4’b0100:31号寄存器</td>
</tr>
<tr>
<td>12</td>
<td>SignExt[2:0]</td>
<td>O</td>
<td>拓展方式：<br>3’b001:0拓展<br>3’b010:符号拓展<br>3’b100:存储到高位</td>
</tr>
<tr>
<td>13</td>
<td>B_change[3:0]</td>
<td>O</td>
<td>B转移的类型<br>4’b0001:beq<br>4’b0010:slt<br>4’b0100:blez</td>
</tr>
<tr>
<td>14</td>
<td>DM_type[5:0]</td>
<td>O</td>
<td>存取指令类型：<br>6’b000001:lw/sw<br>6’b000010:lh/sh<br>6’b000100:lb/sb<br />6’b001000:lhu<br />6’b010000:lbu</td>
</tr>
<tr>
<td>15</td>
<td>MDop[3:0]</td>
<td>O</td>
<td>乘除指令选择信号：<br />4‘b0000:无操作<br />4’b0001:mult<br />4’b0010:multu<br />4’b0011:div<br />4’b0100:divu<br />4’b0101:mfhi<br />4’b0110:mflo<br />4’b0111:mthi<br />4’b1000:mtlo</td>
</tr>
<tr>
<td>16</td>
<td>D_Tuse_rs[1:0]</td>
<td>O</td>
<td>指令的rs寄存器的值从第一次进入D级到被使用的周期数</td>
</tr>
<tr>
<td>17</td>
<td>D_Tuse_rt[1:0]</td>
<td>O</td>
<td>指令的rt寄存器的值从第一次进入D级到被使用的周期数</td>
</tr>
<tr>
<td>18</td>
<td>D_Tnew[1:0]</td>
<td>O</td>
<td>指令从进入D开始到产生运算结果需要的周期数</td>
</tr>
</tbody>
</table>
<h4 id="4npc"><a class="markdownIt-Anchor" href="#4npc"></a> 4.NPC</h4>
<p>NPC（下一指令计算单元）</p>
<p>该模块根据当前pc（包括D级和F级）和其他控制信号（NPCOp，CMP输出信息），计算出下一指令所在的地址npc，传入IFU模块。</p>
<ul>
<li><strong>端口定义</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">信号名</th>
<th style="text-align:left">方向</th>
<th style="text-align:left">位宽</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">F_pc</td>
<td style="text-align:left">I</td>
<td style="text-align:left">32</td>
<td style="text-align:left">F级指令地址</td>
</tr>
<tr>
<td style="text-align:left">D_pc</td>
<td style="text-align:left">I</td>
<td style="text-align:left">32</td>
<td style="text-align:left">D级指令地址</td>
</tr>
<tr>
<td style="text-align:left">offset</td>
<td style="text-align:left">I</td>
<td style="text-align:left">32</td>
<td style="text-align:left">地址偏移量，用于计算B类指令所要跳转的地址</td>
</tr>
<tr>
<td style="text-align:left">imm26</td>
<td style="text-align:left">I</td>
<td style="text-align:left">26</td>
<td style="text-align:left">当前指令数据的前26位（0~25），用于计算jal和j指令所要跳转的地址</td>
</tr>
<tr>
<td style="text-align:left">ra</td>
<td style="text-align:left">I</td>
<td style="text-align:left">32</td>
<td style="text-align:left">储存在寄存器（$ra或是jalr指令中存储“PC+4”的寄存器）中的地址数据，用于实现jr和jalr指令</td>
</tr>
<tr>
<td style="text-align:left">ALU_change</td>
<td style="text-align:left">I</td>
<td style="text-align:left">1</td>
<td style="text-align:left">B类指令判断结果 1：说明当前B类指令的判断结果为真 0：说明判断结果为假</td>
</tr>
<tr>
<td style="text-align:left">branch</td>
<td style="text-align:left">I</td>
<td style="text-align:left">4</td>
<td style="text-align:left">NPC功能选择 0x000：顺序执行 0x001：B类指令跳转 0x010: jal/j跳转 0x011: jr/jalr跳转</td>
</tr>
<tr>
<td style="text-align:left">npc</td>
<td style="text-align:left">O</td>
<td style="text-align:left">32</td>
<td style="text-align:left">输出下一指令地址</td>
</tr>
<tr>
<td style="text-align:left">PC8</td>
<td style="text-align:left">O</td>
<td style="text-align:left">32</td>
<td style="text-align:left">jr指令时存储PC+8的值</td>
</tr>
</tbody>
</table>
<h4 id="5b_transferb类指令比较单元"><a class="markdownIt-Anchor" href="#5b_transferb类指令比较单元"></a> 5.B_transfer(B类指令比较单元)</h4>
<p>该单元根据输入的CMPOp信号对当前B指令的类型进行判断，进而对当前输入的数值进行相应比较，最后输出结果。</p>
<ul>
<li><strong>端口定义</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">信号名</th>
<th style="text-align:left">方向</th>
<th style="text-align:left">位宽</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">A</td>
<td style="text-align:left">I</td>
<td style="text-align:left">32</td>
<td style="text-align:left">输入B_transfer单元的第一个数据</td>
</tr>
<tr>
<td style="text-align:left">B</td>
<td style="text-align:left">I</td>
<td style="text-align:left">32</td>
<td style="text-align:left">输入B_transfer单元的第二个数据</td>
</tr>
<tr>
<td style="text-align:left">Type</td>
<td style="text-align:left">I</td>
<td style="text-align:left">4</td>
<td style="text-align:left">Type功能选择信号<br> 0x0001：beq判断<br> 0x0010：slt判断 <br>0x0100：blez判断</td>
</tr>
<tr>
<td style="text-align:left">ALU_change</td>
<td style="text-align:left">O</td>
<td style="text-align:left">1</td>
<td style="text-align:left">判断结果输出 <br>1: 判断结果为真<br> 0：判断结果为假</td>
</tr>
</tbody>
</table>
<h2 id="三e级流水线"><a class="markdownIt-Anchor" href="#三e级流水线"></a> &lt;三&gt;.E级流水线</h2>
<h4 id="1-alu"><a class="markdownIt-Anchor" href="#1-alu"></a> 1. ALU</h4>
<p>(1) 端口说明</p>
<center>表5-ALU端口说明</center>
<table>
<thead>
<tr>
<th>序号</th>
<th>信号名</th>
<th>方向</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>A[31:0]</td>
<td>I</td>
<td>参与运算的第一个数</td>
</tr>
<tr>
<td>2</td>
<td>B[31:0]</td>
<td>I</td>
<td>参与运算的第二个数</td>
</tr>
<tr>
<td>3</td>
<td>ALUop[11:0]</td>
<td>I</td>
<td>决定ALU做何种操作<br>12’b0000_0000_0001：无符号加<br/>12’b0000_0000_0010：无符号减<br/>12’b0000_0000_0100：与<br/>12’b0000_0000_1000：或<br/>12‘b0000_0001_0000:异或<br />12‘b0000_0010_0000:或非<br />12‘b0000_0100_0000:sll<br />12‘b0000_1000_0000:sra<br />12‘b0001_0000_0000:srl<br />12‘b0010_0000_0000:slt<br />12‘b0100_0000_0000:sltu</td>
</tr>
<tr>
<td>4</td>
<td>res</td>
<td>O</td>
<td>A与B做运算后的结果</td>
</tr>
</tbody>
</table>
<p>(2) 功能定义</p>
<center>表6-ALU功能定义</center>
<table>
<thead>
<tr>
<th>序号</th>
<th>功能</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>加运算</td>
<td>res = A + B</td>
</tr>
<tr>
<td>2</td>
<td>减运算</td>
<td>res = A - B</td>
</tr>
<tr>
<td>3</td>
<td>与运算</td>
<td>res = A &amp; B</td>
</tr>
<tr>
<td>4</td>
<td>或运算</td>
<td>res = A | B</td>
</tr>
<tr>
<td>5</td>
<td>左移位运算</td>
<td>Res=A&lt;&lt;B</td>
</tr>
</tbody>
</table>
<h4 id="2md_unit"><a class="markdownIt-Anchor" href="#2md_unit"></a> 2.MD_Unit</h4>
<ul>
<li><strong>端口定义</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">方向</th>
<th style="text-align:left">信号名</th>
<th style="text-align:left">位宽</th>
<th style="text-align:left">描述</th>
<th style="text-align:left">输入来源</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">clk</td>
<td style="text-align:left">1</td>
<td style="text-align:left">时钟信号</td>
<td style="text-align:left">mips.v中的clk</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">reset</td>
<td style="text-align:left">1</td>
<td style="text-align:left">同步复位信号</td>
<td style="text-align:left">mips.v中的reset</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">en</td>
<td style="text-align:left">1</td>
<td style="text-align:left">MD_Unit使能信号</td>
<td style="text-align:left">判断是否为乘除计算</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">MDop</td>
<td style="text-align:left">4</td>
<td style="text-align:left">指令选择信号</td>
<td style="text-align:left">Controller</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">A</td>
<td style="text-align:left">32</td>
<td style="text-align:left">第一个计算数</td>
<td style="text-align:left">e_A</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">B</td>
<td style="text-align:left">32</td>
<td style="text-align:left">第二个计算数</td>
<td style="text-align:left">e_B</td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">HI</td>
<td style="text-align:left">32</td>
<td style="text-align:left">HI寄存器输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">LO</td>
<td style="text-align:left">32</td>
<td style="text-align:left">LO寄存器输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">out</td>
<td style="text-align:left">32</td>
<td style="text-align:left">取出HI或LO的值</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">busy</td>
<td style="text-align:left">1</td>
<td style="text-align:left">是否在进行乘除计算</td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<h2 id="四m级流水线"><a class="markdownIt-Anchor" href="#四m级流水线"></a> &lt;四&gt;.M级流水线</h2>
<h4 id="1-dm_in"><a class="markdownIt-Anchor" href="#1-dm_in"></a> 1. DM_In</h4>
<ul>
<li><strong>端口定义</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">方向</th>
<th style="text-align:left">信号名</th>
<th style="text-align:left">位宽</th>
<th style="text-align:left">描述</th>
<th style="text-align:left">输入来源</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">low2</td>
<td style="text-align:left">2</td>
<td style="text-align:left">时钟信号</td>
<td style="text-align:left">Address低两位</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">WD</td>
<td style="text-align:left">31</td>
<td style="text-align:left">处理前写入结果</td>
<td style="text-align:left">32位写入数据</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">DM_type</td>
<td style="text-align:left">6</td>
<td style="text-align:left">决定存取指令类型</td>
<td style="text-align:left">存取指令类型：<br/>6’b000001:lw/sw<br/>6’b000010:lh/sh<br/>6’b000100:lb/sb<br />6’b001000:lhu<br />6’b010000:lbu</td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">data_byteen</td>
<td style="text-align:left">4</td>
<td style="text-align:left">字节使能信号</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">DM_input</td>
<td style="text-align:left">32</td>
<td style="text-align:left">处理后的写入结果</td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<h4 id="2dm_out"><a class="markdownIt-Anchor" href="#2dm_out"></a> 2.DM_Out</h4>
<ul>
<li><strong>端口定义</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">方向</th>
<th style="text-align:left">信号名</th>
<th style="text-align:left">位宽</th>
<th style="text-align:left">描述</th>
<th style="text-align:left">输入来源</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">low2</td>
<td style="text-align:left">2</td>
<td style="text-align:left">时钟信号</td>
<td style="text-align:left">Address低两位</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">DM_output</td>
<td style="text-align:left">32</td>
<td style="text-align:left">处理前读入信号</td>
<td style="text-align:left">32位读入数据</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">DM_type</td>
<td style="text-align:left">6</td>
<td style="text-align:left">决定存取指令类型</td>
<td style="text-align:left">存取指令类型：<br/>6’b000001:lw/sw<br/>6’b000010:lh/sh<br/>6’b000100:lb/sb<br />6’b001000:lhu<br />6’b010000:lbu</td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">RD</td>
<td style="text-align:left">32</td>
<td style="text-align:left">处理后的读入结果</td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<h4 id="3cp0"><a class="markdownIt-Anchor" href="#3cp0"></a> 3.CP0</h4>
<ul>
<li><strong>端口定义</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">方向</th>
<th style="text-align:left">信号名</th>
<th style="text-align:left">位宽</th>
<th style="text-align:left">描述</th>
<th style="text-align:left">输入来源</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">clk</td>
<td style="text-align:left">1</td>
<td style="text-align:left">时钟信号</td>
<td style="text-align:left">cpu主时钟</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">reset</td>
<td style="text-align:left">1</td>
<td style="text-align:left">复位信号</td>
<td style="text-align:left">cpu同步复位信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">WE</td>
<td style="text-align:left">1</td>
<td style="text-align:left">写入使能</td>
<td style="text-align:left">前一级相同信号输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">Address</td>
<td style="text-align:left">5</td>
<td style="text-align:left">CP0 寄存器编号</td>
<td style="text-align:left">前一级相同信号输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">WD</td>
<td style="text-align:left">32</td>
<td style="text-align:left">CP0 寄存器的写入数据</td>
<td style="text-align:left">前一级相同信号输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">BD_in</td>
<td style="text-align:left">1</td>
<td style="text-align:left">分支延迟槽指令标志</td>
<td style="text-align:left">前一级相同信号输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">VPC</td>
<td style="text-align:left">32</td>
<td style="text-align:left">中断/异常时的 PC</td>
<td style="text-align:left">前一级相同信号输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">ExcCode_in</td>
<td style="text-align:left">5</td>
<td style="text-align:left">中断/异常的类型</td>
<td style="text-align:left">前一级相同信号输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">HWInt</td>
<td style="text-align:left">6</td>
<td style="text-align:left">6 个设备中断</td>
<td style="text-align:left">前一级相同信号输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">EXLClr</td>
<td style="text-align:left">1</td>
<td style="text-align:left">置 0 SR 的EXL 位</td>
<td style="text-align:left">m_eret控制信号输入</td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">req</td>
<td style="text-align:left">1</td>
<td style="text-align:left">异常/中断请求</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">EPC</td>
<td style="text-align:left">32</td>
<td style="text-align:left">处理后的读入结果</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">D_out</td>
<td style="text-align:left">32</td>
<td style="text-align:left">CP0 寄存器的输出数据</td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<h2 id="五各级流水线寄存器"><a class="markdownIt-Anchor" href="#五各级流水线寄存器"></a> &lt;五&gt;.各级流水线寄存器</h2>
<h4 id="1if_id"><a class="markdownIt-Anchor" href="#1if_id"></a> 1.IF_ID</h4>
<h4 id="d_regifid流水寄存器"><a class="markdownIt-Anchor" href="#d_regifid流水寄存器"></a> D_Reg（IF/ID流水寄存器）</h4>
<ul>
<li><strong>端口定义</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">方向</th>
<th style="text-align:left">信号名</th>
<th style="text-align:left">位宽</th>
<th style="text-align:left">描述</th>
<th style="text-align:left">输入来源</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">clk</td>
<td style="text-align:left">1</td>
<td style="text-align:left">时钟信号</td>
<td style="text-align:left">mips.v中的clk</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">reset</td>
<td style="text-align:left">1</td>
<td style="text-align:left">同步复位信号</td>
<td style="text-align:left">mips.v中的reset</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">en</td>
<td style="text-align:left">1</td>
<td style="text-align:left">D级寄存器使能信号</td>
<td style="text-align:left">stall信号取反</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">clr</td>
<td style="text-align:left">1</td>
<td style="text-align:left">D级寄存器清空信号</td>
<td style="text-align:left">是否清空延迟槽决定</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">req</td>
<td style="text-align:left">1</td>
<td style="text-align:left">D级寄存器异常/中断请求信号</td>
<td style="text-align:left">CP0</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">F_instr</td>
<td style="text-align:left">32</td>
<td style="text-align:left">F级instr输入</td>
<td style="text-align:left">IFU_instr</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">F_pc</td>
<td style="text-align:left">32</td>
<td style="text-align:left">F级pc输入</td>
<td style="text-align:left">IFU_pc</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">F_ExcCode</td>
<td style="text-align:left">5</td>
<td style="text-align:left">F级ExcCode输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">F_BD</td>
<td style="text-align:left">1</td>
<td style="text-align:left">F级BD输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">D_instr</td>
<td style="text-align:left">32</td>
<td style="text-align:left">D级instr输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">D_pc</td>
<td style="text-align:left">32</td>
<td style="text-align:left">D级pc输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">D_ExcCode</td>
<td style="text-align:left">5</td>
<td style="text-align:left">D级ExcCode输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">D_BD</td>
<td style="text-align:left">1</td>
<td style="text-align:left">D级BD输出</td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<h2 id="2id_ex"><a class="markdownIt-Anchor" href="#2id_ex"></a> 2.ID_EX</h2>
<h2 id="e_regidex流水寄存器"><a class="markdownIt-Anchor" href="#e_regidex流水寄存器"></a> E_Reg（ID/EX流水寄存器）</h2>
<p><strong>端口定义</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">方向</th>
<th style="text-align:left">信号名</th>
<th style="text-align:left">位宽</th>
<th style="text-align:left">描述</th>
<th style="text-align:left">输入来源</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">clk</td>
<td style="text-align:left">1</td>
<td style="text-align:left">时钟信号</td>
<td style="text-align:left">mips.v中的clk</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">reset</td>
<td style="text-align:left">1</td>
<td style="text-align:left">同步复位信号</td>
<td style="text-align:left">mips.v中的reset</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">clr</td>
<td style="text-align:left">1</td>
<td style="text-align:left">E级寄存器清空信号</td>
<td style="text-align:left">HazardUnit中stall信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">req</td>
<td style="text-align:left">1</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_RD1</td>
<td style="text-align:left">32</td>
<td style="text-align:left">D级GRF输出RD1</td>
<td style="text-align:left">通过B_transfer_D1转发的数据</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_RD2</td>
<td style="text-align:left">32</td>
<td style="text-align:left">D级GRF输出RD2</td>
<td style="text-align:left">通过B_transfer_D2转发的数据</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_instr_s</td>
<td style="text-align:left">5</td>
<td style="text-align:left">D级instr的shamt</td>
<td style="text-align:left">D_instr的s域数据</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_A1</td>
<td style="text-align:left">5</td>
<td style="text-align:left">D级A1输入</td>
<td style="text-align:left">D_instr的rs域数据</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_A2</td>
<td style="text-align:left">5</td>
<td style="text-align:left">D级A2输入</td>
<td style="text-align:left">D_instr的rt域数据</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_A3</td>
<td style="text-align:left">5</td>
<td style="text-align:left">D级A3输入</td>
<td style="text-align:left">通过MUX_A3选择出的数据</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_imm32</td>
<td style="text-align:left">32</td>
<td style="text-align:left">D级imm32输入</td>
<td style="text-align:left">通过EXT模块扩展出的数据</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_PC</td>
<td style="text-align:left">32</td>
<td style="text-align:left">D级PC输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_PC8</td>
<td style="text-align:left">32</td>
<td style="text-align:left">D级PC8输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">Tnew_D</td>
<td style="text-align:left">2</td>
<td style="text-align:left">D级指令的Tnew输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_Wegrf</td>
<td style="text-align:left">1</td>
<td style="text-align:left">D级控制信号输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_WeDm</td>
<td style="text-align:left">1</td>
<td style="text-align:left">D级控制信号输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_ALUop</td>
<td style="text-align:left">7</td>
<td style="text-align:left">D级控制信号输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_AluSrc1</td>
<td style="text-align:left">4</td>
<td style="text-align:left">D级控制信号输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_AluSrc2</td>
<td style="text-align:left">4</td>
<td style="text-align:left">D级控制信号输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_WhichtoReg</td>
<td style="text-align:left">8</td>
<td style="text-align:left">D级控制信号输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_RegDst</td>
<td style="text-align:left">4</td>
<td style="text-align:left">D级控制信号输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_DM_type</td>
<td style="text-align:left">6</td>
<td style="text-align:left">D级控制信号输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_ALU_change</td>
<td style="text-align:left">1</td>
<td style="text-align:left">D级ALU_change输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_MDop</td>
<td style="text-align:left">4</td>
<td style="text-align:left">D级MDop输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_branch</td>
<td style="text-align:left">5</td>
<td style="text-align:left">D级branch输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_ExcCode</td>
<td style="text-align:left">5</td>
<td style="text-align:left">D级ExcCode输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_BD</td>
<td style="text-align:left">1</td>
<td style="text-align:left">D级BD输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_mfc0</td>
<td style="text-align:left">1</td>
<td style="text-align:left">D级mfc0输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_mtc0</td>
<td style="text-align:left">1</td>
<td style="text-align:left">D级mtc0输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_eret</td>
<td style="text-align:left">1</td>
<td style="text-align:left">D级eret输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_syscall</td>
<td style="text-align:left">1</td>
<td style="text-align:left">D级syscall输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_RD1</td>
<td style="text-align:left">32</td>
<td style="text-align:left">E级RD1输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_RD2</td>
<td style="text-align:left">32</td>
<td style="text-align:left">E级RD2输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_instr_s</td>
<td style="text-align:left">5</td>
<td style="text-align:left">移位指令的位移数</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_A1</td>
<td style="text-align:left">5</td>
<td style="text-align:left">E级A1输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_A2</td>
<td style="text-align:left">5</td>
<td style="text-align:left">E级A2输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_A3</td>
<td style="text-align:left">5</td>
<td style="text-align:left">E级A3输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_imm32</td>
<td style="text-align:left">32</td>
<td style="text-align:left">E级imm32输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_PC</td>
<td style="text-align:left">32</td>
<td style="text-align:left">E级PC输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_PC8</td>
<td style="text-align:left">32</td>
<td style="text-align:left">E级PC8输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_Tnew</td>
<td style="text-align:left">2</td>
<td style="text-align:left">E级指令的Tnew输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_Wegrf</td>
<td style="text-align:left">1</td>
<td style="text-align:left">E级控制信号输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_WeDm</td>
<td style="text-align:left">1</td>
<td style="text-align:left">E级控制信号输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_ALUop</td>
<td style="text-align:left">12</td>
<td style="text-align:left">E级控制信号输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_AluSrc1</td>
<td style="text-align:left">4</td>
<td style="text-align:left">E级控制信号输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_AluSrc2</td>
<td style="text-align:left">4</td>
<td style="text-align:left">E级控制信号输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_WhichtoReg</td>
<td style="text-align:left">11</td>
<td style="text-align:left">E级控制信号输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_RegDst</td>
<td style="text-align:left">3</td>
<td style="text-align:left">E级控制信号输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_DM_type</td>
<td style="text-align:left">6</td>
<td style="text-align:left">E级控制信号输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_ALU_change</td>
<td style="text-align:left">1</td>
<td style="text-align:left">E级ALU_change输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_MDop</td>
<td style="text-align:left">4</td>
<td style="text-align:left">E级MDop输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_branch</td>
<td style="text-align:left">5</td>
<td style="text-align:left">E级branch输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_ExcCode</td>
<td style="text-align:left">5</td>
<td style="text-align:left">E级ExcCode输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_BD</td>
<td style="text-align:left">1</td>
<td style="text-align:left">E级BD输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_mfc0</td>
<td style="text-align:left">1</td>
<td style="text-align:left">E级mfc0输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_mtc0</td>
<td style="text-align:left">1</td>
<td style="text-align:left">E级mtc0输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_eret</td>
<td style="text-align:left">1</td>
<td style="text-align:left">E级eret输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">E_syscall</td>
<td style="text-align:left">1</td>
<td style="text-align:left">E级syscall输出</td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<ul>
<li>
<p><strong>运算功能</strong></p>
<p>Tnew_E = (Tnew_D &gt; 0) ? Tnew_D - 1: 0Tnew_E=(Tnew_D&gt;0)?Tnew_D−1:0</p>
</li>
</ul>
<h4 id="3ex_mem"><a class="markdownIt-Anchor" href="#3ex_mem"></a> 3.EX_MEM</h4>
<h4 id="m_regexmem流水寄存器"><a class="markdownIt-Anchor" href="#m_regexmem流水寄存器"></a> M_Reg（EX/MEM流水寄存器）</h4>
<ul>
<li>端口定义</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">方向</th>
<th style="text-align:left">信号名</th>
<th style="text-align:left">位宽</th>
<th style="text-align:left">描述</th>
<th style="text-align:left">输入来源</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">clk</td>
<td style="text-align:left">1</td>
<td style="text-align:left">时钟信号</td>
<td style="text-align:left">mips.v中的clk</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">reset</td>
<td style="text-align:left">1</td>
<td style="text-align:left">同步复位信号</td>
<td style="text-align:left">mips.v中的reset</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_A2</td>
<td style="text-align:left">5</td>
<td style="text-align:left">E级A2输入</td>
<td style="text-align:left">ALU_out数据</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_A3</td>
<td style="text-align:left">5</td>
<td style="text-align:left">E级A3输入（转发值）</td>
<td style="text-align:left">MUX_ALU选择出来的数据</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_RD2</td>
<td style="text-align:left">32</td>
<td style="text-align:left">E级RD2输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_ALUout</td>
<td style="text-align:left">32</td>
<td style="text-align:left">E级res输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_PC</td>
<td style="text-align:left">32</td>
<td style="text-align:left">E级PC输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_PC8</td>
<td style="text-align:left">32</td>
<td style="text-align:left">E级PC8输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_Tnew</td>
<td style="text-align:left">2</td>
<td style="text-align:left">E级Tnew输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_Wegrf</td>
<td style="text-align:left">1</td>
<td style="text-align:left">E级控制信号输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_WeDm</td>
<td style="text-align:left">1</td>
<td style="text-align:left">E级控制信号输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_WhichtoReg</td>
<td style="text-align:left">8</td>
<td style="text-align:left">E级控制信号输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_RegDst</td>
<td style="text-align:left">4</td>
<td style="text-align:left">E级控制信号输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_DM_type</td>
<td style="text-align:left">6</td>
<td style="text-align:left">E级控制信号输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_ALU_change</td>
<td style="text-align:left">1</td>
<td style="text-align:left">E级ALU_change输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_imm32</td>
<td style="text-align:left">32</td>
<td style="text-align:left">E级imm32输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_branch</td>
<td style="text-align:left">5</td>
<td style="text-align:left">E级branch输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_ExcCode</td>
<td style="text-align:left">5</td>
<td style="text-align:left">E级ExcCode输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_BD</td>
<td style="text-align:left">1</td>
<td style="text-align:left">E级BD输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_mfc0</td>
<td style="text-align:left">1</td>
<td style="text-align:left">E级mfc0输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_mtc0</td>
<td style="text-align:left">1</td>
<td style="text-align:left">E级mtc0输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_eret</td>
<td style="text-align:left">1</td>
<td style="text-align:left">E级eret输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_syscall</td>
<td style="text-align:left">1</td>
<td style="text-align:left">E级syscall输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">M_A2</td>
<td style="text-align:left">5</td>
<td style="text-align:left">M级A2输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">M_A3</td>
<td style="text-align:left">5</td>
<td style="text-align:left">M级A3输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">M_RD2</td>
<td style="text-align:left">32</td>
<td style="text-align:left">M级RD2输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">M_ALUout</td>
<td style="text-align:left">32</td>
<td style="text-align:left">M级res输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">M_PC</td>
<td style="text-align:left">32</td>
<td style="text-align:left">M级PC输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">M_PC8</td>
<td style="text-align:left">32</td>
<td style="text-align:left">M级PC8输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">M_Tnew</td>
<td style="text-align:left">2</td>
<td style="text-align:left">M级Tnew输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">M_Wegrf</td>
<td style="text-align:left">1</td>
<td style="text-align:left">M级Tnew输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">M_WeDm</td>
<td style="text-align:left">1</td>
<td style="text-align:left">M级控制信号输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">M_WhichtoReg</td>
<td style="text-align:left">8</td>
<td style="text-align:left">M级控制信号输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">M_RegDst</td>
<td style="text-align:left">4</td>
<td style="text-align:left">M级控制信号输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">M_DM_type</td>
<td style="text-align:left">6</td>
<td style="text-align:left">M级控制信号输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">M_ALU_change</td>
<td style="text-align:left">1</td>
<td style="text-align:left">M级ALU_change输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">M_imm32</td>
<td style="text-align:left">32</td>
<td style="text-align:left">M级imm32输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">M_branch</td>
<td style="text-align:left">5</td>
<td style="text-align:left">M级branch输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">M_ExcCode</td>
<td style="text-align:left">5</td>
<td style="text-align:left">M级ExcCode输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">M_BD</td>
<td style="text-align:left">1</td>
<td style="text-align:left">M级BD输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">M_mfc0</td>
<td style="text-align:left">1</td>
<td style="text-align:left">M级mfc0输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">M_mtc0</td>
<td style="text-align:left">1</td>
<td style="text-align:left">M级mtc0输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">M_eret</td>
<td style="text-align:left">1</td>
<td style="text-align:left">M级eret输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">M_syscall</td>
<td style="text-align:left">1</td>
<td style="text-align:left">M级syscall输出</td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<ul>
<li>
<p><strong>运算功能</strong></p>
<p>Tnew_M = (Tnew_E &gt; 0) ? Tnew_E - 1: 0Tnew_M=(Tnew_E&gt;0)?Tnew_E−1:0</p>
</li>
</ul>
<h4 id="4mem_wb"><a class="markdownIt-Anchor" href="#4mem_wb"></a> 4.MEM_WB</h4>
<h4 id="w_regmemwb流水寄存器"><a class="markdownIt-Anchor" href="#w_regmemwb流水寄存器"></a> W_Reg（MEM/WB流水寄存器）</h4>
<ul>
<li><strong>接口定义</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">方向</th>
<th style="text-align:left">信号名</th>
<th style="text-align:left">位宽</th>
<th style="text-align:left">描述</th>
<th style="text-align:left">输入来源</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">clk</td>
<td style="text-align:left">1</td>
<td style="text-align:left">时钟信号</td>
<td style="text-align:left">mips.v中的clk</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">reset</td>
<td style="text-align:left">1</td>
<td style="text-align:left">同步复位信号</td>
<td style="text-align:left">mips.v中的reset</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">M_A3</td>
<td style="text-align:left">5</td>
<td style="text-align:left">M级A3输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">M_RD</td>
<td style="text-align:left">32</td>
<td style="text-align:left">M级RD输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">M_PC</td>
<td style="text-align:left">32</td>
<td style="text-align:left">M级PC输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">M_PC8</td>
<td style="text-align:left">32</td>
<td style="text-align:left">M级PC8输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">M_Wegrf</td>
<td style="text-align:left">1</td>
<td style="text-align:left">M级控制信号输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">M_WhichtoReg</td>
<td style="text-align:left">1</td>
<td style="text-align:left">M级控制信号输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">M_RegDst</td>
<td style="text-align:left">4</td>
<td style="text-align:left">M级控制信号输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">M_imm32</td>
<td style="text-align:left">32</td>
<td style="text-align:left">M级imm32输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">M_ALU_change</td>
<td style="text-align:left">1</td>
<td style="text-align:left">M级ALU_change输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">M_Tnew</td>
<td style="text-align:left">2</td>
<td style="text-align:left">M级Tnew输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">W_A3</td>
<td style="text-align:left">5</td>
<td style="text-align:left">W级A3输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">W_ALUout</td>
<td style="text-align:left">32</td>
<td style="text-align:left">W级res输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">W_RD</td>
<td style="text-align:left">32</td>
<td style="text-align:left">W级RD输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">W_PC</td>
<td style="text-align:left">32</td>
<td style="text-align:left">W级PC输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">W_PC8</td>
<td style="text-align:left">32</td>
<td style="text-align:left">W级PC8输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">W_Wegrf</td>
<td style="text-align:left">1</td>
<td style="text-align:left">W级控制信号输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">W_WhichtoReg</td>
<td style="text-align:left">8</td>
<td style="text-align:left">W级控制信号输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">W_RegDst</td>
<td style="text-align:left">4</td>
<td style="text-align:left">W级控制信号输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">W_imm32</td>
<td style="text-align:left">32</td>
<td style="text-align:left">W级imm32输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">W_ALU_change</td>
<td style="text-align:left">1</td>
<td style="text-align:left">W级ALU_change输出</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">W_Tnew</td>
<td style="text-align:left">2</td>
<td style="text-align:left">W级Tnew输出</td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<h2 id="六暂停-转发处理及相关多路选择器"><a class="markdownIt-Anchor" href="#六暂停-转发处理及相关多路选择器"></a> &lt;六&gt;.暂停、转发处理及相关多路选择器</h2>
<h3 id="一冲突综合单元hazardunit"><a class="markdownIt-Anchor" href="#一冲突综合单元hazardunit"></a> （一）.冲突综合单元（HazardUnit)</h3>
<table>
<thead>
<tr>
<th style="text-align:left">方向</th>
<th style="text-align:left">信号名</th>
<th style="text-align:left">位宽</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_A1</td>
<td style="text-align:left">5</td>
<td style="text-align:left">D级A1端输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_A2</td>
<td style="text-align:left">5</td>
<td style="text-align:left">D级A2端输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_A1</td>
<td style="text-align:left">5</td>
<td style="text-align:left">E级A1端输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_A2</td>
<td style="text-align:left">5</td>
<td style="text-align:left">E级A2端输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">M_A2</td>
<td style="text-align:left">5</td>
<td style="text-align:left">M级A2端输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_A3</td>
<td style="text-align:left">5</td>
<td style="text-align:left">E级A3端输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">M_A3</td>
<td style="text-align:left">5</td>
<td style="text-align:left">M级A3端输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">W_A3</td>
<td style="text-align:left">5</td>
<td style="text-align:left">W级A3端输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_Tuse_rs</td>
<td style="text-align:left">2</td>
<td style="text-align:left">D_Tuse_rs输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_Tuse_rt</td>
<td style="text-align:left">2</td>
<td style="text-align:left">D_Tuse_rt输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_Tnew</td>
<td style="text-align:left">2</td>
<td style="text-align:left">E级Tnew输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">M_Tnew</td>
<td style="text-align:left">2</td>
<td style="text-align:left">M级Tnew输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">W_Tnew</td>
<td style="text-align:left">2</td>
<td style="text-align:left">W级Tnew输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_Wegrf</td>
<td style="text-align:left">1</td>
<td style="text-align:left">E级Wegrf输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">M_Wegrf</td>
<td style="text-align:left">1</td>
<td style="text-align:left">M级Wegrf输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">W_Wegrf</td>
<td style="text-align:left">1</td>
<td style="text-align:left">W级Wegrf输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_WhichtoReg</td>
<td style="text-align:left">8</td>
<td style="text-align:left">E级WhichtoReg输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">M_WhichtoReg</td>
<td style="text-align:left">8</td>
<td style="text-align:left">M级WhichtoReg输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">start</td>
<td style="text-align:left">1</td>
<td style="text-align:left">乘除开始信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">busy</td>
<td style="text-align:left">1</td>
<td style="text-align:left">乘除忙碌信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">MDU_en</td>
<td style="text-align:left">1</td>
<td style="text-align:left">D级将进行乘除运算信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">D_eret</td>
<td style="text-align:left">1</td>
<td style="text-align:left">D级eret输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">E_mtc0</td>
<td style="text-align:left">1</td>
<td style="text-align:left">E级mtc0输入</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">M_mtc0</td>
<td style="text-align:left">1</td>
<td style="text-align:left">M级mtc0输入</td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">SelB_D1</td>
<td style="text-align:left">2</td>
<td style="text-align:left">B_transfer的D1输入转发信号</td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">SelB_D2</td>
<td style="text-align:left">2</td>
<td style="text-align:left">B_transfer的D2输入转发信号</td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">SelALU_A</td>
<td style="text-align:left">2</td>
<td style="text-align:left">ALU输入A转发信号</td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">SelALU_B</td>
<td style="text-align:left">2</td>
<td style="text-align:left">ALU输入B转发信号</td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">SelDM</td>
<td style="text-align:left">1</td>
<td style="text-align:left">DM写入WD转发信号</td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">stall</td>
<td style="text-align:left">1</td>
<td style="text-align:left">冲突信号</td>
</tr>
</tbody>
</table>
<h3 id="二控制和冒险简述"><a class="markdownIt-Anchor" href="#二控制和冒险简述"></a> （二）.控制和冒险简述</h3>
<ul>
<li>
<p>对于控制冒险，本实验要求大家实现<strong>比较过程前移至 D 级</strong>，并<strong>采用延迟槽</strong>。</p>
</li>
<li>
<p>对于数据冒险，两大策略及其应用：</p>
<div class="highlight-container" data-rel="Markdown"><figure class="iseeu highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">假设当前我需要的数据，其实已经计算出来，只是还没有进入寄存器堆，那么我们可以用<span class="strong">**转发**</span>( Forwarding )来解决，即不引用寄存器堆的值，而是直接从后面的流水级的供给者把计算结果发送到前面流水级的需求者来引用。如果我们需要的数据还没有算出来。则我们就只能<span class="strong">**暂停**</span>( Stall )，让流水线停止工作，等到我们需要的数据计算完毕，再开始下面的工作。</span><br></pre></td></tr></table></figure></div>
</li>
</ul>
<h3 id="三冒险处理"><a class="markdownIt-Anchor" href="#三冒险处理"></a> (三）.冒险处理</h3>
<p>冒险处理我们均通过“A_T”法实现——</p>
<h4 id="转发forward"><a class="markdownIt-Anchor" href="#转发forward"></a> 转发（forward）</h4>
<p>当前面的指令要写寄存器但还未写入，而后面的指令需要用到没有被写入的值时，这时候会产生<strong>数据冒险</strong>，我们首先考虑进行转发。我们<strong>假设所有的数据冒险均可通过转发解决</strong>。也就是说，当某一指令前进到必须使用某一寄存器的值的流水阶段时，这个寄存器的值一定已经产生，并<strong>存储于后续某个流水线寄存器中</strong>。</p>
<p>在这一阶段，我们不管需要的值有没由计算出，都要进行转发，即暴力转发。为实现这一机制，我们要清楚哪些模块需要转发后的数据（<strong>需求者</strong>）和保存着写入值的流水寄存器（<strong>供应者</strong>）</p>
<ul>
<li><strong>供应者及其产生的数据</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">流水级</th>
<th style="text-align:left">产生数据</th>
<th style="text-align:left">MUX名&amp;选择信号名</th>
<th style="text-align:left">MUX输出名</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">E</td>
<td style="text-align:left">E_imm32，<br/>E_PC8</td>
<td style="text-align:left">直接流水线传递</td>
<td style="text-align:left">直接流水线传递</td>
</tr>
<tr>
<td style="text-align:left">M</td>
<td style="text-align:left">M_ALUout，<br/>M_PC8</td>
<td style="text-align:left">直接流水线传递</td>
<td style="text-align:left">直接流水线传递</td>
</tr>
<tr>
<td style="text-align:left">W</td>
<td style="text-align:left">w_res，<br/>w_RD，<br/>w_imm32,<br>W_PC8</td>
<td style="text-align:left">w_WhichtoReg</td>
<td style="text-align:left">WD</td>
</tr>
</tbody>
</table>
<p>注：当M级指令为读hi和lo的指令时， M_AO中的结果是从上一周期在乘除槽中读取的hi或lo的值；如果是其他指令，M_AO是上一周期ALU的计算结果。</p>
<ul>
<li><strong>需求者及其产生的数据</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">接收端口</th>
<th style="text-align:left">选择数据</th>
<th style="text-align:left">HMUX名&amp;选择信号名</th>
<th style="text-align:left">MUX输出名</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">B_transfer_D1</td>
<td style="text-align:left">D_V1,<br/>M_out,<br/>E_out</td>
<td style="text-align:left">SelB_D1</td>
<td style="text-align:left">d_b_transfer1</td>
</tr>
<tr>
<td style="text-align:left">B_transfer_D2</td>
<td style="text-align:left">d_RD2,<br>m_res,<br>e_res</td>
<td style="text-align:left">SelB_D2</td>
<td style="text-align:left">d_b_transfer2</td>
</tr>
<tr>
<td style="text-align:left">ALU_A</td>
<td style="text-align:left">e_RD1，<br/> WD，<br/>m_res</td>
<td style="text-align:left">SelALU_A</td>
<td style="text-align:left">e_A</td>
</tr>
<tr>
<td style="text-align:left">ALU_B</td>
<td style="text-align:left">e_RD2，<br/>WD，<br/>m_res</td>
<td style="text-align:left">SelALU_B</td>
<td style="text-align:left">e_B</td>
</tr>
<tr>
<td style="text-align:left">DM_WD</td>
<td style="text-align:left">m_RD2，<br/> WD</td>
<td style="text-align:left">SelDM</td>
<td style="text-align:left">M_WD_f</td>
</tr>
<tr>
<td style="text-align:left">NPC_ra</td>
<td style="text-align:left">D_V1_f ,<br/> E_PC8 ,<br/> M_PC8</td>
<td style="text-align:left">SelJr</td>
<td style="text-align:left">ra</td>
</tr>
</tbody>
</table>
<p>从上表可以看出，W级中的数据没有转发到D级，原因是我们在GRF内实现了内部转发机制，将GRF输入端的数据（还未写入）及时反映到RD1或这RD2，判断条件为<code>A3 == A2</code>或者<code>A3 == A1</code>。</p>
<p>此时为了生成HMUX的选择信号，我们需要向HCU（冒险控制器）输入”A”数据，然后进行选择信号的计算，执行转发的条件为——</p>
<ul>
<li>
<p><strong>前位点的读取寄存器地址和某转发输入来源的写入寄存器地址相等且不为 0</strong></p>
</li>
<li>
<p><strong>写使能信号有效</strong></p>
<h4 id="转发的构造"><a class="markdownIt-Anchor" href="#转发的构造"></a> 转发的构造</h4>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://charles2530.github.io/image/4.png"
                      alt="" 
                ></p>
</li>
</ul>
<h4 id="暂停stall"><a class="markdownIt-Anchor" href="#暂停stall"></a> 暂停（stall）</h4>
<p>接下来，我们来处理通过转发不能处理的数据冒险。在这种情况下，新的数据还未来得及产生。我们只能暂停流水线，等待新的数据产生。为了方便处理，我们仅仅为D级的指令进行暂停处理。</p>
<p>我们把Tuse和Tnew作为暂停的判断依据——</p>
<ul>
<li>Tuse：指令进入 <strong>D 级</strong>后，其后的某个功能部件<strong>再</strong>经过多少时钟周期就<strong>必须</strong>要使用寄存器值。对于有两个操作数的指令，其<strong>每个操作数的 Tuse 值可能不等</strong>（如 store 型指令 rs、rt 的 Tuse 分别为 1 和 2 ）。</li>
<li>Tnew：位于 <strong>E 级及其后各级</strong>的指令，再经过多少周期就能够产生要写入寄存器的结果。在我们目前的 CPU 中，W 级的指令Tnew 恒为 0；对于同一条指令，Tnew@M = max(Tnew@E - 1, 0)、</li>
</ul>
<p>在这一阶段，我们找到D级生成的Tuse_rs和Tuse_rt和在E,M,W级寄存器中流水的Tnew_D，Tnew_M，Tnew_W，如下表所示</p>
<ul>
<li><strong>Tuse表和计算表达式</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">指令类型</th>
<th style="text-align:left">Tuse_rs</th>
<th style="text-align:left">Tuse_rt</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">calc_R</td>
<td style="text-align:left">1</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left">calc_I</td>
<td style="text-align:left">1</td>
<td style="text-align:left">X</td>
</tr>
<tr>
<td style="text-align:left">shift</td>
<td style="text-align:left">X</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left">shiftv</td>
<td style="text-align:left">1</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left">load</td>
<td style="text-align:left">1</td>
<td style="text-align:left">X</td>
</tr>
<tr>
<td style="text-align:left">store</td>
<td style="text-align:left">1</td>
<td style="text-align:left">2</td>
</tr>
<tr>
<td style="text-align:left">md</td>
<td style="text-align:left">1</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left">mt</td>
<td style="text-align:left">1</td>
<td style="text-align:left">X</td>
</tr>
<tr>
<td style="text-align:left">mf</td>
<td style="text-align:left">X</td>
<td style="text-align:left">X</td>
</tr>
<tr>
<td style="text-align:left">branch</td>
<td style="text-align:left">0</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td style="text-align:left">j / jr</td>
<td style="text-align:left">X</td>
<td style="text-align:left">X</td>
</tr>
<tr>
<td style="text-align:left">jal / jalr</td>
<td style="text-align:left">0</td>
<td style="text-align:left">X</td>
</tr>
<tr>
<td style="text-align:left">lui</td>
<td style="text-align:left">X</td>
<td style="text-align:left">X</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>Tnew表和计算表达式</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">指令类型</th>
<th style="text-align:left">Tnew_D</th>
<th style="text-align:left">Tnew_E</th>
<th style="text-align:left">Tnew_M</th>
<th style="text-align:left">Tnew_W</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">calc_R</td>
<td style="text-align:left">2</td>
<td style="text-align:left">1</td>
<td style="text-align:left">0</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td style="text-align:left">calc_I</td>
<td style="text-align:left">2</td>
<td style="text-align:left">1</td>
<td style="text-align:left">0</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td style="text-align:left">shift</td>
<td style="text-align:left">2</td>
<td style="text-align:left">1</td>
<td style="text-align:left">0</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td style="text-align:left">shiftv</td>
<td style="text-align:left">2</td>
<td style="text-align:left">1</td>
<td style="text-align:left">0</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td style="text-align:left">load</td>
<td style="text-align:left">3</td>
<td style="text-align:left">2</td>
<td style="text-align:left">1</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td style="text-align:left">store</td>
<td style="text-align:left">X</td>
<td style="text-align:left">X</td>
<td style="text-align:left">X</td>
<td style="text-align:left">X</td>
</tr>
<tr>
<td style="text-align:left">md</td>
<td style="text-align:left">X</td>
<td style="text-align:left">X</td>
<td style="text-align:left">X</td>
<td style="text-align:left">X</td>
</tr>
<tr>
<td style="text-align:left">mt</td>
<td style="text-align:left">X</td>
<td style="text-align:left">X</td>
<td style="text-align:left">X</td>
<td style="text-align:left">X</td>
</tr>
<tr>
<td style="text-align:left">mf</td>
<td style="text-align:left">2</td>
<td style="text-align:left">1</td>
<td style="text-align:left">0</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td style="text-align:left">branch</td>
<td style="text-align:left">X</td>
<td style="text-align:left">X</td>
<td style="text-align:left">X</td>
<td style="text-align:left">X</td>
</tr>
<tr>
<td style="text-align:left">jal / jalr</td>
<td style="text-align:left">0</td>
<td style="text-align:left">0</td>
<td style="text-align:left">0</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td style="text-align:left">j / jr</td>
<td style="text-align:left">X</td>
<td style="text-align:left">X</td>
<td style="text-align:left">X</td>
<td style="text-align:left">X</td>
</tr>
<tr>
<td style="text-align:left">lui</td>
<td style="text-align:left">1</td>
<td style="text-align:left">0</td>
<td style="text-align:left">0</td>
<td style="text-align:left">0</td>
</tr>
</tbody>
</table>
<p>然后我们Tnew和Tuse传入HCU（冒险控制器中），然后进行stall信号的计算。如果满足以下条件则stall有效——</p>
<ul>
<li>
<p><strong>Tnew &gt; Tuse</strong></p>
</li>
<li>
<p><strong>前位点的读取寄存器地址和某转发输入来源的写入寄存器地址相等且不为 0</strong></p>
</li>
<li>
<p><strong>写使能信号有效</strong></p>
</li>
<li>
<p><strong>当E级延迟槽在进行运算（<code>start | busy</code>）时，D级为md、mt、mf指令</strong></p>
</li>
<li>
<h4 id="阻塞的构造d级"><a class="markdownIt-Anchor" href="#阻塞的构造d级"></a> <strong>阻塞的构造（D级）</strong></h4>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://charles2530.github.io/image/5.png"
                      alt="" 
                ></p>
<details class="blue" data-header-exclude><summary><i class="fa-solid fa-chevron-right"></i>Folding coding </summary>
              <div class='content'>
              <div class="highlight-container" data-rel="Verilog"><figure class="iseeu highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">assign</span> stall_rs = (D_A1!= <span class="number">0</span>)&amp;&amp;((D_Tuse_rs&lt;E_Tnew)&amp;&amp;(D_A1 == E_A3)&amp;&amp;E_Wegrf||</span><br><span class="line">                  (D_Tuse_rs&lt;M_Tnew)&amp;&amp;(D_A1 == M_A3)&amp;&amp;M_Wegrf||</span><br><span class="line">                  (D_Tuse_rs&lt;W_Tnew)&amp;&amp;(D_A1 == W_A3)&amp;&amp;W_Wegrf);</span><br><span class="line"><span class="comment">//the pre is the condition</span></span><br><span class="line"><span class="keyword">assign</span> stall_rt = (D_A2!= <span class="number">0</span>)&amp;&amp;((D_Tuse_rt&lt;E_Tnew)&amp;&amp;(D_A2 == E_A3)&amp;&amp;E_Wegrf||</span><br><span class="line">                  (D_Tuse_rt&lt;M_Tnew)&amp;&amp;(D_A2 == M_A3)&amp;&amp;M_Wegrf||</span><br><span class="line">                  (D_Tuse_rt&lt;W_Tnew)&amp;&amp;(D_A2 == W_A3)&amp;&amp;W_Wegrf);</span><br><span class="line"></span><br><span class="line"><span class="keyword">assign</span> stall_md=(start||busy)&amp;&amp;(MDU_en);</span><br><span class="line"></span><br><span class="line"><span class="keyword">assign</span> stall_eret=D_eret&amp;((E_mtc0&amp;(E_A3==<span class="number">5&#x27;d14</span>))||(M_mtc0&amp;&amp;(M_A3==<span class="number">5&#x27;d14</span>)));</span><br><span class="line"><span class="keyword">assign</span> stall = (stall_rs||stall_rt||stall_md||stall_eret)&amp;&amp;(~Is_nop);</span><br></pre></td></tr></table></figure></div>
              </div>
            </details>
</li>
</ul>
<h2 id="真值表"><a class="markdownIt-Anchor" href="#真值表"></a> 真值表</h2>
<table>
<thead>
<tr>
<th style="text-align:center">端口</th>
<th>addu</th>
<th>subu</th>
<th>ori</th>
<th>lw</th>
<th>sw</th>
<th>lui</th>
<th>beq</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">op</td>
<td>000000</td>
<td>000000</td>
<td>001101</td>
<td>100011</td>
<td>101011</td>
<td>001111</td>
<td>000100</td>
</tr>
<tr>
<td style="text-align:center">func</td>
<td>100001</td>
<td>100011</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:center">AluOp</td>
<td>0000001</td>
<td>0000010</td>
<td>0001000</td>
<td>0000000</td>
<td>0000000</td>
<td>0000000</td>
<td>0000000</td>
</tr>
<tr>
<td style="text-align:center">WeGrf</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td style="text-align:center">WeDm</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td style="text-align:center">branch</td>
<td>0001</td>
<td>0001</td>
<td>0001</td>
<td>0001</td>
<td>0001</td>
<td>0001</td>
<td>0010</td>
</tr>
<tr>
<td style="text-align:center">AluSrc1</td>
<td>0001</td>
<td>0001</td>
<td>0001</td>
<td>0001</td>
<td>0001</td>
<td>0001</td>
<td>0001</td>
</tr>
<tr>
<td style="text-align:center">AluSrc2</td>
<td>0001</td>
<td>0001</td>
<td>0010</td>
<td>0010</td>
<td>0010</td>
<td>0001</td>
<td>0001</td>
</tr>
<tr>
<td style="text-align:center">WhichtoReg</td>
<td>0001</td>
<td>0001</td>
<td>0001</td>
<td>0010</td>
<td>0001</td>
<td>0100</td>
<td>0001</td>
</tr>
<tr>
<td style="text-align:center">RegDst</td>
<td>0001</td>
<td>0001</td>
<td>0010</td>
<td>0010</td>
<td>0010</td>
<td>0010</td>
<td>1010</td>
</tr>
<tr>
<td style="text-align:center">SignExt</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td style="text-align:center"><strong>端口</strong></td>
<td><strong>andi</strong></td>
<td><strong>jal</strong></td>
<td><strong>j</strong></td>
<td><strong>jr</strong></td>
<td><strong>sll</strong></td>
<td><strong>add</strong></td>
<td><strong>sub</strong></td>
</tr>
<tr>
<td style="text-align:center">op</td>
<td>001100</td>
<td>000011</td>
<td>000010</td>
<td>000000</td>
<td>000000</td>
<td>000000</td>
<td>000000</td>
</tr>
<tr>
<td style="text-align:center">func</td>
<td></td>
<td></td>
<td></td>
<td>001000</td>
<td>000000</td>
<td>100000</td>
<td>100010</td>
</tr>
<tr>
<td style="text-align:center">AluOp</td>
<td>0000100</td>
<td>0000000</td>
<td>0000000</td>
<td>0000000</td>
<td>0010000</td>
<td>0000000</td>
<td>0000001</td>
</tr>
<tr>
<td style="text-align:center">WeGrf</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td style="text-align:center">WeDm</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td style="text-align:center">branch</td>
<td>0001</td>
<td>0100</td>
<td>0100</td>
<td>1000</td>
<td>0001</td>
<td>0001</td>
<td>0001</td>
</tr>
<tr>
<td style="text-align:center">AluSrc1</td>
<td>0001</td>
<td>0001</td>
<td>0001</td>
<td>0001</td>
<td>0010</td>
<td>0001</td>
<td>0001</td>
</tr>
<tr>
<td style="text-align:center">AluSrc2</td>
<td>0010</td>
<td>0001</td>
<td>0001</td>
<td>0001</td>
<td>0100</td>
<td>0001</td>
<td>0001</td>
</tr>
<tr>
<td style="text-align:center">WhichtoReg</td>
<td>0001</td>
<td>1000</td>
<td>0001</td>
<td>0001</td>
<td>0001</td>
<td>0001</td>
<td>0001</td>
</tr>
<tr>
<td style="text-align:center">RegDst</td>
<td>0010</td>
<td>0100</td>
<td>0001</td>
<td>0001</td>
<td>0001</td>
<td>0001</td>
<td>0001</td>
</tr>
<tr>
<td style="text-align:center">SignExt</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>
<h2 id="桥和计数器"><a class="markdownIt-Anchor" href="#桥和计数器"></a> 桥和计数器</h2>
<h4 id="1bridge"><a class="markdownIt-Anchor" href="#1bridge"></a> 1.Bridge</h4>
<ul>
<li><strong>端口定义</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">方向</th>
<th style="text-align:left">信号名</th>
<th style="text-align:left">位宽</th>
<th style="text-align:left">描述</th>
<th style="text-align:left">输入来源</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">Address_in</td>
<td style="text-align:left">32</td>
<td style="text-align:left">写入/读取的外设单元的地址</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">WD_in</td>
<td style="text-align:left">32</td>
<td style="text-align:left">写入外设单元的数据</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">byteen</td>
<td style="text-align:left">4</td>
<td style="text-align:left">写入外设单元的使能</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">DM_RD</td>
<td style="text-align:left">32</td>
<td style="text-align:left">DM读取值的输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">T0_RD</td>
<td style="text-align:left">32</td>
<td style="text-align:left">Timer1读取值的输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">T1_RD</td>
<td style="text-align:left">32</td>
<td style="text-align:left">Timer0读取值的输入</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">DM_WE</td>
<td style="text-align:left">4</td>
<td style="text-align:left">DM写入使能</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">T0_WE</td>
<td style="text-align:left">1</td>
<td style="text-align:left">Timer1写入使能</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">T1_WE</td>
<td style="text-align:left">1</td>
<td style="text-align:left">Timer2写入使能</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">Address_out</td>
<td style="text-align:left">32</td>
<td style="text-align:left">写入/读取的外设单元的地址</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">WD_out</td>
<td style="text-align:left">32</td>
<td style="text-align:left">写入外设单元的数据</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">RD_out</td>
<td style="text-align:left">32</td>
<td style="text-align:left">外设单元的读取值输出</td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<h4 id="2tc"><a class="markdownIt-Anchor" href="#2tc"></a> <a class="link"   target="_blank" rel="noopener" href="http://2.TC" >2.TC <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></h4>
<ul>
<li><strong>端口定义</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">方向</th>
<th style="text-align:left">信号名</th>
<th style="text-align:left">位宽</th>
<th style="text-align:left">描述</th>
<th style="text-align:left">输入来源</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">clk</td>
<td style="text-align:left">1</td>
<td style="text-align:left">时钟信号</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">reset</td>
<td style="text-align:left">1</td>
<td style="text-align:left">同步复位信号</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">Addr</td>
<td style="text-align:left">30</td>
<td style="text-align:left">Timer写入地址</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">WE</td>
<td style="text-align:left">1</td>
<td style="text-align:left">Timer写入使能</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">I</td>
<td style="text-align:left">Din</td>
<td style="text-align:left">32</td>
<td style="text-align:left">Timer写入数据</td>
<td style="text-align:left">前一级相同信号</td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">D_out</td>
<td style="text-align:left">32</td>
<td style="text-align:left">Timer读取数据</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">IRQ</td>
<td style="text-align:left">1</td>
<td style="text-align:left">中断请求</td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<p>##重要机制实现方法</p>
<h3 id="cp0响应机制"><a class="markdownIt-Anchor" href="#cp0响应机制"></a> CP0响应机制</h3>
<p>CP0是检测异常和中断的重要部件，异常和中断通过以下接口传入——</p>
<ul>
<li><strong>中断信息</strong>通过 <strong>HWInt[7:2]</strong> 接口进入，其中HWInt[2]连接Timer0的终端请求，HWInt[3]连接Timer1的终端请求，HWInt[4]连接外部的中断请求。</li>
<li><strong>异常信息</strong>通过<strong>ExcCode_in</strong>和<strong>BD_in</strong>两个接口传入，ExcCode_in传入的是异常代码（ADEL，ADES，RI，OV），BD_in传入的是延迟槽指令标志（有效则表示当前指令为延迟槽指令）。</li>
</ul>
<p>检测到中断或者异常时，CP0会进行判断并响应，决定是否将req(<strong>CP0向CPU发出的中断请求</strong>)置1。判断逻辑如下——</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wire inter_req  = (|(HWInt &amp; IM)) &amp; IE &amp; (!EXL);//中断有效判断</span><br><span class="line">wire exc_req    = (ExcCode_in != 5&#x27;d0) &amp; (!EXL);//异常有效判断</span><br><span class="line">assign req      = inter_req | exc_req;//</span><br></pre></td></tr></table></figure></div>
<p>当req有效，CP0还需要完成以下任务——</p>
<ul>
<li>
<p>EXL置1</p>
</li>
<li>
<p>将M级PC存入EPC（延迟槽指令中存入EPC-4）</p>
</li>
<li>
<p>如果当前响应中断，ExcCode寄存器写入0；若响应异常，ExcCode寄存器写入外部传入的异常代码ExcCode_in</p>
</li>
<li>
<p>BD寄存器写入外部传入的BD_in信号</p>
</li>
<li>
<p>此外，无论是否发出中断请求，在每一周期均需要将HWInt[6:2]写入Cause寄存器中的的IP域</p>
<h3 id="系统桥设计"><a class="markdownIt-Anchor" href="#系统桥设计"></a> 系统桥设计</h3>
<p>系统桥其实是充当一个“交换机”的角色，将CPU传来的地址写入相应的外设（DM、Timer0、Timer1），只需要组合逻辑便可实现。</p>
<h3 id="异常识别"><a class="markdownIt-Anchor" href="#异常识别"></a> 异常识别</h3>
<p>P7中我们考虑的异常情况有以下几种——</p>
<ul>
<li>F级异常：
<ul>
<li>PC地址没有字对齐（AdEL）</li>
<li>PC地址超过0x3000 ~ 0x6ffc（AdEL）</li>
</ul>
</li>
<li>D级异常：
<ul>
<li>未知的指令码（RI）</li>
</ul>
</li>
<li>E级异常：
<ul>
<li>addi、add、sub计算溢出（Ov）</li>
<li>load类指令计算地址时加法溢出（AdEL）</li>
<li>store类指令计算地址时加法溢出（AdES）</li>
</ul>
</li>
<li>M级异常：
<ul>
<li>lw取数地址未 4 字节对齐（AdEL）</li>
<li>lh、lhu取数地址未与 2 字节对齐（AdEL）</li>
<li>lh、lhu、lb、lbu取 Timer 寄存器的值（AdEL）</li>
<li>load型指令取数地址超出 DM、Timer0、Timer1 的范围（AdEL）</li>
<li>sw存数地址未 4 字节对齐（AdES）</li>
<li>sh存数地址未 2 字节对齐（AdES）</li>
<li>sh、sb存 Timer 寄存器的值（AdES）</li>
<li>sw向计时器的 Count 寄存器存值（AdES）</li>
<li>store型指令存数地址超出 DM、Timer0、Timer1 的范围（AdES）</li>
</ul>
</li>
</ul>
<p>针对以上列出的异常情况，我们在每一个流水级对异常进行检测。由于教程提出了以下要求——</p>
<ul>
<li>发生取指异常后视为 <code>nop</code> 直至提交到 CP0。</li>
<li>发生 <code>RI</code> 异常后视为 <code>nop</code> 直至提交到 CP0。</li>
<li><code>load</code> 与 <code>store</code> 类算址溢出按照 <code>AdEL</code> 与 <code>AdES</code> 处理。</li>
</ul>
<p>因此不会出现<strong>一个指令在多级出现异常</strong>的情况。如果某个流水级出现了新的异常，我们将这个异常流水到下一级即可，而不是流水上一级传来的异常；如果这个流水级没有出现新的异常，则将上一级传来的异常继续流水给下一级即可。</p>
<h2 id="p8工程模块"><a class="markdownIt-Anchor" href="#p8工程模块"></a> P8工程模块</h2>
<h3 id="fpga_top顶层模块"><a class="markdownIt-Anchor" href="#fpga_top顶层模块"></a> fpga_top（顶层模块）</h3>
<p>该模块替代P7中的mips模块，增加了和外设（数码管、LED等等）通信的IO接口。</p>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">信号名</th>
<th style="text-align:left">方向</th>
<th style="text-align:left">位宽</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">clk_in</td>
<td style="text-align:left">I</td>
<td style="text-align:left">1</td>
<td style="text-align:left">时钟信号</td>
</tr>
<tr>
<td style="text-align:left">sys_rstn</td>
<td style="text-align:left">I</td>
<td style="text-align:left">1</td>
<td style="text-align:left">低电平同步复位信号</td>
</tr>
<tr>
<td style="text-align:left">dip_swithc0</td>
<td style="text-align:left">I</td>
<td style="text-align:left">8</td>
<td style="text-align:left">第0组拨码开关控制信号</td>
</tr>
<tr>
<td style="text-align:left">dip_swithc1</td>
<td style="text-align:left">I</td>
<td style="text-align:left">8</td>
<td style="text-align:left">第1组拨码开关控制信号</td>
</tr>
<tr>
<td style="text-align:left">dip_swithc2</td>
<td style="text-align:left">I</td>
<td style="text-align:left">8</td>
<td style="text-align:left">第2组拨码开关控制信号</td>
</tr>
<tr>
<td style="text-align:left">dip_swithc3</td>
<td style="text-align:left">I</td>
<td style="text-align:left">8</td>
<td style="text-align:left">第3组拨码开关控制信号</td>
</tr>
<tr>
<td style="text-align:left">dip_swithc4</td>
<td style="text-align:left">I</td>
<td style="text-align:left">8</td>
<td style="text-align:left">第4组拨码开关控制信号</td>
</tr>
<tr>
<td style="text-align:left">dip_swithc5</td>
<td style="text-align:left">I</td>
<td style="text-align:left">8</td>
<td style="text-align:left">第5组拨码开关控制信号</td>
</tr>
<tr>
<td style="text-align:left">dip_swithc6</td>
<td style="text-align:left">I</td>
<td style="text-align:left">8</td>
<td style="text-align:left">第6组拨码开关控制信号</td>
</tr>
<tr>
<td style="text-align:left">dip_switch7</td>
<td style="text-align:left">I</td>
<td style="text-align:left">8</td>
<td style="text-align:left">第7组拨码开关控制信号</td>
</tr>
<tr>
<td style="text-align:left">user_key</td>
<td style="text-align:left">I</td>
<td style="text-align:left">8</td>
<td style="text-align:left">用户按键开关控制信号</td>
</tr>
<tr>
<td style="text-align:left">led_light</td>
<td style="text-align:left">O</td>
<td style="text-align:left">31</td>
<td style="text-align:left">LED灯控制信号</td>
</tr>
<tr>
<td style="text-align:left">digital_tube2</td>
<td style="text-align:left">O</td>
<td style="text-align:left">8</td>
<td style="text-align:left">第2组四段数码管驱动信号</td>
</tr>
<tr>
<td style="text-align:left">digital_tube_sel2</td>
<td style="text-align:left">O</td>
<td style="text-align:left">1</td>
<td style="text-align:left">第2组四段数码管片选信号</td>
</tr>
<tr>
<td style="text-align:left">digital_tube1</td>
<td style="text-align:left">O</td>
<td style="text-align:left">8</td>
<td style="text-align:left">第1组四段数码管驱动信号</td>
</tr>
<tr>
<td style="text-align:left">digital_tube_sel1</td>
<td style="text-align:left">O</td>
<td style="text-align:left">3</td>
<td style="text-align:left">第1组四段数码管片选信号</td>
</tr>
<tr>
<td style="text-align:left">digital_tube0</td>
<td style="text-align:left">O</td>
<td style="text-align:left">8</td>
<td style="text-align:left">第0组四段数码管驱动信号</td>
</tr>
<tr>
<td style="text-align:left">digital_tube_sel0</td>
<td style="text-align:left">O</td>
<td style="text-align:left">3</td>
<td style="text-align:left">第0组四段数码管片选信号</td>
</tr>
<tr>
<td style="text-align:left">uart_rxd</td>
<td style="text-align:left">I</td>
<td style="text-align:left">1</td>
<td style="text-align:left">UART接收信号</td>
</tr>
<tr>
<td style="text-align:left">uart_txd</td>
<td style="text-align:left">O</td>
<td style="text-align:left">1</td>
<td style="text-align:left">UART发送信号</td>
</tr>
</tbody>
</table>
<h3 id="bridge系统桥"><a class="markdownIt-Anchor" href="#bridge系统桥"></a> Bridge（系统桥）</h3>
<table>
<thead>
<tr>
<th style="text-align:left">信号名</th>
<th style="text-align:left">方向</th>
<th style="text-align:left">位宽</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">clk</td>
<td style="text-align:left">I</td>
<td style="text-align:left">1</td>
<td style="text-align:left">时钟信号</td>
</tr>
<tr>
<td style="text-align:left">reset</td>
<td style="text-align:left">I</td>
<td style="text-align:left">1</td>
<td style="text-align:left">高电平同步复位信号</td>
</tr>
<tr>
<td style="text-align:left">A_in</td>
<td style="text-align:left">I</td>
<td style="text-align:left">32</td>
<td style="text-align:left">写入/读取的外设单元的地址</td>
</tr>
<tr>
<td style="text-align:left">WD_in</td>
<td style="text-align:left">I</td>
<td style="text-align:left">32</td>
<td style="text-align:left">写入外设单元的数据</td>
</tr>
<tr>
<td style="text-align:left">byteen</td>
<td style="text-align:left">I</td>
<td style="text-align:left">4</td>
<td style="text-align:left">写入外设单元的使能</td>
</tr>
<tr>
<td style="text-align:left">DM_RD</td>
<td style="text-align:left">I</td>
<td style="text-align:left">32</td>
<td style="text-align:left">DM读取值的输入</td>
</tr>
<tr>
<td style="text-align:left">Timer_RD</td>
<td style="text-align:left">I</td>
<td style="text-align:left">32</td>
<td style="text-align:left">Timer读取值的输入</td>
</tr>
<tr>
<td style="text-align:left">UART_RD</td>
<td style="text-align:left">I</td>
<td style="text-align:left">32</td>
<td style="text-align:left">UART读取值的输入</td>
</tr>
<tr>
<td style="text-align:left">Tube_RD</td>
<td style="text-align:left">I</td>
<td style="text-align:left">32</td>
<td style="text-align:left">Tube读取值的输入</td>
</tr>
<tr>
<td style="text-align:left">GPIO_RD</td>
<td style="text-align:left">I</td>
<td style="text-align:left">32</td>
<td style="text-align:left">GPIO读取值的输入</td>
</tr>
<tr>
<td style="text-align:left">A_out</td>
<td style="text-align:left">O</td>
<td style="text-align:left">32</td>
<td style="text-align:left">写入/读取的外设单元的地址</td>
</tr>
<tr>
<td style="text-align:left">WD_out</td>
<td style="text-align:left">O</td>
<td style="text-align:left">32</td>
<td style="text-align:left">写入外设单元的数据</td>
</tr>
<tr>
<td style="text-align:left">RD_out</td>
<td style="text-align:left">O</td>
<td style="text-align:left">32</td>
<td style="text-align:left">外设单元的读取值输出</td>
</tr>
<tr>
<td style="text-align:left">DM_WE</td>
<td style="text-align:left">O</td>
<td style="text-align:left">4</td>
<td style="text-align:left">DM写入使能</td>
</tr>
<tr>
<td style="text-align:left">Timer_WE</td>
<td style="text-align:left">O</td>
<td style="text-align:left">1</td>
<td style="text-align:left">Timer写入使能</td>
</tr>
<tr>
<td style="text-align:left">UART_WE</td>
<td style="text-align:left">O</td>
<td style="text-align:left">1</td>
<td style="text-align:left">UART写入使能</td>
</tr>
<tr>
<td style="text-align:left">Tube_WE</td>
<td style="text-align:left">O</td>
<td style="text-align:left">4</td>
<td style="text-align:left">Tube写入使能</td>
</tr>
<tr>
<td style="text-align:left">GPIO_WE</td>
<td style="text-align:left">O</td>
<td style="text-align:left">4</td>
<td style="text-align:left">GPIO写入使能</td>
</tr>
<tr>
<td style="text-align:left">UART_STB</td>
<td style="text-align:left">O</td>
<td style="text-align:left">1</td>
<td style="text-align:left">UART片选信号</td>
</tr>
</tbody>
</table>
<h3 id="tube数码管驱动模块"><a class="markdownIt-Anchor" href="#tube数码管驱动模块"></a> Tube（数码管驱动模块）</h3>
<table>
<thead>
<tr>
<th style="text-align:left">信号名</th>
<th style="text-align:left">方向</th>
<th style="text-align:left">位宽</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">clk</td>
<td style="text-align:left">I</td>
<td style="text-align:left">1</td>
<td style="text-align:left">时钟信号</td>
</tr>
<tr>
<td style="text-align:left">reset</td>
<td style="text-align:left">I</td>
<td style="text-align:left">1</td>
<td style="text-align:left">高电平同步复位信号</td>
</tr>
<tr>
<td style="text-align:left">A</td>
<td style="text-align:left">I</td>
<td style="text-align:left">32</td>
<td style="text-align:left">读/写数码管的地址</td>
</tr>
<tr>
<td style="text-align:left">WD</td>
<td style="text-align:left">I</td>
<td style="text-align:left">32</td>
<td style="text-align:left">写入数码管的数据</td>
</tr>
<tr>
<td style="text-align:left">WE</td>
<td style="text-align:left">I</td>
<td style="text-align:left">1</td>
<td style="text-align:left">数码管写入使能</td>
</tr>
<tr>
<td style="text-align:left">RD</td>
<td style="text-align:left">I</td>
<td style="text-align:left">32</td>
<td style="text-align:left">数码管读取数据</td>
</tr>
<tr>
<td style="text-align:left">digital_tube2</td>
<td style="text-align:left">O</td>
<td style="text-align:left">8</td>
<td style="text-align:left">第2组四段数码管驱动信号</td>
</tr>
<tr>
<td style="text-align:left">digital_tube_sel2</td>
<td style="text-align:left">O</td>
<td style="text-align:left">1</td>
<td style="text-align:left">第2组四段数码管片选信号</td>
</tr>
<tr>
<td style="text-align:left">digital_tube1</td>
<td style="text-align:left">O</td>
<td style="text-align:left">8</td>
<td style="text-align:left">第1组四段数码管驱动信号</td>
</tr>
<tr>
<td style="text-align:left">digital_tube_sel1</td>
<td style="text-align:left">O</td>
<td style="text-align:left">3</td>
<td style="text-align:left">第1组四段数码管片选信号</td>
</tr>
<tr>
<td style="text-align:left">digital_tube0</td>
<td style="text-align:left">O</td>
<td style="text-align:left">8</td>
<td style="text-align:left">第0组四段数码管驱动信号</td>
</tr>
<tr>
<td style="text-align:left">digital_tube_sel0</td>
<td style="text-align:left">O</td>
<td style="text-align:left">3</td>
<td style="text-align:left">第0组四段数码管片选信号</td>
</tr>
</tbody>
</table>
<h3 id="gpio通用io驱动模块"><a class="markdownIt-Anchor" href="#gpio通用io驱动模块"></a> GPIO（通用IO驱动模块）</h3>
<p>该模块位于CPU模块中，主要用于获取外部中断信息和内部异常信息，进行判断后输出异常/中断请求。同时该模块中设有四个寄存器——SR，Cause，EPC和PRIP。</p>
<table>
<thead>
<tr>
<th style="text-align:left">信号名</th>
<th style="text-align:left">方向</th>
<th style="text-align:left">位宽</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">clk</td>
<td style="text-align:left">I</td>
<td style="text-align:left">1</td>
<td style="text-align:left">时钟信号</td>
</tr>
<tr>
<td style="text-align:left">reset</td>
<td style="text-align:left">I</td>
<td style="text-align:left">1</td>
<td style="text-align:left">复位信号</td>
</tr>
<tr>
<td style="text-align:left">A</td>
<td style="text-align:left">I</td>
<td style="text-align:left">32</td>
<td style="text-align:left">读GPIO的地址</td>
</tr>
<tr>
<td style="text-align:left">WD</td>
<td style="text-align:left">I</td>
<td style="text-align:left">32</td>
<td style="text-align:left">写入GPIO的数据</td>
</tr>
<tr>
<td style="text-align:left">WE</td>
<td style="text-align:left">I</td>
<td style="text-align:left">1</td>
<td style="text-align:left">GPIO写入使能</td>
</tr>
<tr>
<td style="text-align:left">dip_swithc0</td>
<td style="text-align:left">I</td>
<td style="text-align:left">8</td>
<td style="text-align:left">第0组拨码开关控制信号</td>
</tr>
<tr>
<td style="text-align:left">dip_swithc1</td>
<td style="text-align:left">I</td>
<td style="text-align:left">8</td>
<td style="text-align:left">第1组拨码开关控制信号</td>
</tr>
<tr>
<td style="text-align:left">dip_swithc2</td>
<td style="text-align:left">I</td>
<td style="text-align:left">8</td>
<td style="text-align:left">第2组拨码开关控制信号</td>
</tr>
<tr>
<td style="text-align:left">dip_swithc3</td>
<td style="text-align:left">I</td>
<td style="text-align:left">8</td>
<td style="text-align:left">第3组拨码开关控制信号</td>
</tr>
<tr>
<td style="text-align:left">dip_swithc4</td>
<td style="text-align:left">I</td>
<td style="text-align:left">8</td>
<td style="text-align:left">第4组拨码开关控制信号</td>
</tr>
<tr>
<td style="text-align:left">dip_swithc5</td>
<td style="text-align:left">I</td>
<td style="text-align:left">8</td>
<td style="text-align:left">第5组拨码开关控制信号</td>
</tr>
<tr>
<td style="text-align:left">dip_swithc6</td>
<td style="text-align:left">I</td>
<td style="text-align:left">8</td>
<td style="text-align:left">第6组拨码开关控制信号</td>
</tr>
<tr>
<td style="text-align:left">dip_switch7</td>
<td style="text-align:left">I</td>
<td style="text-align:left">8</td>
<td style="text-align:left">第7组拨码开关控制信号</td>
</tr>
<tr>
<td style="text-align:left">user_key</td>
<td style="text-align:left">I</td>
<td style="text-align:left">8</td>
<td style="text-align:left">用户按键开关控制信号</td>
</tr>
<tr>
<td style="text-align:left">RD</td>
<td style="text-align:left">O</td>
<td style="text-align:left">8</td>
<td style="text-align:left">GPIO的读取数据</td>
</tr>
<tr>
<td style="text-align:left">led_light</td>
<td style="text-align:left">O</td>
<td style="text-align:left">32</td>
<td style="text-align:left">LED灯控制信号</td>
</tr>
</tbody>
</table>
<h3 id="uart模块"><a class="markdownIt-Anchor" href="#uart模块"></a> UART模块</h3>
<p>该模块为系统桥，实际上是区分地址的组合逻辑模块，用于CPU和DM、Timer1、Timer0之间的的数据交换。</p>
<table>
<thead>
<tr>
<th style="text-align:left">信号名</th>
<th style="text-align:left">方向</th>
<th style="text-align:left">位宽</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">CLK_I</td>
<td style="text-align:left">I</td>
<td style="text-align:left">1</td>
<td style="text-align:left">时钟信号</td>
</tr>
<tr>
<td style="text-align:left">RST_I</td>
<td style="text-align:left">I</td>
<td style="text-align:left">1</td>
<td style="text-align:left">高电平同步复位信号</td>
</tr>
<tr>
<td style="text-align:left">ADD_I</td>
<td style="text-align:left">I</td>
<td style="text-align:left">3（[4:2]）</td>
<td style="text-align:left">读/写UART的地址</td>
</tr>
<tr>
<td style="text-align:left">WE_I</td>
<td style="text-align:left">I</td>
<td style="text-align:left">1</td>
<td style="text-align:left">UART写使能信号（和CPU交互）</td>
</tr>
<tr>
<td style="text-align:left">DAT_I</td>
<td style="text-align:left">I</td>
<td style="text-align:left">32</td>
<td style="text-align:left">UART写入数据（和CPU交互）</td>
</tr>
<tr>
<td style="text-align:left">STB_I</td>
<td style="text-align:left">I</td>
<td style="text-align:left">1</td>
<td style="text-align:left">UART片选信号输入</td>
</tr>
<tr>
<td style="text-align:left">RxD</td>
<td style="text-align:left">I</td>
<td style="text-align:left">1</td>
<td style="text-align:left">UART接收数据（和外设交互）</td>
</tr>
<tr>
<td style="text-align:left">DAT_O</td>
<td style="text-align:left">O</td>
<td style="text-align:left">32</td>
<td style="text-align:left">UART读取数据（和CPU交互）</td>
</tr>
<tr>
<td style="text-align:left">ACK_O</td>
<td style="text-align:left">O</td>
<td style="text-align:left">1</td>
<td style="text-align:left">UART片选信号输出</td>
</tr>
<tr>
<td style="text-align:left">TxD</td>
<td style="text-align:left">O</td>
<td style="text-align:left">1</td>
<td style="text-align:left">UART发送数据（和外设交互）</td>
</tr>
<tr>
<td style="text-align:left">inter</td>
<td style="text-align:left">O</td>
<td style="text-align:left">1</td>
<td style="text-align:left">中断请求信号</td>
</tr>
</tbody>
</table>
<h3 id="ip-core-的使用和相关调整"><a class="markdownIt-Anchor" href="#ip-core-的使用和相关调整"></a> IP Core 的使用和相关调整</h3>
<p>因为在P8实验中，为了使得我们的微系统是“可综合的”，我们需要将<strong>用常规方法描述的DM和IM</strong>删去，同时用FPGA内封装好的特殊功能部件——“<strong>块储存器</strong>”（<strong>“IP核”的一种</strong>）来替换。我们在ISE中生成后，直接在我们的微系统中调用即可。调用模板如</p>
<details class="blue" data-header-exclude><summary><i class="fa-solid fa-chevron-right"></i>Folding coding </summary>
              <div class='content'>
              <div class="highlight-container" data-rel="Verilog"><figure class="iseeu highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">IM u_IM(<span class="comment">//input</span></span><br><span class="line">        <span class="variable">.clka</span>           ( clk_in                    ), <span class="comment">// input clka</span></span><br><span class="line">        <span class="variable">.addra</span>          ( IM_A               [<span class="number">11</span>:<span class="number">0</span>] ), <span class="comment">// input [11 : 0] addra</span></span><br><span class="line">        <span class="comment">//output</span></span><br><span class="line">        <span class="variable">.douta</span>          ( IM_RD              [<span class="number">31</span>:<span class="number">0</span>] )  <span class="comment">// output [31 : 0] douta</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">DM u_DM (<span class="comment">//input</span></span><br><span class="line">        <span class="variable">.clka</span>           ( clk_in                    ), <span class="comment">// input clka</span></span><br><span class="line">        <span class="variable">.wea</span>            ( Bridge_DM_WE       [<span class="number">3</span>:<span class="number">0</span>]  ), <span class="comment">// input [3 : 0] wea</span></span><br><span class="line">        <span class="variable">.addra</span>          ( DM_A               [<span class="number">11</span>:<span class="number">0</span>] ), <span class="comment">// input [11 : 0] addra</span></span><br><span class="line">        <span class="variable">.dina</span>           ( Bridge_RD_out      [<span class="number">31</span>:<span class="number">0</span>] ), <span class="comment">// input [31 : 0] dina</span></span><br><span class="line">        <span class="comment">//output</span></span><br><span class="line">        <span class="variable">.douta</span>          ( DM_RD              [<span class="number">31</span>:<span class="number">0</span>] )  <span class="comment">// output [31 : 0] douta</span></span><br><span class="line">        );</span><br></pre></td></tr></table></figure></div>
              </div>
            </details>
<p>与我们之前使用的IM和DM不同，P8中使用的块储存器是 <strong>“同步读出”</strong>，这种行为差异造成了数据读出的时机不同，为了适应这一变化，需要对流水线的结构作出一定的修改。笔者采用的是<strong>修改流水寄存器</strong>的方法，即<strong>短接法</strong>。教程中的描述为——</p>
<blockquote>
<p><strong>修改流水级寄存器</strong>。由于 Block RAM/ROM 的读端口可以抽象成组合逻辑与寄存器的连接，而 P6/P7 的流水线则是将组合逻辑读出的值输入 M/W 级流水寄存器；因此若将 M/W 级流水寄存器中的流水m_data_rdata的寄存器短接，就等价于将 Block RAM 读出端的&quot;寄存器&quot;移到了 M/W 流水寄存器上。这样修改后，流水线的结构与修改前几乎是相同的。</p>
</blockquote>
<p>此外，我们该需要对D级流水寄存器和Bridge进行相应调整</p>
<ul>
<li><strong>D级寄存器</strong>的调整：为保证D 级发生阻塞时，指令被正确地 stall 在 D 级，我们需要D级流水寄存器中增加一个l临时寄存器来存储<strong>上一次在D级的instruction</strong>。然后再通过一个选择信号来选择当前进入D级的instruction是<strong>IM同步读出的instrcution</strong>还是<strong>临时寄存器中的instruction</strong>。清空延迟槽时<strong>将D级instruction置0</strong>的操作也类似。</li>
</ul>
<details class="blue" data-header-exclude><summary><i class="fa-solid fa-chevron-right"></i>Folding coding </summary>
              <div class='content'>
              <div class="highlight-container" data-rel="Verilog"><figure class="iseeu highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//IF流水寄存器</span></span><br><span class="line"> 	<span class="keyword">reg</span>        stall_tag;</span><br><span class="line">    <span class="keyword">reg</span>        clr_tag;</span><br><span class="line">    <span class="keyword">reg</span> [<span class="number">31</span>:<span class="number">0</span>] last_instr_reg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assign</span> D_Instr = clr_tag   ? <span class="number">32&#x27;d0</span> :</span><br><span class="line">                     stall_tag ? last_instr_reg : </span><br><span class="line">                                 F_Instr;</span><br><span class="line">    <span class="keyword">always</span> @(<span class="keyword">posedge</span> clk) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span>(reset)<span class="keyword">begin</span></span><br><span class="line">            last_instr_reg &lt;= <span class="number">0</span>; </span><br><span class="line">            stall_tag      &lt;= <span class="number">0</span>; </span><br><span class="line">            clr_tag        &lt;= <span class="number">1&#x27;b1</span>;</span><br><span class="line">        <span class="keyword">end</span> </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            last_instr_reg &lt;= D_Instr;</span><br><span class="line">            stall_tag      &lt;= (~en) ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line">            clr_tag        &lt;= (req|clr) ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br></pre></td></tr></table></figure></div>
              </div>
            </details>
<ul>
<li><strong>Bridge</strong>的调整：由于Bridge沟通的外设既有同步读的DM，也有异步读的Timer，Tube，UART，GPIO等设备，这样在Bridge向CPU传数据的时候会产生冲突。因此笔者将他们的读方式统一成“同步读”，方法是——在Bridge为每一个外设设置一个数据寄存器（DM除外），每个时钟上升沿更新<strong>从这些外设中异步读出的值</strong>。此外，我们还需要将<strong>被访问的外设的地址</strong>存进一个临时寄存器，每次根据这个<strong>临时寄存器</strong>的地址从若干<strong>数据寄存器</strong>中选择相应的值，返回到CPU中。</li>
</ul>
<details class="blue" data-header-exclude><summary><i class="fa-solid fa-chevron-right"></i>Folding coding </summary>
              <div class='content'>
              <div class="highlight-container" data-rel="Verilog"><figure class="iseeu highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">reg</span> [<span class="number">31</span>:<span class="number">0</span>] Timer_RD_reg;</span><br><span class="line"><span class="keyword">reg</span> [<span class="number">31</span>:<span class="number">0</span>] UART_RD_reg;</span><br><span class="line"><span class="keyword">reg</span> [<span class="number">31</span>:<span class="number">0</span>] Tube_RD_reg;</span><br><span class="line"><span class="keyword">reg</span> [<span class="number">31</span>:<span class="number">0</span>] GPIO_RD_reg;</span><br><span class="line"><span class="keyword">reg</span> [<span class="number">31</span>:<span class="number">0</span>] Address_reg;</span><br><span class="line">                </span><br><span class="line"><span class="keyword">always</span> @(<span class="keyword">posedge</span> clk) <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span>(reset) <span class="keyword">begin</span></span><br><span class="line">        Timer_RD_reg &lt;= <span class="number">0</span>;  </span><br><span class="line">        UART_RD_reg &lt;= <span class="number">0</span>; </span><br><span class="line">        Tube_RD_reg &lt;= <span class="number">0</span>;</span><br><span class="line">        GPIO_RD_reg &lt;= <span class="number">0</span>;</span><br><span class="line">        Address_reg &lt;= <span class="number">0</span>; </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        Timer_RD_reg &lt;= Timer_RD;  </span><br><span class="line">        UART_RD_reg &lt;= UART_RD; </span><br><span class="line">        Tube_RD_reg &lt;= Tube_RD;</span><br><span class="line">        GPIO_RD_reg &lt;= GPIO_RD;</span><br><span class="line">        Address_reg &lt;= Address_in; </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">assign</span> DM_WE       =  (Address_in &gt;= `Data_Begin    &amp;&amp;  Address_in &lt;= `Data_End)?byteen:<span class="number">4&#x27;d0</span>;</span><br><span class="line">    <span class="keyword">assign</span> UART_WE     =  (Address_in &gt;= `UART_Begin   &amp;&amp;  Address_in &lt;= `UART_End)?|byteen:<span class="number">1&#x27;d0</span>;</span><br><span class="line">    <span class="keyword">assign</span> Tube_WE     =  (Address_in &gt;= `Tube_Begin   &amp;&amp;  Address_in &lt;= `Tube_End)?byteen:<span class="number">4&#x27;d0</span>;</span><br><span class="line">    <span class="keyword">assign</span> Timer_WE    =  (Address_in &gt;= `Timer_Begin   &amp;&amp;  Address_in &lt;= `Timer_End)?|byteen:<span class="number">1&#x27;d0</span>;</span><br><span class="line">    <span class="keyword">assign</span> GPIO_WE     =  (Address_in &gt;= `SWITCH_Begin &amp;&amp;  Address_in &lt;= `SWITCH_End ||Address_in &gt;= `KEY_Begin &amp;&amp; Address_in &lt;= `KEY_End||Address_in &gt;= `LED_Begin &amp;&amp; Address_in &lt;= `LED_End)?byteen:<span class="number">4&#x27;d0</span>;</span><br><span class="line">    <span class="keyword">assign</span> Address_out =  Address_in;</span><br><span class="line">    <span class="keyword">assign</span> WD_out      =  WD_in;</span><br><span class="line">    <span class="keyword">assign</span> RD_out      =  (Address_reg &gt;= `Data_Begin   &amp;&amp;  Address_reg &lt;= `Data_End) ? DM_RD :</span><br><span class="line">                          (Address_reg &gt;= `Timer_Begin  &amp;&amp;  Address_reg &lt;= `Timer_End) ? Timer_RD_reg :</span><br><span class="line">                          (Address_reg &gt;= `UART_Begin   &amp;&amp;  Address_reg &lt;= `UART_End) ? UART_RD_reg :</span><br><span class="line">                          (Address_reg &gt;= `Tube_Begin   &amp;&amp;  Address_reg &lt;= `Tube_End) ? Tube_RD_reg :</span><br><span class="line">                          (Address_reg &gt;= `SWITCH_Begin &amp;&amp;  Address_reg &lt;= `SWITCH_End ||Address_reg &gt;= `KEY_Begin &amp;&amp; Address_reg &lt;= `KEY_End||Address_reg &gt;= `LED_Begin &amp;&amp; Address_reg &lt;= `LED_End) ? GPIO_RD_reg :</span><br><span class="line">                          <span class="number">32&#x27;d0</span>;</span><br></pre></td></tr></table></figure></div>
              </div>
            </details>
<h3 id="数码管驱动设计"><a class="markdownIt-Anchor" href="#数码管驱动设计"></a> 数码管驱动设计</h3>
<p>数码管驱动中有两个寄存器，和对其他外设的操作一样，我们需要实现CPU对寄存器的读写。代码比较简单，如下所示</p>
<details class="blue" data-header-exclude><summary><i class="fa-solid fa-chevron-right"></i>Folding coding </summary>
              <div class='content'>
              <div class="highlight-container" data-rel="Verilog"><figure class="iseeu highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">reg</span> [<span class="number">15</span>:<span class="number">0</span>] tube_0_data;</span><br><span class="line">   <span class="keyword">reg</span> [<span class="number">15</span>:<span class="number">0</span>] tube_1_data;</span><br><span class="line">   <span class="keyword">reg</span> [<span class="number">3</span>:<span class="number">0</span>]  tube_2_data; </span><br><span class="line">   <span class="keyword">wire</span> [<span class="number">7</span>:<span class="number">0</span>] digital_tube2_wire; </span><br><span class="line">   <span class="keyword">wire</span> digital_en; </span><br><span class="line">  <span class="comment">//write</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">always</span> @(<span class="keyword">posedge</span> clk) <span class="keyword">begin</span></span><br><span class="line">      <span class="keyword">if</span>(reset)<span class="keyword">begin</span></span><br><span class="line">          tube_0_data &lt;= <span class="number">0</span>; </span><br><span class="line">          tube_1_data &lt;= <span class="number">0</span>;</span><br><span class="line">          tube_2_data &lt;= <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span>(| WE) <span class="keyword">begin</span></span><br><span class="line">          <span class="keyword">if</span>(Address &gt;= `Tube_1_Begin &amp;&amp; Address &lt;= `Tube_1_End) <span class="keyword">begin</span></span><br><span class="line">              <span class="keyword">if</span>(WE[<span class="number">0</span>]) tube_0_data[<span class="number">7</span>:<span class="number">0</span>]  &lt;= WD[<span class="number">7</span>:<span class="number">0</span>];</span><br><span class="line">              <span class="keyword">if</span>(WE[<span class="number">1</span>]) tube_0_data[<span class="number">15</span>:<span class="number">8</span>] &lt;= WD[<span class="number">15</span>:<span class="number">8</span>];</span><br><span class="line">              <span class="keyword">if</span>(WE[<span class="number">2</span>]) tube_1_data[<span class="number">7</span>:<span class="number">0</span>]  &lt;= WD[<span class="number">23</span>:<span class="number">16</span>];</span><br><span class="line">              <span class="keyword">if</span>(WE[<span class="number">3</span>]) tube_1_data[<span class="number">15</span>:<span class="number">8</span>] &lt;= WD[<span class="number">31</span>:<span class="number">24</span>]; </span><br><span class="line">          <span class="keyword">end</span>      </span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span>(Address &gt;= `Tube_2_Begin &amp;&amp; Address &lt;= `Tube_2_End) <span class="keyword">begin</span></span><br><span class="line">              <span class="keyword">if</span>(WE[<span class="number">0</span>]) tube_2_data &lt;= WD[<span class="number">3</span>:<span class="number">0</span>];</span><br><span class="line">          <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span>    </span><br><span class="line">  <span class="comment">//read</span></span><br><span class="line">  <span class="keyword">assign</span> RD = (Address &gt;= `Tube_1_Begin &amp;&amp; Address &lt;= `Tube_1_End) ? &#123;tube_1_data, tube_0_data&#125; :</span><br><span class="line">              (Address &gt;= `Tube_2_Begin &amp;&amp; Address &lt;= `Tube_2_End) ? &#123;<span class="number">28&#x27;d0</span>,  tube_2_data&#125; :</span><br><span class="line">                                                  <span class="number">32&#x27;d0</span>;</span><br><span class="line">   <span class="comment">//moniter</span></span><br><span class="line">   <span class="keyword">assign</span> digital_en=<span class="number">1&#x27;b1</span>;</span><br><span class="line">   digital_tube d0 (</span><br><span class="line">       <span class="variable">.clk</span>(clk),</span><br><span class="line">       <span class="variable">.rstn</span>(~reset),</span><br><span class="line">       <span class="variable">.en</span>(digital_en),</span><br><span class="line">       <span class="variable">.data</span>(tube_0_data),</span><br><span class="line">       <span class="variable">.sel</span>(digital_tube_sel0),</span><br><span class="line">       <span class="variable">.seg</span>(digital_tube0)</span><br><span class="line">   );</span><br><span class="line"></span><br><span class="line">   digital_tube d1 (</span><br><span class="line">       <span class="variable">.clk</span>(clk),</span><br><span class="line">       <span class="variable">.rstn</span>(~reset),</span><br><span class="line">       <span class="variable">.en</span>(digital_en),</span><br><span class="line">       <span class="variable">.data</span>(tube_1_data),</span><br><span class="line">       <span class="variable">.sel</span>(digital_tube_sel1),</span><br><span class="line">       <span class="variable">.seg</span>(digital_tube1)</span><br><span class="line">   );</span><br><span class="line">   <span class="comment">//output </span></span><br><span class="line">   <span class="keyword">reg</span> reset_tag;</span><br><span class="line">    <span class="keyword">always</span> @(<span class="keyword">posedge</span> clk) <span class="keyword">begin</span></span><br><span class="line">       <span class="keyword">if</span> (reset) reset_tag &lt;= <span class="number">1</span>;</span><br><span class="line">       <span class="keyword">else</span>      reset_tag  &lt;= <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">assign</span> digital_tube_sel2  =   <span class="number">1&#x27;b1</span>;</span><br><span class="line">   <span class="keyword">assign</span> digital_tube2= reset_tag ? <span class="number">8&#x27;b1111_1111</span> :digital_tube2_wire;</span><br><span class="line">   <span class="keyword">assign</span> digital_tube2_wire =   <span class="number">8&#x27;b1111_1111</span>;</span><br></pre></td></tr></table></figure></div>
              </div>
            </details>
<p>在数码管驱动设计中，我们不仅要能够向驱动中的寄存器读写数据，还要根据驱动内部寄存器的值向真正的数码管传递对应的电平信号，来控制数码管的亮灭。四段数码管为一组，每组数码管由一个驱动信号、一个片选信号控制。原理如下</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://hyggge.github.io/2021/12/25/CO_P8_MIPS%E5%BE%AE%E7%B3%BB%E7%BB%9F%EF%BC%88%E6%9D%BF%E7%BA%A7%E9%AA%8C%E8%AF%81%EF%BC%89/%E5%85%AB%E6%AE%B5%E6%95%B0%E7%A0%81%E7%AE%A1png.png"
                      alt="img" 
                ></p>
<p>一段数码管显示的16进制数与控制信号的关系如下表所示(注意：实验中采用的是共阳极数码管，低电平时亮，高电平时灭)</p>
<table>
<thead>
<tr>
<th style="text-align:center">数码管显示的16进制数</th>
<th style="text-align:center">数码管控制信号{DP,G,F,E,D,C,B,A}</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center">0xC0</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">0xF9</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">0xA4</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">0xB0</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">0x99</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">0x92</td>
</tr>
<tr>
<td style="text-align:center">6</td>
<td style="text-align:center">0x82</td>
</tr>
<tr>
<td style="text-align:center">7</td>
<td style="text-align:center">0xF8</td>
</tr>
<tr>
<td style="text-align:center">8</td>
<td style="text-align:center">0x80</td>
</tr>
<tr>
<td style="text-align:center">9</td>
<td style="text-align:center">0x90</td>
</tr>
<tr>
<td style="text-align:center">A</td>
<td style="text-align:center">0x88</td>
</tr>
<tr>
<td style="text-align:center">B</td>
<td style="text-align:center">0x83</td>
</tr>
<tr>
<td style="text-align:center">C</td>
<td style="text-align:center">0xC6</td>
</tr>
<tr>
<td style="text-align:center">D</td>
<td style="text-align:center">0xA1</td>
</tr>
<tr>
<td style="text-align:center">E</td>
<td style="text-align:center">0x86</td>
</tr>
<tr>
<td style="text-align:center">F</td>
<td style="text-align:center">0x8E</td>
</tr>
</tbody>
</table>
<p>为实现该功能，笔者设计了单独的模块<code>digital_tube</code>来对一组数码管的亮灭进行控制，直接在<code>Tube</code>模块中调用即可。</p>
<details class="blue" data-header-exclude><summary><i class="fa-solid fa-chevron-right"></i>Folding coding </summary>
              <div class='content'>
              <div class="highlight-container" data-rel="Verilog"><figure class="iseeu highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    ----a----</span></span><br><span class="line"><span class="comment">    |       |</span></span><br><span class="line"><span class="comment">    f       b</span></span><br><span class="line"><span class="comment">    |       |</span></span><br><span class="line"><span class="comment">    ----g----</span></span><br><span class="line"><span class="comment">    |       |</span></span><br><span class="line"><span class="comment">    e       c</span></span><br><span class="line"><span class="comment">    |       |</span></span><br><span class="line"><span class="comment">    ----d----  .dp</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    seg[7:0] = &#123;dp, a, b, c, d, e, f, g&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">module</span> digital_tube(</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">wire</span> clk,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">wire</span> rstn,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">wire</span> en,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">wire</span> [<span class="number">15</span>:<span class="number">0</span>] data,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">wire</span> [<span class="number">3</span>:<span class="number">0</span>] sel,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">wire</span> [<span class="number">7</span>:<span class="number">0</span>] seg</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">localparam</span> PERIOD = <span class="number">32&#x27;d25_000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// div counter</span></span><br><span class="line">    <span class="keyword">reg</span> [<span class="number">31</span>:<span class="number">0</span>] counter;</span><br><span class="line">    <span class="keyword">always</span> @(<span class="keyword">posedge</span> clk) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (~rstn) <span class="keyword">begin</span></span><br><span class="line">            counter &lt;= <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            <span class="keyword">if</span> (counter + <span class="number">1</span> == PERIOD) </span><br><span class="line">                counter &lt;= <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                counter &lt;= counter + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// select</span></span><br><span class="line">    <span class="keyword">reg</span> [<span class="number">1</span>:<span class="number">0</span>] select;</span><br><span class="line">    <span class="keyword">always</span> @(<span class="keyword">posedge</span> clk) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (~rstn) <span class="keyword">begin</span></span><br><span class="line">            select &lt;= <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            <span class="keyword">if</span> (counter + <span class="number">1</span> == PERIOD) </span><br><span class="line">                select &lt;= select + <span class="number">1&#x27;b1</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">assign</span> sel = (<span class="number">4&#x27;b1</span> &lt;&lt; select);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// data output</span></span><br><span class="line">    <span class="keyword">function</span> [<span class="number">7</span>:<span class="number">0</span>] hex2dig;   <span class="comment">// dp = 1</span></span><br><span class="line">        <span class="keyword">input</span> [<span class="number">3</span>:<span class="number">0</span>] hex;</span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">            <span class="keyword">case</span> (hex)</span><br><span class="line">            <span class="number">4&#x27;h0</span>    : hex2dig = <span class="number">8&#x27;b1000_0001</span>;   <span class="comment">// not g</span></span><br><span class="line">            <span class="number">4&#x27;h1</span>    : hex2dig = <span class="number">8&#x27;b1100_1111</span>;   <span class="comment">// b, c</span></span><br><span class="line">            <span class="number">4&#x27;h2</span>    : hex2dig = <span class="number">8&#x27;b1001_0010</span>;   <span class="comment">// not c, f</span></span><br><span class="line">            <span class="number">4&#x27;h3</span>    : hex2dig = <span class="number">8&#x27;b1000_0110</span>;   <span class="comment">// not e, f</span></span><br><span class="line">            <span class="number">4&#x27;h4</span>    : hex2dig = <span class="number">8&#x27;b1100_1100</span>;   <span class="comment">// not a, d, e</span></span><br><span class="line">            <span class="number">4&#x27;h5</span>    : hex2dig = <span class="number">8&#x27;b1010_0100</span>;   <span class="comment">// not b, e</span></span><br><span class="line">            <span class="number">4&#x27;h6</span>    : hex2dig = <span class="number">8&#x27;b1010_0000</span>;   <span class="comment">// not b</span></span><br><span class="line">            <span class="number">4&#x27;h7</span>    : hex2dig = <span class="number">8&#x27;b1000_1111</span>;   <span class="comment">// a, b, c</span></span><br><span class="line">            <span class="number">4&#x27;h8</span>    : hex2dig = <span class="number">8&#x27;b1000_0000</span>;   <span class="comment">// all</span></span><br><span class="line">            <span class="number">4&#x27;h9</span>    : hex2dig = <span class="number">8&#x27;b1000_0100</span>;   <span class="comment">// not e</span></span><br><span class="line">            <span class="number">4&#x27;hA</span>    : hex2dig = <span class="number">8&#x27;b1000_1000</span>;   <span class="comment">// not d</span></span><br><span class="line">            <span class="number">4&#x27;hB</span>    : hex2dig = <span class="number">8&#x27;b1110_0000</span>;   <span class="comment">// not a, b</span></span><br><span class="line">            <span class="number">4&#x27;hC</span>    : hex2dig = <span class="number">8&#x27;b1011_0001</span>;   <span class="comment">// a, d, e, f</span></span><br><span class="line">            <span class="number">4&#x27;hD</span>    : hex2dig = <span class="number">8&#x27;b1100_0010</span>;   <span class="comment">// not a, f</span></span><br><span class="line">            <span class="number">4&#x27;hE</span>    : hex2dig = <span class="number">8&#x27;b1011_0000</span>;   <span class="comment">// not b, c</span></span><br><span class="line">            <span class="number">4&#x27;hF</span>    : hex2dig = <span class="number">8&#x27;b1011_1000</span>;   <span class="comment">// a, e, f, g</span></span><br><span class="line">            <span class="keyword">default</span> : hex2dig = <span class="number">8&#x27;b1111_1111</span>;</span><br><span class="line">            <span class="keyword">endcase</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endfunction</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">assign</span> seg = en ? hex2dig(data[select * <span class="number">4</span> +: <span class="number">4</span>]) : <span class="number">8&#x27;b1111_1110</span>; <span class="comment">// &#x27;-&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
              </div>
            </details>
<h3 id="通用io驱动设计"><a class="markdownIt-Anchor" href="#通用io驱动设计"></a> 通用IO驱动设计</h3>
<p>通用IO包括三部分——<strong>64 位用户输入微动开关</strong>、 <strong>8 个通用按键开关和LED</strong>、<strong>LED</strong>。前两个是输入设备，只有LED是输出设备。</p>
<ul>
<li>对于输入设备（<strong>64 位用户输入微动开关</strong>、 <strong>8 个通用按键开关</strong>）而言，外部传来的数据只有在<strong>CPU读取该设备数据的时候</strong>才是有效的，也就是说，在CPU读其他外设时，无论该输入设备输进什么值，都是无效值，也就没有必要用寄存器将外界读取的值存储下来，只需要将输入设备的引脚直接连接到控制模块的读数据端口，使 CPU 将它们当作一个只读的寄存器。</li>
<li>对于输出设备（<strong>LED</strong>）而言，每次CPU写进设备驱动的数据都应该保存下来，这样才能保证CPU读写其他外设时，该驱动仍然向<strong>真正的输出外设</strong>稳定地输出数据。</li>
</ul>
<p>整体写法也比较简单，如下所示——</p>
<details class="blue" data-header-exclude><summary><i class="fa-solid fa-chevron-right"></i>Folding coding </summary>
              <div class='content'>
              <div class="highlight-container" data-rel="Verilog"><figure class="iseeu highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">reg</span> [<span class="number">31</span>:<span class="number">0</span>] led_reg;</span><br><span class="line">   <span class="comment">//led display</span></span><br><span class="line">   <span class="keyword">assign</span> led_light = ~led_reg; </span><br><span class="line">  </span><br><span class="line">   <span class="comment">//read</span></span><br><span class="line">   <span class="keyword">assign</span> RD = (Address &gt;= `SWITCH_1_Begin  &amp;&amp; Address &lt;= `SWITCH_1_End) ? ~&#123;dip_switch3, dip_switch2, dip_switch1, dip_switch0&#125; :</span><br><span class="line">               (Address &gt;= `SWITCH_2_Begin &amp;&amp; Address &lt;= `SWITCH_2_End) ? ~&#123;dip_switch7, dip_switch6, dip_switch5, dip_switch4&#125; :</span><br><span class="line">               (Address &gt;= `KEY_Begin &amp;&amp; Address &lt;= `KEY_End) ? &#123;<span class="number">24&#x27;d0</span>, ~user_key&#125; :</span><br><span class="line">               (Address &gt;= `LED_Begin &amp;&amp; Address &lt;= `LED_End ) ? &#123;led_reg&#125; : <span class="number">32&#x27;d0</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//write</span></span><br><span class="line">   <span class="keyword">always</span> @(<span class="keyword">posedge</span> clk) <span class="keyword">begin</span></span><br><span class="line">       <span class="keyword">if</span>(reset) led_reg &lt;= <span class="number">32&#x27;hffff_ffff</span>;</span><br><span class="line">       <span class="keyword">else</span> <span class="keyword">if</span>(| WE) <span class="keyword">begin</span></span><br><span class="line">               <span class="keyword">if</span>(WE[<span class="number">0</span>]) led_reg[<span class="number">7</span>:<span class="number">0</span>]   &lt;= WD[<span class="number">7</span>:<span class="number">0</span>];</span><br><span class="line">               <span class="keyword">if</span>(WE[<span class="number">1</span>]) led_reg[<span class="number">15</span>:<span class="number">8</span>]  &lt;= WD[<span class="number">15</span>:<span class="number">8</span>];</span><br><span class="line">               <span class="keyword">if</span>(WE[<span class="number">2</span>]) led_reg[<span class="number">23</span>:<span class="number">16</span>] &lt;= WD[<span class="number">23</span>:<span class="number">16</span>];</span><br><span class="line">               <span class="keyword">if</span>(WE[<span class="number">3</span>]) led_reg[<span class="number">31</span>:<span class="number">24</span>] &lt;= WD[<span class="number">31</span>:<span class="number">24</span>]; </span><br><span class="line">       <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">end</span></span><br></pre></td></tr></table></figure></div>
              </div>
            </details>
<h3 id="uart的修改"><a class="markdownIt-Anchor" href="#uart的修改"></a> UART的修改</h3>
<p>为了实现UART中断功能，即<strong>接收到一次完整的数据后向CPU产生中断信号，CPU对其进行响应</strong>，我们需要对UART进行一定的修改,并使用教程里的源码模仿即可。其实也比较简单。</p>
<details class="blue" data-header-exclude><summary><i class="fa-solid fa-chevron-right"></i>Folding coding </summary>
              <div class='content'>
              <div class="highlight-container" data-rel="Verilog"><figure class="iseeu highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">output</span> inter;</span><br><span class="line"><span class="keyword">assign</span> inter = rs;</span><br></pre></td></tr></table></figure></div>
              </div>
            </details>
<ul>
<li>Warning:一定要修改UART的头文件中有关时钟频率的宏定义（根据21级教程来，时钟频率改为25MHz）！否则会导致波特率不匹配！</li>
</ul>
<h3 id="二-mips软件代码"><a class="markdownIt-Anchor" href="#二-mips软件代码"></a> 二、 MIPS软件代码</h3>
<details class="blue" data-header-exclude><summary><i class="fa-solid fa-chevron-right"></i>Folding coding </summary>
              <div class='content'>
              <div class="highlight-container" data-rel="Markdown"><figure class="iseeu highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line">.text</span><br><span class="line"><span class="section">#interrupt  enable</span></span><br><span class="line">ori	$at, 0xfff1</span><br><span class="line">mtc0	$at, $12</span><br><span class="line"><span class="section">#Address</span></span><br><span class="line">li $s0,0x7f00 #counter</span><br><span class="line">li $s1,0x7f30 #UART</span><br><span class="line">li $s2,0x7f50 #TUBE</span><br><span class="line">li $s3,0x7f60 #SWITCH</span><br><span class="line">li $s4,0x7f68 #KEY</span><br><span class="line">li $s5,0x7f70 #LED</span><br><span class="line"><span class="section">#Constant</span></span><br><span class="line">li $t8,2604 #Baudbits</span><br><span class="line">li $t7,0xb  #Timer<span class="emphasis">_mode1</span></span><br><span class="line"><span class="emphasis">li $t6,25000000 #per second</span></span><br><span class="line"><span class="emphasis">#li $t6,25 #per second</span></span><br><span class="line"><span class="emphasis">#judge_</span>Mode</span><br><span class="line">FPGA<span class="emphasis">_begin:</span></span><br><span class="line"><span class="emphasis">lw $t1,0($s4)</span></span><br><span class="line"><span class="emphasis">move $t2,$t1</span></span><br><span class="line"><span class="emphasis">andi $t2,0x0001</span></span><br><span class="line"><span class="emphasis">li $t3,1 #counter_</span>mode</span><br><span class="line">beq $t2,$t3,Counter<span class="emphasis">_Mode</span></span><br><span class="line"><span class="emphasis">nop</span></span><br><span class="line"><span class="emphasis">Calculate_</span>Mode:</span><br><span class="line"><span class="code">    lw	$t1, 4($s3)</span></span><br><span class="line"><span class="code">    lw	$t2, 0($s3)</span></span><br><span class="line"><span class="code">    lbu	$t0, 0($s4)</span></span><br><span class="line"><span class="code">    andi $t0, 0xfffc</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    switch:</span></span><br><span class="line"><span class="code">        op_1:</span></span><br><span class="line"><span class="code">        li	$t3, 4</span></span><br><span class="line"><span class="code">        bne	$t0, $t3, op_2</span></span><br><span class="line"><span class="code">        nop</span></span><br><span class="line"><span class="code">        add	$t4, $t1, $t2</span></span><br><span class="line"><span class="code">        j	switch_end</span></span><br><span class="line"><span class="code">		    nop</span></span><br><span class="line"><span class="code">        </span></span><br><span class="line"><span class="code">        op_2:</span></span><br><span class="line"><span class="code">        li	$t3, 8</span></span><br><span class="line"><span class="code">        bne	$t0, $t3, op_3</span></span><br><span class="line"><span class="code">        nop</span></span><br><span class="line"><span class="code">        sub	$t4, $t1, $t2</span></span><br><span class="line"><span class="code">        j	switch_end</span></span><br><span class="line"><span class="code">		    nop</span></span><br><span class="line"><span class="code">        </span></span><br><span class="line"><span class="code">        op_3:</span></span><br><span class="line"><span class="code">        li	$t3, 16</span></span><br><span class="line"><span class="code">        bne	$t0, $t3, op_4</span></span><br><span class="line"><span class="code">        nop</span></span><br><span class="line"><span class="code">        mult $t1, $t2</span></span><br><span class="line"><span class="code">        mflo $t4</span></span><br><span class="line"><span class="code">        j	switch_end</span></span><br><span class="line"><span class="code">		    nop</span></span><br><span class="line"><span class="code">        </span></span><br><span class="line"><span class="code">        op_4:</span></span><br><span class="line"><span class="code">        li	$t3, 32</span></span><br><span class="line"><span class="code">        bne	$t0, $t3, op_5</span></span><br><span class="line"><span class="code">        nop</span></span><br><span class="line"><span class="code">        div  $t1, $t2</span></span><br><span class="line"><span class="code">        mflo $t4</span></span><br><span class="line"><span class="code">        j	switch_end</span></span><br><span class="line"><span class="code">		    nop</span></span><br><span class="line"><span class="code">        </span></span><br><span class="line"><span class="code">        op_5:</span></span><br><span class="line"><span class="code">        li	$t3, 64</span></span><br><span class="line"><span class="code">        bne	$t0, $t3, op_6</span></span><br><span class="line"><span class="code">        nop</span></span><br><span class="line"><span class="code">        and	$t4, $t1, $t2</span></span><br><span class="line"><span class="code">        j	switch_end</span></span><br><span class="line"><span class="code">		    nop</span></span><br><span class="line"><span class="code">        </span></span><br><span class="line"><span class="code">        op_6:</span></span><br><span class="line"><span class="code">        li	$t3, 128</span></span><br><span class="line"><span class="code">        bne	$t0, $t3, switch_end</span></span><br><span class="line"><span class="code">        nop</span></span><br><span class="line"><span class="code">        or	$t4, $t1, $t2</span></span><br><span class="line"><span class="code">        </span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">    switch_end:</span></span><br><span class="line"><span class="code">        jal Display_sel</span></span><br><span class="line"><span class="code">        nop</span></span><br><span class="line"><span class="code">        j	FPGA_begin</span></span><br><span class="line"><span class="code">        nop</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Display<span class="emphasis">_sel:</span></span><br><span class="line"><span class="emphasis">    lw $t2,0($s4)</span></span><br><span class="line"><span class="emphasis">    andi $t2,0x0002</span></span><br><span class="line"><span class="emphasis">    li $t3,2 #counter_</span>mode</span><br><span class="line"><span class="code">    beq $t2,$t3,UART_display</span></span><br><span class="line"><span class="code">    nop</span></span><br><span class="line"><span class="code">    sw	$t4, 0($s2) #use $t4 to display</span></span><br><span class="line"><span class="code">	sw  $t4, 0($s5)</span></span><br><span class="line"><span class="code">    jr $ra</span></span><br><span class="line"><span class="code">    nop</span></span><br><span class="line"><span class="code">    UART_display:</span></span><br><span class="line"><span class="code">    sw $t8,8($s1)</span></span><br><span class="line"><span class="code">    sw $t8,12($s1)</span></span><br><span class="line"><span class="code">    srl $t5,$t4,24</span></span><br><span class="line"><span class="code">    sb $t5,0($s1)</span></span><br><span class="line"><span class="code">    srl $t5,$t4,16</span></span><br><span class="line"><span class="code">    sb $t5,0($s1)</span></span><br><span class="line"><span class="code">    srl $t5,$t4,8</span></span><br><span class="line"><span class="code">    sb $t5,0($s1)</span></span><br><span class="line"><span class="code">    sb $t4,0($s1)</span></span><br><span class="line"><span class="code">    jr $ra</span></span><br><span class="line"><span class="code">    nop</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Counter<span class="emphasis">_Mode:</span></span><br><span class="line"><span class="emphasis"># t0 is input-value</span></span><br><span class="line"><span class="emphasis"># t1 is max-value</span></span><br><span class="line"><span class="emphasis"># t4 is value counter</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">#mode judge</span></span><br><span class="line"><span class="emphasis">    lw $t3,0($s4)</span></span><br><span class="line"><span class="emphasis">    andi $t2,$t3,0x0004</span></span><br><span class="line"><span class="emphasis">    li $t5,4</span></span><br><span class="line"><span class="emphasis">    beq $t5,$t2,in_</span>order</span><br><span class="line"><span class="code">    nop</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">not<span class="emphasis">_order:</span></span><br><span class="line"><span class="emphasis">	sw $0,0($s0)</span></span><br><span class="line"><span class="emphasis">	lw	$t0, 0($s3)</span></span><br><span class="line"><span class="emphasis">	li $t4,0</span></span><br><span class="line"><span class="emphasis">	move $t1,$t0</span></span><br><span class="line"><span class="emphasis">	sw	$t6, 4($s0)</span></span><br><span class="line"><span class="emphasis">	sw	$t7, 0($s0)#mode1</span></span><br><span class="line"><span class="emphasis">	j counter_</span>loop1</span><br><span class="line"><span class="code">	nop</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">counter<span class="emphasis">_loop1: </span></span><br><span class="line"><span class="emphasis">	lw	$t0, 0($s3)</span></span><br><span class="line"><span class="emphasis">  	jal Display_</span>sel</span><br><span class="line">  	nop</span><br><span class="line"><span class="code">	beq	$t0, $t1, counter_loop1</span></span><br><span class="line"><span class="code">	nop</span></span><br><span class="line"><span class="code">	j FPGA_begin</span></span><br><span class="line"><span class="code">	nop</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">in<span class="emphasis">_order:</span></span><br><span class="line"><span class="emphasis">	sw $0,0($s0)</span></span><br><span class="line"><span class="emphasis">	lw	$t0, 0($s3)</span></span><br><span class="line"><span class="emphasis">	move $t1,$t0</span></span><br><span class="line"><span class="emphasis">	move $t4,$t0</span></span><br><span class="line"><span class="emphasis">	sw	$t6, 4($s0)</span></span><br><span class="line"><span class="emphasis">	sw	$t7, 0($s0)#mode1</span></span><br><span class="line"><span class="emphasis">	j counter_</span>loop2</span><br><span class="line"><span class="code">	nop</span></span><br><span class="line"><span class="code">	</span></span><br><span class="line"><span class="code">counter_loop2: </span></span><br><span class="line"><span class="code">	lw	$t0, 0($s3)</span></span><br><span class="line"><span class="code">  	jal Display_sel</span></span><br><span class="line"><span class="code">  	nop</span></span><br><span class="line"><span class="code">	beq	$t0, $t1, counter_loop2</span></span><br><span class="line"><span class="code">	nop</span></span><br><span class="line"><span class="code">	j FPGA_begin</span></span><br><span class="line"><span class="code">	nop</span></span><br><span class="line"><span class="code">		</span></span><br><span class="line"><span class="code"> .ktext 0x4180</span></span><br><span class="line"><span class="code"> mfc0 $k0,$13</span></span><br><span class="line"><span class="code"> li $k1,0x400</span></span><br><span class="line"><span class="code"> beq $k0,$k1,timer_inter</span></span><br><span class="line"><span class="code"> nop</span></span><br><span class="line"><span class="code"> interrupt:</span></span><br><span class="line"><span class="code">  lw 	$k0, 0($s1)</span></span><br><span class="line"><span class="code">  sw 	$k0, 0($s1)</span></span><br><span class="line"><span class="code">  eret </span></span><br><span class="line"><span class="code"> timer_inter:</span></span><br><span class="line"><span class="code">	bne $t5,$t2,add_part</span></span><br><span class="line"><span class="code">	nop</span></span><br><span class="line"><span class="code">	sub_part:</span></span><br><span class="line"><span class="code"> 	beq	$t4, $0, end</span></span><br><span class="line"><span class="code"> 	nop</span></span><br><span class="line"><span class="code"> 	addi	$t4, $t4, -1</span></span><br><span class="line"><span class="code"> 	j end</span></span><br><span class="line"><span class="code"> 	nop</span></span><br><span class="line"><span class="code">	add_part:</span></span><br><span class="line"><span class="code">	beq	$t4, $t0, end</span></span><br><span class="line"><span class="code"> 	nop</span></span><br><span class="line"><span class="code">	addi	$t4, $t4, 1</span></span><br><span class="line"><span class="code"> 	end:</span></span><br><span class="line"><span class="code">	eret</span></span><br><span class="line"><span class="code"></span></span><br></pre></td></tr></table></figure></div>
              </div>
            </details>
<h2 id="自动化生成coe文件"><a class="markdownIt-Anchor" href="#自动化生成coe文件"></a> 自动化生成coe文件</h2>
<p>当我们写完软件部分的代码时，需要将其转换成机器码，同时还需要根据coe文件格式进行一定处理——文件开头加相应前缀，每行机器码后面需要加逗号。如果手动进行修改的话费时费力，可以通过下面的python脚本自动生成coe文件。</p>
<details class="blue" data-header-exclude><summary><i class="fa-solid fa-chevron-right"></i>Folding coding </summary>
              <div class='content'>
              <div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_mars</span>():</span><br><span class="line">    os.chdir(<span class="string">&#x27;D:\\coding_file\\study\\Lesson\\co_lesson\\lesson\\p8\\statistic&#x27;</span>)</span><br><span class="line">    os.system(</span><br><span class="line">        <span class="string">&quot;java -jar Mars.jar nc db lg ex mc LargeText 100000 test.asm &gt;mips_out.txt&quot;</span>)</span><br><span class="line">    os.system(</span><br><span class="line">        <span class="string">&quot;java -jar Mars.jar nc a db mc CompactDataAtZero dump 0x00003000-0x0000417c HexText ../mips/text.txt test.asm &gt; mips_log.txt&quot;</span>)</span><br><span class="line">    os.system(</span><br><span class="line">        <span class="string">&quot;java -jar Mars.jar nc a db mc CompactDataAtZero dump 0x00004180-0x00004f00 HexText ../mips/handler.txt test.asm &gt; mips_log.txt&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;../mips/text.txt&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> text_file:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;../mips/handler.txt&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> handler_file:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;../mips/code.txt&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> code_file:</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x3000</span>, <span class="number">0x4180</span>, <span class="number">4</span>):</span><br><span class="line">                    ret1 = text_file.readline()</span><br><span class="line">                    <span class="keyword">if</span> (ret1):</span><br><span class="line">                        code_file.write(ret1)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        code_file.write(<span class="string">&quot;00000000\n&quot;</span>)</span><br><span class="line">                code_file.write(handler_file.read())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    run_mars()</span><br><span class="line">    os.chdir(<span class="string">&#x27;D:\\coding_file\\study\\Lesson\\co_lesson\\lesson\\p8\\mips&#x27;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;code.txt&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.readlines()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">        <span class="keyword">if</span> i != <span class="built_in">len</span>(data) - <span class="number">1</span>:</span><br><span class="line">            data[i] = data[i][:-<span class="number">1</span>] + <span class="string">&quot;,\n&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            data[i] = data[i][:-<span class="number">1</span>] + <span class="string">&quot;;\n&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;fpga.coe&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">&quot;memory_initialization_radix=16;\nmemory_initialization_vector=\n&quot;</span>)</span><br><span class="line">        f.writelines(data)</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
              </div>
            </details>

        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> P8 Design documents</li>
        <li><strong>Author:</strong> Charles</li>
        <li><strong>Created at:</strong> 2022-12-26 21:12:55</li>
        
            <li>
                <strong>Updated at:</strong> 2023-06-17 14:13:59
            </li>
        
        <li>
            <strong>Link:</strong> https://charles2530.github.io/2022/12/26/p8-design-documents/
        </li>
        <li>
            <strong>License:</strong> This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0</a>.
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/CO/">#CO</a>&nbsp;
                    </li>
                
            </ul>
        

        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                        rel="prev"
                        href="/2022/12/27/co-mips/"
                        >
                            <span class="left arrow-icon flex-center">
                                <i class="fa-solid fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">CO-Mips</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                        rel="next"
                        href="/2022/12/26/p7-design-documents/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">P7 Design documents</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                                <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        


        
            <div class="comment-container">
                <div class="comments-container pjax">
  <div id="comment-anchor"></div>
  <div class="comment-area-title">
    <i class="fa-solid fa-comments"></i>&nbsp;Comments
  </div>
  

  <!-- 
            
    <div id="gitalk-container"></div>
    <script data-swup-reload-script
            src="//cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js"></script>
    <script data-swup-reload-script>

        function loadGitalk() {
            let __gitalk__pathname = decodeURI(location.pathname);
            const __gitalk__pathnameLength = __gitalk__pathname.length;
            const __gitalk__pathnameMaxLength = 50;
            if (__gitalk__pathnameLength > __gitalk__pathnameMaxLength) {
                __gitalk__pathname = __gitalk__pathname.substring(0, __gitalk__pathnameMaxLength - 3) + '...';
            }

            try {
                Gitalk && new Gitalk({
                    clientID: '8083299a8ee2aaf23879',
                    clientSecret: 'a8161e81d4872181e884fdb69f7be24916b6a9d0',
                    repo: 'charles2530_issues',
                    owner: 'Charles2530',
                    admin: ['Charles2530'],
                    id: __gitalk__pathname,
                    language: 'en'
                }).render('gitalk-container');

            } catch (e) {
                window.Gitalk = null;
            }
        }

        if ('true') {
            const loadGitalkTimeout = setTimeout(() => {
                loadGitalk();
                clearTimeout(loadGitalkTimeout);
            }, 1000);
        } else {
            window.addEventListener('DOMContentLoaded', loadGitalk);
        }
    </script>



         -->
  <script src="https://utteranc.es/client.js" repo="Charles2530/Charles2530.github.io" issue-term="pathname"
    label="Comment" theme="preferred-color-scheme" crossorigin="anonymous" async>
  </script>
  
</div>

            </div>
        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">P8 Design documents</div>
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#verilog%E6%B5%81%E6%B0%B4%E7%BA%BFcpu%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3"><span class="nav-text"> Verilog流水线CPU设计文档</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80-cpu%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88%E7%BB%BC%E8%BF%B0"><span class="nav-text"> 一、 CPU设计方案综述</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80-%E6%80%BB%E4%BD%93%E8%AE%BE%E8%AE%A1%E6%A6%82%E8%BF%B0"><span class="nav-text"> （一） 总体设计概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C-%E5%85%B3%E9%94%AE%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%B9%89"><span class="nav-text"> （二） 关键模块定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%8F%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="nav-text"> 宏的定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cpu%E6%A8%A1%E5%9D%97"><span class="nav-text"> CPU模块</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80f%E7%BA%A7%E6%B5%81%E6%B0%B4%E7%BA%BF"><span class="nav-text"> &lt;一&gt;.F级流水线</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-pc"><span class="nav-text"> 1. PC</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8Cd%E7%BA%A7%E6%B5%81%E6%B0%B4%E7%BA%BF"><span class="nav-text"> &lt;二&gt;.D级流水线</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-grf"><span class="nav-text"> 1. GRF</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-ext"><span class="nav-text"> 2. EXT</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-controller"><span class="nav-text"> 3. Controller</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4npc"><span class="nav-text"> 4.NPC</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5b_transferb%E7%B1%BB%E6%8C%87%E4%BB%A4%E6%AF%94%E8%BE%83%E5%8D%95%E5%85%83"><span class="nav-text"> 5.B_transfer(B类指令比较单元)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89e%E7%BA%A7%E6%B5%81%E6%B0%B4%E7%BA%BF"><span class="nav-text"> &lt;三&gt;.E级流水线</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-alu"><span class="nav-text"> 1. ALU</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2md_unit"><span class="nav-text"> 2.MD_Unit</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9Bm%E7%BA%A7%E6%B5%81%E6%B0%B4%E7%BA%BF"><span class="nav-text"> &lt;四&gt;.M级流水线</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-dm_in"><span class="nav-text"> 1. DM_In</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2dm_out"><span class="nav-text"> 2.DM_Out</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3cp0"><span class="nav-text"> 3.CP0</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E5%90%84%E7%BA%A7%E6%B5%81%E6%B0%B4%E7%BA%BF%E5%AF%84%E5%AD%98%E5%99%A8"><span class="nav-text"> &lt;五&gt;.各级流水线寄存器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1if_id"><span class="nav-text"> 1.IF_ID</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#d_regifid%E6%B5%81%E6%B0%B4%E5%AF%84%E5%AD%98%E5%99%A8"><span class="nav-text"> D_Reg（IF&#x2F;ID流水寄存器）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2id_ex"><span class="nav-text"> 2.ID_EX</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#e_regidex%E6%B5%81%E6%B0%B4%E5%AF%84%E5%AD%98%E5%99%A8"><span class="nav-text"> E_Reg（ID&#x2F;EX流水寄存器）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3ex_mem"><span class="nav-text"> 3.EX_MEM</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#m_regexmem%E6%B5%81%E6%B0%B4%E5%AF%84%E5%AD%98%E5%99%A8"><span class="nav-text"> M_Reg（EX&#x2F;MEM流水寄存器）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4mem_wb"><span class="nav-text"> 4.MEM_WB</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#w_regmemwb%E6%B5%81%E6%B0%B4%E5%AF%84%E5%AD%98%E5%99%A8"><span class="nav-text"> W_Reg（MEM&#x2F;WB流水寄存器）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E6%9A%82%E5%81%9C-%E8%BD%AC%E5%8F%91%E5%A4%84%E7%90%86%E5%8F%8A%E7%9B%B8%E5%85%B3%E5%A4%9A%E8%B7%AF%E9%80%89%E6%8B%A9%E5%99%A8"><span class="nav-text"> &lt;六&gt;.暂停、转发处理及相关多路选择器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E5%86%B2%E7%AA%81%E7%BB%BC%E5%90%88%E5%8D%95%E5%85%83hazardunit"><span class="nav-text"> （一）.冲突综合单元（HazardUnit)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C%E6%8E%A7%E5%88%B6%E5%92%8C%E5%86%92%E9%99%A9%E7%AE%80%E8%BF%B0"><span class="nav-text"> （二）.控制和冒险简述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E5%86%92%E9%99%A9%E5%A4%84%E7%90%86"><span class="nav-text"> (三）.冒险处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BD%AC%E5%8F%91forward"><span class="nav-text"> 转发（forward）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BD%AC%E5%8F%91%E7%9A%84%E6%9E%84%E9%80%A0"><span class="nav-text"> 转发的构造</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9A%82%E5%81%9Cstall"><span class="nav-text"> 暂停（stall）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%98%BB%E5%A1%9E%E7%9A%84%E6%9E%84%E9%80%A0d%E7%BA%A7"><span class="nav-text"> 阻塞的构造（D级）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9C%9F%E5%80%BC%E8%A1%A8"><span class="nav-text"> 真值表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A1%A5%E5%92%8C%E8%AE%A1%E6%95%B0%E5%99%A8"><span class="nav-text"> 桥和计数器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1bridge"><span class="nav-text"> 1.Bridge</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2tc"><span class="nav-text"> 2.TC </span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cp0%E5%93%8D%E5%BA%94%E6%9C%BA%E5%88%B6"><span class="nav-text"> CP0响应机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E6%A1%A5%E8%AE%BE%E8%AE%A1"><span class="nav-text"> 系统桥设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E8%AF%86%E5%88%AB"><span class="nav-text"> 异常识别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#p8%E5%B7%A5%E7%A8%8B%E6%A8%A1%E5%9D%97"><span class="nav-text"> P8工程模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#fpga_top%E9%A1%B6%E5%B1%82%E6%A8%A1%E5%9D%97"><span class="nav-text"> fpga_top（顶层模块）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bridge%E7%B3%BB%E7%BB%9F%E6%A1%A5"><span class="nav-text"> Bridge（系统桥）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tube%E6%95%B0%E7%A0%81%E7%AE%A1%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9D%97"><span class="nav-text"> Tube（数码管驱动模块）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gpio%E9%80%9A%E7%94%A8io%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9D%97"><span class="nav-text"> GPIO（通用IO驱动模块）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#uart%E6%A8%A1%E5%9D%97"><span class="nav-text"> UART模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ip-core-%E7%9A%84%E4%BD%BF%E7%94%A8%E5%92%8C%E7%9B%B8%E5%85%B3%E8%B0%83%E6%95%B4"><span class="nav-text"> IP Core 的使用和相关调整</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E7%A0%81%E7%AE%A1%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1"><span class="nav-text"> 数码管驱动设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E7%94%A8io%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1"><span class="nav-text"> 通用IO驱动设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#uart%E7%9A%84%E4%BF%AE%E6%94%B9"><span class="nav-text"> UART的修改</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C-mips%E8%BD%AF%E4%BB%B6%E4%BB%A3%E7%A0%81"><span class="nav-text"> 二、 MIPS软件代码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E7%94%9F%E6%88%90coe%E6%96%87%E4%BB%B6"><span class="nav-text"> 自动化生成coe文件</span></a></li></ol></li></ol>

    </div>
</div>
        </div>
    
</div>



                

            </div>
            
            

        </div>

        <div class="main-content-footer">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info">
            &copy;
            
              <span>2022</span>
              -
            
            2023&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">Charles</a>
        </div>
        
            <script data-swup-reload-script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv" class="busuanzi_container_site_uv">
                        Visitor Count&nbsp;<span id="busuanzi_value_site_uv" class="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="busuanzi_container_site_pv">
                        Total Page Views&nbsp;<span id="busuanzi_value_site_pv" class="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            <span class="powered-by-container">Powered by Charles</span>
                <br>
            <span class="theme-version-container">Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.3.0</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fa-regular fa-comments"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-expand-width flex-center">
            <i class="fa-regular fa-expand"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="right-bottom-tools rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                <i class="fa-regular fa-rss"></i>
                </a>
            </li>
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    


</main>


<script src="/js/libs/Swup.min.js"></script>

<script src="/js/libs/SwupSlideTheme.min.js"></script>

<script src="/js/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/libs/SwupScrollPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
        ],
        containers: ["#swup"],
    });

    swup.on("pageView", () => {
        Global.refresh();
    });

    // if (document.readyState === "complete") {
    //
    // } else {
    //     document.addEventListener("DOMContentLoaded", () => init());
    // }
</script>




  
<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/layouts/navbarShrink.js"></script>

<script src="/js/tools/scrollTopBottom.js"></script>

<script src="/js/tools/lightDarkSwitch.js"></script>

<script src="/js/layouts/categoryList.js"></script>



    
<script src="/js/tools/localSearch.js"></script>




    
<script src="/js/tools/codeBlock.js"></script>




    
<script src="/js/layouts/lazyload.js"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js"></script>




    
<script src="/js/libs/mermaid.min.js"></script>

    
<script src="/js/plugins/mermaid.js"></script>




    
<script src="/js/libs/minimasonry.min.js"></script>

    
<script src="/js/plugins/masonry.js"></script>



<div class="post-scripts" data-swup-reload-script>
    
        
<script src="/js/tools/tocToggle.js"></script>

<script src="/js/layouts/toc.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/plugins/tabs.js"></script>

    
</div>

  
</body>

</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/love.js"></script>
