<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Charles">
    
    <meta name="author" content="Charles">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
        
        
        
    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://charles2530.github.io/2023/09/19/sysy-compiler-design-doc/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="post by Charles in 2023-09-19 10:28:17">
<meta property="og:type" content="article">
<meta property="og:title" content="SysY-compiler-design-doc">
<meta property="og:url" content="http://charles2530.github.io/2023/09/19/sysy-compiler-design-doc/index.html">
<meta property="og:site_name" content="Charles&#39;s Castle">
<meta property="og:description" content="post by Charles in 2023-09-19 10:28:17">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://charles2530.github.io/image/SysY-compiler-design-doc/parseTree.png">
<meta property="og:image" content="https://charles2530.github.io/image/SysY-compiler-design-doc/image-20230926084756548.png">
<meta property="og:image" content="https://charles2530.github.io/image/SysY-compiler-design-doc/image-20230926093020645.png">
<meta property="og:image" content="https://charles2530.github.io/image/SysY-compiler-design-doc/image-20231025204943210.png">
<meta property="og:image" content="https://charles2530.github.io/image/SysY-compiler-design-doc/image-20231025214942032.png">
<meta property="og:image" content="https://charles2530.github.io/image/SysY-compiler-design-doc/image-20231119215943218.png">
<meta property="og:image" content="https://charles2530.github.io/image/SysY-compiler-design-doc/image-20231119220001178.png">
<meta property="og:image" content="https://charles2530.github.io/image/SysY-compiler-design-doc/image-20231119223355130.png">
<meta property="og:image" content="https://charles2530.github.io/image/SysY-compiler-design-doc/image-20231120000001515.png">
<meta property="og:image" content="https://charles2530.github.io/image/SysY-compiler-design-doc/image-20231120000151951.png">
<meta property="og:image" content="https://charles2530.github.io/image/SysY-compiler-design-doc/image-20231120095602990.png">
<meta property="og:image" content="https://charles2530.github.io/image/SysY-compiler-design-doc/image-20231120095644956.png">
<meta property="article:published_time" content="2023-09-19T02:28:17.000Z">
<meta property="article:modified_time" content="2023-12-24T02:29:28.566Z">
<meta property="article:author" content="Du Jinyang">
<meta property="article:tag" content="compiler">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://charles2530.github.io/image/SysY-compiler-design-doc/parseTree.png">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="https://charles2530.github.io/image/background/favicon.png" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="https://charles2530.github.io/image/background/favicon.png">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="https://charles2530.github.io/image/background/favicon.png">
    <!--- Page Info-->
    
    <title>
        
            SysY-compiler-design-doc -
        
        Charles&#39;s Castle
    </title>

    <link rel="stylesheet" href="//evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/fonts/Chillax/chillax.css">

    <!--- Inject Part-->
    
        
            
                
                    <script data-swup-reload-script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?8e0e5f382d14d87cbeadc33a36e71e86"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script>
                
    
            
    

    
        <style>
    :root {
        --preloader-background-color: #fff;
        --preloader-text-color: #000;
    }

    @media (prefers-color-scheme: dark) {
        :root {
            --preloader-background-color: #202124;
            --preloader-text-color: #fff;
        }
    }

    @media (prefers-color-scheme: light) {
        :root {
            --preloader-background-color: #fff;
            --preloader-text-color: #000;
        }
    }

    @media (max-width: 600px) {
        .ml13 {
            font-size: 2.6rem !important; /* Adjust this value as needed */
        }
    }

    .preloader {
        display: flex;
        flex-direction: column;
        gap: 1rem; /* Tailwind 'gap-4' is 1rem */
        align-items: center;
        justify-content: center;
        position: fixed;
        padding: 12px;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 100vw;
        height: 100vh; /* 'h-screen' is 100% of the viewport height */
        background-color: var(--preloader-background-color);
        z-index: 1100; /* 'z-[1100]' sets the z-index */
        transition: opacity 0.2s ease-in-out;
    }

    .ml13 {
        font-size: 3.2rem;
        /* text-transform: uppercase; */
        color: var(--preloader-text-color);
        letter-spacing: -1px;
        font-weight: 500;
        font-family: 'Chillax-Variable', sans-serif;
        text-align: center;
    }

    .ml13 .word {
        display: inline-flex;
        flex-wrap: wrap;
        white-space: nowrap;
    }

    .ml13 .letter {
        display: inline-block;
        line-height: 1em;
    }
</style>

<div class="preloader">
    <script src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/libs/anime.min.js"></script>
    <h1 class="ml13">
        Charles&#39;s Castle
    </h1>
    <script>
        var textWrapper = document.querySelector('.ml13');
        // Split text into words
        var words = textWrapper.textContent.trim().split(' ');

        // Clear the existing content
        textWrapper.innerHTML = '';

        // Wrap each word and its letters in spans
        words.forEach(function(word) {
            var wordSpan = document.createElement('span');
            wordSpan.classList.add('word');
            wordSpan.innerHTML = word.replace(/\S/g, "<span class='letter'>$&</span>");
            textWrapper.appendChild(wordSpan);
            textWrapper.appendChild(document.createTextNode(' ')); // Add space between words
        });


        anime.timeline({loop: true})
            .add({
                targets: '.ml13 .letter',
                translateY: [100,0],
                translateZ: 0,
                opacity: [0,1],
                easing: "easeOutExpo",
                duration: 1400,
                delay: (el, i) => 300 + 30 * i
            }).add({
            targets: '.ml13 .letter',
            translateY: [0,-100],
            opacity: [1,0],
            easing: "easeInExpo",
            duration: 1200,
            delay: (el, i) => 100 + 30 * i
        });

        let themeStatus = JSON.parse(localStorage.getItem('REDEFINE-THEME-STATUS'))?.isDark;

        // If the theme status is not found in local storage, check the preferred color scheme
        if (themeStatus === undefined || themeStatus === null) {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                themeStatus = 'dark';
            } else {
                themeStatus = 'light';
            }
        }

        // Now you can use the themeStatus variable in your code
        if (themeStatus) {
            document.documentElement.style.setProperty('--preloader-background-color', '#202124');
            document.documentElement.style.setProperty('--preloader-text-color', '#fff');
        } else {
            document.documentElement.style.setProperty('--preloader-background-color', '#fff');
            document.documentElement.style.setProperty('--preloader-text-color', '#000');
        }

        window.addEventListener('load', function () {
            hidePreloaderAfterTimeout(1000); // Hide after 1000 milliseconds once the window has loaded
        });

        // Backup failsafe: Hide preloader after a maximum of 5000 milliseconds, regardless of the window load event
        hidePreloaderAfterTimeout(5000);

        function hidePreloaderAfterTimeout(delay) {
            setTimeout(function () {
                var preloader = document.querySelector('.preloader');
                preloader.style.opacity = '0';
                setTimeout(function () {
                    preloader.style.display = 'none';
                }, 200);
            }, delay);
        }
    </script>
</div>
    

    
<link rel="stylesheet" href="/css/style.css">


    
        <link rel="stylesheet" href="//evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/assets/build/styles.css">
    

    <link rel="stylesheet" href="//evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/fonts/fonts.css">
    <link rel="stylesheet" href="//evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/fonts/Satoshi/satoshi.css">
    <!--- Font Part-->
    
    
    
    


    <script id="hexo-configurations">
    window.config = {"hostname":"charles2530.github.io","root":"/","language":"en","path":"search.xml"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"title_alignment":"left","headings_top_spacing":{"h1":"5rem","h2":"4rem","h3":"2.8rem","h4":"2.5rem","h5":"2.2rem","h6":"2rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":true,"list":["lol","Neo","God"]},"code_block":{"copy":true,"style":"mac","font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":6,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"recommendation":{"enable":true,"title":"recommend_articles","limit":3,"mobile_limit":2,"placeholder":"https://charles2530.github.io/image/background/p3.jfif","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":"#1890ff","default_mode":"light"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":true},"scroll_progress":{"bar":true,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":true,"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"https://charles2530.github.io/image/background/background-light1.jpg","dark":"https://charles2530.github.io/image/background/background-dark1.jpg"},"title":"Charles's Castle","subtitle":{"text":["Happiness is best!","Never give up!","Everyday is a gift!"],"hitokoto":{"enable":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#000000","dark":"#d1d1b6"},"text_style":{"title_size":"3.2rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":true,"style":"center","links":{"github":"https://github.com/Charles2530/","zhihu":"https://www.zhihu.com/people/yang-guang-xiao-zi-55-55","email":"charles2530@163.com"},"qrs":{"weixin":"https://charles2530.github.io/image/background/Wechat_icon.png"}}},"plugins":{"feed":{"enable":true},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null},{"name":null,"artist":null,"url":null,"cover":null}]},"mermaid":{"enable":true,"version":"9.3.0"}},"version":"2.6.1","navbar":{"auto_hide":true,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Categories":{"path":"/categories","icon":"fas fa-bookmark"},"Tags":{"path":"/tags","icon":"fas fa-tags"},"About":{"icon":"fa-regular fa-user","submenus":{"Me":"/about","Github":"https://github.com/Charles2530/","Blog":"https://charles2530.github.io","Statistics":"https://tongji.baidu.com/"}}},"search":{"enable":true,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":"This is Charles's Castle","show_on_mobile":true,"links":{"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Photos":{"icon":"fa-solid fa-image","path":"/masonry/"},"Essays":{"icon":"fa-solid fa-message-lines","path":"/essay/"},"Friends":{"icon":"fa-solid fa-user-group","path":"/friends/"}}},"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2022/12/27 00:00:00"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":true};
  </script>
    
    <!--- Fontawesome Part-->
    <link rel="stylesheet" href="//evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/fontawesome/fontawesome.min.css">
    <link rel="stylesheet" href="//evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/fontawesome/brands.min.css">
    <link rel="stylesheet" href="//evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/fontawesome/solid.min.css">
    <link rel="stylesheet" href="//evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/fontawesome/regular.min.css">
    
    
    
    
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Charles's Castle" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
<!--        <span class="swup-progress-icon">-->
<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
<!--        </span>-->
    
</div>


<main class="page-container" id="swup">

    

    <div class="main-content-container">


        <div class="main-content-header">
            <header class="navbar-container px-6 md:px-12">

    <div class="navbar-content ">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="https://charles2530.github.io/image/background/logo.jpg">
                </a>
            
            <a class="logo-title" href="/">
                
                Charles&#39;s Castle
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/categories"
                                        >
                                    <i class="fas fa-bookmark fa-fw"></i>
                                    CATEGORIES
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/tags"
                                        >
                                    <i class="fas fa-tags fa-fw"></i>
                                    TAGS
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown"
                                   href="#"
                                        onClick=&#34;return false;&#34;>
                                    <i class="fa-regular fa-user fa-fw"></i>
                                    ABOUT
                                    <i class="fa-solid fa-chevron-down fa-fw"></i>
                                </a>

                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                        
                                            <li>
                                                <a href="/about">
                                                    ME
                                                </a>
                                            </li>
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://github.com/Charles2530/">
                                                    GITHUB
                                                </a>
                                            </li>
                                        
                                            <li>
                                                <a href="https://charles2530.github.io">
                                                    BLOG
                                                </a>
                                            </li>
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://tongji.baidu.com/">
                                                    STATISTICS
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-screen w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/categories"
                        >
                            <span>
                                CATEGORIES
                            </span>
                            
                                <i class="fas fa-bookmark fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/tags"
                        >
                            <span>
                                TAGS
                            </span>
                            
                                <i class="fas fa-tags fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item-sub text-base my-1.5 flex flex-col w-full">
                        
                        <div class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary cursor-pointer text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                             navbar-data-toggle="submenu-About"
                        >
                            <span>
                                ABOUT
                            </span>
                            
                                <i class="fa-solid fa-chevron-right fa-sm fa-fw transition-all"></i>
                            
                        </div>
                        

                        
                            <div class="flex-col items-start px-2 py-2 hidden" data-target="submenu-About">
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           href="/about">ME</a>
                                    </div>
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://github.com/Charles2530/">GITHUB</a>
                                    </div>
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           href="https://charles2530.github.io">BLOG</a>
                                    </div>
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://tongji.baidu.com/">STATISTICS</a>
                                    </div>
                                
                            </div>
                        
                    </li>
            

            
            
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/archives"
                        >
                            <span>Archives</span>
                            <i class="fa-regular fa-archive fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/masonry/"
                        >
                            <span>Photos</span>
                            <i class="fa-solid fa-image fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/essay/"
                        >
                            <span>Essays</span>
                            <i class="fa-solid fa-message-lines fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/friends/"
                        >
                            <span>Friends</span>
                            <i class="fa-solid fa-user-group fa-sm fa-fw"></i>
                        </a>
                    </li>
                
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">23</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">78</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">302</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="post-page-container flex relative justify-between box-border w-full h-full">
    <div class="article-content-container">

        <div class="article-title relative w-full">
            
                
                
                <img src="https://charles2530.github.io/image/background/p3.jpg" alt="SysY-compiler-design-doc" class="w-full h-60 sm:h-72 md:h-80 object-cover sm:rounded-t-large dark:brightness-75"/>
                
                <div class="w-full flex items-center absolute bottom-0 justify-start">
                    <h1 class="article-title-cover text-center mx-6 my-6 text-second-text-color bg-background-color-transparent px-4 py-3 text-3xl sm:text-4xl md:text-5xl font-bold backdrop-blur-lg rounded-xl border border-border-color ">SysY-compiler-design-doc</h1>
                </div>
            
            </div>

        
            <div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
                <div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
                    <img src="https://charles2530.github.io/image/background/logo2.jpg">
                </div>
                <div class="info flex flex-col justify-between">
                    <div class="author flex items-center">
                        <span class="name text-default-text-color text-lg font-semibold">Charles</span>
                        
                            <span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv7</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2023-09-19 10:28:17</span>
        <span class="mobile">2023-09-19 10:28:17</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2023-12-24 10:29:28</span>
            <span class="mobile">2023-12-24 10:29:28</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/Computer/">Computer</a>&nbsp;
                        </li>
                    
                    
                
                    
                        
                            <li>></li>
                        
                        <li>
                            <a href="/categories/Computer/Compiler/">Compiler</a>&nbsp;
                        </li>
                    
                    
                
                    
                        
                            <li>></li>
                        
                        <li>
                            <a href="/categories/Computer/Compiler/compiler-lab/">compiler-lab</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/compiler/">compiler</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fa-regular fa-typewriter"></i>&nbsp;<span>18.7k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fa-regular fa-clock"></i>&nbsp;<span>78 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        


        <div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
            <h1 id="sysy编译器设计文档"><a class="markdownIt-Anchor" href="#sysy编译器设计文档"></a> SysY编译器设计文档</h1>
<p><strong>姓名：杜金阳</strong></p>
<p><strong>学号：21373191</strong></p>
<h2 id="参考编译器介绍"><a class="markdownIt-Anchor" href="#参考编译器介绍"></a> 参考编译器介绍</h2>
<p>参考编译器采用Pascal语言，其中pl0-compiler这个编译器展示了非常完整的词法分析和语法分析的过程，流程非常工整，展现了代码生成前的基本思路，为我们设计自己的编译器提供了参考。而pascal-compiler这个编译器在此基础上变得更加细致了，支持了更多的文法规则，总而言之这两个编译器给我们带来了很大的帮助，为我们设计编译器打下了很好的基础。</p>
<h2 id="编译器总体设计"><a class="markdownIt-Anchor" href="#编译器总体设计"></a> 编译器总体设计</h2>
<blockquote>
<p>完整SysY编译器代码见——<a class="link"   target="_blank" rel="noopener" href="https://github.com/Charles2530/SysY_Compiler_2023" >SysY_Compiler_2023: 北航2023年编译原理源代码 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<p>编译器完整文法如下：</p>
<div class="highlight-container" data-rel="Markdown"><figure class="iseeu highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">编译单元    CompUnit → &#123;Decl&#125; &#123;FuncDef&#125; MainFuncDef  </span><br><span class="line">声明  Decl → ConstDecl | VarDecl</span><br><span class="line">常量声明    ConstDecl → &#x27;const&#x27; BType ConstDef &#123; &#x27;,&#x27; ConstDef &#125; &#x27;;&#x27; // i</span><br><span class="line">基本类型    BType → &#x27;int&#x27;</span><br><span class="line">常数定义    ConstDef → Ident &#123; &#x27;[&#x27; ConstExp &#x27;]&#x27; &#125; &#x27;=&#x27; ConstInitVal  // b k</span><br><span class="line">常量初值    ConstInitVal → ConstExp</span><br><span class="line"><span class="code">    | &#x27;&#123;&#x27; [ ConstInitVal &#123; &#x27;,&#x27; ConstInitVal &#125; ] &#x27;&#125;&#x27; </span></span><br><span class="line"><span class="code">变量声明    VarDecl → BType VarDef &#123; &#x27;,&#x27; VarDef &#125; &#x27;;&#x27; // i</span></span><br><span class="line"><span class="code">变量定义    VarDef → Ident &#123; &#x27;[&#x27; ConstExp &#x27;]&#x27; &#125; // b</span></span><br><span class="line"><span class="code">    | Ident &#123; &#x27;[&#x27; ConstExp &#x27;]&#x27; &#125; &#x27;=&#x27; InitVal // k</span></span><br><span class="line"><span class="code">变量初值    InitVal → Exp | &#x27;&#123;&#x27; [ InitVal &#123; &#x27;,&#x27; InitVal &#125; ] &#x27;&#125;&#x27;</span></span><br><span class="line"><span class="code">函数定义    FuncDef → FuncType Ident &#x27;(&#x27; [FuncFParams] &#x27;)&#x27; Block // b g j</span></span><br><span class="line"><span class="code">主函数定义   MainFuncDef → &#x27;int&#x27; &#x27;main&#x27; &#x27;(&#x27; &#x27;)&#x27; Block // g j</span></span><br><span class="line"><span class="code">函数类型    FuncType → &#x27;void&#x27; | &#x27;int&#x27; </span></span><br><span class="line"><span class="code">函数形参表   FuncFParams → FuncFParam &#123; &#x27;,&#x27; FuncFParam &#125; </span></span><br><span class="line"><span class="code">函数形参    FuncFParam → BType Ident [&#x27;[&#x27; &#x27;]&#x27; &#123; &#x27;[&#x27; ConstExp &#x27;]&#x27; &#125;]  //   b k</span></span><br><span class="line"><span class="code">语句块     Block → &#x27;&#123;&#x27; &#123; BlockItem &#125; &#x27;&#125;&#x27; </span></span><br><span class="line"><span class="code">语句块项    BlockItem → Decl | Stmt </span></span><br><span class="line"><span class="code">语句  Stmt → LVal &#x27;=&#x27; Exp &#x27;;&#x27; | [Exp] &#x27;;&#x27; | Block // h i</span></span><br><span class="line"><span class="code">    | &#x27;if&#x27; &#x27;(&#x27; Cond &#x27;)&#x27; Stmt [ &#x27;else&#x27; Stmt ] // j</span></span><br><span class="line"><span class="code">    | &#x27;for&#x27; &#x27;(&#x27;[ForStmt] &#x27;;&#x27; [Cond] &#x27;;&#x27; [ForStmt] &#x27;)&#x27; Stmt</span></span><br><span class="line"><span class="code">    | &#x27;break&#x27; &#x27;;&#x27; | &#x27;continue&#x27; &#x27;;&#x27; // i m</span></span><br><span class="line"><span class="code">    | &#x27;return&#x27; [Exp] &#x27;;&#x27; // f i</span></span><br><span class="line"><span class="code">    | LVal &#x27;=&#x27; &#x27;getint&#x27;&#x27;(&#x27;&#x27;)&#x27;&#x27;;&#x27; // h i j</span></span><br><span class="line"><span class="code">    | &#x27;printf&#x27;&#x27;(&#x27;FormatString&#123;,Exp&#125;&#x27;)&#x27;&#x27;;&#x27; // i j l</span></span><br><span class="line"><span class="code">语句 ForStmt → LVal &#x27;=&#x27; Exp   //h</span></span><br><span class="line"><span class="code">表达式 Exp → AddExp 注：SysY 表达式是int 型表达式 </span></span><br><span class="line"><span class="code">条件表达式   Cond → LOrExp </span></span><br><span class="line"><span class="code">左值表达式   LVal → Ident &#123;&#x27;[&#x27; Exp &#x27;]&#x27;&#125; // c k</span></span><br><span class="line"><span class="code">基本表达式   PrimaryExp → &#x27;(&#x27; Exp &#x27;)&#x27; | LVal | Number </span></span><br><span class="line"><span class="code">数值  Number → IntConst </span></span><br><span class="line"><span class="code">一元表达式   UnaryExp → PrimaryExp | Ident &#x27;(&#x27; [FuncRParams] &#x27;)&#x27; // c d e j</span></span><br><span class="line"><span class="code">        | UnaryOp UnaryExp </span></span><br><span class="line"><span class="code">单目运算符   UnaryOp → &#x27;+&#x27; | &#x27;−&#x27; | &#x27;!&#x27; 注：&#x27;!&#x27;仅出现在条件表达式中 </span></span><br><span class="line"><span class="code">函数实参表   FuncRParams → Exp &#123; &#x27;,&#x27; Exp &#125; </span></span><br><span class="line"><span class="code">乘除模表达式  MulExp → UnaryExp | MulExp (&#x27;*&#x27; | &#x27;/&#x27; | &#x27;%&#x27;) UnaryExp </span></span><br><span class="line"><span class="code">加减表达式   AddExp → MulExp | AddExp (&#x27;+&#x27; | &#x27;−&#x27;) MulExp </span></span><br><span class="line"><span class="code">关系表达式   RelExp → AddExp | RelExp (&#x27;&lt;&#x27; | &#x27;&gt;&#x27; | &#x27;&lt;=&#x27; | &#x27;&gt;=&#x27;) AddExp</span></span><br><span class="line"><span class="code">相等性表达式  EqExp → RelExp | EqExp (&#x27;==&#x27; | &#x27;!=&#x27;) RelExp</span></span><br><span class="line"><span class="code">逻辑与表达式  LAndExp → EqExp | LAndExp &#x27;&amp;&amp;&#x27; EqExp</span></span><br><span class="line"><span class="code">逻辑或表达式  LOrExp → LAndExp | LOrExp &#x27;||&#x27; LAndExp </span></span><br><span class="line"><span class="code">常量表达式   ConstExp → AddExp 注：使用的Ident 必须是常量</span></span><br><span class="line"><span class="code">格式字符串:  &lt;FormatString&gt; → &#x27;&quot;&#x27;&#123;&lt;Char&gt;&#125;&#x27;&quot;&#x27; // a</span></span><br></pre></td></tr></table></figure></div>
<h3 id="基于java语言设计"><a class="markdownIt-Anchor" href="#基于java语言设计"></a> 基于Java语言设计</h3>
<p>本SysY编译器选择了采用<strong>Java语言</strong>进行编写，充分发挥了Java<strong>面向对象编程</strong>的特点，这样相比于C++更有利于大工程的设计，但也带来了代码冗长的问题，所以本编译器及其重视设计一个好的架构以<strong>减少不必要的重构</strong>，并使代码风格更加易读。</p>
<h3 id="总体结构"><a class="markdownIt-Anchor" href="#总体结构"></a> 总体结构</h3>
<p>本编译器的总体设计结构参考了教程中的编译顺序，即<strong>词法分析</strong>、<strong>语法分析</strong>、<strong>错误处理</strong>、<strong>中间代码生成</strong>、<strong>生成mips代码</strong>、<strong>中端代码优化</strong>、<strong>后端代码优化</strong>几个部分，文件夹具体结构如下：</p>
<div class="highlight-container" data-rel="Markdown"><figure class="iseeu highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">├─backend</span><br><span class="line">│  ├─generation</span><br><span class="line">│  │  ├─mips</span><br><span class="line">│  │  │  └─asm</span><br><span class="line">│  │  │      ├─datasegment</span><br><span class="line">│  │  │      └─textsegment</span><br><span class="line">│  │  │          ├─complex</span><br><span class="line">│  │  │          ├─mipsinstr</span><br><span class="line">│  │  │          └─structure</span><br><span class="line">│  │  └─utils</span><br><span class="line">│  └─simplify</span><br><span class="line">│      └─method</span><br><span class="line">├─frontend</span><br><span class="line">│  ├─generation</span><br><span class="line">│  │  ├─lexer</span><br><span class="line">│  │  ├─semantic</span><br><span class="line">│  │  │  ├─symtable</span><br><span class="line">│  │  │  │  └─symbol</span><br><span class="line">│  │  │  │      └─varsymbol</span><br><span class="line">│  │  │  └─utils</span><br><span class="line">│  │  └─syntax</span><br><span class="line">│  │      ├─decl</span><br><span class="line">│  │      ├─funcdef</span><br><span class="line">│  │      ├─mainfuncdef</span><br><span class="line">│  │      └─utils</span><br><span class="line">│  └─simplify</span><br><span class="line">│      └─method</span><br><span class="line">├─iostream</span><br><span class="line">│  ├─declare</span><br><span class="line">│  └─structure</span><br><span class="line">└─midend</span><br><span class="line"><span class="code">    ├─generation</span></span><br><span class="line"><span class="code">    │  ├─llvm</span></span><br><span class="line"><span class="code">    │  ├─utils</span></span><br><span class="line"><span class="code">    │  │  └─irtype</span></span><br><span class="line"><span class="code">    │  └─value</span></span><br><span class="line"><span class="code">    │      ├─construction</span></span><br><span class="line"><span class="code">    │      │  ├─procedure</span></span><br><span class="line"><span class="code">    │      │  └─user</span></span><br><span class="line"><span class="code">    │      └─instr</span></span><br><span class="line"><span class="code">    │          ├─basis</span></span><br><span class="line"><span class="code">    │          └─optimizer</span></span><br><span class="line"><span class="code">    └─simplify</span></span><br><span class="line"><span class="code">        ├─controller</span></span><br><span class="line"><span class="code">        │  └─datastruct</span></span><br><span class="line"><span class="code">        └─method</span></span><br></pre></td></tr></table></figure></div>
<h2 id="词法分析"><a class="markdownIt-Anchor" href="#词法分析"></a> 词法分析</h2>
<h3 id="总体设计"><a class="markdownIt-Anchor" href="#总体设计"></a> 总体设计</h3>
<p>词法分析算是整个编译器设计较为简单的部分，承担的任务就是 <strong>通过扫描输入的源程序字符串，将其分割成一个个单词，同时记录这些单词的类别信息</strong> 。于此同时，词法分析还需要去除那些对于编译没用的符号，例如各种空白符和注释等。经过词法分析器的解析，我们就可以从词法分析器依次获取每个单词的信息，包括 <strong>单词值和单词类别</strong> ，用于后续的编译。</p>
<p>对此，我在词法分析设计方面主要设计了三个类来辅助<strong>词法分析处理</strong></p>
<ul>
<li><code>LexicalAnalysis</code>(词法分析器)——用于<strong>保存保留字</strong>，并根据单词<strong>生成对应的类别码</strong></li>
<li><code>LexicalWordCheck</code>(词法分类检查)——用于<strong>分割语句</strong>形成对应的词法单词，并负责词法分析过程的<strong>错误处理</strong></li>
<li><code>SymToken</code>(标识符存储单位)——用于<strong>存储词法分析形成的信息</strong>，包括每个单词的类别码、值、所在行数等</li>
</ul>
<p>具体而言，在<code>Compiler</code>主类中从文件中读取完整的源码，然后按行输入<code>LexicalAnalysis</code>进行分析，之后在<code>LexicalWordCheck</code>中由<code>if-else</code>分支语句进行类别判断，然后进入对应分支读取完整单词，得到一个<code>SymToken</code>实例，不断重复上述操作直到读到源码末尾。</p>
<ul>
<li>对于保留字采用<code>HashMap</code>进行查寻，保留字为键，类别码为值，当得到一个保留字单词就查询<code>HashMap</code>获得类别码</li>
<li>对于注释空白符跳过不识别，即直接读到注释之后的第一个字符</li>
<li>对于行号记录，在<code>Compiler</code>每次循环前将行号加一</li>
</ul>
<blockquote>
<p>注：考虑到评测系统为<code>Linux</code>系统于是对于要跳过的空白符需要注意判断<code>\r</code>的情况，当然也可以直接调用方法直接跳过空白符。</p>
</blockquote>
<h3 id="词法错误处理"><a class="markdownIt-Anchor" href="#词法错误处理"></a> 词法错误处理</h3>
<p>在词法分析部分，需要处理的词法分析错误只有一种—— <strong>字符串中出现非法字符</strong> 。除下面三类以外，均为非法字符——</p>
<ul>
<li>十进制编码为32,33,40-126的ASCII字符</li>
<li>（编码92）出现当且仅当为’\n’</li>
<li>&lt;FormatChar&gt;==&gt;’%d’</li>
</ul>
<p>判断使用正则表达式即可，注意要将%d和\n作为一个整体进行判断。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkIllegalSym</span><span class="params">(String word)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">legalSym</span> <span class="operator">=</span> <span class="string">&quot;\&quot;([ !()*+,\\-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ\\[\\]^_`abcdefghijklmnopqrstuvwxyz&#123;|&#125;~]|(%d)|(\\\\n))*\&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> !word.matches(legalSym);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h2 id="语法分析"><a class="markdownIt-Anchor" href="#语法分析"></a> 语法分析</h2>
<h3 id="总体设计-2"><a class="markdownIt-Anchor" href="#总体设计-2"></a> 总体设计</h3>
<p>语法分析部分的主要任务是让我们<strong>按照课程组给定的文法构造相应的抽象语法树(<code>AST</code>)，并输出后序遍历<code>AST</code>树的结果</strong>即可完成该部分任务。所以我采用在词法分析部分先进行<strong>一遍的扫描</strong>来获得词法分析分析出来的<code>token</code>集合，这样虽然理论上并没有边读词法边分析文法效率高，但如果综合考<strong>虑由于文法的<code>FIRST</code>集合的交集存在导致的词法预读现象</strong>，最终两种方式获得的分析效率其实相差无几，但预先分析出词法<code>token</code>集合可以很好地<strong>减少编码出现错误的概率</strong>，同时也可以使<strong>整个编译过程更加结构清晰，架构完整,实现高内聚低耦合</strong>。</p>
<p>而具体到语法分析部分使用的方法，我采用了<strong>递归下降子程序</strong>的方法来构建<code>AST</code>树，并通过设计<code>Definer</code>类和<code>Judge</code>类来<strong>避免了大量的重复造轮子</strong>的操作，具体操作细节请看下文。</p>
<h4 id="构造ast生成图辅助设计文法分析程序"><a class="markdownIt-Anchor" href="#构造ast生成图辅助设计文法分析程序"></a> 构造AST生成图辅助设计文法分析程序</h4>
<p>在参加了编译大赛的同学那里了解到了一个神器——<strong><code>antlr4</code></strong>，这是一个<code>IDEA</code>的插件，通过它只要你给定设计好的词法和文法，再给定符合词法和文法的程序，你就可以<strong>直观的看到相应代码建立<code>AST</code>树的结果</strong>，这将对我们更加深入理解文法分析的过程和之后的<code>debug</code>工作做出巨大的贡献。</p>
<blockquote>
<p>据说<code>antlr4</code>甚至可以直接帮你生成词法分析和语法分析程序，但这肯定是课程组不允许的，所以我就没有探索这部分的内容</p>
</blockquote>
<p>下图为用<code>antlr4</code>分析<code>helloworld</code>程序构造的语法树(由于每年的文法可能有差异，可能会有细微的不同)。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://charles2530.github.io/image/SysY-compiler-design-doc/parseTree.png"
                      alt="parseTree" 
                ></p>
<h4 id="改写左递归文法"><a class="markdownIt-Anchor" href="#改写左递归文法"></a> 改写左递归文法</h4>
<p>由于我采用的是递归下降分析法，所以<strong>为了避免死循环的出现</strong>，一个非常重要的步骤就是<strong>去除文法中的左递归</strong>(左递归会导致死循环应该编译理论课已经讲过了)，通过仔细分析课程组的文法，不难发现主要的左递归都出现在了<strong>Exp表达式</strong>那个部分中(如下图)，所以我们要找到合适的方法改写这部分左递归。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://charles2530.github.io/image/SysY-compiler-design-doc/image-20230926084756548.png"
                      alt="image-20230926084756548" 
                ></p>
<p>关于如何修改左递归，课程组已经在教程和语法分析的专题讲座中给我们了一部分的思路，所以具体而言我采用了<strong>改写为<code>BNF</code>范式并进行了少量修改以达到和课程组给定的<code>AST</code>树结构相同的目的</strong>，下面以<code>AddExp</code>和<code>MulExp</code>举例。</p>
<p>原本存在左递归的文法是这样的。</p>
<div class="highlight-container" data-rel="Markdown"><figure class="iseeu highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AddExp : MulExp | AddExp (&#x27;+&#x27; | &#x27;−&#x27;) MulExp</span><br><span class="line">MulExp : UnaryExp | MulExp (&#x27;<span class="emphasis">*&#x27; | &#x27;/&#x27; | &#x27;%&#x27;) UnaryExp</span></span><br></pre></td></tr></table></figure></div>
<p>所谓改写为<code>BNF</code>范式，具体而言通过观察不难发现，<code>AddExp</code>本质上是由若干个<code>MulExp</code>组成，<code>MulExp</code>本质上是由若干个<code>UnaryExp</code>组成，所以改写后的文法是这样的。</p>
<div class="highlight-container" data-rel="Markdown"><figure class="iseeu highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AddExp : MulExp &#123;(&#x27;+&#x27; | &#x27;−&#x27;) MulExp&#125;</span><br><span class="line">MulExp : UnaryExp &#123;(&#x27;<span class="emphasis">*&#x27; | &#x27;/&#x27; | &#x27;%&#x27;) UnaryExp&#125;</span></span><br></pre></td></tr></table></figure></div>
<p>这样我们就成功消除了左递归，但这就结束了吗，并不是，由于我们修改了文法，所以造成了我们的文法和课程组要求的<code>AST</code>树出现了结构上的差异，所以我们在实际编写代码时还需要进行一些小的修改，比如在生成<code>AddExp</code>时，可以在每次解析<code>('+' | '−') MulExp</code>之前，先将之前已经解析出的若干个<code>MulExp</code>合成一个<code>AddExp</code>，最后再将最终的<code>AddExp</code>加入调用该节点的父节点，<strong>具体到代码中实际就是一个不停更换父节点的过程</strong>，代码示例如下。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">AddExp</span><span class="params">(AstNode constExpNode)</span> &#123;</span><br><span class="line">    <span class="type">AstNode</span> <span class="variable">addExpNode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AstNode</span>(<span class="string">&quot;&lt;AddExp&gt;&quot;</span>);</span><br><span class="line">    MulExp(addExpNode);</span><br><span class="line">    <span class="type">AstNode</span> <span class="variable">father</span> <span class="operator">=</span> addExpNode;</span><br><span class="line">    <span class="keyword">while</span> (getPreSym().equals(<span class="string">&quot;PLUS&quot;</span>) || getPreSym().equals(<span class="string">&quot;MINU&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">// Removed part unimportant code</span></span><br><span class="line">        father = extraAddExpNode;</span><br><span class="line">        <span class="keyword">if</span> (getPreSym().equals(<span class="string">&quot;PLUS&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">// Removed part unimportant code</span></span><br><span class="line">            MulExp(father);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getPreSym().equals(<span class="string">&quot;MINU&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">// Removed part unimportant code</span></span><br><span class="line">            MulExp(father);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    constExpNode.addChild(father);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>这样左递归文法的问题就迎刃而解了。</p>
<h4 id="语法分析具体设计"><a class="markdownIt-Anchor" href="#语法分析具体设计"></a> 语法分析具体设计</h4>
<p>在<strong>语法分析</strong>部分，我认为是编译过程一个非常重要的过程，它可以帮助我们<strong>将词法分析获得的<code>token</code>集合进行进一步的分析，将其建立成结构化的语法树，以便于后续的编译</strong>。</p>
<p>而在实际编写代码的过程中，首先我建立了<code>SyntaxAnalysis</code>(语法分析类)、<code>AstNode</code>(抽象语法树节点类)两个类来负责<strong>语法树递归下降的调用和后序遍历的实现</strong>，并为建立<code>AST</code>树打下基础。</p>
<p>具体到递归下降部分而言，我首先根据课程给定文法的开始符号<code>CompUnit</code>的给定文法将建立了<code>AstRecursion</code>类来模拟递归下降过程的开始，并根据起始文法(如下图)将<code>CompUnit</code>分为了<code>Decl</code>，<code>FuncDef</code>和<code>MainFuncDef</code>三个类，从而编写分别属于这几个部分不被共用的语法部分。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://charles2530.github.io/image/SysY-compiler-design-doc/image-20230926093020645.png"
                      alt="image-20230926093020645" 
                ></p>
<p>之后我又编写了<code>Judge</code>类和<code>Definer</code>类来定义了<strong>在递归下降过程中上述三个部分需要共用的语法成分的判断条件和具体操作</strong>。这样在结构比较清晰的情况下我们就很好地实现了递归下降结构的设计，之后只需要按照给定的文法定义相关结构即可，在此不再具体赘述。</p>
<h4 id="处理预读操作"><a class="markdownIt-Anchor" href="#处理预读操作"></a> 处理预读操作</h4>
<p>在我的实际编码过程中，在处理<code>Stmt</code>时，由于<code>FIRST</code>集合存在交集，所以我们需要进行<strong>预读操作</strong>来将这两个成分分开，具体而言我定义了下面这个函数来获得相对于当前<code>token</code>的位置前几个或后几个<code>token</code>的具体值。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> SymToken <span class="title function_">getNextSymToken</span><span class="params">(<span class="type">int</span> pos)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (symPos + pos &gt; symTokens.size() - <span class="number">1</span> || symPos + pos &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> symTokens.get(symPos + pos);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>这样我们就可以更加灵活的定义条件来避免FIRST集有交集的情况出现了。</p>
<h3 id="语法错误处理"><a class="markdownIt-Anchor" href="#语法错误处理"></a> 语法错误处理</h3>
<p>在编写语法分析部分时，随着错误处理种类的不断增加，为了更好地提高错误处理的效率，所以我设计了**<code>ErrorController</code>类并在类中提供了错误类别码来辅助我进行相关的错误不同种类的识别和精确处理**。而在语法分析方面，我们主要要处理三类错误——<strong>缺少分号</strong>、<strong>缺少右小括号</strong>和<strong>缺少右中括号</strong>，这三种错误处理要求如下表。(注意是报错行号是给定符号<strong>前一个非终结符</strong>所在的行号)</p>
<table>
<thead>
<tr>
<th>错误类型</th>
<th>错误类别码</th>
<th>解释</th>
<th>对应文法</th>
</tr>
</thead>
<tbody>
<tr>
<td>缺少分号</td>
<td>i</td>
<td>报错行号为分号<strong>前一个非终结符</strong>所在行号。</td>
<td>&lt;Stmt&gt;,&lt;ConstDecl&gt;及&lt;VarDecl&gt;中的’;’</td>
</tr>
<tr>
<td>缺少右小括号</td>
<td>j</td>
<td>报错行号为右小括号<strong>前一个非终结符</strong>所在行号。</td>
<td>函数调用(&lt;UnaryExp&gt;)、函数定义(&lt;FuncDef&gt;)及&lt;Stmt&gt;中的’)’</td>
</tr>
<tr>
<td>缺少右中括号’]’</td>
<td>k</td>
<td>报错行号为右中括号<strong>前一个非终结符</strong>所在行号。</td>
<td>数组定义(&lt;ConstDef&gt;,&lt;VarDef&gt;,&lt;FuncFParam&gt;)和使用(&lt;LVal&gt;)中的’]’</td>
</tr>
</tbody>
</table>
<p>这三种错误处理还是比较简单的，只需要在文法读到相应的部分去申请一个<code>ErrorController</code>对象并填入相应的错误类别码即可，还是比较简单的。</p>
<h2 id="错误处理"><a class="markdownIt-Anchor" href="#错误处理"></a> 错误处理</h2>
<p>错误分析部分的主要任务是通过建立并<strong>管理符号表</strong>，从而实现对<strong>语义分析的控制</strong>，进而控制判断所建立的语法树中出现的语义错误。</p>
<blockquote>
<p>语法错误部分已经在之前的词法分析和语法分析中处理完成</p>
</blockquote>
<h3 id="符号表建立"><a class="markdownIt-Anchor" href="#符号表建立"></a> 符号表建立</h3>
<p>要想建立行之有效的语义分析模块，一个非常重要的先决条件就是建立符号表，本文设计的符号表建立在栈式符号表的基础上，<strong>通过下标模拟入栈退栈来实现了实际为“类树状结构”的栈式符号表</strong>。</p>
<h4 id="符号表的组成"><a class="markdownIt-Anchor" href="#符号表的组成"></a> 符号表的组成</h4>
<p>符号表由<code>Symbol</code>、<code>StackSymbolTable</code>、<code>SymbolTable</code>三部分组成。</p>
<h5 id="symbol"><a class="markdownIt-Anchor" href="#symbol"></a> Symbol</h5>
<p>本文创建了一个<code>Symbol</code>这一符号类，用于存储符号的基本信息。然后由该类派生出<code>VarSymbol</code>、<code>ConstSymbol</code>、<code>FuncSymbol</code>三个子类，用来存储不同类型符号的信息——</p>
<ul>
<li><strong><code>VarSymbol</code></strong>：变量名，变量值类型（int），变量维度，变量各维度的长度，变量初始值。</li>
<li><strong><code>ConstSymbol</code></strong>：常量名，常量值类型（int），常量维度，常量各维度的长度，常量初始值。</li>
<li><strong><code>FuncSymbol</code></strong>：函数名，函数返回值类型（int/void），函数各形参类型，函数各形参维度。</li>
</ul>
<blockquote>
<blockquote>
<p>通过符号表可以算出<strong>全局常量的具体值</strong>，与此同时全局变量的初始值可以在编译阶段计算出，因此对于非全局的常量和变量，其“变量初始值”一项为null</p>
</blockquote>
</blockquote>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Symbol</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">SymType</span> &#123;</span><br><span class="line">        INT, VOID, CONST</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> String symbolName;</span><br><span class="line">    <span class="keyword">private</span> SymType symbolType;</span><br><span class="line">    <span class="keyword">private</span> Integer symbolLevel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<ul>
<li>这里设计了枚举类<code>SymType</code>来区分函数的类型（<code>VOID</code>，<code>INT</code>）和变量的类型（<code>INT</code>，<code>CONST</code>），由于有变量维度dim的存在，所以不需要额外设计<code>ARRAY</code>和<code>CONST_ARRAY</code>类型来区分变量类型和数组类型。</li>
</ul>
<h5 id="stacksymboltable"><a class="markdownIt-Anchor" href="#stacksymboltable"></a> StackSymbolTable</h5>
<p>栈式符号表类<code>StackSymbolTable</code>可以是一层栈式符号表，存储了<strong>属于当前作用域的所有符号</strong>。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StackSymbolTable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> HashMap&lt;String, Symbol&gt; symbols;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<ul>
<li><code>symbols</code>的第一维存储的是这个作用域某个<code>symbol</code>的<code>name</code>，通过名字可以索引出这个对象。</li>
</ul>
<h5 id="symboltable"><a class="markdownIt-Anchor" href="#symboltable"></a> SymbolTable</h5>
<p>符号表类<code>SymbolTable</code>从全局角度管理了属于该程序的所有符号表，方便各层栈式符号表的<strong>入栈出栈</strong>及从全局的角度实现了各<code>symbol</code>的<strong>插入删除</strong>需求。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SymbolTable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> HashMap&lt;Integer, ArrayList&lt;StackSymbolTable&gt;&gt; symbolTables;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> isGlobalArea;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> loopLevel;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> FuncSymbol currentFunc;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> curLevel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<ul>
<li><code>symbolTables</code>第一维存储的是<strong>某栈式符号表所在的维数信息</strong>，第二维是一个数组存储了<strong>在这一维所有的栈式符号表信息</strong>。</li>
<li><code>isGlobalArea</code>记录了此时的<code>ConstDecl</code>和<code>VarDecl</code>是否为全局变量，从而决定是否适用<code>symCalc</code>调用符号表算出对应的值。</li>
<li><code>loopLevel</code>用于记录当前所处的循环维数，从而判断此时出现<code>break</code>和<code>continue</code>是否符合语义。</li>
<li><code>currentFunc</code>用于记录当前正在解析的函数所对应的符号，用与检查函数中是否出现不匹配的<code>return</code>语句。</li>
<li><code>curLevel</code>用于记录当前<code>symbolTable</code>所处的维数信息。</li>
</ul>
<h3 id="语义错误处理"><a class="markdownIt-Anchor" href="#语义错误处理"></a> 语义错误处理</h3>
<h4 id="错误处理总览"><a class="markdownIt-Anchor" href="#错误处理总览"></a> 错误处理总览</h4>
<table>
<thead>
<tr>
<th>错误类型</th>
<th>错误类别码</th>
<th>解释</th>
<th>对应文法及出错符号 ( … 表示省略该条规则后续部分)</th>
</tr>
</thead>
<tbody>
<tr>
<td>非法符号</td>
<td>a</td>
<td>格式字符串中出现非法字符报错行号为 <strong>&lt;FormatString&gt;</strong> 所在行数。</td>
<td>&lt;FormatString&gt; → ‘“‘{&lt;Char&gt;}’”</td>
</tr>
<tr>
<td>名字重定义</td>
<td>b</td>
<td>函数名或者变量名在<strong>当前作用域</strong>下重复定义。注意，变量一定是同一级作用域下才会判定出错，不同级作用域下，内层会覆盖外层定义。报错行号为 <strong>&lt;Ident&gt;</strong> 所在行数。</td>
<td>&lt;ConstDef&gt;→&lt;Ident&gt; … &lt;VarDef&gt;→&lt;Ident&gt; … &lt;Ident&gt; … &lt;FuncDef&gt;→&lt;FuncType&gt;&lt;Ident&gt; … &lt;FuncFParam&gt; → &lt;BType&gt; &lt;Ident&gt; …</td>
</tr>
<tr>
<td>未定义的名字</td>
<td>c</td>
<td>使用了未定义的标识符报错行号为 <strong>&lt;Ident&gt;</strong> 所在行数。</td>
<td>&lt;LVal&gt;→&lt;Ident&gt; … &lt;UnaryExp&gt;→&lt;Ident&gt; …</td>
</tr>
<tr>
<td>函数参数个数不匹配</td>
<td>d</td>
<td>函数调用语句中，参数个数与函数定义中的参数个数不匹配。报错行号为函数调用语句的<strong>函数名</strong>所在行数。</td>
<td>&lt;UnaryExp&gt;→&lt;Ident&gt;‘(’[&lt;FuncRParams&gt;]‘)’</td>
</tr>
<tr>
<td>函数参数类型不匹配</td>
<td>e</td>
<td>函数调用语句中，参数类型与函数定义中对应位置的参数类型不匹配。报错行号为函数调用语句的<strong>函数名</strong>所在行数。</td>
<td>&lt;UnaryExp&gt;→&lt;Ident&gt;‘(’[&lt;FuncRParams&gt;]‘)’</td>
</tr>
<tr>
<td>无返回值的函数存在不匹配的return语句</td>
<td>f</td>
<td>报错行号为 <strong>‘return’</strong> 所在行号。</td>
<td>&lt;Stmt&gt;→‘return’ {‘[’&lt;Exp&gt;’]’}‘;’</td>
</tr>
<tr>
<td>有返回值的函数缺少return语句</td>
<td>g</td>
<td>只需要考虑函数末尾是否存在return语句，<strong>无需考虑数据流</strong>。报错行号为函数<strong>结尾的’}’</strong> 所在行号。</td>
<td>&lt;FuncDef&gt; → &lt;FuncType&gt; &lt;Ident&gt; ‘(’ [&lt;FuncFParams&gt;] ‘)’ &lt;Block&gt; &lt;MainFuncDef&gt; → ‘int’ ‘main’ ‘(’ ‘)’ &lt;Block&gt;</td>
</tr>
<tr>
<td>不能改变常量的值</td>
<td>h</td>
<td>&lt;LVal&gt;为常量时，不能对其修改。报错行号为 <strong>&lt;LVal&gt;</strong> 所在行号。</td>
<td>&lt;Stmt&gt;→&lt;LVal&gt;‘=’ &lt;Exp&gt;‘;’ &lt;Stmt&gt;→&lt;LVal&gt;‘=’ ‘getint’ ‘(’ ‘)’ ‘;’</td>
</tr>
<tr>
<td>缺少分号</td>
<td>i</td>
<td>报错行号为分号<strong>前一个非终结符</strong>所在行号。</td>
<td>&lt;Stmt&gt;,&lt;ConstDecl&gt;及&lt;VarDecl&gt;中的’;’</td>
</tr>
<tr>
<td>缺少右小括号’)’</td>
<td>j</td>
<td>报错行号为右小括号<strong>前一个非终结符</strong>所在行号。</td>
<td>函数调用(&lt;UnaryExp&gt;)、函数定义(&lt;FuncDef&gt;)及&lt;Stmt&gt;中的’)’</td>
</tr>
<tr>
<td>缺少右中括号’]’</td>
<td>k</td>
<td>报错行号为右中括号<strong>前一个非终结符</strong>所在行号。</td>
<td>数组定义(&lt;ConstDef&gt;,&lt;VarDef&gt;,&lt;FuncFParam&gt;)和使用(&lt;LVal&gt;)中的’]’</td>
</tr>
<tr>
<td>printf中格式字符与表达式个数不匹配</td>
<td>l</td>
<td>报错行号为 <strong>‘printf’</strong> 所在行号。</td>
<td>&lt;Stmt&gt; →‘printf’‘(’&lt;FormatString&gt;{,&lt;Exp&gt;}’)’‘;’</td>
</tr>
<tr>
<td>在非循环块中使用break和continue语句</td>
<td>m</td>
<td>报错行号为 <strong>‘break’</strong> 与 <strong>’continue’</strong> 所在行号。</td>
<td>&lt;Stmt&gt;→‘break’‘;’ &lt;Stmt&gt;→‘continue’‘;’</td>
</tr>
</tbody>
</table>
<ul>
<li>在上文所示的表格中，a,i,j,k属于<strong>语法错误</strong>，已经在之前<strong>词法分析</strong>和<strong>语法分析</strong>部分完成了处理</li>
</ul>
<h4 id="语义分析单元"><a class="markdownIt-Anchor" href="#语义分析单元"></a> 语义分析单元</h4>
<h5 id="errorcontroller和errortoken"><a class="markdownIt-Anchor" href="#errorcontroller和errortoken"></a> ErrorController和ErrorToken</h5>
<p>和之前处理语法错误类似，各种语义错误也需要在<code>ErrorController</code>中设置相关的错误处理函数，由于题目要求输出错误需要按照行号顺序依次输出，所以我们需要先用容器将相关的错误信息存储下来，之后再按照行号大小进行排序后统一输出，所以我重新建立了错误符号类<code>ErrorToken</code>来存储每个错误的错误码及行号等信息，并在<code>ErrorController</code>中统一输出。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ErrorToken</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String errorCategoryCode;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> lineNum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<ul>
<li><code>errorCategoryCode</code>为当前的错误码，<code>lineNum</code>为出现该错误时的行号</li>
</ul>
<h5 id="span"><a class="markdownIt-Anchor" href="#span"></a> Span</h5>
<p>语义分析中有许多部分要求我们输出某个非终结符的行号，但在之前的设计中只有词法分析部分记录了所有终结符的行号信息，于此同时记录各个部分所处的行号范围对后续的<code>debug</code>过程也有着巨大的帮助，所有我设计了范围类<code>Span</code>来记录符号集中各符号所处的范围起始行数和终结行数信息。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Span</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> startLine;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> endLine;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h5 id="语义分析处理"><a class="markdownIt-Anchor" href="#语义分析处理"></a> 语义分析处理</h5>
<p>在语义分析处理部分我写了四个工具类<code>symChecker</code>，<code>symDefiner</code>,<code>symType</code>,<code>symCalc</code>来辅助我建立符号表并输出错误信息。</p>
<blockquote>
<p>下面给出各个工具类的部分代码</p>
</blockquote>
<ul>
<li><code>symChecker</code>类：检查类，用于对各个<code>AstNode</code>进行错误检查并输出对应的<code>Symbol</code>变量。</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">check</span><span class="params">(AstNode rootAst)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">switch</span> (rootAst.getGrammarType()) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;CompUnit&gt;&quot;</span>:</span><br><span class="line">            checkCompUnitChecker(rootAst);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;ConstDef&gt;&quot;</span>:</span><br><span class="line">            <span class="comment">// Error b</span></span><br><span class="line">            checkConstDefChecker(rootAst);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;VarDef&gt;&quot;</span>:</span><br><span class="line">            <span class="comment">// Error b</span></span><br><span class="line">            checkVarDefChecker(rootAst);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;Block&gt;&quot;</span>:</span><br><span class="line">            checkBlockChecker(rootAst);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;FORTK&quot;</span>:</span><br><span class="line">            checkForStmtChecker(rootAst);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;BREAKTK&quot;</span>:</span><br><span class="line">            <span class="comment">// Error m</span></span><br><span class="line">            checkBreakStmtChecker(rootAst);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;CONTINUETK&quot;</span>:</span><br><span class="line">            <span class="comment">// Error m</span></span><br><span class="line">            checkContinueStmtChecker(rootAst);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;RETURNTK&quot;</span>:</span><br><span class="line">            <span class="comment">// Error f</span></span><br><span class="line">            checkReturnStmtChecker(rootAst);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;LVal&gt;&quot;</span>:</span><br><span class="line">            <span class="comment">// Error c</span></span><br><span class="line">            checkLValChecker(rootAst);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;FuncDef&gt;&quot;</span>:</span><br><span class="line">            <span class="comment">// Error b,g</span></span><br><span class="line">            checkFuncDefChecker(rootAst);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;FuncFParam&gt;&quot;</span>:</span><br><span class="line">            <span class="comment">// Error b</span></span><br><span class="line">            checkFuncFParamChecker(rootAst);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;MainFuncDef&gt;&quot;</span>:</span><br><span class="line">            <span class="comment">// Error b,g</span></span><br><span class="line">            checkMainFuncDefChecker(rootAst);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;ASSIGN&quot;</span>:</span><br><span class="line">            <span class="comment">// Error h</span></span><br><span class="line">            checkASSIGNChecker(rootAst);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;UnaryExp&gt;&quot;</span>:</span><br><span class="line">            <span class="comment">// Error b,c,d,e</span></span><br><span class="line">            checkUnaryExpChecker(rootAst);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;PRINTFTK&quot;</span>:</span><br><span class="line">            <span class="comment">// Error l</span></span><br><span class="line">            checkPRINTFTKChecker(rootAst);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            SemanticAnalysis.preTraverse(rootAst);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<ul>
<li><code>symDefiner</code>类：工具类，用于对<code>AstNode</code>进行一些辅助操作，如给函数引入形式参数，求解某个<code>Exp</code>对应的类型维数信息等。</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setParamInfo</span><span class="params">(AstNode astNode, FuncSymbol symbol)</span> &#123;</span><br><span class="line">    ... ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title function_">getExpDim</span><span class="params">(AstNode astNode)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (astNode.getGrammarType()) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;Number&gt;&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> getExpDimNumber(astNode);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;LVal&gt;&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> getExpDimLVal(astNode);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;UnaryExp&gt;&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> getExpDimUnaryExp(astNode);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;PrimaryExp&gt;&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> getExpDimPrimaryExp(astNode);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> getExpDim(astNode.getChildList().get(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<ul>
<li><code>symType</code>类：类别类，利用递归下降求解某变量或函数对应的参数类型。</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Symbol.SymType <span class="title function_">getExpType</span><span class="params">(AstNode astNode)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (astNode.getGrammarType()) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;Number&gt;&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> getExpTypeNumber(astNode);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;LVal&gt;&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> getExpTypeLVal(astNode);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;UnaryExp&gt;&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> getExpTypeUnaryExp(astNode);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;PrimaryExp&gt;&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> getExpTypePrimaryExp(astNode);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> getExpType(astNode.getChildList().get(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<ul>
<li><code>symCalc</code>类：计算类，书写了大量计算函数，用于计算可以立即被符号表计算出结果的信息，如全局变量区的<code>VarDef</code>和<code>ConstDef</code>的初始值。</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">calc</span><span class="params">(AstNode astNode)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (astNode.getGrammarType()) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;Exp&gt;&quot;</span>, <span class="string">&quot;&lt;ConstExp&gt;&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> calc(astNode.getChildList().get(<span class="number">0</span>));</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;AddExp&gt;&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> calcAddExp(astNode);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;MulExp&gt;&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> calcMulExp(astNode);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;UnaryExp&gt;&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> calcUnaryExp(astNode);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;PrimaryExp&gt;&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> calcPrimaryExp(astNode);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;Number&gt;&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> calcNumber(astNode);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;LVal&gt;&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> calcLValExp(astNode);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>通过上面定义的这些工具类，我们就可以很有效的处理各种语义错误了。具体调用方法就是和语法分析过程类似，通过一个后续遍历让每个<code>astNode</code>调用<code>check</code>函数来按照顺序检查每个变量即可。</p>
<h5 id="函数参数匹配问题"><a class="markdownIt-Anchor" href="#函数参数匹配问题"></a> 函数参数匹配问题</h5>
<p>在这次作业中，相比下比较困难的部分时我们需要处理函数参数个数和维度匹配的问题。函数参数个数匹配比较简单，难的是函数维度的匹配（维度匹配包括维度个数的匹配、各维度长度的比较）。有些变量在定义时，纬度的长度不是简单的常数，而是用常量表达式（即<code>ConstInitVal</code>）来表示长度。因此，为了能够进行匹配，我们需要进行在编译时将该长度计算出来。本文采用的方法是，给<code>Exp</code>、<code>MulExp</code>、<code>AddExp</code>等类都编写一个<code>evaluate</code>方法。在需要计算<code>Exp</code>的值时，即调用<code>Exp</code>的<code>evaluate</code>方法，在这个方法中又调用<code>AddExp</code>的<code>evaluate</code>……以此类推，最终<code>Exp</code>的<code>evaluate</code>返回的就是整个表达式的值。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; paramNum; i++) &#123;</span><br><span class="line">    Symbol.<span class="type">SymType</span> <span class="variable">paramType</span> <span class="operator">=</span> funcSymbol.getFparamTypes().get(i);</span><br><span class="line">    Symbol.<span class="type">SymType</span> <span class="variable">argType</span> <span class="operator">=</span> SymTypeJudge.getExpType(childList.get(i));</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">paramdim</span> <span class="operator">=</span> funcSymbol.getFparamDims().get(i);</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">argdim</span> <span class="operator">=</span> SymDefiner.getExpDim(childList.get(i));</span><br><span class="line">    <span class="keyword">if</span> (!paramType.equals(argType) || !paramdim.equals(argdim)) &#123;</span><br><span class="line">        ErrorController.addError(<span class="keyword">new</span> <span class="title class_">ErrorToken</span>(<span class="string">&quot;e&quot;</span>,rootAst.getSpan().getStartLine()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h2 id="中间代码生成"><a class="markdownIt-Anchor" href="#中间代码生成"></a> 中间代码生成</h2>
<p>中间代码生成主要分为<strong>两个重要部分</strong>，第一个是重新进行语义分析<strong>重建栈式符号表</strong>从而将各个部分<strong>转化为<code>llvm_ir</code><strong>的格式，另一个重要任务是利用<code>llvm</code>中一切皆value的思想</strong>重新建立起一棵由不同种类的value组成的新语法树</strong>，最后生成中间代码其实就是对新语法树的一个<strong>后序遍历</strong>过程。</p>
<h3 id="llvm_ir转化"><a class="markdownIt-Anchor" href="#llvm_ir转化"></a> <code>llvm_ir</code>转化</h3>
<p>要想实现<code>llvm_ir</code>的转化，我们首先需要<strong>清空之前错误处理时建立的符号表</strong>，并重新开始<code>AST</code>的遍历，并将遍历到的各种不同成分的<code>AstNode</code>进行处理即可，遍历及处理的代码如下：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//GenerationMain.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">preTraverse</span><span class="params">(AstNode rootAst)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (rootAst.isLeaf()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (AstNode astNode : rootAst.getChildList()) &#123;</span><br><span class="line">        GenerationMain.llvmGenIR.genIrAnalysis(astNode);</span><br><span class="line">        <span class="keyword">if</span> (astNode.getGrammarType().matches(</span><br><span class="line">            <span class="string">&quot;IFTK|FORTK|BREAKTK|CONTINUETK|RETURNTK|PRINTFTK|ASSIGN&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//LLvmGenIr.java</span></span><br><span class="line"><span class="keyword">public</span> Value <span class="title function_">genIrAnalysis</span><span class="params">(AstNode rootAst)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">switch</span> (rootAst.getGrammarType()) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;CompUnit&gt;&quot;</span> -&gt; genIrCompUnitChecker(rootAst);</span><br><span class="line">            <span class="comment">//Definer.java</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;ConstDef&gt;&quot;</span> -&gt; genIrConstDefChecker(rootAst);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;VarDef&gt;&quot;</span> -&gt; genIrVarDefChecker(rootAst);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;Block&gt;&quot;</span> -&gt; genIrBlockChecker(rootAst);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;IFTK&quot;</span> -&gt; genIrIfStmtChecker(rootAst);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;FORTK&quot;</span> -&gt; genIrForStmtChecker(rootAst);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;BREAKTK&quot;</span> -&gt; genIrBreakStmtChecker();</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;CONTINUETK&quot;</span> -&gt; genIrContinueStmtChecker();</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;RETURNTK&quot;</span> -&gt; genIrReturnStmtChecker(rootAst);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;PRINTFTK&quot;</span> -&gt; genIrPrintStmtChecker(rootAst);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;Exp&gt;&quot;</span>,<span class="string">&quot;&lt;ConstExp&gt;&quot;</span> -&gt; genIrExpChecker(rootAst);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;PrimaryExp&gt;&quot;</span> -&gt; genIrPrimaryExpChecker(rootAst);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;Number&gt;&quot;</span> -&gt; genIrNumberCallChecker(rootAst);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;UnaryExp&gt;&quot;</span> -&gt; genIrUnaryExpChecker(rootAst);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;MulExp&gt;&quot;</span> -&gt; genIrMulExpChecker(rootAst);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;AddExp&gt;&quot;</span> -&gt; genIrAddExpChecker(rootAst);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;RelExp&gt;&quot;</span> -&gt; genIrRelExpChecker(rootAst);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;EqExp&gt;&quot;</span> -&gt; genIrEqExpChecker(rootAst);</span><br><span class="line">            <span class="comment">//FuncDef.java</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;FuncDef&gt;&quot;</span> -&gt; genIrFuncDefChecker(rootAst);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;FuncFParam&gt;&quot;</span> -&gt; genIrFuncFParamChecker(rootAst);</span><br><span class="line">            <span class="comment">//MainFuncDef.java</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;MainFuncDef&gt;&quot;</span> -&gt; genIrMainFuncDefChecker(rootAst);</span><br><span class="line">            <span class="comment">//Lexer_part</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;ASSIGN&quot;</span> -&gt; genIrAssignChecker(rootAst);</span><br><span class="line">        <span class="keyword">default</span> -&gt; &#123;</span><br><span class="line">            GenerationMain.preTraverse(rootAst);</span><br><span class="line">            <span class="keyword">yield</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>这里需要注意，由于文法分析的限制，所以我们在<strong>判断<code>stmt</code>的具体种类</strong>时不可避免的需要用到叶子节点，而叶子节点访问后需要回溯到其父节点进行对应的处理，这样就会<strong>造成二次访问</strong>，所以我们需要在其叶节点进行过一次访问后跳出循环。</p>
<p>由于<code>llvm</code>中有着<strong>一切皆<code>value</code>的思想</strong>，所以我们可以选择将该函数的<strong>返回值</strong>改为<code>Value</code>，这样就可以在处理之后归于统一，从而维护更好的代码风格也更有利于管理。除此之外，在实际进行处理时，我发现有许多方法可以重复复用，所以我建立了<code>LLvmGenUtils</code>类来<strong>处理这些可以重用的轮子</strong>。</p>
<h4 id="for循环的处理"><a class="markdownIt-Anchor" href="#for循环的处理"></a> <code>For</code>循环的处理</h4>
<p>在实际操作时，<code>for</code>循环给我带来了不少的麻烦，主要相比于<code>while</code>循环，<code>for</code>循环的<code>forstmt</code>和<code>cond</code>均可以<strong>缺省</strong>，这也就导致在实际转化为<code>llvm</code>时产生的<code>BasicBlock</code>的数量会动态变化，可以说是一大难点了，需要重点注意,下面为我处理<code>for</code>循环转化部分的代码。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Value <span class="title function_">genIrForStmtChecker</span><span class="params">(AstNode sonAst)</span> &#123;</span><br><span class="line">    <span class="type">AstNode</span> <span class="variable">rootAst</span> <span class="operator">=</span> sonAst.getParent();</span><br><span class="line">    <span class="type">AstNode</span> <span class="variable">forStmtVal1</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">AstNode</span> <span class="variable">condAst</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">AstNode</span> <span class="variable">forStmtVal2</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; rootAst.getChildList().size(); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (rootAst.getChildList().get(i).getGrammarType().equals(<span class="string">&quot;&lt;ForStmt&gt;&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">2</span>) &#123;</span><br><span class="line">                forStmtVal1 = rootAst.getChildList().get(i);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                forStmtVal2 = rootAst.getChildList().get(i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rootAst.getChildList().get(i).getGrammarType().equals(<span class="string">&quot;&lt;Cond&gt;&quot;</span>)) &#123;</span><br><span class="line">            condAst = rootAst.getChildList().get(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (forStmtVal1 != <span class="literal">null</span>) &#123;</span><br><span class="line">        genIrAnalysis(forStmtVal1);</span><br><span class="line">    &#125;</span><br><span class="line">    SymbolTable.enterLoop();</span><br><span class="line">    <span class="type">BasicBlock</span> <span class="variable">condBlock</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (condAst != <span class="literal">null</span>) &#123;</span><br><span class="line">        condBlock = <span class="keyword">new</span> <span class="title class_">BasicBlock</span>(IrNameController.getBlockName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">BasicBlock</span> <span class="variable">currentLoopBlock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicBlock</span>(IrNameController.getBlockName());</span><br><span class="line">    <span class="type">BasicBlock</span> <span class="variable">followBlock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicBlock</span>(IrNameController.getBlockName());</span><br><span class="line">    IrNameController.pushLoop(<span class="keyword">new</span> <span class="title class_">Loop</span>(forStmtVal1, condBlock,</span><br><span class="line">                                       forStmtVal2, currentLoopBlock, followBlock));</span><br><span class="line">    <span class="keyword">if</span> (condAst != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">JumpInstr</span>(condBlock);</span><br><span class="line">        IrNameController.setCurrentBlock(condBlock);</span><br><span class="line">        llvmGenUtils.genCondIr(condAst, currentLoopBlock, followBlock);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">JumpInstr</span>(currentLoopBlock);</span><br><span class="line">    &#125;</span><br><span class="line">    IrNameController.setCurrentBlock(currentLoopBlock);</span><br><span class="line">    genIrAnalysis(rootAst.getChildList().get(rootAst.getChildList().size() - <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">if</span> (forStmtVal2 != <span class="literal">null</span>) &#123;</span><br><span class="line">        genIrAnalysis(forStmtVal2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (condAst != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">JumpInstr</span>(condBlock);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">JumpInstr</span>(currentLoopBlock);</span><br><span class="line">    &#125;</span><br><span class="line">    IrNameController.setCurrentBlock(followBlock);</span><br><span class="line">    IrNameController.popLoop();</span><br><span class="line">    SymbolTable.leaveLoop();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="变量名重定义"><a class="markdownIt-Anchor" href="#变量名重定义"></a> 变量名重定义</h4>
<p>在实际生成<code>llvm</code>中间代码的过程中，对<strong>虚拟寄存器的命名</strong>获得是一个非常重要的步骤，我们知道虚拟寄存器的命名有两种方式——<strong>使用数字递增顺序</strong>和<strong>使用字符串变量命名</strong>，前者难度较大且容易出错，可读性也较差，所以笔者选用了使用字符串变量命名的方法来获得虚拟寄存器的名称。</p>
<p>具体而言，笔者建立了<code>IrNameController</code>类和<code>IrPrefix</code>类来进行名称获取的管理。</p>
<ul>
<li><code>IrNameController</code>类用于定义了一些静态方法来使每次调用时都可以<strong>动态的产生新的名字</strong>。</li>
<li><code>IrPrefix</code>类按照虚拟寄存器的不同作用为这些命名加上对应的前缀使代码的可读性得以增强，是一个<strong>枚举类</strong>。</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//IrNameController.java</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> HashMap&lt;Function, Integer&gt; blockNameIndexHashMap;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Integer paramNameIndex;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Integer stringLiteralNameIndex;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> HashMap&lt;Function, Integer&gt; localVarNameIndexHashMap;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getLocalVarName</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">localVarNameIndex</span> <span class="operator">=</span> localVarNameIndexHashMap.get(currentFunction);</span><br><span class="line">    localVarNameIndexHashMap.put(currentFunction, localVarNameIndex + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> IrPrefix.LOCAL_VAR_NAME.toString() + localVarNameIndex;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getBlockName</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">blockNameIndex</span> <span class="operator">=</span> blockNameIndexHashMap.get(currentFunction);</span><br><span class="line">    blockNameIndexHashMap.put(currentFunction, blockNameIndex + <span class="number">1</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">funcName</span> <span class="operator">=</span> currentFunction.getName().equals(<span class="string">&quot;@main&quot;</span>) ? <span class="string">&quot;main&quot;</span> :</span><br><span class="line">    currentFunction.getName().substring(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">return</span> funcName + <span class="string">&quot;_&quot;</span> + IrPrefix.BB_NAME + blockNameIndex;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getGlobalVarName</span><span class="params">(String varName)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> IrPrefix.GLOBAL_VAR_NAME + varName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getParamName</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> IrPrefix.PARAM_NAME.toString() + paramNameIndex++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getStringLiteralName</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> IrPrefix.STRING_LITERAL_NAME.toString() + stringLiteralNameIndex++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getFuncName</span><span class="params">(String funcName)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (funcName.equals(<span class="string">&quot;main&quot;</span>)) ? <span class="string">&quot;@main&quot;</span> : IrPrefix.FUNC_NAME + funcName;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//IrPrefix.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">IrPrefix</span> &#123;</span><br><span class="line">    BB_NAME(<span class="string">&quot;block_label_&quot;</span>),<span class="comment">//基本块名</span></span><br><span class="line">    FUNC_NAME(<span class="string">&quot;@f_&quot;</span>),<span class="comment">//函数名</span></span><br><span class="line">    GLOBAL_VAR_NAME(<span class="string">&quot;@g_&quot;</span>),<span class="comment">//全局变量名</span></span><br><span class="line">    LOCAL_VAR_NAME(<span class="string">&quot;%v_&quot;</span>),<span class="comment">//局部变量名</span></span><br><span class="line">    PARAM_NAME(<span class="string">&quot;%a_&quot;</span>),<span class="comment">//参数名</span></span><br><span class="line">    STRING_LITERAL_NAME(<span class="string">&quot;@s_&quot;</span>);<span class="comment">//字符串字面量名</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String prefix;</span><br><span class="line"></span><br><span class="line">    IrPrefix(String prefix) &#123;</span><br><span class="line">        <span class="built_in">this</span>.prefix = prefix;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> prefix;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h3 id="value语法树建立"><a class="markdownIt-Anchor" href="#value语法树建立"></a> <code>Value</code>语法树建立</h3>
<h4 id="一切皆value"><a class="markdownIt-Anchor" href="#一切皆value"></a> 一切皆<code>value</code></h4>
<p><code>LLVM</code>中的核心观点就是“一切皆<code>Value</code>”，所以我选择建立的<code>value</code>类作为所有<code>value</code>语法树的公共父节点，最终建立的继承结构如下图</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://charles2530.github.io/image/SysY-compiler-design-doc/image-20231025204943210.png"
                      alt="image-20231025204943210" 
                ></p>
<p>具体而言，对于我们所生成的中间代码，可以理解为就是一个以<code>module</code>为根节点的语法树，而<code>module</code>中由<strong>字符串字面值列表</strong>、<strong>全局变量列表</strong>和<strong>函数列表</strong>三个部分组成，而这三个部分又可以依次向下展开，也就形成了树结构的基本样式。对于该结构而言，字符串列表和全局变量都比较简单，所以我这里重点介绍一下<strong>函数列表</strong>的结构。</p>
<h5 id="function结构"><a class="markdownIt-Anchor" href="#function结构"></a> <code>Function</code>结构</h5>
<p><code>Function</code>函数主要分为<strong>参数列表</strong>和<strong>基本块列表</strong>两个部分，参数列表较为容易实现，而基本块则是一个相对陌生的概念，所以我在正式展开介绍前先介绍一下基本块的概念。</p>
<p>所谓基本块，就是<strong>代码中可以连续执行的最大序列</strong>，简而言之就是对于一个基本块而言，程序的执行（控制流）只能从基本块的第一条语句进入，只能从基本块的最后一条语句离开，符合这样的条件的代码段就是一个基本块，在我们完成基本块的划分后，后续的中间代码优化都是建立在<strong>基本块的块内逻辑和块间逻辑</strong>上的，所以将一个函数划分成多个基本块是非常重要的。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Function</span> <span class="keyword">extends</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IrType returnType;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;BasicBlock&gt; basicBlocks;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;Param&gt; params;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>那我们应该如何划分基本块呢，有一个非常重要的部分就是<strong>跳转语句</strong>，因为只有遇到跳转语句后才会使得我们的代码段不再连续，这样也就自然形成的基本块的划分。</p>
<p>而在<code>BasicBlock</code>内部是由一系列指令<code>Instr</code>和所属函数的指针组成的，所以我们在之前转化<code>llvm_ir</code>的过程中其实本质就是不断将<code>AST</code>中建立的各种<strong>函数变量</strong>和<strong>符号变量</strong>转化成一条条指令装入<code>BasicBlock</code>的过程。</p>
<h5 id="instr类型"><a class="markdownIt-Anchor" href="#instr类型"></a> Instr类型</h5>
<p><code>Instr</code>指令部分我分成了<code>basis</code>和<code>optimizer</code>两部分分别表示<strong>基本指令</strong>和<strong>优化指令</strong>，其中优化指令是后续代码优化需要用到的如phi等指令，而基本指令我分为了<code>AllocaInstr</code>、<code>BrInstr</code>、<code>CalcInstr</code>、<code>CallInstr</code>、<code>GetEleInstr</code>、<code>IcmpInstr</code>、<code>JumpInstr</code>、<code>LoadInstr</code>、<code>RetInstr</code>、<code>StoreInstr</code>、<code>TruncInstr</code>、<code>ZextInstr</code>等，之后按照不同指令需要的操作数不同各自重写相应的<code>toString</code>方法即可。</p>
<p>值得一提的是，这里我们终于使用到了上述结构中定义的<code>User</code>类，这个类是所有需要用到<strong>操作数</strong>的类的公共父类，在他其中定义了一个<code>protected</code>属性的<code>operands</code>操作数集合，并定义了各种操作数可以使用的方法，从而使其子类调用方法时更加便利。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">extends</span> <span class="title class_">Value</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> ArrayList&lt;Value&gt; operands;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="类型管理"><a class="markdownIt-Anchor" href="#类型管理"></a> 类型管理</h4>
<p>为了更好的区分各种变量的类型，所以我们不可避免的需要<strong>建立类型类</strong>并加以管理，具体而言我建立了<code>IrType</code>类并在其下方继承了四个子类<code>ArrayType</code>，<code>PointerType</code>，<code>StructType</code>和<code>VarType</code>分别表示<strong>数组类型</strong>、<strong>指针类型</strong>、<strong>结构类型</strong>和<strong>变量类型</strong>，其中结构类型是语法树中一些非叶子节点所属的类型，如<code>BasicBlock</code>。建立好这些类型类之后，我们就可以在其中重写<code>toString</code>方法，这样可以避免大量重复造轮子的需求。</p>
<h4 id="二维数组"><a class="markdownIt-Anchor" href="#二维数组"></a> 二维数组</h4>
<p>在实际操作中，二维数组的处理毫无疑问是一大难点，仅仅它的<code>toString</code>编写难度就异常巨大，你需要根据它定义初值的情况动态处理字符串，代码复杂程度还是很高的,具体体现在为<strong>变量初始化</strong>（<code>Initial</code>）和<strong>取数</strong>（<code>GetEleInstr</code>）两个部分，需要我们格外细心。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Initial.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (initValue == <span class="literal">null</span> || initValue.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> (type.isInt32()) ? type + <span class="string">&quot; 0&quot;</span> : type + <span class="string">&quot; zeroinitializer&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (type.isInt32()) &#123;</span><br><span class="line">            <span class="keyword">return</span> type + <span class="string">&quot; &quot;</span> + initValue.get(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (space.size() == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> type + <span class="string">&quot; [&quot;</span> + initValue.stream().map(number -&gt; <span class="string">&quot;i32 &quot;</span> + number)</span><br><span class="line">                    .collect(Collectors.joining(<span class="string">&quot;, &quot;</span>)) + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                <span class="keyword">if</span> (offset == <span class="number">0</span>) &#123;</span><br><span class="line">                    sb.append(type).append(<span class="string">&quot; zeroinitializer&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    sb.append(type).append(<span class="string">&quot; [&quot;</span>);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; space.get(<span class="number">0</span>); i++) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (i * space.get(<span class="number">1</span>) &lt; offset) &#123;</span><br><span class="line">                            sb.append(<span class="string">&quot;[&quot;</span>).append(space.get(<span class="number">1</span>)).append(<span class="string">&quot; x i32]&quot;</span>).append(<span class="string">&quot;[&quot;</span>);</span><br><span class="line">                            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; space.get(<span class="number">1</span>); j++) &#123;</span><br><span class="line">                                sb.append(<span class="string">&quot;i32 &quot;</span>).append(initValue.get(i * space.get(<span class="number">1</span>) + j));</span><br><span class="line">                                <span class="keyword">if</span> (j != space.get(<span class="number">1</span>) - <span class="number">1</span>) &#123;</span><br><span class="line">                                    sb.append(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            sb.append(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            sb.append(<span class="string">&quot;[&quot;</span>).append(space.get(<span class="number">1</span>)).</span><br><span class="line">                                append(<span class="string">&quot; x i32] &quot;</span>).append(<span class="string">&quot;zeroinitializer&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (i != space.get(<span class="number">0</span>) - <span class="number">1</span>) &#123;</span><br><span class="line">                            sb.append(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    sb.append(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> sb.toString();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//GetEleInstr.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    <span class="type">PointerType</span> <span class="variable">ptrType</span> <span class="operator">=</span> (PointerType) (operands.get(<span class="number">0</span>).getType());</span><br><span class="line">    <span class="type">IrType</span> <span class="variable">type</span> <span class="operator">=</span> ptrType.getTarget();</span><br><span class="line">    sb.append(name).append(<span class="string">&quot; = getelementptr inbounds &quot;</span>)</span><br><span class="line">        .append(type).append(<span class="string">&quot;, &quot;</span>)</span><br><span class="line">        .append(ptrType).append(<span class="string">&quot; &quot;</span>)</span><br><span class="line">        .append(operands.get(<span class="number">0</span>).getName())</span><br><span class="line">        .append((type.isArray() ? <span class="string">&quot;, i32 0, i32 &quot;</span> : <span class="string">&quot;, i32 &quot;</span>));</span><br><span class="line">    <span class="keyword">if</span> (type.isArray() &amp;&amp; ((ArrayType) type).getEleSpace().size() == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (operands.get(<span class="number">1</span>).getName().matches(<span class="string">&quot;[0-9]+&quot;</span>)) &#123;</span><br><span class="line">            ArrayList&lt;Integer&gt; spaces = ((ArrayType) type).getEleSpace();</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">offset</span> <span class="operator">=</span> Integer.parseInt(operands.get(<span class="number">1</span>).getName());</span><br><span class="line">            sb.append(offset / spaces.get(<span class="number">1</span>)).append(<span class="string">&quot;, i32 &quot;</span>).append(offset % spaces.get(<span class="number">1</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sb.append(<span class="string">&quot;0, i32 &quot;</span>).append(operands.get(<span class="number">1</span>).getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sb.append(operands.get(<span class="number">1</span>).getName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>当我们完成到这里后，最后一个步骤就是将所有继承了<code>Value</code>类的节点全部<strong>重写<code>toString</code>方法</strong>然后调用<code>modele.toString()</code>就可以获得最终的中间代码了，<code>module</code>类的<code>toString</code>方法如下，其他类可以类似效仿：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    sb.append(GetIntDeclare.getDeclare()).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    sb.append(PutIntDeclare.getDeclare()).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    sb.append(PutStrDeclare.getDeclare()).append(<span class="string">&quot;\n\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (FormatString stringLiteral : stringLiterals) &#123;</span><br><span class="line">        sb.append(stringLiteral).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sb.append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (GlobalVar globalVar : globalVars) &#123;</span><br><span class="line">        sb.append(globalVar.toString()).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sb.append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (Function function : functions) &#123;</span><br><span class="line">        sb.append(function.toString()).append(<span class="string">&quot;\n\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h2 id="生成mips代码"><a class="markdownIt-Anchor" href="#生成mips代码"></a> 生成<code>mips</code>代码</h2>
<p>在进行<strong>代码优化</strong>之前，笔者先进行了<code>mips</code>代码生成的编写，这样可以在中间代码相对简单时生成<code>mips</code>，后续优化编写之后<strong>指令集变化也较小</strong>，这样可以得到更高的编译器编写效率。言归正传，我们要想由中间代码生成<code>mips</code>汇编，我们需要<strong>遍历之前生成的<code>Value</code>语法树</strong>，并以<code>Instr</code>为单位<strong>将每条指令转化为几条汇编指令</strong>，转化的整体而言难度还是比较小的，主要的难点在于对<strong>栈指针的移动</strong>和<strong>内存管理</strong>。</p>
<h4 id="汇编指令转化"><a class="markdownIt-Anchor" href="#汇编指令转化"></a> 汇编指令转化</h4>
<p>汇编指令转化部分我将<code>mips</code>汇编分为了<code>.data</code>和<code>.text</code>段，并分别用一个数组存储对应的<code>Assembly</code>类,之后编写各类不同的指令继承<code>Assembly</code>这个父类即可。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://charles2530.github.io/image/SysY-compiler-design-doc/image-20231025214942032.png"
                      alt="image-20231025214942032" 
                ></p>
<p>而具体到汇编指令的转化，我们需要在<code>Instr</code>中编写<code>generateAssembly()</code>方法并在各个子类中<strong>重写该方法</strong>，即可完成转化。</p>
<p>除此之外，我们还需要实现<code>.word</code>和<code>.asciiz</code>两个预处理指令，下方我以<code>.word</code>指令举例，<code>.asciiz</code>类似实现即可。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WordAsm</span> <span class="keyword">extends</span> <span class="title class_">DataAssembly</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;Integer&gt; initValue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WordAsm</span><span class="params">(String label, String value, ArrayList&lt;Integer&gt; initValue)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(label, value);</span><br><span class="line">        <span class="built_in">this</span>.initValue = initValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (initValue == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> label + <span class="string">&quot;: .word &quot;</span> + value;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">offsetTot</span> <span class="operator">=</span> Integer.parseInt(value) - initValue.size();</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">res</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(label + <span class="string">&quot;: .word &quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= initValue.size() - <span class="number">1</span>; i++) &#123;</span><br><span class="line">                res.append(initValue.get(i));</span><br><span class="line">                <span class="keyword">if</span> (i != initValue.size() - <span class="number">1</span>) &#123;</span><br><span class="line">                    res.append(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; offsetTot; i++) &#123;</span><br><span class="line">                res.append(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (i != offsetTot - <span class="number">1</span>) &#123;</span><br><span class="line">                    res.append(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> res.toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="栈指针移动"><a class="markdownIt-Anchor" href="#栈指针移动"></a> 栈指针移动</h4>
<p>为了更好实现<strong>栈指针的移动和相关的取数操作</strong>，我编写了<code>RegisterUtils</code>方法类，里面编写了包括<strong>移动栈指针</strong>，<strong>申请寄存器</strong>，<strong>取寄存器的值</strong>，<strong>取内存的值</strong>，<strong>取指针对应值</strong>等多种内存环境下的常用方法的封装，这样可以使代码复用性更强，适应高内聚低耦合的需求。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RegisterUtils</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title function_">moveValueOffset</span><span class="params">(Value value)</span> &#123;</span><br><span class="line">        ... ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">allocReg</span><span class="params">(Value value, Register target)</span> &#123;</span><br><span class="line">        ... ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">reAllocReg</span><span class="params">(Value value, Register target)</span> &#123;</span><br><span class="line">       ... ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Register <span class="title function_">loadRegisterValue</span><span class="params">(Value operand, Register instead, Register reg)</span> &#123;</span><br><span class="line">        ... ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Register <span class="title function_">loadVariableValue</span><span class="params">(Value operand, Register reg, Register instead)</span> &#123;</span><br><span class="line">        ... ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Register <span class="title function_">loadPointerValue</span><span class="params">(Value operand, Register pointerReg, Register instead)</span> &#123;</span><br><span class="line">        ... ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Register <span class="title function_">loadMemoryOffset</span><span class="params">(Value operand, Register instead, Register target,</span></span><br><span class="line"><span class="params">                                            Register pointerReg, Register offsetReg)</span> &#123;</span><br><span class="line">        ... ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Register <span class="title function_">allocParamReg</span><span class="params">(Value para, Register paraReg,</span></span><br><span class="line"><span class="params">                                         <span class="type">int</span> currentOffset, ArrayList&lt;Register&gt; allocatedRegs)</span> &#123;</span><br><span class="line">        ... ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Register <span class="title function_">allocParamMem</span><span class="params">(Value para, Register paraReg, <span class="type">int</span> currentOffset,</span></span><br><span class="line"><span class="params">                                         ArrayList&lt;Register&gt; allocatedRegs, <span class="type">int</span> paraNum)</span> &#123;</span><br><span class="line">        ... ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="寄存器控制"><a class="markdownIt-Anchor" href="#寄存器控制"></a> 寄存器控制</h4>
<p>生成汇编还有一个非常重要的步骤是<strong>为每个虚拟寄存器分配对应的实际寄存器</strong>，这里需要我们创建<code>Register</code>寄存器类和<code>RegisterController</code>控制器类来<strong>控制寄存器的分配</strong>。</p>
<p><code>Register</code>类是一个枚举类，相比于直接使用字符串访问寄存器，使用枚举类的好处在于可以调用<strong>枚举类的<code>ordinal()</code>方法</strong>，这个可以找到每个枚举常量的索引，就像数组索引一样，这样有利于我们<strong>动态访问所需的寄存器</strong>。</p>
<p>而<code>RegisterController</code>类是一个建立了一组<code>Value</code>和<code>Register</code>的对应关系，从而及时更新各个<code>Value</code>实际分配的寄存器，这样也就实现了对寄存器的动态管理的需求。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RegisterController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> HashMap&lt;Value, Register&gt; valueRegisterHashMap;</span><br><span class="line">    <span class="keyword">public</span> Register <span class="title function_">getRegister</span><span class="params">(Value value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (valueRegisterHashMap == <span class="literal">null</span>) ? <span class="literal">null</span> :</span><br><span class="line">                valueRegisterHashMap.get(value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">allocRegister</span><span class="params">(Value value, Register register)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (valueRegisterHashMap == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        valueRegisterHashMap.put(value, register);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="内存管理策略"><a class="markdownIt-Anchor" href="#内存管理策略"></a> 内存管理策略</h4>
<p>对于已经分配好寄存器的变量，我们可以<strong>直接将其翻译成对应的寄存器</strong>，而对于其他变量，我们只能将其<strong>放到内存中</strong>，使用的时候从内存中取,这就要涉及到内存管理策略了，而本编译器的内存管理策略如下。</p>
<p>调用新函数前，<code>$sp</code>的值会设置为<strong>新函数的栈底</strong>，在当前函数的作用域中， <code>$sp</code>的值不会随内存分配而变化。函数前3个形参保存在<code>$a1, $a2, $a3</code>中，<code>$a0</code>只用于IO，剩余的形参存入内存方便后续取用。在调用某个函数时，我们需要先保存当前已经分配的寄存器，然后将函数参数、<code>$sp</code>和<code>$ra</code>寄存器依次保存栈顶。最后，<strong>将<code>$sp</code>的值加上目前的总偏移量，作为被调用函数的栈底</strong>。接下来，直接<code>jump</code>到目标函数对应的<code>label</code>即可。<strong>当函数返回时将存储于内存的变量恢复</strong>。</p>
<p>在函数内部使用到的<strong>局部变量依次存放</strong>，并在<code>AssemblyUnit</code>记录每个局部变量的存放位置相对于栈底的偏移，以及当前栈顶到栈底的总偏移量。每定义一个需要分配空间的变量时，栈指针偏移，然后在<code>AssemblyUnit</code>中<strong>记录好该变量到该偏移量的映射关系</strong>即可。</p>
<p>到此一个简单的、没有进行任何优化的编译器正式完工,后续可以开始开展<strong>优化工作</strong>了。</p>
<blockquote>
<p>注：在编写llvm生成和mips生成时我编写了一台评测机，链接为——<a class="link"   target="_blank" rel="noopener" href="https://github.com/Charles2530/compiler_autotest" >Charles2530/compiler_autotest: 北航2023年编译原理自动化测试 (github.com) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>，可供参考。</p>
</blockquote>
<h2 id="中端代码优化"><a class="markdownIt-Anchor" href="#中端代码优化"></a> 中端代码优化</h2>
<h3 id="全局变量局部化"><a class="markdownIt-Anchor" href="#全局变量局部化"></a> 全局变量局部化</h3>
<p><strong>全局变量局部化</strong> 是指将函数出于全局区的变量转化到局部使用，由于全局变量(非数组)是可以<strong>在编译阶段计算出具体的值</strong> 的，而在GVN有<strong>常数折叠</strong> 的行为，所以<strong>将可以直接转化为常数的全局变量进行转化</strong> 后可以更好的推进后续的优化。</p>
<p>具体而言，全局变量局部化主要对两种情况的全局变量进行了优化:</p>
<ol>
<li><strong>如果全局变量没有使用者，那么就可以局部化</strong></li>
<li><strong>如果全局变量只有一个使用者，那么就可以局部化</strong></li>
</ol>
<p>为了实现全局变量局部化，我们首先需要设计一个HashMap存储每个全局变量和调用它的函数列表，之后我们需要创建函数调用表，之后按照上述逻辑将符合条件的函数局部化即可,下面是局部化的代码逻辑。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * localize 是局部化全局变量的函数</span></span><br><span class="line"><span class="comment">     * 该函数的执行逻辑如下:</span></span><br><span class="line"><span class="comment">     * 1. 如果全局变量没有使用者，那么就可以局部化</span></span><br><span class="line"><span class="comment">     * 2. 如果全局变量只有一个使用者，那么就可以局部化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">localize</span><span class="params">(GlobalVar globalVar)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (globalVarUsers.get(globalVar).isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (globalVarUsers.get(globalVar).size() == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="type">Function</span> <span class="variable">target</span> <span class="operator">=</span> globalVarUsers.get(globalVar).iterator().next();</span><br><span class="line">        <span class="keyword">if</span> (!FunctionInlineUnit.getResponse(target).isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">BasicBlock</span> <span class="variable">entry</span> <span class="operator">=</span> target.getBasicBlocks().get(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (globalVar.getType().isInt32()) &#123;</span><br><span class="line">           	... ...</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h3 id="基本块简化"><a class="markdownIt-Anchor" href="#基本块简化"></a> 基本块简化</h3>
<p>在生成中间代码后，我们首先需要<strong>删除一些不必要的跳转指令</strong>，虽然这部分并不会优化我们中间代码的效率，但这可以很好的简化中间代码，而且去除重复跳转语句后可以让我们在后续写优化时可以通过访问基本块的最后一条指令即可获得所需的跳转块，大大提高优化效率。具体而言主要分为<strong>删除重复的分支语句</strong>和<strong>删除死代码块</strong>两部分。</p>
<h4 id="删除重复分支语句"><a class="markdownIt-Anchor" href="#删除重复分支语句"></a> 删除重复分支语句</h4>
<p>所谓删除基本块中重复的分支，对于每个基本块而言，仅需<strong>保留第一个分支</strong>即可，该分支以下的代码不会被执行，所以我们在合适的位置将这个数组截断即可，函数代码如下:</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deleteDuplicateBranch</span><span class="params">(BasicBlock basicBlock)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; basicBlock.getInstrArrayList().size() - <span class="number">1</span>; i++) &#123;</span><br><span class="line">        <span class="type">Instr</span> <span class="variable">instr</span> <span class="operator">=</span> basicBlock.getInstrArrayList().get(i);</span><br><span class="line">        <span class="keyword">if</span> (instr <span class="keyword">instanceof</span> BrInstr || instr <span class="keyword">instanceof</span> JumpInstr</span><br><span class="line">            || instr <span class="keyword">instanceof</span> RetInstr) &#123;</span><br><span class="line">            basicBlock.setInstrArrayList(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(</span><br><span class="line">                basicBlock.getInstrArrayList().subList(<span class="number">0</span>, i + <span class="number">1</span>)));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="删除死代码块"><a class="markdownIt-Anchor" href="#删除死代码块"></a> 删除死代码块</h4>
<p>删除死代码块而言，如果<strong>该基本块不可达，则该基本块为死代码块</strong>，应当被删除，函数代码如下:</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deleteDeadBlock</span><span class="params">(Function function)</span> &#123;</span><br><span class="line">    HashSet&lt;BasicBlock&gt; vis = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="type">BasicBlock</span> <span class="variable">entry</span> <span class="operator">=</span> function.getBasicBlocks().get(<span class="number">0</span>);</span><br><span class="line">    dfs(entry, vis);</span><br><span class="line">    function.getBasicBlocks().removeIf(bb -&gt; !vis.contains(bb) &amp;&amp; bb.setDeleted(<span class="literal">true</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>这里通过深度优先搜索进行访问，并用vis数组进行记录即可，而遇到死代码块，我们直接进行一个标记，后续直接删除即可。</p>
<h3 id="mem2reg"><a class="markdownIt-Anchor" href="#mem2reg"></a> Mem2Reg</h3>
<p>Mem2Reg将一个<strong>非SSA的形式转化到含有phi函数的SSA形式</strong>，具体分为<strong>插入phi指令</strong>和<strong>变量重命名</strong>两个步骤。具体而言，在实现Mem2Reg之前，我们需要创建一些数据结构来辅助完成Mem2Reg的内容。</p>
<h4 id="cfg流图构建"><a class="markdownIt-Anchor" href="#cfg流图构建"></a> CFG流图构建</h4>
<p><strong>控制流程图(Control Flow Graph)<strong>简称CFG，记录了每个块之间的跳转关系，具体而言即</strong>记录了每个块的前序基本块和后继基本块</strong>。</p>
<p>要想构建控制流图，需要寻找函数各个块的直接跳转指令和间接跳转指令，并为其添加跳转的记录即可。具体函数逻辑如下:</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * buildControlFlowGraph 方法用于构建控制流图</span></span><br><span class="line"><span class="comment">     * 这里求解出了IndBasicBlock和OutBasicBlock</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">buildControlFlowGraph</span><span class="params">(Function function)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (BasicBlock basicBlock : function.getBasicBlocks()) &#123;</span><br><span class="line">        <span class="type">Instr</span> <span class="variable">lastInstr</span> <span class="operator">=</span> basicBlock.getLastInstr();</span><br><span class="line">        <span class="keyword">if</span> (lastInstr <span class="keyword">instanceof</span> JumpInstr jumpInstr) &#123;</span><br><span class="line">            ControlFlowGraph.addDoubleEdge(basicBlock, jumpInstr.getTarget());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lastInstr <span class="keyword">instanceof</span> BrInstr brInstr) &#123;</span><br><span class="line">            ControlFlowGraph.addDoubleEdge(basicBlock, brInstr.getThenBlock());</span><br><span class="line">            ControlFlowGraph.addDoubleEdge(basicBlock, brInstr.getElseBlock());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="支配树及df构建"><a class="markdownIt-Anchor" href="#支配树及df构建"></a> 支配树及DF构建</h4>
<p><strong>DominatorTree 是支配树</strong>，在这个阶段我们需要形成四个数据结构，即每个基本块的支配集合，支配边界集合，直接支配父节点和直接支配子节点集合。除此之外，我们还可以在这个过程中算出<strong>每个基本块所在支配树的深度</strong>，用于后续GCM优化提供服务。</p>
<p>这几个定义如下:</p>
<ul>
<li><strong>支配</strong>(dominate)：如果CFG中从起始节点到基本块y的所有路径都经过了基本块x，我们说<strong>x支配y</strong></li>
<li><strong>严格支配</strong>(strict dominate)：显然每个基本块都支配它自己。如果x支配y，且x不等于y，那么<strong>x严格支配y</strong></li>
<li><strong>直接支配者</strong>（immediate dominator, idom）：严格支配n，且不严格支配任何严格支配 n 的节点的节点(直观理解就是所有严格支配n的节点中离n最近的那一个)，我们称其为n的直接支配者</li>
<li><strong>支配边界</strong>（<strong>D</strong>ominance <strong>F</strong>rontier）：节点 n 的支配边界是 CFG 中刚好<strong>不</strong>被 n 支配到的节点集合</li>
</ul>
<h5 id="支配集合"><a class="markdownIt-Anchor" href="#支配集合"></a> 支配集合</h5>
<p>要想构建支配集合，对于这个函数而言，函数的逻辑是在for循环中<strong>找到所有不被 basicBlock支配的block，放入reachSet中</strong>，这样所有不在reachedSet中的Block就都是被basicBlock，支配的Block，然后将所有不在reachSet中的block放入domList中(包括basicBlock本身)</p>
<blockquote>
<p>注:这里与教程中的支配集合定义有区别，应该理解为该支配集合里的节点都是被该节点支配的。这样省略了求不动点的过程，效率更高。</p>
</blockquote>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">searchBlockDominateSet</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">BasicBlock</span> <span class="variable">entry</span> <span class="operator">=</span> basicBlocks.get(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">for</span> (BasicBlock basicBlock : basicBlocks) &#123;</span><br><span class="line">        HashSet&lt;BasicBlock&gt; reachedSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        DominatorTree.dfsDominate(entry, basicBlock, reachedSet);</span><br><span class="line">        ArrayList&lt;BasicBlock&gt; domList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (BasicBlock bb : basicBlocks) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!reachedSet.contains(bb)) &#123;</span><br><span class="line">                domList.add(bb);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        DominatorTree.addBlockDominateSet(basicBlock, domList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h5 id="构建支配树"><a class="markdownIt-Anchor" href="#构建支配树"></a> 构建支配树</h5>
<p>求解支配树换言之就是求解直接支配关系，<strong>即A直接支配B——A严格支配B，且不严格支配任何严格支配B的节点</strong>。所以我们需要借助之前生成的集合，判断该节点和他的支配集合是否为直接支配关系，如果是直接支配就直接生成直接支配父节点和直接支配子节点集合。</p>
<p>判断是否为直接支配关系的逻辑如下:</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isImmediateDominator</span><span class="params">(BasicBlock basicBlock, BasicBlock dominateBlock)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> basicBlock.getBlockDominateSet().contains(dominateBlock) &amp;&amp;</span><br><span class="line">        !dominateBlock.equals(basicBlock);</span><br><span class="line">    <span class="keyword">for</span> (BasicBlock midBlock : basicBlock.getBlockDominateSet()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!midBlock.equals(dominateBlock) &amp;&amp; !midBlock.equals(basicBlock)</span><br><span class="line">            &amp;&amp; midBlock.getBlockDominateSet().contains(dominateBlock)) &#123;</span><br><span class="line">            flag = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> flag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h5 id="构建支配边界集合"><a class="markdownIt-Anchor" href="#构建支配边界集合"></a> 构建支配边界集合</h5>
<p>求解支配边界是一个相对固定的算法，直接借助教程所给的伪代码即可。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://charles2530.github.io/image/SysY-compiler-design-doc/image-20231119215943218.png"
                      alt="image-20231119215943218" 
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://charles2530.github.io/image/SysY-compiler-design-doc/image-20231119220001178.png"
                      alt="image-20231119220001178" 
                ></p>
<blockquote>
<p>上述伪代码是插入phi函数的伪代码，我们的迭代支配边界也将在这个过程被计算出来。</p>
</blockquote>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">searchBlockDominanceFrontier</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;BasicBlock, ArrayList&lt;BasicBlock&gt;&gt; entry :</span><br><span class="line">         ControlFlowGraph.getFunctionOutBasicBlock(<span class="built_in">this</span>).entrySet()) &#123;</span><br><span class="line">        <span class="type">BasicBlock</span> <span class="variable">from</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">        ArrayList&lt;BasicBlock&gt; outBasicBlocks = entry.getValue();</span><br><span class="line">        <span class="keyword">for</span> (BasicBlock to : outBasicBlocks) &#123;</span><br><span class="line">            <span class="type">BasicBlock</span> <span class="variable">runner</span> <span class="operator">=</span> from;</span><br><span class="line">            <span class="keyword">while</span> (!runner.getBlockDominateSet().contains(to)</span><br><span class="line">                   || runner.equals(to)) &#123;</span><br><span class="line">                DominatorTree.addBlockDominanceFrontierEdge(runner, to);</span><br><span class="line">                runner = runner.getBlockDominateParent();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h5 id="计算支配树深度集"><a class="markdownIt-Anchor" href="#计算支配树深度集"></a> 计算支配树深度集</h5>
<p><strong>支配树深度集合计算</strong>相对比较简单，实际就是一个深度优先搜索的过程，代码如下:</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">dfsDominateLevel</span><span class="params">(BasicBlock basicBlock, Integer depth)</span> &#123;</span><br><span class="line">    DominatorTree.addBlockDominateTreeDepth(basicBlock, depth);</span><br><span class="line">    <span class="keyword">for</span> (BasicBlock child : basicBlock.getBlockDominateChildList()) &#123;</span><br><span class="line">        DominatorTree.dfsDominateLevel(child, depth + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="插入phi指令"><a class="markdownIt-Anchor" href="#插入phi指令"></a> 插入Phi指令</h4>
<p>在有了上述功能作为基础后，我们就可以开始我们Mem2Reg的过程了。这里主要分为<strong>Phi指令位置选择</strong>和<strong>变量重命名</strong>两个步骤。</p>
<h5 id="phi指令位置选择"><a class="markdownIt-Anchor" href="#phi指令位置选择"></a> Phi指令位置选择</h5>
<p>这部分可以参考之前的伪代码，本算法首先将defBasicBlockArrayList中的基本块推入栈中，然后在while循环执行固定算法即可，这段代码形成的代码如下:</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">insertPhi</span><span class="params">()</span> &#123;</span><br><span class="line">    HashSet&lt;BasicBlock&gt; f = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    Stack&lt;BasicBlock&gt; w = <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;&gt;();</span><br><span class="line">    Mem2RegUnit.defBasicBlockArrayList.forEach(w::push);</span><br><span class="line">    <span class="keyword">while</span> (!w.isEmpty()) &#123;</span><br><span class="line">        <span class="type">BasicBlock</span> <span class="variable">x</span> <span class="operator">=</span> w.pop();</span><br><span class="line">        <span class="keyword">for</span> (BasicBlock y : x.getBlockDominanceFrontier()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!f.contains(y)) &#123;</span><br><span class="line">                f.add(y);</span><br><span class="line">                <span class="type">Instr</span> <span class="variable">phiInstr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PhiInstr</span>(IrNameController.getLocalVarName(</span><br><span class="line">                    y.getBelongingFunc()), y.getBlockIndBasicBlock());</span><br><span class="line">                y.insertInstr(<span class="number">0</span>, phiInstr);</span><br><span class="line">                useInstrArrayList.add(phiInstr);</span><br><span class="line">                defInstrArrayList.add(phiInstr);</span><br><span class="line">                <span class="keyword">if</span> (!defBasicBlockArrayList.contains(y)) &#123;</span><br><span class="line">                    w.push(y);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>这里<strong>f 为需要添加phi的基本块的集合，w 为定义变量的基本块的集合</strong>。</p>
<blockquote>
<p>注：phi既是useInstr,又是defInstr</p>
</blockquote>
<h5 id="变量重命名"><a class="markdownIt-Anchor" href="#变量重命名"></a> 变量重命名</h5>
<p>变量重命名主要依托于深度优先搜索，来实现对基本块的变量进行重命名，文档中的伪代码如下:</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://charles2530.github.io/image/SysY-compiler-design-doc/image-20231119223355130.png"
                      alt="image-20231119223355130" 
                ></p>
<p>而变量重命名的主要代码如下:</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">dfsVarRename</span><span class="params">(BasicBlock presentBlock)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">cnt</span> <span class="operator">=</span> removeUnnecessaryInstr(presentBlock);</span><br><span class="line">    <span class="keyword">for</span> (BasicBlock basicBlock : presentBlock.getBlockOutBasicBlock()) &#123;</span><br><span class="line">        <span class="type">Instr</span> <span class="variable">instr</span> <span class="operator">=</span> basicBlock.getInstrArrayList().get(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (instr <span class="keyword">instanceof</span> PhiInstr phiInstr &amp;&amp; useInstrArrayList.contains(phiInstr)) &#123;</span><br><span class="line">            phiInstr.modifyValue(((stack.isEmpty()) ?</span><br><span class="line">                                  <span class="keyword">new</span> <span class="title class_">Constant</span>(<span class="string">&quot;0&quot;</span>, <span class="keyword">new</span> <span class="title class_">VarType</span>(<span class="number">32</span>), <span class="literal">false</span>) : stack.peek()), presentBlock);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    presentBlock.getBlockDominateChildList().forEach(Mem2RegUnit::dfsVarRename);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; cnt; i++) &#123;</span><br><span class="line">        stack.pop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>在这里，cnt 记录遍历presentBlock的过程中，stack的push次数，而该函数的执行逻辑如下:</p>
<ol>
<li>在移除了非必要的Instr后，遍历presentBlock的后继集合，将最新的define（stack.peek）填充进每个后继块的第一个phi指令中(有可能某个后继块没有和当前alloc指令相关的phi，需要进行特判(符合条件的Phi应该在useInstrList中))</li>
<li>对presentBlock支配的基本块使用dfsVarRename方法，实现DFS</li>
<li>将该次dfs时压入stack的数据全部弹出</li>
</ol>
<h3 id="死代码删除"><a class="markdownIt-Anchor" href="#死代码删除"></a> 死代码删除</h3>
<p>程序包含的一些代码可能并不会被运行或者不会对结果产生影响，那么我们称这种代码为死代码。我们将不会被运行到的称为<strong>不可达代码</strong>，将不会对结果产生影响的代码成为<strong>无用代码</strong>。删除无用或不可达代码可以缩减IR代码，可使程序更小、编译更快、执行也更快。</p>
<p>其实之前的基本块简化也可以算是死代码删除，但那里删除的都是真的没有用的代码，对于优化没有帮助，所以这部分主要介绍删除不会对结果产生影响的代码。这里我主要定义了isDead()函数来判断某个指令是否可以被死代码优化。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isDead</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.isValid() &amp;&amp; !(<span class="built_in">this</span> <span class="keyword">instanceof</span> CallInstr) &amp;&amp;</span><br><span class="line">        !(<span class="built_in">this</span> <span class="keyword">instanceof</span> IoStreamGeneration) &amp;&amp; <span class="built_in">this</span>.getUseDefChain().isEmpty();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>这里我们首先意识到IO指令和函数调用指令是肯定不能优化的，除此之外我们我们需要判断指令是否优先以及是否有其他指令使用了该指令，如果该指令无效或者没有其他指令使用该指令，这样我们就可以删除这条指令。</p>
<p>这里isValid 的指令有 alloca，alu，call，gep，io，getint，load，phi，zext，其中call指令调用的函数将指针作为形参、修改全局变量、调用了其他函数，因此不能直接删除，io中的 getint 指令获得的数字即使没有用到也应该完成io操作，也不能删除。</p>
<h3 id="函数内联"><a class="markdownIt-Anchor" href="#函数内联"></a> 函数内联</h3>
<blockquote>
<p>关于函数内联这个操作，其实正常是属于中端代码优化的，但我受到参考编译器的启发，发现这个操作其实可以在生成<code>AST</code>树后进行节点调整完成，这样可以很好的完成后续的操作，但在尝试后发现这个功能在Mem2Reg后修改效率更高，所以最终这部分还是放在了中端代码优化部分。</p>
</blockquote>
<p>程序中的一次函数调用，除去函数内部执行造成的开销，会产生很多的额外开销，如保存和恢复现场，参数传递和跳转到被调用函数，以及完成执行后返回等，而对于非递归，且没有调用与递归相关函数的函数，我们可以将其内部的执行指令嵌入到调用它的函数中，这种优化，我们叫做函数内联。</p>
<p>函数内联时首先要判断这个函数是否可以被内联，评价标准是内联函数不能递归，不能调用其他函数。而函数内联分析主要分为以下几个步骤:</p>
<ol>
<li>建立函数调用图</li>
<li>深度优先搜索函数调用图，判断是否有递归</li>
<li>内联函数并更新函数调用图</li>
<li>删除无用函数</li>
<li>重复1-4步骤，直到不动点稳定</li>
</ol>
<p>而具体代码如下:</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">inlineAnalysis</span><span class="params">()</span> &#123;</span><br><span class="line">    FunctionInlineUnit.fixedPoint = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">while</span> (FunctionInlineUnit.fixedPoint) &#123;</span><br><span class="line">        FunctionInlineUnit.fixedPoint = <span class="literal">false</span>;</span><br><span class="line">        FunctionInlineUnit.buildFuncCallGraph();</span><br><span class="line">        <span class="keyword">module</span>.getFunctions().forEach(Function::dfsCaller);</span><br><span class="line">        FunctionInlineUnit.inlineFunctionsList.forEach(Function::inlineFunction);</span><br><span class="line">        FunctionInlineUnit.inlineFunctionsList.clear();</span><br><span class="line">        FunctionInlineUnit.buildFuncCallGraph();</span><br><span class="line">        FunctionInlineUnit.removeUselessFunction();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>在函数调用图构建时和上述全局变量局部化的函数调用图构建过程相同，其余部分也较为简单，这里我主要介绍内联函数那一步。</p>
<h4 id="内联函数操作"><a class="markdownIt-Anchor" href="#内联函数操作"></a> 内联函数操作</h4>
<p>内联函数操作的执行逻辑如下:</p>
<ol>
<li>通过遍历，获得所有调用 inlineFunc 的 callInstr</li>
<li>对于每一个 callInstr，将其替换为 inlineFunc 的所有基本块</li>
<li>去除调用关系</li>
</ol>
<p>显而易见，这里最难的一步是将callInstr替换为基本块集合的操作，这里我们需要将函数调用指令所在的基本块分割成两半，之后将函数调用指令所在的基本块之后再建一个块，用于存放函数调用指令之后的指令，最后我们需要克隆函数调用指令所在的基本块，将克隆的基本块插入到函数调用指令所在的基本块之后即可。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">replaceFunctions</span><span class="params">(CallInstr callInstr)</span> &#123;</span><br><span class="line">    <span class="type">Function</span> <span class="variable">response</span> <span class="operator">=</span> callInstr.getTarget();</span><br><span class="line">    <span class="type">BasicBlock</span> <span class="variable">basicBlock</span> <span class="operator">=</span> callInstr.getBelongingBlock();</span><br><span class="line">    <span class="type">Function</span> <span class="variable">function</span> <span class="operator">=</span> basicBlock.getBelongingFunc();</span><br><span class="line">    <span class="type">BasicBlock</span> <span class="variable">inlineBlock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicBlock</span>(IrNameController.getBlockName(function));</span><br><span class="line">    function.addBasicBlock(inlineBlock, function.getBasicBlocks().indexOf(basicBlock) + <span class="number">1</span>);</span><br><span class="line">    FunctionInlineUnit.splitBlock(callInstr, basicBlock, inlineBlock);</span><br><span class="line">    FunctionInlineUnit.cloneBlock(callInstr, basicBlock, inlineBlock, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>除此之外需要强调，在函数内联完成后，由于内联函数属于块间优化，所以我们在执行后需要重建流图和支配树，再继续后续的操作。</p>
<h3 id="gvm"><a class="markdownIt-Anchor" href="#gvm"></a> GVM</h3>
<p>GVN(Global Variable Numbering) 全局值编号：为全局的变量进行编号，实现全局的消除公共表达式。</p>
<p>要想实现这些操作，我们需要构建全局变量编号哈希表，之后在分析时我们可以将各个指令的hash值存入，如果在该hash表中有之前的记录就可以直接替换，这样就实现了全局的消除公共表达式。</p>
<h4 id="常数折叠"><a class="markdownIt-Anchor" href="#常数折叠"></a> 常数折叠</h4>
<p>由于常数相同值但计算表达式不同的情况的存在，所以我们需要先将可以合并的表达式进行合并，这样我们就可以获得更多的公共表达式。</p>
<p>进行常数折叠时我们需要根据每个calcInstr的两个操作数中常数的数量进行分类讨论:</p>
<ol>
<li>
<p>如果没有常数，则可以将前后两个操作数相同且操作位减法、取模或除法时进行相应的操作。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Value <span class="title function_">simplifyNoConstant</span><span class="params">(CalcInstr calcInstr)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (calcInstr.getOperands().get(<span class="number">0</span>).equals(calcInstr.getOperands().get(<span class="number">1</span>))) &#123;</span><br><span class="line">        <span class="keyword">if</span> (calcInstr.getInstrType().matches(<span class="string">&quot;sub|srem&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Constant</span>(<span class="string">&quot;0&quot;</span>, <span class="keyword">new</span> <span class="title class_">VarType</span>(<span class="number">32</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (calcInstr.getInstrType().matches(<span class="string">&quot;sdiv&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Constant</span>(<span class="string">&quot;1&quot;</span>, <span class="keyword">new</span> <span class="title class_">VarType</span>(<span class="number">32</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
</li>
<li>
<p>如果有一个常数，我们需要按照常数所处的位置进行相应的优化。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Value <span class="title function_">simplifySingle</span><span class="params">(CalcInstr calcInstr)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (calcInstr.getOperands().get(<span class="number">0</span>) <span class="keyword">instanceof</span> Constant constant) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">val</span> <span class="operator">=</span> constant.getVal();</span><br><span class="line">        <span class="keyword">if</span> (val == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (calcInstr.getInstrType().matches(<span class="string">&quot;add&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> calcInstr.getOperands().get(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (calcInstr.getInstrType().matches(<span class="string">&quot;mul&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Constant</span>(<span class="string">&quot;0&quot;</span>, <span class="keyword">new</span> <span class="title class_">VarType</span>(<span class="number">32</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (val == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (calcInstr.getInstrType().matches(<span class="string">&quot;mul&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> calcInstr.getOperands().get(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">val</span> <span class="operator">=</span> ((Constant) calcInstr.getOperands().get(<span class="number">1</span>)).getVal();</span><br><span class="line">        <span class="keyword">if</span> (val == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (calcInstr.getInstrType().matches(<span class="string">&quot;add|sub&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> calcInstr.getOperands().get(<span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (calcInstr.getInstrType().matches(<span class="string">&quot;mul&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Constant</span>(<span class="string">&quot;0&quot;</span>, <span class="keyword">new</span> <span class="title class_">VarType</span>(<span class="number">32</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (val == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (calcInstr.getInstrType().matches(<span class="string">&quot;mul|sdiv&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> calcInstr.getOperands().get(<span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (calcInstr.getInstrType().matches(<span class="string">&quot;srem&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Constant</span>(<span class="string">&quot;0&quot;</span>, <span class="keyword">new</span> <span class="title class_">VarType</span>(<span class="number">32</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
</li>
<li>
<p>如果有两个常数，我们可以直接提前进行计算。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Value <span class="title function_">simplifyDouble</span><span class="params">(CalcInstr calcInstr)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">op1</span> <span class="operator">=</span> ((Constant) calcInstr.getOperands().get(<span class="number">0</span>)).getVal();</span><br><span class="line">    <span class="type">int</span> <span class="variable">op2</span> <span class="operator">=</span> ((Constant) calcInstr.getOperands().get(<span class="number">1</span>)).getVal();</span><br><span class="line">    op2 = (calcInstr.getInstrType().matches(<span class="string">&quot;sdiv|srem&quot;</span>) &amp;&amp; op2 == <span class="number">0</span>) ? <span class="number">1</span> : op2;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">switch</span> (calcInstr.getInstrType()) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;add&quot;</span> -&gt; <span class="keyword">new</span> <span class="title class_">Constant</span>(String.valueOf(op1 + op2), <span class="keyword">new</span> <span class="title class_">VarType</span>(<span class="number">32</span>));</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;sub&quot;</span> -&gt; <span class="keyword">new</span> <span class="title class_">Constant</span>(String.valueOf(op1 - op2), <span class="keyword">new</span> <span class="title class_">VarType</span>(<span class="number">32</span>));</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;mul&quot;</span> -&gt; <span class="keyword">new</span> <span class="title class_">Constant</span>(String.valueOf(op1 * op2), <span class="keyword">new</span> <span class="title class_">VarType</span>(<span class="number">32</span>));</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;sdiv&quot;</span> -&gt; <span class="keyword">new</span> <span class="title class_">Constant</span>(String.valueOf(op1 / op2), <span class="keyword">new</span> <span class="title class_">VarType</span>(<span class="number">32</span>));</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;srem&quot;</span> -&gt; <span class="keyword">new</span> <span class="title class_">Constant</span>(String.valueOf(op1 % op2), <span class="keyword">new</span> <span class="title class_">VarType</span>(<span class="number">32</span>));</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;and&quot;</span> -&gt; <span class="keyword">new</span> <span class="title class_">Constant</span>(String.valueOf(op1 &amp; op2), <span class="keyword">new</span> <span class="title class_">VarType</span>(<span class="number">32</span>));</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;or&quot;</span> -&gt; <span class="keyword">new</span> <span class="title class_">Constant</span>(String.valueOf(op1 | op2), <span class="keyword">new</span> <span class="title class_">VarType</span>(<span class="number">32</span>));</span><br><span class="line">        <span class="keyword">default</span> -&gt; <span class="literal">null</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
</li>
</ol>
<p>这样我们就完成了常数折叠步骤。</p>
<h4 id="消除公共表达式"><a class="markdownIt-Anchor" href="#消除公共表达式"></a> 消除公共表达式</h4>
<p>遍历一遍Instr，找出所有可优化的alu, gep, icmp和func，如果GVN中已存在，直接用该值即可, 否则插入到GVN中，之后对其直接支配的子节点调用该函数实现递归，最后需要将该基本块插入GVN的instr全部删去, 避免影响兄弟子树的遍历。实现的代码如下:</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">uniqueInstr</span><span class="params">(BasicBlock entry, HashMap&lt;String, Instr&gt; hashMap)</span> &#123;</span><br><span class="line">    ConstantFoldingController.foldingCalcInstr(entry);</span><br><span class="line">    HashSet&lt;Instr&gt; vis = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    Iterator&lt;Instr&gt; iterator = entry.getInstrArrayList().iterator();</span><br><span class="line">    <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">        <span class="type">Instr</span> <span class="variable">instr</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">        <span class="keyword">if</span> (instr <span class="keyword">instanceof</span> CalcInstr || instr <span class="keyword">instanceof</span> IcmpInstr ||</span><br><span class="line">            instr <span class="keyword">instanceof</span> GetEleInstr || (instr <span class="keyword">instanceof</span> CallInstr callInstr &amp;&amp;</span><br><span class="line">                                             ((Function) callInstr.getOperands().get(<span class="number">0</span>)).isImprovable())) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">hash</span> <span class="operator">=</span> instr.getGlobalVariableNumberingHash();</span><br><span class="line">            <span class="keyword">if</span> (hashMap.containsKey(hash)) &#123;</span><br><span class="line">                instr.replaceAllUse(hashMap.get(hash));</span><br><span class="line">                iterator.remove();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                hashMap.put(hash, instr);</span><br><span class="line">                vis.add(instr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    entry.getBlockDominateChildList()</span><br><span class="line">        .forEach(child -&gt; uniqueInstr(child, hashMap));</span><br><span class="line">    DebugDetailController.printGlobalVariableNumbering(entry.getBelongingFunc(), hashMap);</span><br><span class="line">    <span class="keyword">for</span> (Instr instr : vis) &#123;</span><br><span class="line">        hashMap.remove(instr.getGlobalVariableNumberingHash());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<blockquote>
<p>在上述优化过程中，有一个非常重要的部分是优化callInstr，但并不是每个调用函数指令都是可以被优化的，简而言之，只有函数满足参数没有指针类型, 每个指令没有读写全局变量，不能调用其他函数</p>
</blockquote>
<h3 id="gcm"><a class="markdownIt-Anchor" href="#gcm"></a> GCM</h3>
<p>GCM(Global Code Motion) 全局代码移动：根据Value之间的依赖关系，将代码的位置重新安排，从而使得一些不必要（不会影响结果）的代码尽可能少执行。</p>
<p>在实现GCM之前我们需要进行循环分析和副作用分析，除此之外我们还需要获得支配树的深度(这一步之前已经实现过了)。</p>
<h4 id="循环分析"><a class="markdownIt-Anchor" href="#循环分析"></a> 循环分析</h4>
<p>所谓循环分析，也就是获得各个基本块所处的循环层数。而如何判断一个基本块进入循环了呢，这就需要用到我们理论课的知识了，即判断循环的依据是如果某个块支配了它的某个前序块，那么这个块就是循环的头这样我们将循环层数添加即可。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loopAnalysis</span><span class="params">()</span> &#123;</span><br><span class="line">    ... ...</span><br><span class="line">    ArrayList&lt;BasicBlock&gt; latchBlocks = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    ArrayList&lt;BasicBlock&gt; posOrderBlocks =</span><br><span class="line">        DominatorTree.computeDominanceTreePostOrder(<span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">for</span> (BasicBlock basicBlock : posOrderBlocks) &#123;</span><br><span class="line">        <span class="keyword">for</span> (BasicBlock indBasicBlock : basicBlock.getBlockIndBasicBlock()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (basicBlock.getBlockDominateSet().contains(indBasicBlock)) &#123;</span><br><span class="line">                latchBlocks.add(indBasicBlock);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!latchBlocks.isEmpty()) &#123;</span><br><span class="line">            <span class="type">LoopVal</span> <span class="variable">loop</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoopVal</span>(basicBlock, latchBlocks);</span><br><span class="line">            LoopAnalysisController.addLoopIntoGraph(latchBlocks, loop);</span><br><span class="line">            latchBlocks.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    LoopAnalysisController.addLoopSons(basicBlocks.get(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="副作用分析"><a class="markdownIt-Anchor" href="#副作用分析"></a> 副作用分析</h4>
<p>在副作用分析之前，我们需要构建函数调用图，然后借助这个图完成分析。之后我们需要看该函数调用的所有函数，如果它调用的函数本身存在副作用或者它调用的函数没有被访问过且该函数调用的函数存在副作用，则该函数存在副作用。主要代码逻辑如下:</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">processAnalysis</span><span class="params">(Function function)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">sideEffect</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    addFunctionVisited(function, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (getFunctionProcessed(function)) &#123;</span><br><span class="line">        sideEffect = function.getSideEffect();</span><br><span class="line">        <span class="keyword">for</span> (Function response : function.getResponses()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!getFunctionVisited(response) &amp;&amp; !getFunctionProcessed(response)) &#123;</span><br><span class="line">                processAnalysis(response);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Function response : function.getResponses()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (response.getSideEffect() ||</span><br><span class="line">                (!getFunctionVisited(response) &amp;&amp; !getFunctionProcessed(response)</span><br><span class="line">                 &amp;&amp; processAnalysis(response))) &#123;</span><br><span class="line">                sideEffect = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    addFunctionVisited(function, <span class="literal">false</span>);</span><br><span class="line">    function.setSideEffect(sideEffect);</span><br><span class="line">    addFunctionProcessed(function, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> sideEffect;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="全局代码移动"><a class="markdownIt-Anchor" href="#全局代码移动"></a> 全局代码移动</h4>
<p>在完成两个前序步骤后，我们就可以正式展开优化了。全局代码移动算法的功能是调度那些“浮动”的指令，把它们归位到一个个基本块中。这个过程必须保留已有的控制依赖和数据依赖。在这个大前提下，算法可以自由发挥，我们的目标就是尽可能把代码移动到循环外面，尽可能让代码的执行路径变少。</p>
<p>而如果我们想要调度指令，需要遵守以下几个流程:find_Pinned_Insts，schedule_Early，schedule_Late，select_block</p>
<h5 id="find_pinned_insts"><a class="markdownIt-Anchor" href="#find_pinned_insts"></a> find_Pinned_Insts</h5>
<p>有些指令是无法被灵活调度的，如phi，br/jump，ret等指令，这些指令我们叫做pinnedInst。pinnedInst受到控制依赖的牵制，无法被调度到其他基本块，也就是说这些指令和它们的基本块是绑定的。这一部分，我们需要先遍历指令将pinnedInst进行标记。具体代码如下:</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isPinned</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> !(<span class="built_in">this</span> <span class="keyword">instanceof</span> CalcInstr) &amp;&amp; !(<span class="built_in">this</span> <span class="keyword">instanceof</span> IcmpInstr) &amp;&amp;</span><br><span class="line">        !(<span class="built_in">this</span> <span class="keyword">instanceof</span> ZextInstr) &amp;&amp; !(<span class="built_in">this</span> <span class="keyword">instanceof</span> GetEleInstr) &amp;&amp;</span><br><span class="line">        !(<span class="built_in">this</span> <span class="keyword">instanceof</span> CallInstr callInstr &amp;&amp; callInstr.isPure());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h5 id="schedule_early"><a class="markdownIt-Anchor" href="#schedule_early"></a> schedule_Early</h5>
<p>这一步骤我们会尽可能的把指令前移，<strong>确定每个指令能被调度到的最早的基本块</strong>，同时不影响指令间的依赖关系。这里我们可以直接参考教程提供的伪代码即可。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://charles2530.github.io/image/SysY-compiler-design-doc/image-20231120000001515.png"
                      alt="image-20231120000001515" 
                ></p>
<p>该函数对应的代码如下:</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * scheduleEarly 用于在GCM中实现尽可能的把指令前移，</span></span><br><span class="line"><span class="comment">     * 确定每个指令能被调度到的最早的基本块，同时不影响指令间的依赖关系。</span></span><br><span class="line"><span class="comment">     * 当我们把指令向前提时，限制它前移的是它的输入，</span></span><br><span class="line"><span class="comment">     * 即每条指令最早要在它的所有输入定义后的位置。</span></span><br><span class="line"><span class="comment">     * 该函数执行逻辑如下:</span></span><br><span class="line"><span class="comment">     * 1.如果已经处理过了，或者是无法移动，那么就结束处理。</span></span><br><span class="line"><span class="comment">     * 2.如果未处理，将这条指令从当前块移除，然后插入到入口块的最后一条指令之前。</span></span><br><span class="line"><span class="comment">     * 3.遍历该指令用到的操作数，尝试前移。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">scheduleEarly</span><span class="params">(Instr instr, Function function)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!visited.contains(instr) &amp;&amp; !instr.isPinned()) &#123;</span><br><span class="line">        visited.add(instr);</span><br><span class="line">        <span class="type">BasicBlock</span> <span class="variable">root</span> <span class="operator">=</span> function.getBasicBlocks().get(<span class="number">0</span>);</span><br><span class="line">        instr.getBelongingBlock().getInstrArrayList().remove(instr);</span><br><span class="line">        root.addInstr(instr, root.getInstrArrayList().size() - <span class="number">1</span>);</span><br><span class="line">        GlobalCodeMovementUnit.addPath(instr, root);</span><br><span class="line">        instr.getOperands().forEach(v -&gt; scheduleEarlyAnalysis(v, instr, function));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h5 id="schedule_late"><a class="markdownIt-Anchor" href="#schedule_late"></a> schedule_Late</h5>
<p>这部分我们会尽可能的把指令后移，<strong>确定每个指令能被调度到的最晚的基本块</strong>。每个指令也会被使用它们的指令限制，限制其不能无限向后移。这里我们同样可以直接参考教程提供的伪代码即可。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://charles2530.github.io/image/SysY-compiler-design-doc/image-20231120000151951.png"
                      alt="image-20231120000151951" 
                ></p>
<p>该函数对应的代码如下:</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * scheduleLate 用于在GCM中尽可能的把指令后移，</span></span><br><span class="line"><span class="comment">     * 确定每个指令能被调度到的最晚的基本块。</span></span><br><span class="line"><span class="comment">     * 每个指令也会被使用它们的指令限制，限制其不能无限向后移。</span></span><br><span class="line"><span class="comment">     * 该函数执行逻辑如下:</span></span><br><span class="line"><span class="comment">     * 1.如果已经处理过了，或者是无法移动，那么就结束处理。</span></span><br><span class="line"><span class="comment">     * 2.如果未处理，遍历该指令的使用者，寻找LCA尝试后移。</span></span><br><span class="line"><span class="comment">     * 3.如果该指令的使用者是Phi指令，那么遍历Phi指令的每个操作数，寻找LCA尝试后移。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">scheduleLate</span><span class="params">(Instr instr)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!visited.contains(instr) &amp;&amp; !instr.isPinned()) &#123;</span><br><span class="line">        visited.add(instr);</span><br><span class="line">        <span class="type">BasicBlock</span> <span class="variable">lcaBlock</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (User user : instr.getUsers()) &#123;</span><br><span class="line">            lcaBlock = scheduleLateAnalysis(user, instr, lcaBlock);</span><br><span class="line">        &#125;</span><br><span class="line">        GlobalCodeMovementUnit.pickFinalPos(lcaBlock, instr);</span><br><span class="line">        <span class="type">BasicBlock</span> <span class="variable">bestBlock</span> <span class="operator">=</span> instr.getBelongingBlock();</span><br><span class="line">        <span class="keyword">for</span> (Instr instInst : bestBlock.getInstrArrayList()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!instInst.equals(instr) &amp;&amp; !(instInst <span class="keyword">instanceof</span> PhiInstr) &amp;&amp;</span><br><span class="line">                instInst.getOperands().contains(instr)) &#123;</span><br><span class="line">                instr.getBelongingBlock().getInstrArrayList().remove(instr);</span><br><span class="line">                bestBlock.addInstr(instr, bestBlock.getInstrArrayList().indexOf(instInst));</span><br><span class="line">                GlobalCodeMovementUnit.addPath(instr, bestBlock);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h5 id="select_block"><a class="markdownIt-Anchor" href="#select_block"></a> select_block</h5>
<p>在确定每个指令可以被灵活调度的空间后，我们将进行最关键的一步，为指令选择它最终的基本块。这里选择的依据是循环深度尽可能浅且尽可能的靠前，这里循环分析就起作用了。这里对应代码如下:</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * pickFinalPos 用于在GCM中寻找指令最终所处的位置</span></span><br><span class="line"><span class="comment">     * 该函数的执行逻辑如下：</span></span><br><span class="line"><span class="comment">     * 1.如果该指令没有使用者，那么直接返回</span></span><br><span class="line"><span class="comment">     * 2.如果该指令有使用者，那么遍历该指令的使用者，找到最佳位置</span></span><br><span class="line"><span class="comment">     * 3.找到他们的LCA，如果他们是有共同祖先的，那么就将该指令插入到共同祖先的位置</span></span><br><span class="line"><span class="comment">     * 4.如果共同祖先不是该指令的所在块，则尽量让循环深度变小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">pickFinalPos</span><span class="params">(BasicBlock lcaBlock, Instr instr)</span> &#123;</span><br><span class="line">    <span class="type">BasicBlock</span> <span class="variable">posBlock</span> <span class="operator">=</span> lcaBlock;</span><br><span class="line">    <span class="keyword">if</span> (!instr.getUsers().isEmpty()) &#123;</span><br><span class="line">        <span class="type">BasicBlock</span> <span class="variable">bestBlock</span> <span class="operator">=</span> posBlock;</span><br><span class="line">        <span class="keyword">while</span> ((posBlock.getBlockDominateParent() != <span class="literal">null</span>) &amp;&amp;</span><br><span class="line">               !posBlock.equals(instr.getBelongingBlock())) &#123;</span><br><span class="line">            posBlock = posBlock.getBlockDominateParent();</span><br><span class="line">            <span class="keyword">if</span> (posBlock.getLoopDepth() &lt; bestBlock.getLoopDepth()) &#123;</span><br><span class="line">                bestBlock = posBlock;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        instr.getBelongingBlock().getInstrArrayList().remove(instr);</span><br><span class="line">        bestBlock.addInstr(instr, bestBlock.getInstrArrayList().size() - <span class="number">1</span>);</span><br><span class="line">        GlobalCodeMovementUnit.addPath(instr, bestBlock);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h2 id="后端代码优化"><a class="markdownIt-Anchor" href="#后端代码优化"></a> 后端代码优化</h2>
<h3 id="后端消除phi"><a class="markdownIt-Anchor" href="#后端消除phi"></a> 后端消除Phi</h3>
<p>由于phi指令的存在，所以我们不能直接将phi指令转化为汇编，消PHI最简单的一个思路是在源基本块跳转之前将PHI指令拆成多条move指令，之后再将move指令转化为汇编即可完成相关工作。</p>
<h4 id="phi指令转化"><a class="markdownIt-Anchor" href="#phi指令转化"></a> Phi指令转化</h4>
<p>要想将Phi指令转化为move指令，我们需要先将其转化为ParallelCopy指令并将其插入到跳转语句之前，而转化为ParallelCopy的方法就是将phiInstr的每个option都放到对应的ParallelCopy中，这里注意需要options按照前驱的顺序排列，然后删除Phi指令即可。这里可以参考课程教程伪代码如下:</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://charles2530.github.io/image/SysY-compiler-design-doc/image-20231120095602990.png"
                      alt="image-20231120095602990" 
                ></p>
<p>而将ParallelCopy指令转化为Move指令的过程，我们首先需要将其直接转化为一个move数组的集合，之后需要通过添加临时变量的方法解决循环赋值以及共享寄存器等问题，这样就可以形成所需的move指令，相关伪代码如下:</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://charles2530.github.io/image/SysY-compiler-design-doc/image-20231120095644956.png"
                      alt="image-20231120095644956" 
                ></p>
<p>而move指令的转汇编代码如下:</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generateAssembly</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.generateAssembly();</span><br><span class="line">    <span class="type">Register</span> <span class="variable">dstReg</span> <span class="operator">=</span> AssemblyUnit.getRegisterController().getRegister(to);</span><br><span class="line">    <span class="type">Register</span> <span class="variable">srcReg</span> <span class="operator">=</span> AssemblyUnit.getRegisterController().getRegister(from);</span><br><span class="line">    <span class="keyword">if</span> (dstReg != <span class="literal">null</span> &amp;&amp; dstReg.equals(srcReg)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    dstReg = (dstReg == <span class="literal">null</span>) ? Register.K0 : dstReg;</span><br><span class="line">    srcReg = RegisterUtils.loadVariableValue(from, srcReg, dstReg);</span><br><span class="line">    <span class="keyword">if</span> (!srcReg.equals(dstReg)) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">MoveAsm</span>(dstReg, srcReg);</span><br><span class="line">    &#125;</span><br><span class="line">    RegisterUtils.memAllocReg(to, dstReg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>而这里在转move指令部分我们就需要用到分配寄存器，这些需要我们在后续使用图着色算法进行设计。</p>
<h4 id="图着色寄存器分配"><a class="markdownIt-Anchor" href="#图着色寄存器分配"></a> 图着色寄存器分配</h4>
<p>由于mips只有32个寄存器，所以如何进行寄存器分配是编译优化当中一个重要的问题。这里的基本思路是保留目前处于活跃状态的寄存器，如果当前寄存器全部分配完成，则需要依靠堆栈进行分配(不过这种情况基本不会出现)。</p>
<p>这里我先用枚举类Register来表示表示MIPS中的寄存器，代码如下:</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">Register</span> &#123;</span><br><span class="line">    <span class="comment">// MIPS registers</span></span><br><span class="line">    ZERO(<span class="string">&quot;$zero&quot;</span>),</span><br><span class="line">    V0(<span class="string">&quot;$v0&quot;</span>), V1(<span class="string">&quot;$v1&quot;</span>),</span><br><span class="line">    A0(<span class="string">&quot;$a0&quot;</span>), A1(<span class="string">&quot;$a1&quot;</span>), A2(<span class="string">&quot;$a2&quot;</span>), A3(<span class="string">&quot;$a3&quot;</span>),</span><br><span class="line">    T0(<span class="string">&quot;$t0&quot;</span>), T1(<span class="string">&quot;$t1&quot;</span>), T2(<span class="string">&quot;$t2&quot;</span>), T3(<span class="string">&quot;$t3&quot;</span>), T4(<span class="string">&quot;$t4&quot;</span>), T5(<span class="string">&quot;$t5&quot;</span>), T6(<span class="string">&quot;$t6&quot;</span>), T7(<span class="string">&quot;$t7&quot;</span>),</span><br><span class="line">    S0(<span class="string">&quot;$s0&quot;</span>), S1(<span class="string">&quot;$s1&quot;</span>), S2(<span class="string">&quot;$s2&quot;</span>), S3(<span class="string">&quot;$s3&quot;</span>), S4(<span class="string">&quot;$s4&quot;</span>), S5(<span class="string">&quot;$s5&quot;</span>), S6(<span class="string">&quot;$s6&quot;</span>), S7(<span class="string">&quot;$s7&quot;</span>),</span><br><span class="line">    T8(<span class="string">&quot;$t8&quot;</span>), T9(<span class="string">&quot;$t9&quot;</span>),</span><br><span class="line">    K0(<span class="string">&quot;$k0&quot;</span>), K1(<span class="string">&quot;$k1&quot;</span>), GP(<span class="string">&quot;$gp&quot;</span>), SP(<span class="string">&quot;$sp&quot;</span>), FP(<span class="string">&quot;$fp&quot;</span>), RA(<span class="string">&quot;$ra&quot;</span>);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * regName 是寄存器的名称，便于使用enum的值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String regName;</span><br><span class="line"></span><br><span class="line">    Register(String regName) &#123;</span><br><span class="line">        <span class="built_in">this</span>.regName = regName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * regTransform 方法用于将int类型的index转换为Register类型，</span></span><br><span class="line"><span class="comment">     * 类似于enum的valueOf方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Register <span class="title function_">regTransform</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> values()[index];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> regName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>之后我们在寄存器分配控制器中装入所有可以使用的寄存器，然后完成相关分配工作即可，具体而言是我们需要设计var2reg和reg2var这两个实现value和寄存器的映射即可。</p>
<p>当我们需要分配寄存器给基本块时，首先遍历一边所有指令，记录每个变量在该基本块里最后一次被使用的位置，之后再遍历一遍所有指令,执行releaseReg方法，然后遍历其直接支配的节点,调用映射函数reflection并将该基本块定义的变量对应的寄存器释放，最后将“后继不再使用但是是从indBasicBlock传过来”的变量对应的寄存器映射恢复回来，即可完成申请寄存器操作。简要代码如下:</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">blockAllocate</span><span class="params">(BasicBlock entry)</span> &#123;</span><br><span class="line">    HashMap&lt;Value, Value&gt; lastUseMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    HashSet&lt;Value&gt; defined = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    HashSet&lt;Value&gt; used = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    entry.getInstrArrayList().forEach(instr -&gt; instr.getOperands().forEach(</span><br><span class="line">        operand -&gt; lastUseMap.put(operand, instr)));</span><br><span class="line">    entry.getInstrArrayList().forEach(instr -&gt; releaseReg(entry, instr, lastUseMap,</span><br><span class="line">                                                          var2reg, reg2var, defined, used));</span><br><span class="line">    entry.getBlockDominateChildList().forEach(RegisterAllocator::reflection);</span><br><span class="line">    <span class="keyword">for</span> (Value value : defined) &#123;</span><br><span class="line">        <span class="keyword">if</span> (var2reg.containsKey(value)) &#123;</span><br><span class="line">            reg2var.remove(var2reg.get(value));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (Value value : used) &#123;</span><br><span class="line">        <span class="keyword">if</span> (var2reg.containsKey(value) &amp;&amp; !defined.contains(value)) &#123;</span><br><span class="line">            reg2var.put(var2reg.get(value), value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>而释放寄存器方面，我们分为两种情况讨论。如果该指令的某个operand是该基本块内的最后一次使用，并且该基本块的out中没有这个operand,那么我们可以暂时释放这个变量所占用的寄存器（释放reg2var，但不改变var2reg）。而如果该指令属于定义语句，并且不是创建数组的alloc指令，我们需要为该变量分配寄存器，代码逻辑如下:</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">releaseReg</span><span class="params">(BasicBlock entry, Instr instr, HashMap&lt;Value, Value&gt; lastUseMap,</span></span><br><span class="line"><span class="params">                               HashMap&lt;Value, Register&gt; var2reg,</span></span><br><span class="line"><span class="params">                               HashMap&lt;Register, Value&gt; reg2var,</span></span><br><span class="line"><span class="params">                               HashSet&lt;Value&gt; defined, HashSet&lt;Value&gt; used)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(instr <span class="keyword">instanceof</span> PhiInstr)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Value operand : instr.getOperands()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (lastUseMap.get(operand).equals(instr) &amp;&amp; var2reg.containsKey(operand) &amp;&amp;</span><br><span class="line">                !entry.getOutBasicBlockHashSet().contains(operand)) &#123;</span><br><span class="line">                reg2var.remove(var2reg.get(operand));</span><br><span class="line">                used.add(operand);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (instr.isValid() &amp;&amp; !(instr <span class="keyword">instanceof</span> ZextInstr)) &#123;</span><br><span class="line">        defined.add(instr);</span><br><span class="line">        <span class="type">Register</span> <span class="variable">reg</span> <span class="operator">=</span> allocRegFor();</span><br><span class="line">        <span class="keyword">if</span> (reg != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (reg2var.containsKey(reg)) &#123;</span><br><span class="line">                var2reg.remove(reg2var.get(reg));</span><br><span class="line">            &#125;</span><br><span class="line">            reg2var.put(reg, instr);</span><br><span class="line">            var2reg.put(instr, reg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>这样我们就完成了寄存器的分配，但还有一个重要的问题没有解决，哪些寄存器可以释放呢，这就需要活跃性分析决定哪些变量需要保留。</p>
<h5 id="活跃性变量分析"><a class="markdownIt-Anchor" href="#活跃性变量分析"></a> 活跃性变量分析</h5>
<p>为了实现活跃性变量分析，首先我们需要生成Use-Def链，先使用后定义的变量放在use中，先定义后使用的变量放在def中，代码逻辑如下:</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">genUseDefAnalysis</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (Value operand : <span class="built_in">this</span>.getOperands()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.getBelongingBlock().getDefBasicBlockHashSet().contains(operand) &amp;&amp;</span><br><span class="line">            (operand <span class="keyword">instanceof</span> Instr || operand <span class="keyword">instanceof</span> GlobalVar</span><br><span class="line">             || operand <span class="keyword">instanceof</span> Param)) &#123;</span><br><span class="line">            <span class="built_in">this</span>.getBelongingBlock().getUseBasicBlockHashSet().add(operand);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.getBelongingBlock().getUseBasicBlockHashSet().contains(<span class="built_in">this</span>) &amp;&amp; <span class="built_in">this</span>.isValid()) &#123;</span><br><span class="line">        <span class="built_in">this</span>.getBelongingBlock().getDefBasicBlockHashSet().add(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>之后需要根据之前获得的use和def的情况计算每个基本块的in集合和out集合，即根据后继的in，求出当前block的out，再根据公式in = (out - def) + use，求出当前基本块的in，如果in集合发生变化，则继续执行while循环，否则结束，代码逻辑如下:</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">calculateInOut</span><span class="params">(Function function)</span> &#123;</span><br><span class="line">    ArrayList&lt;BasicBlock&gt; basicBlocks = function.getBasicBlocks();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">change</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">while</span> (change) &#123;</span><br><span class="line">        change = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> basicBlocks.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="type">BasicBlock</span> <span class="variable">basicBlock</span> <span class="operator">=</span> basicBlocks.get(i);</span><br><span class="line">            HashSet&lt;Value&gt; out = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">            basicBlock.getBlockOutBasicBlock().forEach(</span><br><span class="line">                successor -&gt; out.addAll(successor.getInBasicBlockHashSet()));</span><br><span class="line">            addOutBlockHashSet(basicBlock, out);</span><br><span class="line">            HashSet&lt;Value&gt; in = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(out);</span><br><span class="line">            in.removeAll(basicBlock.getDefBasicBlockHashSet());</span><br><span class="line">            in.addAll(basicBlock.getUseBasicBlockHashSet());</span><br><span class="line">            HashSet&lt;Value&gt; originIn = basicBlock.getInBasicBlockHashSet();</span><br><span class="line">            addInBlockHashSet(basicBlock, in);</span><br><span class="line">            <span class="keyword">if</span> (!in.equals(originIn)) &#123;</span><br><span class="line">                change = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h3 id="跳转指令删除"><a class="markdownIt-Anchor" href="#跳转指令删除"></a> 跳转指令删除</h3>
<p>由于在llvm中每个基本块的最后一定要有跳转语句，而mips如果最后没有跳转则可以自动顺延到下一个块，所以当llvm如果跳转的就是下一个块，则可以省略一条跳转语句，除此之外如果两个块的前序后继均为1则可以直接合并这两个块，这部分比较简单，在此不再详细说明。</p>
<blockquote>
<p>至此编译器设计完整结束!!!</p>
</blockquote>
<h2 id="参考编译器"><a class="markdownIt-Anchor" href="#参考编译器"></a> 参考编译器</h2>
<p>[1].<a class="link"   target="_blank" rel="noopener" href="https://github.com/Hyggge/Petrichor" >Hyggge/Petrichor: Java 实现的 SysY - LLVM IR 编译器 (github.com) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>[2].<a class="link"   target="_blank" rel="noopener" href="https://github.com/echo17666/BUAA2022-SysY-Compiler" >echo17666/BUAA2022-SysY-Compiler: A SysY Compiler written by Java for the Compiler Technology Course in BUAA (github.com) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>[3].<a class="link"   target="_blank" rel="noopener" href="https://github.com/Chenrt-ggx/MipsCompiler" >Chenrt-ggx/MipsCompiler: BUAA 1906 Mips Compiler (github.com) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>[4].<a class="link"   target="_blank" rel="noopener" href="https://github.com/Thysrael/Pansy" >Thysrael/Pansy: 一个简单的编译 SysY 语言（C 语言子集）到 Mips 的编译器，采用 Java 实现。 (github.com) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>

        </div>

        
            <div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
                <div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> SysY-compiler-design-doc</li>
        <li><strong>Author:</strong> Charles</li>
        <li><strong>Created at
                :</strong> 2023-09-19 10:28:17</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2023-12-24 10:29:28
            </li>
        
        <li>
            <strong>Link:</strong> https://charles2530.github.io/2023/09/19/sysy-compiler-design-doc/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
                
                    <li class="tag-item mx-0.5">
                        <a href="/tags/compiler/">#compiler</a>&nbsp;
                    </li>
                
            </ul>
        

        
  <div class="recommended-article px-2 sm:px-6 md:px-8">
   <div class="recommended-desktop">
    <div class="recommended-article-header text-xl md:text-3xl font-bold mt-10">
     <i aria-hidden="true"></i><span>recommend_articles</span>
    </div>
    <div class="recommended-article-group"><a class="recommended-article-item" href="/2023/09/20/chatgpt-plus-accounts-access/" title="ChatGPT-Plus-Accounts-Access" rel="bookmark">
  <img src="https://charles2530.github.io/image/background/p4.jpg" alt="ChatGPT-Plus-Accounts-Access" class="!max-w-none">
  <span class="title">ChatGPT-Plus-Accounts-Access</span>
</a><a class="recommended-article-item" href="/2023/07/17/swift-note-14/" title="Swift-note-14" rel="bookmark">
  <img src="https://charles2530.github.io/image/background/p4.jfif" alt="Swift-note-14" class="!max-w-none">
  <span class="title">Swift-note-14</span>
</a><a class="recommended-article-item" href="/2023/02/18/bash-note-4/" title="Bash-note-4" rel="bookmark">
  <img src="https://charles2530.github.io/image/background/p4.jfif" alt="Bash-note-4" class="!max-w-none">
  <span class="title">Bash-note-4</span>
</a></div>
   </div>
   <div class="recommended-mobile">
   <div class="recommended-article-header text-xl md:text-3xl font-bold mt-10">
     <i aria-hidden="true"></i><span>recommend_articles</span>
   </div>
   <div class="recommended-article-group"><a class="recommended-article-item" href="/2023/09/20/chatgpt-plus-accounts-access/" title="ChatGPT-Plus-Accounts-Access" rel="bookmark">
  <img src="https://charles2530.github.io/image/background/p4.jpg" alt="ChatGPT-Plus-Accounts-Access" class="!max-w-none">
  <span class="title">ChatGPT-Plus-Accounts-Access</span>
</a><a class="recommended-article-item" href="/2023/07/17/swift-note-14/" title="Swift-note-14" rel="bookmark">
  <img src="https://charles2530.github.io/image/background/p4.jfif" alt="Swift-note-14" class="!max-w-none">
  <span class="title">Swift-note-14</span>
</a></div>
   </div>
  </div>

        
            <div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
                
                    <div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="prev"
                        rel="prev"
                        href="/2023/09/20/chatgpt-plus-accounts-access/"
                        >
                            <span class="left arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-left"></i>
                            </span>
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">ChatGPT-Plus-Accounts-Access</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="next"
                        rel="next"
                        href="/2023/09/15/mpi-note-2/"
                        >
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">MPI-note-2</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        


        
            <div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
                <div class="comments-container mt-10 w-full ">
    <div id="comment-anchor" class="w-full h-2.5"></div>
    <div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">
        Comments
    </div>
    

        <!-- 
            
    <div id="gitalk-container"></div>
    <script data-swup-reload-script
            src="//cdn.staticfile.org/gitalk/1.8.0/gitalk.min.js"></script>
    <script data-swup-reload-script>

        function loadGitalk() {
            let __gitalk__pathname = decodeURI(location.pathname);
            const __gitalk__pathnameLength = __gitalk__pathname.length;
            const __gitalk__pathnameMaxLength = 50;
            if (__gitalk__pathnameLength > __gitalk__pathnameMaxLength) {
                __gitalk__pathname = __gitalk__pathname.substring(0, __gitalk__pathnameMaxLength - 3) + '...';
            }

            try {
                Gitalk && new Gitalk({
                    clientID: '8083299a8ee2aaf23879',
                    clientSecret: 'a8161e81d4872181e884fdb69f7be24916b6a9d0',
                    repo: 'charles2530_issues',
                    owner: 'Charles2530',
                    admin: ['Charles2530'],
                    id: __gitalk__pathname,
                    language: 'en',
                    proxy: 'https://github.com/login/oauth/access_token'
                }).render('gitalk-container');

            } catch (e) {
                window.Gitalk = null;
            }
        }

        if ('true') {
            const loadGitalkTimeout = setTimeout(() => {
                loadGitalk();
                clearTimeout(loadGitalkTimeout);
            }, 1000);
        } else {
            window.addEventListener('DOMContentLoaded', loadGitalk);
        }
    </script>



         -->
        <script src="https://utteranc.es/client.js" repo="Charles2530/Charles2530.github.io" issue-term="pathname"
            label="Comment" theme="preferred-color-scheme" crossorigin="anonymous" async>
            </script>
    
</div>

            </div>
        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">SysY-compiler-design-doc</div>
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#sysy%E7%BC%96%E8%AF%91%E5%99%A8%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3"><span class="nav-text"> SysY编译器设计文档</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E7%BC%96%E8%AF%91%E5%99%A8%E4%BB%8B%E7%BB%8D"><span class="nav-text"> 参考编译器介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E5%99%A8%E6%80%BB%E4%BD%93%E8%AE%BE%E8%AE%A1"><span class="nav-text"> 编译器总体设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8Ejava%E8%AF%AD%E8%A8%80%E8%AE%BE%E8%AE%A1"><span class="nav-text"> 基于Java语言设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E4%BD%93%E7%BB%93%E6%9E%84"><span class="nav-text"> 总体结构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90"><span class="nav-text"> 词法分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E4%BD%93%E8%AE%BE%E8%AE%A1"><span class="nav-text"> 总体设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%8D%E6%B3%95%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="nav-text"> 词法错误处理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95%E5%88%86%E6%9E%90"><span class="nav-text"> 语法分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E4%BD%93%E8%AE%BE%E8%AE%A1-2"><span class="nav-text"> 总体设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%84%E9%80%A0ast%E7%94%9F%E6%88%90%E5%9B%BE%E8%BE%85%E5%8A%A9%E8%AE%BE%E8%AE%A1%E6%96%87%E6%B3%95%E5%88%86%E6%9E%90%E7%A8%8B%E5%BA%8F"><span class="nav-text"> 构造AST生成图辅助设计文法分析程序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%94%B9%E5%86%99%E5%B7%A6%E9%80%92%E5%BD%92%E6%96%87%E6%B3%95"><span class="nav-text"> 改写左递归文法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95%E5%88%86%E6%9E%90%E5%85%B7%E4%BD%93%E8%AE%BE%E8%AE%A1"><span class="nav-text"> 语法分析具体设计</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%84%E7%90%86%E9%A2%84%E8%AF%BB%E6%93%8D%E4%BD%9C"><span class="nav-text"> 处理预读操作</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="nav-text"> 语法错误处理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="nav-text"> 错误处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%A6%E5%8F%B7%E8%A1%A8%E5%BB%BA%E7%AB%8B"><span class="nav-text"> 符号表建立</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%A6%E5%8F%B7%E8%A1%A8%E7%9A%84%E7%BB%84%E6%88%90"><span class="nav-text"> 符号表的组成</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#symbol"><span class="nav-text"> Symbol</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#stacksymboltable"><span class="nav-text"> StackSymbolTable</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#symboltable"><span class="nav-text"> SymbolTable</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%AD%E4%B9%89%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="nav-text"> 语义错误处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E6%80%BB%E8%A7%88"><span class="nav-text"> 错误处理总览</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%AD%E4%B9%89%E5%88%86%E6%9E%90%E5%8D%95%E5%85%83"><span class="nav-text"> 语义分析单元</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#errorcontroller%E5%92%8Cerrortoken"><span class="nav-text"> ErrorController和ErrorToken</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#span"><span class="nav-text"> Span</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AF%AD%E4%B9%89%E5%88%86%E6%9E%90%E5%A4%84%E7%90%86"><span class="nav-text"> 语义分析处理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E5%8F%82%E6%95%B0%E5%8C%B9%E9%85%8D%E9%97%AE%E9%A2%98"><span class="nav-text"> 函数参数匹配问题</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90"><span class="nav-text"> 中间代码生成</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#llvm_ir%E8%BD%AC%E5%8C%96"><span class="nav-text"> llvm_ir转化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#for%E5%BE%AA%E7%8E%AF%E7%9A%84%E5%A4%84%E7%90%86"><span class="nav-text"> For循环的处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%98%E9%87%8F%E5%90%8D%E9%87%8D%E5%AE%9A%E4%B9%89"><span class="nav-text"> 变量名重定义</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#value%E8%AF%AD%E6%B3%95%E6%A0%91%E5%BB%BA%E7%AB%8B"><span class="nav-text"> Value语法树建立</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80%E5%88%87%E7%9A%86value"><span class="nav-text"> 一切皆value</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#function%E7%BB%93%E6%9E%84"><span class="nav-text"> Function结构</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#instr%E7%B1%BB%E5%9E%8B"><span class="nav-text"> Instr类型</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B1%BB%E5%9E%8B%E7%AE%A1%E7%90%86"><span class="nav-text"> 类型管理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C%E7%BB%B4%E6%95%B0%E7%BB%84"><span class="nav-text"> 二维数组</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%9F%E6%88%90mips%E4%BB%A3%E7%A0%81"><span class="nav-text"> 生成mips代码</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B1%87%E7%BC%96%E6%8C%87%E4%BB%A4%E8%BD%AC%E5%8C%96"><span class="nav-text"> 汇编指令转化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%88%E6%8C%87%E9%92%88%E7%A7%BB%E5%8A%A8"><span class="nav-text"> 栈指针移动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%84%E5%AD%98%E5%99%A8%E6%8E%A7%E5%88%B6"><span class="nav-text"> 寄存器控制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E7%AD%96%E7%95%A5"><span class="nav-text"> 内存管理策略</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%AD%E7%AB%AF%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96"><span class="nav-text"> 中端代码优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E5%B1%80%E9%83%A8%E5%8C%96"><span class="nav-text"> 全局变量局部化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E5%9D%97%E7%AE%80%E5%8C%96"><span class="nav-text"> 基本块简化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E9%87%8D%E5%A4%8D%E5%88%86%E6%94%AF%E8%AF%AD%E5%8F%A5"><span class="nav-text"> 删除重复分支语句</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%AD%BB%E4%BB%A3%E7%A0%81%E5%9D%97"><span class="nav-text"> 删除死代码块</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mem2reg"><span class="nav-text"> Mem2Reg</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#cfg%E6%B5%81%E5%9B%BE%E6%9E%84%E5%BB%BA"><span class="nav-text"> CFG流图构建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%94%AF%E9%85%8D%E6%A0%91%E5%8F%8Adf%E6%9E%84%E5%BB%BA"><span class="nav-text"> 支配树及DF构建</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%94%AF%E9%85%8D%E9%9B%86%E5%90%88"><span class="nav-text"> 支配集合</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E6%94%AF%E9%85%8D%E6%A0%91"><span class="nav-text"> 构建支配树</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E6%94%AF%E9%85%8D%E8%BE%B9%E7%95%8C%E9%9B%86%E5%90%88"><span class="nav-text"> 构建支配边界集合</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AE%A1%E7%AE%97%E6%94%AF%E9%85%8D%E6%A0%91%E6%B7%B1%E5%BA%A6%E9%9B%86"><span class="nav-text"> 计算支配树深度集</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%92%E5%85%A5phi%E6%8C%87%E4%BB%A4"><span class="nav-text"> 插入Phi指令</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#phi%E6%8C%87%E4%BB%A4%E4%BD%8D%E7%BD%AE%E9%80%89%E6%8B%A9"><span class="nav-text"> Phi指令位置选择</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%98%E9%87%8F%E9%87%8D%E5%91%BD%E5%90%8D"><span class="nav-text"> 变量重命名</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%BB%E4%BB%A3%E7%A0%81%E5%88%A0%E9%99%A4"><span class="nav-text"> 死代码删除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E5%86%85%E8%81%94"><span class="nav-text"> 函数内联</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E8%81%94%E5%87%BD%E6%95%B0%E6%93%8D%E4%BD%9C"><span class="nav-text"> 内联函数操作</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gvm"><span class="nav-text"> GVM</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E6%95%B0%E6%8A%98%E5%8F%A0"><span class="nav-text"> 常数折叠</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E9%99%A4%E5%85%AC%E5%85%B1%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-text"> 消除公共表达式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gcm"><span class="nav-text"> GCM</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF%E5%88%86%E6%9E%90"><span class="nav-text"> 循环分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%89%AF%E4%BD%9C%E7%94%A8%E5%88%86%E6%9E%90"><span class="nav-text"> 副作用分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E4%BB%A3%E7%A0%81%E7%A7%BB%E5%8A%A8"><span class="nav-text"> 全局代码移动</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#find_pinned_insts"><span class="nav-text"> find_Pinned_Insts</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#schedule_early"><span class="nav-text"> schedule_Early</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#schedule_late"><span class="nav-text"> schedule_Late</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#select_block"><span class="nav-text"> select_block</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%8E%E7%AB%AF%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96"><span class="nav-text"> 后端代码优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8E%E7%AB%AF%E6%B6%88%E9%99%A4phi"><span class="nav-text"> 后端消除Phi</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#phi%E6%8C%87%E4%BB%A4%E8%BD%AC%E5%8C%96"><span class="nav-text"> Phi指令转化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9B%BE%E7%9D%80%E8%89%B2%E5%AF%84%E5%AD%98%E5%99%A8%E5%88%86%E9%85%8D"><span class="nav-text"> 图着色寄存器分配</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B4%BB%E8%B7%83%E6%80%A7%E5%8F%98%E9%87%8F%E5%88%86%E6%9E%90"><span class="nav-text"> 活跃性变量分析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%B3%E8%BD%AC%E6%8C%87%E4%BB%A4%E5%88%A0%E9%99%A4"><span class="nav-text"> 跳转指令删除</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E7%BC%96%E8%AF%91%E5%99%A8"><span class="nav-text"> 参考编译器</span></a></li></ol></li></ol>

    </div>
</div>
        </div>
    
</div>



                

            </div>

            

        </div>

        <div class="main-content-footer">
            <footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2022</span>
              -
            
            2024&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">Charles</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        302 posts in total
                    </span>
                    
                        <span>
                            1279k words in total
                        </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://cn.vercount.one/js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">Visitor Count</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">Total Page Views</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">Powered by Charles</span>
            <span class="text-sm lg:block">Theme&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.6.1</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
            
                
        
                
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fa-regular fa-comments"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="right-bottom-tools rss flex justify-center items-center">
                <a class="flex justify-center items-center"
                   href="/atom.xml"
                   target="_blank"
                >
                <i class="fa-regular fa-rss"></i>
                </a>
            </li>
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>


    <script src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/libs/Swup.min.js"></script><script src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/libs/SwupSlideTheme.min.js"></script><script src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/libs/SwupScriptsPlugin.min.js"></script><script src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/libs/SwupProgressPlugin.min.js"></script><script src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/libs/SwupScrollPlugin.min.js"></script><script src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/libs/SwupPreloadPlugin.min.js"></script>
<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>






<script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/tools/imageViewer.js"></script><script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/utils.js"></script><script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/main.js"></script><script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/layouts/navbarShrink.js"></script><script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/tools/scrollTopBottom.js"></script><script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/tools/lightDarkSwitch.js"></script><script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/layouts/categoryList.js"></script>


    <script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/tools/localSearch.js"></script>



    <script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/tools/codeBlock.js"></script>



    <script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/layouts/lazyload.js"></script>



    <script src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/tools/runtime.js"></script>
    <script src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/libs/odometer.min.js"></script>
    <link rel="stylesheet" href="//evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/assets/odometer-theme-minimal.css">



  <script src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/libs/Typed.min.js"></script>
  <script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/plugins/typed.js"></script>



    <script src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/libs/mermaid.min.js"></script>
    <script src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/plugins/mermaid.js"></script>



    <script src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/libs/minimasonry.min.js"></script>
    <script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/plugins/masonry.js"></script>




<div class="post-scripts" data-swup-reload-script>
    
        <script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/tools/tocToggle.js"></script><script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/layouts/toc.js"></script><script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.6.1/source/js/plugins/tabs.js"></script>
    
</div>


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/love.js"></script>