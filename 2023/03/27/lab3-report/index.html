<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Charles">
    <meta name="description" content="This is Charles&#39;s Castle">
    <meta name="author" content="Charles">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-redefine.png">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://evan.beee.top" crossorigin>
    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://charles2530.github.io/2023/03/27/lab3-report/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="post by Charles in 2023-03-27 21:48:05">
<meta property="og:type" content="article">
<meta property="og:title" content="lab3_report">
<meta property="og:url" content="http://charles2530.github.io/2023/03/27/lab3-report/index.html">
<meta property="og:site_name" content="Charles&#39;s Castle">
<meta property="og:description" content="post by Charles in 2023-03-27 21:48:05">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://charles2530.github.io/image/self-reflection">
<meta property="og:image" content="http://charles2530.github.io/image/image-20230330211057021.png">
<meta property="og:image" content="http://charles2530.github.io/image/3.4-1.png">
<meta property="og:image" content="http://charles2530.github.io/image/3.4-2.png">
<meta property="og:image" content="http://charles2530.github.io/image/create.png">
<meta property="og:image" content="http://charles2530.github.io/image/irq.png">
<meta property="og:image" content="http://charles2530.github.io/image/image-20230330220427451.png">
<meta property="article:published_time" content="2023-03-27T13:48:05.000Z">
<meta property="article:modified_time" content="2023-03-30T14:16:07.715Z">
<meta property="article:author" content="Du Jinyang">
<meta property="article:tag" content="OS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://charles2530.github.io/image/self-reflection">
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="https://charles2530.github.io/image/background/favicon.png" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="https://charles2530.github.io/image/background/favicon.png">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="https://charles2530.github.io/image/background/favicon.png">
    <!--- Page Info-->
    
    <title>
        
            lab3_report -
        
        Charles&#39;s Castle
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/assets/fonts.css">

    <!--- Font Part-->
    
    
    
    

    <!--- Inject Part-->
    
    <script id="hexo-configurations">
    let Global = window.Global || {};
    Global.hexo_config = {"hostname":"charles2530.github.io","root":"/","language":"en","path":"search.xml"};
    Global.theme_config = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center"},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":true,"list":["lol","Neo","God"]},"code_block":{"copy":true,"style":"mac","font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":6,"number":false,"expand":true,"init_open":true},"copyright":true,"lazyload":true,"recommendation":{"enable":true,"title":"recommend_articles","limit":3,"placeholder":"https://charles2530.github.io/image/background/p3.jfif","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":"#1890ff"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":true},"scroll_progress":{"bar":true,"percentage":true},"busuanzi_counter":{"enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"pjax":true,"open_graph":true},"home_banner":{"enable":true,"image":{"light":"https://charles2530.github.io/image/background/background-light1.jpg","dark":"https://charles2530.github.io/image/background/background-dark1.jpg"},"title":"Charles's Castle","subtitle":{"text":["Happiness is best","Never give up","Everyday is a gift","Happiness is best!","Never give up!","Everyday is a gift!"],"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#000000","dark":"#d1d1b6"},"text_style":{"title_size":"3.2rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":true,"links":{"github":"https://github.com/Charles2530/","zhihu":"https://www.zhihu.com/people/yang-guang-xiao-zi-55-55","email":"charles2530@163.com"}}},"plugins":{"feed":{"enable":true},"aplayer":{"enable":false,"audios":[{"name":null,"artist":null,"url":null,"cover":null},{"name":null,"artist":null,"url":null,"cover":null}]},"mermaid":{"enable":true,"version":"9.3.0"}},"version":"2.0.3","navbar":{"auto_hide":true,"color":{"left":"#f78736","right":"#367df7","transparency":35},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Categories":{"path":"/categories","icon":"fas fa-bookmark"},"Tags":{"path":"/tags","icon":"fas fa-tags"},"About":{"icon":"fa-regular fa-user","submenus":{"Me":"/about","Github":"https://github.com/Charles2530/","Blog":"https://charles2530.github.io","Friends":"/friends"}}},"search":{"enable":true,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}}};
    Global.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 6.3.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style><link rel="alternate" href="/atom.xml" title="Charles's Castle" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>



<body>
  <div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="main-content-container">

        <div class="main-content-header">
            <header class="navbar-container">
    
    <div class="navbar-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                Charles&#39;s Castle
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/"  >
                                    
                                        
                                            <i class="fa-regular fa-house"></i>
                                        
                                        HOME
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/archives"  >
                                    
                                        
                                            <i class="fa-regular fa-archive"></i>
                                        
                                        ARCHIVES
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/categories"  >
                                    
                                        
                                            <i class="fas fa-bookmark"></i>
                                        
                                        CATEGORIES
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/tags"  >
                                    
                                        
                                            <i class="fas fa-tags"></i>
                                        
                                        TAGS
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown" 
                                    href="#" onClick="return false;">
                                    
                                        
                                            <i class="fa-regular fa-user"></i>
                                        
                                        ABOUT&nbsp;<i class="fa-solid fa-chevron-down"></i>
                                    
                                </a>
                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                    
                                        <li>
                                        <a href="/about">ME
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://github.com/Charles2530/">GITHUB
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a href="https://charles2530.github.io">BLOG
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a href="/friends">FRIENDS
                                        </a>
                                        </li>
                                    
                                    </ul>
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="navbar-drawer">
        <ul class="drawer-navbar-list">
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/"  >
                             
                                
                                    <i class="fa-regular fa-house"></i>
                                
                                HOME
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/archives"  >
                             
                                
                                    <i class="fa-regular fa-archive"></i>
                                
                                ARCHIVES
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/categories"  >
                             
                                
                                    <i class="fas fa-bookmark"></i>
                                
                                CATEGORIES
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/tags"  >
                             
                                
                                    <i class="fas fa-tags"></i>
                                
                                TAGS
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="has-dropdown" 
                        href="#" onClick="return false;">
                            
                                
                                    <i class="fa-regular fa-user"></i>
                                
                                ABOUT&nbsp;<i class="fa-solid fa-chevron-down"></i>
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                              
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" href="/about">ME</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" target="_blank" rel="noopener" href="https://github.com/Charles2530/">GITHUB</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" href="https://charles2530.github.io">BLOG</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" href="/friends">FRIENDS</a>
                            </li>
                        
                    
            

        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            
                      
                <div class="article-title">
                    <img src="https://charles2530.github.io/image/background/p2.jpg" alt="lab3_report" />
                    <h1 class="article-title-cover">lab3_report</h1>
                </div>
            
                
            

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="https://charles2530.github.io/image/background/logo.jpg">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">Charles</span>
                            
                                <span class="author-label">Lv6</span>
                            
                        </div>
                        <div class="meta-info">
                            <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2023-03-27 21:48:05</span>
        <span class="mobile">2023-03-27 21:48</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2023-03-30 22:16:07</span>
            <span class="mobile">2023-03-30 22:16</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/Lesson/">Lesson</a>&nbsp;
                    </li>
                
                    <li>
                        &gt; <a href="/categories/Lesson/OS/">OS</a>&nbsp;
                    </li>
                
                    <li>
                        &gt; <a href="/categories/Lesson/OS/OS-report/">OS-report</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/OS/">OS</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content markdown-body">
                <h1 id="lab3-report"><a href="#lab3-report" class="headerlink" title="lab3_report"></a>lab3_report</h1><blockquote>
<p>OO和OS都在学进程，着实这段时间被进程折磨有点狠</p>
</blockquote>
<h3 id="lab-thinkings"><a href="#lab-thinkings" class="headerlink" title="lab_thinkings"></a>lab_thinkings</h3><h4 id="Thinking-3-1"><a href="#Thinking-3-1" class="headerlink" title="Thinking 3.1"></a>Thinking 3.1</h4><h5 id="question"><a href="#question" class="headerlink" title="question"></a>question</h5><blockquote>
<p>请结合 MOS 中的页目录自映射应用解释代码中 <code>e-&gt;env_pgdir[PDX(UVPT)]= PADDR(e-&gt;env_pgdir) | PTE_V </code>的含义。 </p>
</blockquote>
<h5 id="answer"><a href="#answer" class="headerlink" title="answer"></a>answer</h5><p>​		在MOS 中，将页表和页目录映射到了用户空间中的 0x7fc00000-0x80000000（共 4MB）区域，这意味着 MOS 中允许在用户态下通过 UVPT 访问当前进程的页表和页目录。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/../image/self-reflection"
                      alt="image-20230330193000361"
                ></p>
<div class="highlight-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> UVPT 0x7fc0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_V 0x0200</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PDX(va) ((((u_long)(va)) &gt;&gt; 22) &amp; 0x03FF)</span></span><br></pre></td></tr></table></figure></div>

<p>从上面三个宏的定义我们不难理解，<strong>PTE_V</strong> 有效位，若某页表项的有效位为 1，则该页表项中高 20 位就是对应的物理页号。所以这行代码的含义是将页表映射到UVPT所对应的物理地址，从而让用户可以通过UVAT来访问页表，同时用PTE_V置有效位。</p>
<p><code>env_pgdir[PDX(UVPT)]= PADDR(e-&gt;env_pgdir) | PTE_V </code>表示页目录中第<code>PDX(UVPT)</code>项映射到页目录本身的物理地址，实现自映射机制。</p>
<h4 id="Thinking-3-2"><a href="#Thinking-3-2" class="headerlink" title="Thinking 3.2"></a>Thinking 3.2</h4><h5 id="question-1"><a href="#question-1" class="headerlink" title="question"></a>question</h5><blockquote>
<p>elf_load_seg 以函数指针的形式，接受外部自定义的回调函数 map_page。请你找到与之相关的 data 这一参数在此处的来源，并思考它的作用。没有这个参数可不可以？为什么？ </p>
</blockquote>
<h5 id="answer-1"><a href="#answer-1" class="headerlink" title="answer"></a>answer</h5><p>elf_load_seg定义在lib/elfloader.c中，具体定义如下：</p>
<div class="highlight-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Overview:</span></span><br><span class="line"><span class="comment"> *   load an elf format binary file. Map all section</span></span><br><span class="line"><span class="comment"> * at correct virtual address.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Pre-Condition:</span></span><br><span class="line"><span class="comment"> *   `binary` can't be NULL and `size` is the size of binary.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Post-Condition:</span></span><br><span class="line"><span class="comment"> *   Return 0 if success. Otherwise return &lt; 0.</span></span><br><span class="line"><span class="comment"> *   If success, the entry point of `binary` will be stored in `start`</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">elf_load_seg</span><span class="params">(Elf32_Phdr *ph, <span class="type">const</span> <span class="type">void</span> *bin, <span class="type">elf_mapper_t</span> map_page, <span class="type">void</span> *data)</span> </span>{</span><br><span class="line">	u_long va = ph-&gt;p_vaddr;</span><br><span class="line">	<span class="type">size_t</span> bin_size = ph-&gt;p_filesz;</span><br><span class="line">	<span class="type">size_t</span> sgsize = ph-&gt;p_memsz;</span><br><span class="line">	u_int perm = PTE_V;</span><br><span class="line">	<span class="keyword">if</span> (ph-&gt;p_flags &amp; PF_W) {</span><br><span class="line">		perm |= PTE_D;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> r;</span><br><span class="line">	<span class="type">size_t</span> i;</span><br><span class="line">	u_long offset = va - <span class="built_in">ROUNDDOWN</span>(va, BY2PG);</span><br><span class="line">	<span class="keyword">if</span> (offset != <span class="number">0</span>) {</span><br><span class="line">		<span class="keyword">if</span> ((r = <span class="built_in">map_page</span>(data, va, offset, perm, bin, <span class="built_in">MIN</span>(bin_size, BY2PG - offset))) !=</span><br><span class="line">		    <span class="number">0</span>) {</span><br><span class="line">			<span class="keyword">return</span> r;</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Step 1: load all content of bin into memory. */</span></span><br><span class="line">	<span class="keyword">for</span> (i = offset ? <span class="built_in">MIN</span>(bin_size, BY2PG - offset) : <span class="number">0</span>; i &lt; bin_size; i += BY2PG) {</span><br><span class="line">		<span class="keyword">if</span> ((r = <span class="built_in">map_page</span>(data, va + i, <span class="number">0</span>, perm, bin + i, <span class="built_in">MIN</span>(bin_size - i, BY2PG))) != <span class="number">0</span>) {</span><br><span class="line">			<span class="keyword">return</span> r;</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Step 2: alloc pages to reach `sgsize` when `bin_size` &lt; `sgsize`. */</span></span><br><span class="line">	<span class="keyword">while</span> (i &lt; sgsize) {</span><br><span class="line">		<span class="keyword">if</span> ((r = <span class="built_in">map_page</span>(data, va + i, <span class="number">0</span>, perm, <span class="literal">NULL</span>, <span class="built_in">MIN</span>(bin_size - i, BY2PG))) != <span class="number">0</span>) {</span><br><span class="line">			<span class="keyword">return</span> r;</span><br><span class="line">		}</span><br><span class="line">		i += BY2PG;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>elf_load_seg 的最后两个参数用于接受一个自定义的回调函数 map_page，以及需要传递给回调函数的额外参数 data,这个参数在具体实现中传给了map_page，所以我们再看一下map_page的编写——在kern/env.c中传入map_page指针的函数是load_icode_mapper,data参数为e。load_icode_mapper实现如下：</p>
<div class="highlight-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">load_icode_mapper</span><span class="params">(<span class="type">void</span> *data, u_long va, <span class="type">size_t</span> offset, u_int perm, <span class="type">const</span> <span class="type">void</span> *src,</span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="type">size_t</span> len)</span> </span>{</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">Env</span> *env = (<span class="keyword">struct</span> Env *)data;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">Page</span> *p;</span><br><span class="line">	<span class="type">int</span> r;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Step 1: Allocate a page with 'page_alloc'. */</span></span><br><span class="line">	<span class="comment">/* Exercise 3.5: Your code here. (1/2) */</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">page_alloc</span>(&amp;p);</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">/* Step 2: If 'src' is not NULL, copy the 'len' bytes started at 'src' into 'offset' at this</span></span><br><span class="line"><span class="comment">	 * page. */</span></span><br><span class="line">	<span class="comment">// Hint: You may want to use 'memcpy'.</span></span><br><span class="line">	<span class="keyword">if</span> (src != <span class="literal">NULL</span>) {</span><br><span class="line">		<span class="comment">/* Exercise 3.5: Your code here. (2/2) */</span></span><br><span class="line">		<span class="built_in">memcpy</span>((<span class="type">void</span>*)(<span class="built_in">page2kva</span>(p)+offset),src,len);</span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Step 3: Insert 'p' into 'env-&gt;env_pgdir' at 'va' with 'perm'. */</span></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">page_insert</span>(env-&gt;env_pgdir, env-&gt;env_asid, p, va, perm);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>

<p>这里利用传入的data参数辅助得到了env_pgdir的位置，所以由此可见，data参数不能省略。</p>
<h4 id="Thinking-3-3"><a href="#Thinking-3-3" class="headerlink" title="Thinking 3.3"></a>Thinking 3.3</h4><h5 id="question-2"><a href="#question-2" class="headerlink" title="question"></a>question</h5><blockquote>
<p>结合 elf_load_seg 的参数和实现，考虑该函数需要处理哪些页面加载的情况。 </p>
</blockquote>
<h5 id="answer-2"><a href="#answer-2" class="headerlink" title="answer"></a>answer</h5><p>elf_load_seg的作用是将ELF二进制文件加载进来，并将整个段映射到正确的虚拟地址。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/../image/image-20230330211057021.png"
                      alt="image-20230330211057021"
                ></p>
<p>所以对于页面加载有以下几种情况：</p>
<p><code>va</code>和<code>va+bin_size</code>的相对位置有以下6种：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/../image/3.4-1.png"
                      alt="img"
                ></p>
<p><code>va+bin_size</code>和<code>va+sg_size</code>的相对位置有以下6种：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/../image/3.4-2.png"
                      alt="img"
                ></p>
<h4 id="Thinking-3-4"><a href="#Thinking-3-4" class="headerlink" title="Thinking 3.4"></a>Thinking 3.4</h4><h5 id="question-3"><a href="#question-3" class="headerlink" title="question"></a>question</h5><blockquote>
<p>思考上面这一段话，并根据自己在 <strong>Lab2</strong> 中的理解，回答：你认为这里的 env_tf.cp0_epc 存储的是物理地址还是虚拟地址?</p>
</blockquote>
<h5 id="answer-3"><a href="#answer-3" class="headerlink" title="answer"></a>answer</h5><p>env_tf.cp0_epc存储的是虚拟地址，一方面这个值来自于CPU，而CPU提供的均为虚拟地址，另一方面对于每个用户进程来说entry_point都是一样的（如果不手动进行设置的话），这样可使让程序的每次执行都从一个固定的虚拟地址开始，这种统一对CPU是友好的。</p>
<h4 id="Thinking-3-5"><a href="#Thinking-3-5" class="headerlink" title="Thinking 3.5"></a>Thinking 3.5</h4><h5 id="question-4"><a href="#question-4" class="headerlink" title="question"></a>question</h5><blockquote>
<p><strong>0</strong> 号异常 的处理函数为 handle_int，表示中断，由时钟中断、控制台中断等中断造成</p>
<p><strong>1</strong> 号异常 的处理函数为 handle_mod，表示存储异常，进行存储操作时该页被标记为只读</p>
<p><strong>2</strong> 号异常 的处理函数为 handle_tlb，表示 TLB load 异常</p>
<p><strong>3</strong> 号异常 的处理函数为 handle_tlb，表示 TLB store 异常</p>
<p><strong>8</strong> 号异常 的处理函数为 handle_sys，表示系统调用，用户进程通过执行 syscall 指令陷入内核</p>
<p>试找出上述 5 个异常处理函数的具体实现位置。 </p>
</blockquote>
<h5 id="answer-4"><a href="#answer-4" class="headerlink" title="answer"></a>answer</h5><p>handle_int在kern/genex.S中，实现如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">NESTED(handle_int, TF_SIZE, zero)</span><br><span class="line">	mfc0    t0, CP0_CAUSE</span><br><span class="line">	mfc0    t2, CP0_STATUS</span><br><span class="line">	and     t0, t2</span><br><span class="line">	andi    t1, t0, STATUS_IM4</span><br><span class="line">	bnez    t1, timer_irq</span><br><span class="line">	// TODO: handle other irqs</span><br><span class="line">timer_irq:</span><br><span class="line">	sw      zero, (KSEG1 | DEV_RTC_ADDRESS | DEV_RTC_INTERRUPT_ACK)</span><br><span class="line">	li      a0, 0</span><br><span class="line">	j       schedule</span><br><span class="line">END(handle_int)</span><br></pre></td></tr></table></figure></div>

<p>handle_mod在kern/traps.c中，无具体实现。</p>
<p>handle_tlb在kern/traps.c中，无具体实现。</p>
<p>handle_sys在kern/traps.c中，无具体实现。</p>
<h4 id="Thinking-3-6"><a href="#Thinking-3-6" class="headerlink" title="Thinking 3.6"></a>Thinking 3.6</h4><h5 id="question-5"><a href="#question-5" class="headerlink" title="question"></a>question</h5><blockquote>
<p>阅读 init.c、kclock.S、env_asm.S 和 genex.S 这几个文件，并尝试说出enable_irq 和 timer_irq 中每行汇编代码的作用。 </p>
</blockquote>
<h5 id="answer-5"><a href="#answer-5" class="headerlink" title="answer"></a>answer</h5><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//include/asm/cp0regdef.h</span><br><span class="line">#define STATUS_CU0 0x10000000</span><br><span class="line">#define STATUS_IM4 0x1000</span><br><span class="line">#define STATUS_IEc 0x1</span><br><span class="line">#define CP0_STATUS $12</span><br><span class="line">//kern/gemex.S</span><br><span class="line">LEAF(enable_irq)</span><br><span class="line">	li      t0, (STATUS_CU0 | STATUS_IM4 | STATUS_IEc)</span><br><span class="line">	mtc0    t0, CP0_STATUS//设置中断</span><br><span class="line">	jr      ra	//返回</span><br><span class="line">END(enable_irq)</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//include/mmu.h</span><br><span class="line">#define KSEG1 0xA0000000U</span><br><span class="line">//include/drivers/dev_rtc.h:</span><br><span class="line">#define DEV_RTC_INTERRUPT_ACK 0x0110</span><br><span class="line">#define DEV_RTC_ADDRESS 0x15000000</span><br><span class="line">//kern/genex.S</span><br><span class="line">timer_irq:</span><br><span class="line">	sw      zero, (KSEG1 | DEV_RTC_ADDRESS | DEV_RTC_INTERRUPT_ACK)//在相应地址写入0，相应时钟中断</span><br><span class="line">	li      a0, 0</span><br><span class="line">	j       schedule</span><br></pre></td></tr></table></figure></div>

<p>schedule在kern/sched.c中，返回中断并选择一个进程运行。</p>
<h4 id="Thinking-3-7"><a href="#Thinking-3-7" class="headerlink" title="Thinking 3.7"></a>Thinking 3.7</h4><h5 id="question-6"><a href="#question-6" class="headerlink" title="question"></a>question</h5><blockquote>
<p>阅读相关代码，思考操作系统是怎么根据时钟中断切换进程的。</p>
</blockquote>
<h5 id="answer-6"><a href="#answer-6" class="headerlink" title="answer"></a>answer</h5><p> <code>env_sched_list</code>有两个链表存放就绪进程。当进程被创建时，我们将其插入第一个进程调度链表的头部。调用 <code>sched_yield</code> 函数时, 先判断当前时间片是否用完。如果用完，则将其插入另一个链表的结尾，之后判断当前就绪状态进程链表是否为空。如果为空, 将指针切换到另一个就绪状态进程链表。最后从指针指向的链表的头部获取一个就绪进程进行切换。</p>
<hr>
<h2 id="实验难点图示"><a href="#实验难点图示" class="headerlink" title="实验难点图示"></a>实验难点图示</h2><h3 id="lab-difficulties"><a href="#lab-difficulties" class="headerlink" title="lab_difficulties"></a>lab_difficulties</h3><p>lab3的主体是<strong>在用户态下进行进程管理</strong>，主要分为<strong>创建进程</strong>、<strong>时钟中断和异常处理</strong>和<strong>进程调度</strong>三个部分，由于lab3存在大量计租p7的知识，还是相对比较简单的，我利用上机开始做，刚好九点整就完成提交通过了。</p>
<h4 id="创建进程"><a href="#创建进程" class="headerlink" title="创建进程"></a>创建进程</h4><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/../image/create.png"
                      alt="img"
                ></p>
<p>由于没有实现线程，本实验中进程既是基本的分配单元，也是基本的执行单元。每个进程都是一个实体，有其自己的地址空间，通常包括代码段、数据段和堆栈。程序是一个没有生命的实体，只有被操作系统赋予生命时，它才能成为一个活动的实体，而执行中的程序，就是进程。</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>env_init</td>
<td>实现 Env 控制块的空闲队列和调度队列的初始化功能</td>
</tr>
<tr>
<td>env_setup_vm</td>
<td>初始化新进程的地址空间</td>
</tr>
<tr>
<td>void map_segment(Pde *pgdir, u_long pa, u_long va, u_long size,u_int perm)</td>
<td>在一级页表基地址 pgdir 对应的两级页表结构中做段地址映射，将虚拟地址段 [va,va+size) 映射到物理地址段 [pa,pa+size)，因为是按页映射，要求 size 必须是页面大小的整数倍。同时为相关页表项的权限为设置为 perm。它在这里的作用是将内核中的 Page和 Env 数据结构映射到用户地址，以供用户程序读取。</td>
</tr>
<tr>
<td>mkenvid</td>
<td>生成一个新的进程 id</td>
</tr>
<tr>
<td>env_create</td>
<td>创建一个新进程</td>
</tr>
<tr>
<td>env_run</td>
<td>进程运行使用</td>
</tr>
<tr>
<td>schedule</td>
<td>调度函数</td>
</tr>
</tbody></table>
<h5 id="PCB"><a href="#PCB" class="headerlink" title="PCB"></a>PCB</h5><p>进程控制块 (PCB) 是系统专门设置用来管理进程的数据结构，它可以记录进程的外部特征，描述进程的变化过程。而在lab3实验中，PCB是用一个Env结构体实现的。</p>
<div class="highlight-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Env</span> {</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">Trapframe</span> env_tf;  <span class="comment">// Saved registers</span></span><br><span class="line">	<span class="built_in">LIST_ENTRY</span>(Env) env_link; <span class="comment">// Free list</span></span><br><span class="line">	u_int env_id;		  <span class="comment">// Unique environment identifier</span></span><br><span class="line">	u_int env_asid;		  <span class="comment">// ASID</span></span><br><span class="line">	u_int env_parent_id;	  <span class="comment">// env_id of this env's parent</span></span><br><span class="line">	u_int env_status;	  <span class="comment">// Status of the environment</span></span><br><span class="line">	Pde *env_pgdir;		  <span class="comment">// Kernel virtual address of page dir</span></span><br><span class="line">	<span class="built_in">TAILQ_ENTRY</span>(Env) env_sched_link;</span><br><span class="line">	u_int env_pri;</span><br><span class="line">	<span class="comment">// Lab 4 IPC</span></span><br><span class="line">	u_int env_ipc_value;   <span class="comment">// data value sent to us</span></span><br><span class="line">	u_int env_ipc_from;    <span class="comment">// envid of the sender</span></span><br><span class="line">	u_int env_ipc_recving; <span class="comment">// env is blocked receiving</span></span><br><span class="line">	u_int env_ipc_dstva;   <span class="comment">// va at which to map received page</span></span><br><span class="line">	u_int env_ipc_perm;    <span class="comment">// perm of page mapping received</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Lab 4 fault handling</span></span><br><span class="line">	u_int env_user_tlb_mod_entry; <span class="comment">// user tlb mod handler</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Lab 6 scheduler counts</span></span><br><span class="line">	u_int env_runs; <span class="comment">// number of times been env_run'ed</span></span><br><span class="line">};</span><br></pre></td></tr></table></figure></div>

<p>现代计算机系统中经常有很多进程同时存在，每个进程执行不同的任务，它们之间也经常需要相互协作、通信，而这部分在实验中是依靠进程标识符来实现。在 struct Env 进程控制块中的 env_id 这个域，是每个进程独一无二的标识符，需要在进程创建的时候就被赋予。在 env.c 文件中实现了一个叫做 mkenvid 的函数，作用就是生成一个新的进程 id。</p>
<h5 id="设置进程控制块"><a href="#设置进程控制块" class="headerlink" title="设置进程控制块"></a>设置进程控制块</h5><p><strong>第一步</strong>——申请一个空闲的 PCB（也就是 Env 结构体），从 env_free_list 中索取一个空闲PCB 块，这时候的 PCB 就像张白纸一样。</p>
<p><strong>第二步</strong>——“纯手工打造”打造一个进程。在这种创建方式下，由于没有模板进程，所以进程拥有的所有信息都是手工设置。而进程的信息又都存放于进程控制块中，所以需要手工初始化进程控制块。</p>
<p><strong>第三步</strong>——进程光有 PCB 的信息还没法跑起来，每个进程都有独立的地址空间。所以，要为新进程初始化页目录。</p>
<p><strong>第四步</strong>——此时 PCB 已经被填写了很多东西，不再是一张白纸，把它从空闲链表里摘出，就可以使用。</p>
<h5 id="加载二进制镜像"><a href="#加载二进制镜像" class="headerlink" title="加载二进制镜像"></a>加载二进制镜像</h5><p>要想正确加载一个 ELF 文件到内存，只需将 ELF 文件中所有需要加载的程序段（program segment）加载到对应的虚拟地址上即可。</p>
<p>load_icode 函数负责加载可执行文件 binary 到进程 e 的内存中。它调用的 elf_from 函数完成了解析 ELF 文件头的部分，elf_load_seg 负责将 ELF 文件的一个 segment 加载到内存。</p>
<h5 id="创建进程及运行"><a href="#创建进程及运行" class="headerlink" title="创建进程及运行"></a>创建进程及运行</h5><p>创建进程的过程很简单，就是实现对上述个别函数的封装，分配一个新的 <strong>Env</strong> 结构体，设置进程控制块，并将程序载入到该进程的地址空间即可完成。</p>
<p>在创建进程前，需要调用 env_init 初始化进程管理。</p>
<p>进程运行包括两部分——<strong>保存当前进程上下文</strong>和<strong>恢复要启动的进程的上下文</strong>，然后运行该进程。</p>
<h4 id="时钟中断和异常处理"><a href="#时钟中断和异常处理" class="headerlink" title="时钟中断和异常处理"></a>时钟中断和异常处理</h4><h5 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h5><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/../image/irq.png"
                      alt="img"
                ></p>
<p>当发生异常时，处理器会进入一个用于分发异常的程序，这个程序的作用就是检测发生了哪种异常，并调用相应的异常处理程序。一般来说，异常分发程序会被要求放在固定的某个物理地址上（根据处理器的区别有所不同），以保证处理器能在检测到异常时正确地跳转到那里。这个分发程序可以认为是操作系统的一部分。</p>
<h5 id="时钟中断"><a href="#时钟中断" class="headerlink" title="时钟中断"></a>时钟中断</h5><p>时钟中断和操作系统的时间片轮转算法是紧密相关的。时间片轮转调度是一种进程调度算法，每个进程被分配一个时间段，称作它的时间片，即该进程允许运行的时间。如果在时间片结束时进程还在运行，则该进程将挂起，切换到另一个进程运行。那么 CPU 是如何知晓一个进程的时间片结束的呢？就是通过定时器产生的时钟中断。当时钟中断产生时，当前运行的进程被挂起，我们需要在调度队列中选取一个合适的进程运行。如何“选取”，就要涉及到进程的调度了。</p>
<p>kern/kclock.S 中的 kclock_init 函数完成了时钟中断的初始化，该函数向 KSEG1 | DEV_RTC_ADDRESS| DEV_RTC_HZ 位置写入 200，其中 KSEG1 | DEV_RTC_ADDRESS 是模拟器（GXemul）映射实时钟的位置。偏移量为 DEV_RTC_HZ 表示设置实时钟中断的频率，200 表示 1 秒钟中断 200 次；如果写入 0，表示关闭时钟中断。时钟中断对于 GXemul 来说绑定到了 4 号中断上。注意这里的中断号和异常号是不一样的概念，我们实验的异常包括中断，中断本身是 0 号异常。</p>
<p>init/init.c 中的 mips_init 函数在完成初始化并创建进程后，需要调用 kclock_init 函数完成时钟中断的初始化，然后调用 kern/env_asm.S 中的 enable_irq 函数开启中断。</p>
<p>一旦实时钟中断产生，就会触发 MIPS 中断，从而系统将 PC 指向 0x80000080，从而跳转到.text.exc_gen_entry 代码段执行。对于实时钟引起的中断，通过.text.exc_gen_entry 代码段的分发，最终会调用 handle_int 函数来处理实时钟中断。</p>
<p>handle_int 中判断了 Cause 寄存器是不是对应的 4 号中断位引发的中断，如果是，则执行中断服务函数 timer_irq，跳转到 schedule 中执行。而这个函数就是我们将要补充的调度函数。</p>
<h4 id="进程调度"><a href="#进程调度" class="headerlink" title="进程调度"></a>进程调度</h4><p>调度的算法很简单，就是时间片轮转的算法。env 中的优先级在这里起到了作用，我们规定其数值表示进程每次运行的时间片数量。不过寻找就绪状态进程不是简单遍历所有进程，而是用一个调度链表存储所有就绪（可运行）的进程，即一个进程在调度链表中当且仅当这个进程是就绪（ENV_RUNNABLE）状态的。当内核创建新进程时，将其插入调度链表的头部；在其不再就绪（被阻塞）或退出时，将其从调度链表中移除。</p>
<div class="highlight-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Overview:</span></span><br><span class="line"><span class="comment"> *   Implement a round-robin scheduling to select a runnable env and schedule it using 'env_run'.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Post-Condition:</span></span><br><span class="line"><span class="comment"> *   If 'yield' is set (non-zero), 'curenv' should not be scheduled again unless it is the only</span></span><br><span class="line"><span class="comment"> *   runnable env.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Hints:</span></span><br><span class="line"><span class="comment"> *   1. The variable 'count' used for counting slices should be defined as 'static'.</span></span><br><span class="line"><span class="comment"> *   2. Use variable 'env_sched_list', which contains and only contains all runnable envs.</span></span><br><span class="line"><span class="comment"> *   3. You shouldn't use any 'return' statement because this function is 'noreturn'.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">schedule</span><span class="params">(<span class="type">int</span> yield)</span> </span>{</span><br><span class="line">	<span class="type">static</span> <span class="type">int</span> count = <span class="number">0</span>; <span class="comment">// remaining time slices of current env</span></span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">Env</span> *e = curenv;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* We always decrease the 'count' by 1.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * If 'yield' is set, or 'count' has been decreased to 0, or 'e' (previous 'curenv') is</span></span><br><span class="line"><span class="comment">	 * 'NULL', or 'e' is not runnable, then we pick up a new env from 'env_sched_list' (list of</span></span><br><span class="line"><span class="comment">	 * all runnable envs), set 'count' to its priority, and schedule it with 'env_run'. **Panic</span></span><br><span class="line"><span class="comment">	 * if that list is empty**.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * (Note that if 'e' is still a runnable env, we should move it to the tail of</span></span><br><span class="line"><span class="comment">	 * 'env_sched_list' before picking up another env from its head, or we will schedule the</span></span><br><span class="line"><span class="comment">	 * head env repeatedly.)</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Otherwise, we simply schedule 'e' again.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * You may want to use macros below:</span></span><br><span class="line"><span class="comment">	 *   'TAILQ_FIRST', 'TAILQ_REMOVE', 'TAILQ_INSERT_TAIL'</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="comment">/* Exercise 3.12: Your code here. */</span></span><br><span class="line">	<span class="keyword">if</span>(yield||count==<span class="number">0</span>||e==<span class="literal">NULL</span>||e-&gt;env_status!=ENV_RUNNABLE){</span><br><span class="line">		<span class="keyword">if</span>(e!=<span class="literal">NULL</span>&amp;&amp;e-&gt;env_status==ENV_RUNNABLE){</span><br><span class="line">			<span class="built_in">TAILQ_REMOVE</span>(&amp;env_sched_list,e,env_sched_link);</span><br><span class="line">			<span class="comment">//e=TAILQ_FIRST(&amp;env_sched_list);</span></span><br><span class="line">			<span class="built_in">TAILQ_INSERT_TAIL</span>(&amp;env_sched_list,e,env_sched_link);</span><br><span class="line"></span><br><span class="line">		}</span><br><span class="line">		<span class="comment">//LIST_REMOVE(e,env_sched_link);</span></span><br><span class="line">		e=<span class="built_in">TAILQ_FIRST</span>(&amp;env_sched_list);</span><br><span class="line">		<span class="built_in">TAILQ_REMOVE</span>(&amp;env_sched_list,e,env_sched_link);</span><br><span class="line">		count=e-&gt;env_pri;	</span><br><span class="line">	}</span><br><span class="line">	count--;</span><br><span class="line">	<span class="built_in">env_run</span>(e);</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure></div>



<h3 id="lab-summary"><a href="#lab-summary" class="headerlink" title="lab_summary"></a>lab_summary</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/../image/image-20230330220427451.png"
                      alt="image-20230330220427451"
                ></p>
<p>Lab3要求我们实现<strong>进程的创建、切换和调度</strong>，其中进程的调度主要是通过设置异常处理机制来实现。</p>
<p>本次实验的难度比Lab2稍稍低一些，主要原因是本次lab中各个函数之间的联系比较紧密。虽然某些复杂函数理解起来还是有些困难，但是如果在宏观上把握这些函数的关系，那么对于单个函数的理解就变得相对容易了。</p>
<p>这周刚好冯如杯、蓝桥杯、电梯第二周、学生会和班委会一堆事撞一起，OS的难度不大真的减压不少，期待lab4带来更多精彩。</p>

            </div>

            
                <div class="post-copyright-info">
                    <div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> lab3_report</li>
        <li><strong>Author:</strong> Charles</li>
        <li><strong>Created at:</strong> 2023-03-27 21:48:05</li>
        
            <li>
                <strong>Updated at:</strong> 2023-03-30 22:16:07
            </li>
        
        <li>
            <strong>Link:</strong> https://charles2530.github.io/2023/03/27/lab3-report/
        </li>
        <li>
            <strong>License:</strong> All articles in this blog are licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0</a> unless stating additionally.
        </li>
    </ul>
</div>

                </div>
            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/tags/OS/">#OS</a>&nbsp;
                        </li>
                    
                </ul>
            

            <div class="recommended-article">
  <div class="recommended-article-header">
    <i aria-hidden="true"></i><span>recommend_articles</span>
  </div>
  <div class="recommended-article-group"><a class="recommended-article-item" href="/2022/12/30/os-theory-3/" title="OS_theory_3" rel="bookmark">
  <img src="https://charles2530.github.io/image/background/p2.jpg" alt="OS_theory_3">
  <span class="title">OS_theory_3</span>
</a><a class="recommended-article-item" href="/2023/01/08/barycenter-of-tree/" title="Barycenter of tree" rel="bookmark">
  <img src="https://charles2530.github.io/image/background/p2.jpg" alt="Barycenter of tree">
  <span class="title">Barycenter of tree</span>
</a><a class="recommended-article-item" href="/2023/02/03/matlab-note-8/" title="matlab-note-8" rel="bookmark">
  <img src="https://charles2530.github.io/image/background/p2.jpg" alt="matlab-note-8">
  <span class="title">matlab-note-8</span>
</a></div>
</div>

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                            rel="prev"
                            href="/2023/03/30/os-quick-abbreviation/"
                            >
                                <span class="left arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-left"></i>
                                </span>
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">OS-quick-abbreviation</span>
                                    <span class="post-nav-item">Prev posts</span>
                                </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                            rel="next"
                            href="/2023/03/26/oo-multithreading-tips/"
                            >
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">OO_multithreading_tips</span>
                                    <span class="post-nav-item">Next posts</span>
                                </span>
                                <span class="right arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-right"></i>
                                </span>
                            </a>
                        </div>
                    
                </div>
            


            
                <div class="comment-container">
                    <div class="comments-container">
  <div id="comment-anchor"></div>
  <div class="comment-area-title">
    <i class="fa-solid fa-comments">&nbsp;Comments</i>
  </div>
  
</div>

                </div>
            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">lab3_report</div>
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#lab3-report"><span class="nav-text">lab3_report</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#lab-thinkings"><span class="nav-text">lab_thinkings</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Thinking-3-1"><span class="nav-text">Thinking 3.1</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#question"><span class="nav-text">question</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#answer"><span class="nav-text">answer</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Thinking-3-2"><span class="nav-text">Thinking 3.2</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#question-1"><span class="nav-text">question</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#answer-1"><span class="nav-text">answer</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Thinking-3-3"><span class="nav-text">Thinking 3.3</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#question-2"><span class="nav-text">question</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#answer-2"><span class="nav-text">answer</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Thinking-3-4"><span class="nav-text">Thinking 3.4</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#question-3"><span class="nav-text">question</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#answer-3"><span class="nav-text">answer</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Thinking-3-5"><span class="nav-text">Thinking 3.5</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#question-4"><span class="nav-text">question</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#answer-4"><span class="nav-text">answer</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Thinking-3-6"><span class="nav-text">Thinking 3.6</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#question-5"><span class="nav-text">question</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#answer-5"><span class="nav-text">answer</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Thinking-3-7"><span class="nav-text">Thinking 3.7</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#question-6"><span class="nav-text">question</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#answer-6"><span class="nav-text">answer</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C%E9%9A%BE%E7%82%B9%E5%9B%BE%E7%A4%BA"><span class="nav-text">实验难点图示</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#lab-difficulties"><span class="nav-text">lab_difficulties</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%BF%9B%E7%A8%8B"><span class="nav-text">创建进程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#PCB"><span class="nav-text">PCB</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E8%BF%9B%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%9D%97"><span class="nav-text">设置进程控制块</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%95%9C%E5%83%8F"><span class="nav-text">加载二进制镜像</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%BF%9B%E7%A8%8B%E5%8F%8A%E8%BF%90%E8%A1%8C"><span class="nav-text">创建进程及运行</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%B6%E9%92%9F%E4%B8%AD%E6%96%AD%E5%92%8C%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="nav-text">时钟中断和异常处理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="nav-text">异常处理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%97%B6%E9%92%9F%E4%B8%AD%E6%96%AD"><span class="nav-text">时钟中断</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6"><span class="nav-text">进程调度</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lab-summary"><span class="nav-text">lab_summary</span></a></li></ol></li></ol></li></ol>

    </div>
</div>
            </div>
        
    </div>
</div>


                

            </div>



        </div>

        <div class="main-content-footer">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info">
            &copy;
            
              <span>2022</span>
              -
            
            2023&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">Charles</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv" class="busuanzi_container_site_uv">
                        Visitor Count&nbsp;<span id="busuanzi_value_site_uv" class="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="busuanzi_container_site_pv">
                        Total Page Views&nbsp;<span id="busuanzi_value_site_pv" class="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            <span class="powered-by-container">Powered by Charles</span>
                <br>
            <span class="theme-version-container">Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.0.3</a>
        </div>
        
        
        
            <div id="start_div" style="display:none">
                2022/12/27 00:00:00
            </div>
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
        
            <script async data-pjax>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fa-regular fa-comments"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-expand-width flex-center">
            <i class="fa-regular fa-expand"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="right-bottom-tools rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                <i class="fa-regular fa-rss"></i>
                </a>
            </li>
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    


</main>



  
<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/layouts/navbarShrink.js"></script>

<script src="/js/tools/scrollTopBottom.js"></script>

<script src="/js/tools/lightDarkSwitch.js"></script>



    
<script src="/js/tools/localSearch.js"></script>




    
<script src="/js/tools/codeBlock.js"></script>




    
<script src="/js/layouts/lazyload.js"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/layouts/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js"></script>




    
<script src="/js/libs/mermaid.min.js"></script>

    
<script src="/js/plugins/mermaid.js"></script>





<div class="post-scripts pjax">
    
        
<script src="/js/tools/tocToggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/layouts/toc.js"></script>

<script src="/js/plugins/tabs.js"></script>

    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            Global.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            Global.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            Global.refresh();
        });
    });
</script>



  
</body>

</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/love.js"></script>
