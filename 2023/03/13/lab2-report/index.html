<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Charles">
    
    <meta name="author" content="Charles">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    
        
            <link rel="preconnect" href="https://npm.elemecdn.com" crossorigin>
        
    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://charles2530.github.io/2023/03/13/lab2-report/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="post by Charles in 2023-03-13 13:00:22">
<meta property="og:type" content="article">
<meta property="og:title" content="lab2_report">
<meta property="og:url" content="http://charles2530.github.io/2023/03/13/lab2-report/index.html">
<meta property="og:site_name" content="Charles&#39;s Castle">
<meta property="og:description" content="post by Charles in 2023-03-13 13:00:22">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://charles2530.github.io/image/lab2_1">
<meta property="og:image" content="https://charles2530.github.io/image/lab2_2">
<meta property="og:image" content="https://charles2530.github.io/image/lab2_10">
<meta property="og:image" content="https://charles2530.github.io/image/lab2_3">
<meta property="og:image" content="https://charles2530.github.io/image/lab2_4.png">
<meta property="og:image" content="https://charles2530.github.io/image/lab2_5">
<meta property="og:image" content="https://charles2530.github.io/image/lab2_6">
<meta property="og:image" content="https://charles2530.github.io/image/lab2_7">
<meta property="og:image" content="https://charles2530.github.io/image/lab2_9">
<meta property="og:image" content="https://charles2530.github.io/image/lab2_8">
<meta property="article:published_time" content="2023-03-13T05:00:22.000Z">
<meta property="article:modified_time" content="2023-06-17T06:13:59.357Z">
<meta property="article:author" content="Du Jinyang">
<meta property="article:tag" content="OS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://charles2530.github.io/image/lab2_1">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="https://charles2530.github.io/image/background/favicon.png" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="https://charles2530.github.io/image/background/favicon.png">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="https://charles2530.github.io/image/background/favicon.png">
    <!--- Page Info-->
    
    <title>
        
            lab2_report -
        
        Charles&#39;s Castle
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="stylesheet" href="//npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/fonts/fonts.css">
    <link rel="stylesheet" href="//npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/fonts/Satoshi/satoshi.css">
    <link rel="stylesheet" href="//npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/fonts/Chillax/chillax.css">
    <!--- Font Part-->
    
    
    
    

    <!--- Inject Part-->
    
    <script id="hexo-configurations">
    let Global = window.Global || {};
    Global.hexo_config = {"hostname":"charles2530.github.io","root":"/","language":"en","path":"search.xml"};
    Global.theme_config = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":true,"list":["lol","Neo","God"]},"code_block":{"copy":true,"style":"mac","font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":6,"number":false,"expand":true,"init_open":true},"copyright":true,"lazyload":true,"recommendation":{"enable":true,"title":"recommend_articles","limit":3,"mobile_limit":2,"placeholder":"https://charles2530.github.io/image/background/p3.jfif","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":"#1890ff"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":true},"scroll_progress":{"bar":true,"percentage":true},"busuanzi_counter":{"enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"pjax":true,"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"https://charles2530.github.io/image/background/background-light1.jpg","dark":"https://charles2530.github.io/image/background/background-dark1.jpg"},"title":"Charles's Castle","subtitle":{"text":["Happiness is best!","Never give up!","Everyday is a gift!"],"hitokoto":{"enable":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#000000","dark":"#d1d1b6"},"text_style":{"title_size":"3.2rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":true,"links":{"github":"https://github.com/Charles2530/","zhihu":"https://www.zhihu.com/people/yang-guang-xiao-zi-55-55","email":"charles2530@163.com"}}},"plugins":{"feed":{"enable":true},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null},{"name":null,"artist":null,"url":null,"cover":null}]},"mermaid":{"enable":true,"version":"9.3.0"}},"version":"2.2.0","navbar":{"auto_hide":true,"color":{"left":"#f78736","right":"#367df7","transparency":35},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Categories":{"path":"/categories","icon":"fas fa-bookmark"},"Tags":{"path":"/tags","icon":"fas fa-tags"},"About":{"icon":"fa-regular fa-user","submenus":{"Me":"/about","Github":"https://github.com/Charles2530/","Blog":"https://charles2530.github.io"}}},"search":{"enable":true,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":"This is Charles's Castle","links":{"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Photos":{"icon":"fa-solid fa-image","path":"/masonry/"},"Essays":{"icon":"fa-solid fa-message-lines","path":"/essay/"},"Friends":{"icon":"fa-solid fa-user-group","path":"/friends/"}}},"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2022/12/27 00:00:00"};
    Global.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    Global.data_config = {"masonry":true};
  </script>
    
    <!--- Fontawesome Part-->
    <link rel="stylesheet" href="//npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/fontawesome/fontawesome.min.css">
    <link rel="stylesheet" href="//npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/fontawesome/brands.min.css">
    <link rel="stylesheet" href="//npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/fontawesome/solid.min.css">
    <link rel="stylesheet" href="//npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/fontawesome/regular.min.css">
    
    
    
    
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Charles's Castle" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>



<body>
  <div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="main-content-container">

        <div class="main-content-header">
            <header class="navbar-container">
    
    <div class="navbar-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                Charles&#39;s Castle
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/"  >
                                    
                                        
                                            <i class="fa-regular fa-house"></i>
                                        
                                        HOME
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/categories"  >
                                    
                                        
                                            <i class="fas fa-bookmark"></i>
                                        
                                        CATEGORIES
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/tags"  >
                                    
                                        
                                            <i class="fas fa-tags"></i>
                                        
                                        TAGS
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown" 
                                    href="#" onClick="return false;">
                                    
                                        
                                            <i class="fa-regular fa-user"></i>
                                        
                                        ABOUT&nbsp;<i class="fa-solid fa-chevron-down"></i>
                                    
                                </a>
                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                    
                                        <li>
                                        <a href="/about">ME
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://github.com/Charles2530/">GITHUB
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a href="https://charles2530.github.io">BLOG
                                        </a>
                                        </li>
                                    
                                    </ul>
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="navbar-drawer">
        <ul class="drawer-navbar-list">
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/"  >
                             
                                
                                    <i class="fa-regular fa-house"></i>
                                
                                HOME
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/categories"  >
                             
                                
                                    <i class="fas fa-bookmark"></i>
                                
                                CATEGORIES
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/tags"  >
                             
                                
                                    <i class="fas fa-tags"></i>
                                
                                TAGS
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="has-dropdown" 
                        href="#" onClick="return false;">
                            
                                
                                    <i class="fa-regular fa-user"></i>
                                
                                ABOUT&nbsp;<i class="fa-solid fa-chevron-down"></i>
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                              
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" href="/about">ME</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" target="_blank" rel="noopener" href="https://github.com/Charles2530/">GITHUB</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" href="https://charles2530.github.io">BLOG</a>
                            </li>
                        
                    
            

        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            
                      
                <div class="article-title">
                    <img src="https://charles2530.github.io/image/background/p5.jfif" alt="lab2_report" />
                    <h1 class="article-title-cover">lab2_report</h1>
                </div>
            
                
            

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="https://charles2530.github.io/image/background/logo.jpg">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">Charles</span>
                            
                                <span class="author-label">Lv6</span>
                            
                        </div>
                        <div class="meta-info">
                            <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2023-03-13 13:22</span>
        <span class="mobile">2023-03-13 13</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2023-06-17 14:13:59</span>
            <span class="mobile">2023-06-17 14:13</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/Lesson/">Lesson</a>&nbsp;
                    </li>
                
                    <li>
                        &gt; <a href="/categories/Lesson/OS/">OS</a>&nbsp;
                    </li>
                
                    <li>
                        &gt; <a href="/categories/Lesson/OS/OS-report/">OS-report</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/OS/">OS</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fa-regular fa-typewriter"></i>&nbsp;<span>5.3k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fa-regular fa-clock"></i>&nbsp;<span>19 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content markdown-body">
                <h2 id="lab2_report"><a class="markdownIt-Anchor" href="#lab2_report"></a> lab2_report</h2>
<h3 id="advance"><a class="markdownIt-Anchor" href="#advance"></a> advance</h3>
<h4 id="实现物理内存和虚拟内存的管理方式"><a class="markdownIt-Anchor" href="#实现物理内存和虚拟内存的管理方式"></a> 实现物理内存和虚拟内存的管理方式</h4>
<p>在<code>lab2</code>实验中物理内存采用链表法进行管理，而虚拟内存采用二级页表进行管理。本实验相关的映射与寻址规则（内存布局）如下</p>
<ul>
<li>
<p>若虚拟地址处于 <code>0x80000000~0x9fffffff (kseg0)</code>，则将虚拟地址的最高位置 0 得到物理地址，通过 cache 访存。这一部分用于存放内核代码与数据结构。</p>
</li>
<li>
<p>若虚拟地址处于 <code>0xa0000000~0xbfffffff (kseg1)</code>，则将虚拟地址的最高 <strong><code>3</code></strong> 位置 0 得到物理地址，不通过 cache 访存。这一部分可以用于映射外设。</p>
</li>
<li>
<p>若虚拟地址处于 <code>0x00000000~0x7fffffff (kuseg)</code>，则需要通过 <strong><code>TLB</code></strong> 来获取物理地址，通过 cache 访存。</p>
</li>
</ul>
<p>在<code>R3000</code> 中，使用 <code>MMU</code> 来完成上述地址映射，<code>MMU</code> 中是采用硬件 <strong><code>TLB</code></strong> 来完成地址映射。在 <code>R3000</code> 中，需要通过软件填写 <strong><code>TLB</code></strong> 。所有低 <code>2GB</code> 空间的内存访问操作都需要经过 <code>TLB</code>。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://charles2530.github.io/image/lab2_1"
                      alt="image-20230313131725622" 
                ></p>
<p>对于本次实验而言，主要在代码中利用<code>PADDR</code>和<code>KADDR</code>两个宏实现了kseg0虚拟地址和物理地址之间的转化。</p>
<h3 id="lab_thinkings"><a class="markdownIt-Anchor" href="#lab_thinkings"></a> lab_thinkings</h3>
<h4 id="thinking-21"><a class="markdownIt-Anchor" href="#thinking-21"></a> Thinking 2.1</h4>
<h5 id="question"><a class="markdownIt-Anchor" href="#question"></a> question</h5>
<blockquote>
<p>请根据上述说明，回答问题：在编写的 <code>C</code>程序中，指针变量中存储的地址是虚拟地址，还是物理地址？<code>MIPS</code> 汇编程序中 <code>lw</code> 和 <code>sw</code> 使用的是虚拟地址，还是物理地址？</p>
</blockquote>
<h5 id="answer"><a class="markdownIt-Anchor" href="#answer"></a> answer</h5>
<p>正如教程中所说的那样——<code>MIPS R3000</code> 发出的地址均为虚拟地址，因此如果程序想访问某个物理地址，需要通过映射到该物理地址的虚拟地址来访问。<code>CPU</code>只会发出经过产生处理后的虚拟地址，因此在编写的 <code>C</code>程序中指针变量中储存的是虚拟地址。<code>MIPS</code>汇编程序中<code>lw</code>、<code>sw</code>中使用的也是虚拟地址。</p>
<h4 id="thinking-22"><a class="markdownIt-Anchor" href="#thinking-22"></a> Thinking 2.2</h4>
<h5 id="question-2"><a class="markdownIt-Anchor" href="#question-2"></a> question</h5>
<blockquote>
<ul>
<li>
<p>从可重用性的角度，阐述用宏来实现链表的好处。</p>
</li>
<li>
<p>查看实验环境中的 <code>/usr/include/sys/queue.h</code>，了解其中单向链表与循环链表的实现，比较它们与本实验中使用的双向链表，分析三者在插入与删除操作上的性能差异。</p>
</li>
</ul>
</blockquote>
<h5 id="answer-2"><a class="markdownIt-Anchor" href="#answer-2"></a> answer</h5>
<p>使用宏定义对链表操作进行封装，可以实现代码的复用，既减少了工作量，也提高了程序的可读性，而且从健壮性的角度而言，这样的改变很好的使指针的编写错误可能性大大降低。</p>
<p>对于单向链表、循环链表和双向链表而言，这三者的操作性能有以下的差异——</p>
<ul>
<li>
<p><strong>对于单向链表</strong>，由于它只能获得每一项的后面一项，因此在删除时需要遍历整个链表；同样，如果是在某一项的前面插入，也需要从<code>head</code>开始遍历这个链表。但是如果是“在某一项之后插入”，单项链表可以直接进行该操作。</p>
</li>
<li>
<p><strong>对于循环链表</strong>，因为它仍然是单向的，所以在“删除”、“某一项之前插入”、“某一项之后插入”三个操作的性能和单项链表相同。但是，由于循环链表首尾相连，同时维护了一个指向尾项的指针，因此它可以直接在尾部插入。</p>
</li>
<li>
<p><strong>对于双向链表</strong>，因为它可以直接获得某一项的前后两项，所以无论是“删除”还是“在某一项前或后插入”都可以以O(1)的开销实现。但是，双向链表没有维护指向尾部的指针，因此无法直接将某一项插入链表尾部，如要实现该操作还需要遍历整个链表。</p>
</li>
</ul>
<p>综上所述，循环链表和双向链表可以说是在单向链表的基础上完成的两种优化方式，分别完成了尾部插入和逆向插入的难题，但均依旧存在一些缺点。</p>
<h4 id="thinking-23"><a class="markdownIt-Anchor" href="#thinking-23"></a> Thinking 2.3</h4>
<h5 id="question-3"><a class="markdownIt-Anchor" href="#question-3"></a> question</h5>
<blockquote>
<p>请阅读 <code>include/queue.h</code> 以及 <code>include/pmap.h</code>, 将 <code>Page_list</code> 的结构梳理清楚，选择正确的展开结构。</p>
<div class="highlight-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">A:</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Page_list</span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> &#123;</span><br><span class="line">		<span class="keyword">struct</span> &#123;</span><br><span class="line">			<span class="keyword">struct</span> <span class="title class_">Page</span> *le_next;</span><br><span class="line">			<span class="keyword">struct</span> <span class="title class_">Page</span> **le_prev;</span><br><span class="line">		&#125;* pp_link;</span><br><span class="line">		u_short pp_ref;</span><br><span class="line">	&#125;* lh_first;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<div class="highlight-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">B:</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Page_list</span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> &#123;</span><br><span class="line">		<span class="keyword">struct</span> &#123;</span><br><span class="line">			<span class="keyword">struct</span> <span class="title class_">Page</span> *le_next;</span><br><span class="line">			<span class="keyword">struct</span> <span class="title class_">Page</span> **le_prev;</span><br><span class="line">		&#125; pp_link;</span><br><span class="line">		u_short pp_ref;</span><br><span class="line">	&#125; lh_first;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<div class="highlight-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">C:</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Page_list</span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> &#123;</span><br><span class="line">		<span class="keyword">struct</span> &#123;</span><br><span class="line">			<span class="keyword">struct</span> <span class="title class_">Page</span> *le_next;</span><br><span class="line">			<span class="keyword">struct</span> <span class="title class_">Page</span> **le_prev;</span><br><span class="line">		&#125; pp_link;</span><br><span class="line">		u_short pp_ref;</span><br><span class="line">	&#125;* lh_first;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
</blockquote>
<h5 id="answer-3"><a class="markdownIt-Anchor" href="#answer-3"></a> answer</h5>
<p>选项C正确，理由如下：</p>
<div class="highlight-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> LIST_HEAD(name, type)                                                                      \</span></span><br><span class="line"><span class="meta">	struct name &#123;                                                                              \</span></span><br><span class="line"><span class="meta">		struct type *lh_first;                                         \</span></span><br><span class="line"><span class="meta">	&#125;</span></span><br><span class="line"><span class="built_in">LIST_HEAD</span>(Page_list, Page);</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LIST_ENTRY(type)                                                                           \</span></span><br><span class="line"><span class="meta">	struct &#123;                                                                                   \</span></span><br><span class="line"><span class="meta">		struct type *le_next;  <span class="comment">/* next element */</span>                                          \</span></span><br><span class="line"><span class="meta">		struct type **le_prev; <span class="comment">/* address of previous next element */</span>                      \</span></span><br><span class="line"><span class="meta">	&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">LIST_ENTRY</span><span class="params">(Page)</span> Page_LIST_entry_t</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Page</span> &#123;</span><br><span class="line">	Page_LIST_entry_t pp_link; </span><br><span class="line">	u_short pp_ref;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>
<p>将上面各部分分别带入即可。</p>
<h4 id="thinking-24"><a class="markdownIt-Anchor" href="#thinking-24"></a> Thinking 2.4</h4>
<h5 id="question-4"><a class="markdownIt-Anchor" href="#question-4"></a> question</h5>
<blockquote>
<p>请思考下面两个问题：</p>
<ul>
<li>
<p>请阅读上面有关 <code>R3000-TLB</code> 的描述，从虚拟内存的实现角度，阐述 <code>ASID</code> 的必要性。</p>
</li>
<li>
<p>请阅读《<code>IDT R30xx Family Software Reference Manual</code>》的 <code>Chapter 6</code>，结合 <code>ASID</code>段的位数，说明 <code>R3000</code> 中可容纳不同的地址空间的最大数量。</p>
</li>
</ul>
</blockquote>
<h5 id="answer-4"><a class="markdownIt-Anchor" href="#answer-4"></a> answer</h5>
<p><code>ASID(Address Space IDentifier)</code>用于区分不同的地址空间。查找 <strong><code>TLB</code></strong> 表项时，除了需要提供 <strong><code>VPN</code></strong>，还需要提供**<code>ASID</code><strong>。具体而言，操作系统会给每一个进程分配一个页表，每个页表都有自己的虚拟地址空间，而同一虚拟地址在不同地址空间中通常映射到不同的物理地址。如果没有<code>ASID</code>来区分</strong>当前虚拟地址是在哪个进程中使用**，则可能会将该虚拟地址映射到错误的物理地址。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://charles2530.github.io/image/lab2_2"
                      alt="image-20230314075709706" 
                ></p>
<p><code>ASID</code>在<code>EntryHi</code>寄存器中占6位，可以被设置为64个不同的值，因此<code>R3000</code>中可最多容纳<code>64</code>个不同的地址空间。</p>
<h4 id="thinking-25"><a class="markdownIt-Anchor" href="#thinking-25"></a> Thinking 2.5</h4>
<h5 id="question-5"><a class="markdownIt-Anchor" href="#question-5"></a> question</h5>
<blockquote>
<p>请回答下述三个问题：</p>
<ul>
<li>
<p><code>tlb_invalidate</code> 和 <code>tlb_out</code> 的调用关系？</p>
</li>
<li>
<p>请用一句话概括 <code>tlb_invalidate</code> 的作用。</p>
</li>
<li>
<p>逐行解释 <code>tlb_out</code> 中的汇编代码。</p>
</li>
</ul>
</blockquote>
<h5 id="answer-5"><a class="markdownIt-Anchor" href="#answer-5"></a> answer</h5>
<p>我们通过 <code>tlb_invalidate</code> 实现删除特定虚拟地址在 <code>TLB</code> 中的旧表项，函数的主要逻辑位于 <code>kern/tlb_asm.S</code> 中的 <code>tlb_out</code> 中。即<code>tlb_invalidata</code>函数中调用了<code>tlb_out</code>函数。</p>
<p>在页表内容改变后及时更新<code>TLB</code>,从而实现删除特定虚拟地址在 <code>TLB</code> 中的旧表项。</p>
<p><code>tlb_out</code>作用实际上就是<strong>使得某一虚拟地址对应的<code>tlb</code>表项失效</strong>，基本思路是——<strong>先将要查找的虚拟地址存入<code>EntryHi</code>寄存器，然后调用<code>tlbp</code>指令在<code>TLB</code>中查找</strong>（此时Index寄存器中保存了找到的对应表项的索引）。如果没有找到（索引小于0），则直接跳到最后；<strong>如果找到了，将索引对应的<code>tlb</code>项清空</strong>（需要将<code>EntryHi</code>和<code>EntryLo</code>寄存器清零后使用<code>tlbwi</code>指令）。注意在函数最后需要将“调用该函数前<code>EntryHi</code>寄存器中的值恢复”。具体过程见下方注释：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">LEAF(tlb_out)</span><br><span class="line">.set noreorder</span><br><span class="line">       mfc0    t0, CP0_ENTRYHI		#将EntryHi寄存器的值存入t0寄存器</span><br><span class="line">       mtc0    a0, CP0_ENTRYHI		#将a0中的值存入EntryHi寄存器</span><br><span class="line">       nop</span><br><span class="line">       /* Step 1: Use &#x27;tlbp&#x27; to probe TLB entry */</span><br><span class="line">       /* Exercise 2.8: Your code here. (1/2) */</span><br><span class="line">       tlbp 						#根据EntryHi在TLB中查找与之对应的表项，并把表项的索引存入Index寄存器</span><br><span class="line">	nop</span><br><span class="line">       nop</span><br><span class="line">       /* Step 2: Fetch the probe result from CP0.Index */</span><br><span class="line">       mfc0    t1, CP0_INDEX		#将Index寄存器的值存入t1寄存器</span><br><span class="line">.set reorder</span><br><span class="line">       bltz    t1, NO_SUCH_ENTRY	#如果t1值小于零，即没有在TLB中找到EntryHi对应的表项，则跳转到NO_SUCH_ENTRY标签处</span><br><span class="line">		nop</span><br><span class="line">.set noreorder</span><br><span class="line">       mtc0    zero, CP0_ENTRYHI	#将EntryHi寄存器赋值为0</span><br><span class="line">       mtc0    zero, CP0_ENTRYLO0 	#将EntryLo0寄存器赋值为0</span><br><span class="line">		nop</span><br><span class="line">       nop</span><br><span class="line">       /* Step 3: Use &#x27;tlbwi&#x27; to write CP0.EntryHi/Lo into TLB at CP0.Index      */</span><br><span class="line">       /* Exercise 2.8: Your code here. (2/2) */</span><br><span class="line">       tlbwi						#将EntryHi和EntryLo0寄存器中的值存取Index对应的TLB表项中</span><br><span class="line">NOFOUND:</span><br><span class="line">.set reorder</span><br><span class="line"></span><br><span class="line">NO_SUCH_ENTRY:</span><br><span class="line">        mtc0    t0, CP0_ENTRYHI		#将t0寄存器中的值存入EntryHi寄存器(恢复到调用该函数之前的状态)</span><br><span class="line">        j       ra					#函数返回</span><br><span class="line">	nop</span><br><span class="line">END(tlb_out)</span><br></pre></td></tr></table></figure></div>
<h4 id="thinking-26"><a class="markdownIt-Anchor" href="#thinking-26"></a> Thinking 2.6</h4>
<h5 id="question-6"><a class="markdownIt-Anchor" href="#question-6"></a> question</h5>
<blockquote>
<p>任选下述二者之一回答：</p>
<ul>
<li>
<p>简单了解并叙述 <code>X86</code> 体系结构中的内存管理机制，比较 <code>X86</code> 和 <code>MIPS</code> 在内存管理上的区别。</p>
</li>
<li>
<p>简单了解并叙述 <code>RISC-V</code> 中的内存管理机制，比较 <code>RISC-V</code> 与 <code>MIPS</code> 在内存管理上的区别。</p>
</li>
</ul>
</blockquote>
<h5 id="answer-6"><a class="markdownIt-Anchor" href="#answer-6"></a> answer</h5>
<p><strong>X86 和 MIPS 在内存管理上的区别</strong>有以下三点主要区别——</p>
<ul>
<li>
<p>首先是内存管理机制上，<code>MIPS</code>主要采用的是页式管理系统，<code>X86</code>主要采用的是段页式</p>
</li>
<li>
<p>其次，在对 <code>TLB</code> 不命中时的处理上，<code>MIPS</code> 会触发<code>TLB</code> <code>Refill</code> 异常，内核的 <code>tlb_refill_handler</code> 会以 <code>pgd_current</code> 为当前进程的 <code>PGD</code> 基址，索引获得转换失败的虚址对应的 <code>PTE</code>，并将其填入<code>TLB</code>，然后CPU再用刚刚转换失败的虚拟地址重新访问以下<code>TLB</code>。</p>
<p>而<code>X86</code>在<code>TLB</code>不命中时，是由硬件<code>MMU</code>以<code>CR3</code>为当前进程的<code>PGD</code>基址，索引获得<code>PFN</code>后，直接输出PA。同时<code>MMU</code>会填充<code>TLB</code>以加快下次转换的速度。</p>
</li>
<li>
<p>另外转换失败的虚址，MIPS使用<code>BadVAddr</code>寄存器存放，<code>X86</code>使用<code>CR2</code>存放</p>
</li>
</ul>
<h3 id="lab_difficulties"><a class="markdownIt-Anchor" href="#lab_difficulties"></a> lab_difficulties</h3>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://charles2530.github.io/image/lab2_10"
                      alt="image-20230421220223399" 
                ></p>
<h4 id="内核程序启动"><a class="markdownIt-Anchor" href="#内核程序启动"></a> 内核程序启动</h4>
<p>在<code>lab2</code>中内核启动部分总共需要做以下三件事，主要难点在于<code>page_init()</code>部分。</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>mips_detect_memory()</code></td>
<td>探测硬件可用内存，并对一些和内存管理相关的变量进行初始化。</td>
</tr>
<tr>
<td><code>mips_vm_init()</code></td>
<td>为内存管理机制作准备，建立一些用于管理的数据结构。</td>
</tr>
<tr>
<td><code>page_init()</code></td>
<td>实现位于 <code>kern/pmap.c</code> 中，作用是初始化 Pages 结构体以及空闲链表。</td>
</tr>
</tbody>
</table>
<p>值得一提的是，内核启动阶段还没有建立内存管理机制，所以实际上是通过 <code>kseg0</code> 段地址直接操作物理内存的，虽然实验一直在操作如<code>0x80xxxxxx</code> 的虚拟地址，由于 <code>kseg0</code> 段的性质，操作系统可以通过这一段地址来直接操作物理内存，从而逐步建立内存管理机制。</p>
<h4 id="物理内存管理"><a class="markdownIt-Anchor" href="#物理内存管理"></a> 物理内存管理</h4>
<h5 id="页式内存管理"><a class="markdownIt-Anchor" href="#页式内存管理"></a> 页式内存管理</h5>
<p>MOS 中的内存管理使用页式内存管理，采用链表法管理空闲物理页框,MOS 中维护了 <code>npage</code> 个页控制块，也就是 <code>Page</code> 结构体。<code>npage</code> 个 <code>Page</code> 和 <code>npage</code> 个物理页面一一顺序对应，具体来说，<code>npage</code> 个 <code>Page</code>的起始地址为 <code>pages</code>，则 pages[i] 对应从 0 开始计数的第 i 个物理页面。两者的转换可以使用 <code>page2pa</code> 和 <code>pa2page</code> 这两个函数。</p>
<p>这里简单解说一下<code>page2pa</code>函数，具体实现如下：</p>
<div class="highlight-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> u_long <span class="title">page2ppn</span><span class="params">(<span class="keyword">struct</span> Page *pp)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> pp - pages;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> u_long <span class="title">page2pa</span><span class="params">(<span class="keyword">struct</span> Page *pp)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">page2ppn</span>(pp) &lt;&lt; PGSHIFT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>首先我们需要熟悉一下指针运算的效果，这里传入的参数*pp可以等价理解为<code>page[i]</code>，所以<code>pp-pages</code>类似于<code>a[i]-a</code>得到的是数组的下标i，之后<code>&lt;&lt;PGSHIFT</code>部分是将得到的页号i和每一页的page大小相乘从而得到了对应的物理页面。</p>
<h5 id="page存储结构"><a class="markdownIt-Anchor" href="#page存储结构"></a> Page存储结构</h5>
<p>之后就是一个很重要也是难点的部分——Page存储结构。<code>Page</code>是我们用于管理物理内存块的结构体，该结构体包含两部分——一个是&quot;数据域&quot;（<code>pp_ref</code>）,另一个是&quot;指针域&quot;（<code>pp_link</code>）。通过上面的思考题我们知道最终page结构可以简化到以下这种形式</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Page</span>&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">Page</span> *<span class="title">le_next</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">Page</span> **<span class="title">le_prev</span>;</span></span><br><span class="line">	&#125; pp_link;</span><br><span class="line">    u_short pp_ref;</span><br><span class="line">&#125;;  </span><br></pre></td></tr></table></figure></div>
<p>其中，<code>pp_ref</code>代表着该物理内存块被引用的次数，即有多少个虚拟地址映射到该物理内存块。<code>pp_link</code>中包含两个指针变量——<code>le_next</code>和<code>le_prev</code>，前者是<strong>指向后一个Page结构体的指针</strong>，后者是指向<strong>前一个Page的<code>le_next</code>的指针</strong>。</p>
<p>为了便于对<strong>空闲物理内存块的管理</strong>，我们将<strong>所有空闲物理内存块对应的<code>Page</code>结构体</strong>用一个<strong>链表</strong>链接了起来，为了便于链表的增删改查，我们就需要上述<code>le_next</code>和<code>le_prev</code>发挥作用了。链表示意图如下所示</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://charles2530.github.io/image/lab2_3"
                      alt="image-20230314090217222" 
                ></p>
<p>用结构体表示就是这样一个结构：</p>
<div class="highlight-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Page_list</span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> &#123;</span><br><span class="line">		<span class="keyword">struct</span> &#123;</span><br><span class="line">			<span class="keyword">struct</span> <span class="title class_">Page</span> *le_next;</span><br><span class="line">			<span class="keyword">struct</span> <span class="title class_">Page</span> **le_prev;</span><br><span class="line">		&#125; pp_link;</span><br><span class="line">		u_short pp_ref;</span><br><span class="line">	&#125;* lh_first;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>这里在实际操作时对你的指针能力是一个极大的挑战，需要我们对链表的增删改查十分熟悉，值得一提的是该链表实际上是一个<strong>双向链表</strong>，但和我们常见的双向链表又有区别。该双向链表可以直接通过<code>le_next</code>来访问下一个链表项，但却无法直接访问上一个链表项。因为<code>le_prev</code>仅仅是指向了前一个<code>Page</code>的<code>le_next</code>，换句话说，就是一个<strong>指向了&quot;指向自己的指针&quot;的指针</strong>。虽然<code>le_prev</code>无法帮助我们直接访问上一个链表项，但是，它却可以帮助我们以<code>O(1)</code>的开销<strong>实现链表的增删操作</strong>。在此奉上一文<code>gg</code>亲手画的链表前插入的解析图，供大家理解一下与正常链表插入的差异。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://charles2530.github.io/image/lab2_4.png"
                      alt="" 
                ></p>
<p>将空闲物理页对应的 Page 结构体全部插入一个链表中，该链表被称为空闲链表，就是page_free_list,用于存储<strong>指向链表首项的指针</strong>。</p>
<div class="highlight-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Page_list</span> &#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">Page</span> *lh_first;</span><br><span class="line">&#125; page_free_list;</span><br></pre></td></tr></table></figure></div>
<p>至此Page存储结构介绍完毕。</p>
<h5 id="相关函数"><a class="markdownIt-Anchor" href="#相关函数"></a> 相关函数</h5>
<table>
<thead>
<tr>
<th style="text-align:left">函数</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>page_init()</code></td>
<td>物理页面管理<br>初始化空闲页面链表，用于存储“没有被使用”的页控制块,并完成页对齐。</td>
</tr>
<tr>
<td style="text-align:left"><code>page_alloc(struct Page **pp)</code></td>
<td>分配物理页面<br>将 page_free_list 空闲链表头部页控制块对应的物理页面分配出去，将其从空闲链表中移除，并清空对应的物理页面，最后将 pp指向的空间赋值为这个页控制块的地址。</td>
</tr>
<tr>
<td style="text-align:left"><code>page_decref(struct Page *pp)</code></td>
<td>减少物理页面引用<br>令 pp 对应页控制块的引用次数减少 1，如果引用次数为 0 则会调用下面的 page_free 函数将对应物理页面重新设置为空闲页面。</td>
</tr>
<tr>
<td style="text-align:left"><code>page_free(struct Page *pp)</code></td>
<td>回收物理页面到空闲页面链表<br>是判断 pp 指向页控制块对应的物理页面引用次数是否为 0，若为 0 则该物理页面为空闲页面，将其对应的页控制块重新插入到 page_free_list</td>
</tr>
</tbody>
</table>
<p>当一个进程需要分配内存时，将空闲链表头部的页控制块对应的那一页物理内存分配出去，同时将该页控制块从空闲链表的头部删去。当一页物理内存被使用完毕 (准确来说，引用次数为 0 时)，将其对应的页控制块重新插入到空闲链表的头部。</p>
<h4 id="虚拟内存管理"><a class="markdownIt-Anchor" href="#虚拟内存管理"></a> 虚拟内存管理</h4>
<p><code>MOS</code> 中采用 <code>PADDR</code> 与<code>KADDR</code> 这两个宏就可以对位于 <code>kseg0</code> 的虚拟地址和对应的物理地址进行转换。但是，对于位于 <code>kuseg</code> 的虚拟地址，<code>MOS</code> 中采用两级页表结构对其进行地址转换。</p>
<h5 id="二级页表查询机制"><a class="markdownIt-Anchor" href="#二级页表查询机制"></a> 二级页表查询机制</h5>
<p>两级页表机制相比单级页表机制，将虚拟页号进一步分为了两部分。具体来说，对于一个 32 位的虚存地址，从低到高从 0 开始编号，其 31-22 位表示的是一级页表项的偏移量，21-12 位表示的是二级页表项的偏移量，11-0 位表示的是页内偏移量。具体可以通过<code>PDX</code>和<code>PTX</code>两个宏快速获得相关量。</p>
<p>访问虚拟地址时，先通过一级页表基地址和一级页表项的偏移量，找到对应的一级页表项，得到对应的二级页表的物理页号，再根据二级页表项的偏移量找到所需的二级页表项，进而得到该虚拟地址对应的物理页号。具体情况如图所示——</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://charles2530.github.io/image/lab2_5"
                      alt="image-20230314095743231" 
                ></p>
<p><code>MIPS R3000</code>发出的地址均为虚拟地址，因此如果程序想访问某个物理地址，需要通过映射到该物理地址的虚拟地址来访问。在 <code>MOS</code>中，无论是一级页表还是二级页表，它们的结构都一样，只不过每个页表项记录的物理页号含义有所不同。</p>
<h5 id="与页表相关的函数"><a class="markdownIt-Anchor" href="#与页表相关的函数"></a> 与页表相关的函数</h5>
<table>
<thead>
<tr>
<th>函数</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pgdir_walk(Pde *pgdir, u_long va, int create, Pte **ppte)</code></td>
<td>二级页表检索函数<br>该函数将一级页表基地址 <code>pgdir</code> 对应的两级页表结构中 <code>va</code> 虚拟地址所在的二级页表项的指针存储在 <code>ppte</code> 指向的空间上。如果 <code>create</code> 不为 0 且对应的二级页表不存在，则会使用 <code>page_alloc</code> 函数分配一页物理内存用于存放二级页表，如果分配失败则返回错误码。</td>
</tr>
<tr>
<td><code>int page_insert(Pde *pgdir, u_int asid, struct Page *pp, u_long va, u_int perm)</code></td>
<td>增加地址映射函数<br>将一级页表基地址 <code>pgdir</code> 对应的两级页表结构中虚拟地址 <code>va</code> 映射到页控制块 <code>pp</code> 对应的物理页面，并将页表项权限为设置为 perm。</td>
</tr>
<tr>
<td><code>page_lookup(Pde *pgdir, u_long va, Pte **ppte)</code></td>
<td>寻找映射的物理地址函数<br>作用是返回一级页表基地址 <code>pgdir</code>对应的两级页表结构中虚拟地址 <code>va</code> 映射的物理页面的页控制块，同时将<code>ppte</code> 指向的空间设为对应的二级页表项地址。</td>
</tr>
<tr>
<td><code>page_remove(Pde *pgdir, u_int asid, u_long va)</code></td>
<td>取消地址映射函数<br>作用是删除一级页表基地址<code>pgdir</code> 对应的两级页表结构中虚拟地址 <code>va</code> 对物理地址的映射。如果存在这样的映射，那么对应物理页面的引用次数会减少一次。</td>
</tr>
</tbody>
</table>
<p>可以辅助这张图加强理解——</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://charles2530.github.io/image/lab2_6"
                      alt="image-20230314100557280" 
                ></p>
<h5 id="页表项常见权限位"><a class="markdownIt-Anchor" href="#页表项常见权限位"></a> 页表项常见权限位</h5>
<div class="highlight-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_V 0x0200</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_D 0x0400</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_G 0x0100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_COW 0x0001</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_LIBRARY 0x0004</span></span><br></pre></td></tr></table></figure></div>
<table>
<thead>
<tr>
<th>权限位</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>PTE_V</strong></td>
<td>有效位，若某页表项的有效位为 1，则该页表项中高 20 位就是对应的物理页号。</td>
</tr>
<tr>
<td><strong>PTE_D</strong></td>
<td>可写位，若某页表项的可写位为 1，则可经由该页表项对物理页进行写操作。</td>
</tr>
<tr>
<td><strong>PTE_G</strong></td>
<td>全局位，若某页表项的全局位为 1，则 TLB 仅通过虚页号匹配表项，而不匹配ASID，将在 Lab3 中用于映射 pages 和 envs 到用户空间。本 Lab 中可以忽略。</td>
</tr>
<tr>
<td><strong>PTE_COW</strong></td>
<td>写时复制位，将在 Lab4 中用到，通过该权限位实现了 fork 的写时复制机制。本 Lab 中可以忽略。</td>
</tr>
<tr>
<td><strong>PTE_LIBRARY</strong></td>
<td>共享页面位，将在 Lab6 中用到，用于实现管道机制，本 Lab 中可以忽略。</td>
</tr>
</tbody>
</table>
<h4 id="tlb-重填"><a class="markdownIt-Anchor" href="#tlb-重填"></a> <strong>TLB</strong> 重填</h4>
<h5 id="tlb-组成"><a class="markdownIt-Anchor" href="#tlb-组成"></a> <strong>TLB</strong> 组成</h5>
<p>每一个 <code>TLB</code> 表项都有 64 位，其中高 32 位是 Key，低 32 位是 Data。<code>EntryHi</code>、<code>EntryLo</code> 都是 <code>CP0</code> 中的寄存器，他们只是分别对应到 <strong>TLB</strong> 的 <strong>Key</strong> 与 <strong>Data</strong>，并不是 <strong>TLB</strong> 本身。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://charles2530.github.io/image/lab2_7"
                      alt="image-20230314102146758" 
                ></p>
<h5 id="tlb相关指令"><a class="markdownIt-Anchor" href="#tlb相关指令"></a> TLB相关指令</h5>
<table>
<thead>
<tr>
<th>指令</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>tlbr</td>
<td>以 Index 寄存器中的值为索引，读出 TLB 中对应的表项到 EntryHi 与 EntryLo</td>
</tr>
<tr>
<td>tlbwi</td>
<td>以 Index 寄存器中的值为索引，将此时 EntryHi 与 EntryLo 的值写到索引指定的 TLB 表项中。</td>
</tr>
<tr>
<td>tlbwr</td>
<td>将 EntryHi 与 EntryLo 的数据随机写到一个 TLB 表项中（此处使用 Random 寄存器来“随机”指定表项，Random 寄存器本质上是一个不停运行的循环计数器）</td>
</tr>
<tr>
<td>tlbp</td>
<td>根据 EntryHi 中的 Key（包含 VPN 与 ASID），查找 TLB 中与之对应的表项，并将表项的索引存入 Index 寄存器（若未找到匹配项，则 Index 最高位被置 1）</td>
</tr>
</tbody>
</table>
<h5 id="tlb相关函数"><a class="markdownIt-Anchor" href="#tlb相关函数"></a> TLB相关函数</h5>
<table>
<thead>
<tr>
<th>函数</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>tlb_invalidate(<em>u_int</em> <em>asid</em>, <em>u_long</em> <em>va</em>)</td>
<td>实现删除特定虚拟地址的映射，每当页表被修改，就需要调</td>
</tr>
<tr>
<td>_do_tlb_refill(<em>u_long</em> <em>va</em>, <em>u_int</em> <em>asid</em>)</td>
<td>TLB 重填</td>
</tr>
</tbody>
</table>
<h3 id="lab_summary"><a class="markdownIt-Anchor" href="#lab_summary"></a> lab_summary</h3>
<h4 id="整体回顾"><a class="markdownIt-Anchor" href="#整体回顾"></a> 整体回顾</h4>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://charles2530.github.io/image/lab2_9"
                      alt="image-20230403174759500" 
                ></p>
<h4 id="一个小知识点"><a class="markdownIt-Anchor" href="#一个小知识点"></a> 一个小知识点</h4>
<p>在这部分先插入一个我对于c语言的新发现，就是<code>lab2</code>中<code>PADDR</code>宏是这样实现的</p>
<div class="highlight-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PADDR(kva)                                                                                 \</span></span><br><span class="line"><span class="meta">	(&#123;                                                                                         \</span></span><br><span class="line"><span class="meta">		u_long a = (u_long)(kva);                                                          \</span></span><br><span class="line"><span class="meta">		<span class="keyword">if</span> (a &lt; ULIM)                                                                      \</span></span><br><span class="line"><span class="meta">			panic(<span class="string">&quot;PADDR called with invalid kva %08lx&quot;</span>, a);                           \</span></span><br><span class="line"><span class="meta">		a - ULIM;                                                                          \</span></span><br><span class="line"><span class="meta">	&#125;)</span></span><br></pre></td></tr></table></figure></div>
<p>而我对其中的<code>a-ULIM</code>这个非赋值语句产生了好奇，于是通过查资料、问助教发现了这样一种神奇的用法，在此记录一下。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://charles2530.github.io/image/lab2_8"
                      alt="image-20230314110630659" 
                ></p>
<h4 id="lab2中地址相关的常量宏"><a class="markdownIt-Anchor" href="#lab2中地址相关的常量宏"></a> Lab2中地址相关的常量宏</h4>
<table>
<thead>
<tr>
<th>宏</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>PDX(va)</td>
<td>页目录偏移量（查找遍历页表时常用）</td>
</tr>
<tr>
<td>PTX(va)</td>
<td>页表偏移量（查找遍历页表时常用）</td>
</tr>
<tr>
<td>PTE_ADDR(pte)</td>
<td>获取页表项中的物理地址（读取 pte 时常用）</td>
</tr>
<tr>
<td>PADDR(kva)</td>
<td>kseg0 处虚地址 → 物理地址</td>
</tr>
<tr>
<td>KADDR(pa)</td>
<td>物理地址 → kseg0 处虚地址（读取 pte 后可进行转换）</td>
</tr>
<tr>
<td>va2pa(Pde *pgdir, u_long va)</td>
<td>查页表，虚地址 → 物理地址（测试时常用）</td>
</tr>
<tr>
<td>pa2page(u_long pa)</td>
<td>物理地址 → 页控制块（读取 pte 后可进行转换）</td>
</tr>
<tr>
<td>page2pa(struct Page *pp)</td>
<td>页控制块 → 物理地址（填充 pte 时常用）</td>
</tr>
</tbody>
</table>
<h4 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h4>
<p><code>Lab2</code>主要是实现<code>MOS</code>中的内存管理机制，包括物理内存管理、虚拟内存管理和<code>TLB</code>重填机制。和<code>Lab1</code>相比，本次<code>Lab</code>代码量剧增，而且链表操作部分<strong>使用了指向指针的指针</strong>，对代码的理解和补全也造成一定困难（有的时候甚至怀疑自己是不是真的学会了指针）。虽然一路艰辛，但还是收获满满，希望继续加油！！！</p>

            </div>

            
                <div class="post-copyright-info">
                    <div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> lab2_report</li>
        <li><strong>Author:</strong> Charles</li>
        <li><strong>Created at:</strong> 2023-03-13 13:00:22</li>
        
            <li>
                <strong>Updated at:</strong> 2023-06-17 14:13:59
            </li>
        
        <li>
            <strong>Link:</strong> https://charles2530.github.io/2023/03/13/lab2-report/
        </li>
        <li>
            <strong>License:</strong> This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0</a>.
        </li>
    </ul>
</div>

                </div>
            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/tags/OS/">#OS</a>&nbsp;
                        </li>
                    
                </ul>
            

            
  <div class="recommended-article">
   <div class="recommended-desktop">
    <div class="recommended-article-header">
     <i aria-hidden="true"></i><span>recommend_articles</span>
    </div>
    <div class="recommended-article-group"><a class="recommended-article-item" href="/2023/02/11/segment-tree-2/" title="Segment-tree-2" rel="bookmark">
  <img src="https://charles2530.github.io/image/background/p1.jpg" alt="Segment-tree-2">
  <span class="title">Segment-tree-2</span>
</a><a class="recommended-article-item" href="/2023/01/13/tensorflow-function-basis/" title="tensorflow-function-basis" rel="bookmark">
  <img src="https://charles2530.github.io/image/background/p3.jpg" alt="tensorflow-function-basis">
  <span class="title">tensorflow-function-basis</span>
</a><a class="recommended-article-item" href="/2023/02/11/diameter-of-tree/" title="Diameter_of_tree" rel="bookmark">
  <img src="https://charles2530.github.io/image/background/p4.jpg" alt="Diameter_of_tree">
  <span class="title">Diameter_of_tree</span>
</a></div>
   </div>
   <div class="recommended-mobile">
   <div class="recommended-article-header">
     <i aria-hidden="true"></i><span>recommend_articles</span>
   </div>
   <div class="recommended-article-group"><a class="recommended-article-item" href="/2023/02/11/segment-tree-2/" title="Segment-tree-2" rel="bookmark">
  <img src="https://charles2530.github.io/image/background/p1.jpg" alt="Segment-tree-2">
  <span class="title">Segment-tree-2</span>
</a><a class="recommended-article-item" href="/2023/01/13/tensorflow-function-basis/" title="tensorflow-function-basis" rel="bookmark">
  <img src="https://charles2530.github.io/image/background/p3.jpg" alt="tensorflow-function-basis">
  <span class="title">tensorflow-function-basis</span>
</a></div>
   </div>
  </div>

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                            rel="prev"
                            href="/2023/03/14/lab-discussion-1/"
                            >
                                <span class="left arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-left"></i>
                                </span>
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">lab_discussion_1</span>
                                    <span class="post-nav-item">Prev posts</span>
                                </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                            rel="next"
                            href="/2023/03/10/tensorflow2-1-note/"
                            >
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">Tensorflow2.1-note</span>
                                    <span class="post-nav-item">Next posts</span>
                                </span>
                                <span class="right arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-right"></i>
                                </span>
                            </a>
                        </div>
                    
                </div>
            


            
                <div class="comment-container">
                    <div class="comments-container">
  <div id="comment-anchor"></div>
  <div class="comment-area-title">
    <i class="fa-solid fa-comments"></i>&nbsp;Comments
  </div>
  

  <!-- 
            
    <div id="gitalk-container"></div>
    <script data-pjax
            src="//cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js"></script>
    <script data-pjax>

        function loadGitalk() {
            let __gitalk__pathname = decodeURI(location.pathname);
            const __gitalk__pathnameLength = __gitalk__pathname.length;
            const __gitalk__pathnameMaxLength = 50;
            if (__gitalk__pathnameLength > __gitalk__pathnameMaxLength) {
                __gitalk__pathname = __gitalk__pathname.substring(0, __gitalk__pathnameMaxLength - 3) + '...';
            }

            try {
                Gitalk && new Gitalk({
                    clientID: '8083299a8ee2aaf23879',
                    clientSecret: 'a8161e81d4872181e884fdb69f7be24916b6a9d0',
                    repo: 'charles2530_issues',
                    owner: 'Charles2530',
                    admin: ['Charles2530'],
                    id: __gitalk__pathname,
                    language: 'en'
                }).render('gitalk-container');

            } catch (e) {
                window.Gitalk = null;
            }
        }

        if ('true') {
            const loadGitalkTimeout = setTimeout(() => {
                loadGitalk();
                clearTimeout(loadGitalkTimeout);
            }, 1000);
        } else {
            window.addEventListener('DOMContentLoaded', loadGitalk);
        }
    </script>



         -->
  <script src="https://utteranc.es/client.js" repo="Charles2530/Charles2530.github.io" issue-term="pathname"
    label="Comment" theme="preferred-color-scheme" crossorigin="anonymous" async>
  </script>
  
</div>

                </div>
            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">lab2_report</div>
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#lab2_report"><span class="nav-text"> lab2_report</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#advance"><span class="nav-text"> advance</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E5%92%8C%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E7%9A%84%E7%AE%A1%E7%90%86%E6%96%B9%E5%BC%8F"><span class="nav-text"> 实现物理内存和虚拟内存的管理方式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lab_thinkings"><span class="nav-text"> lab_thinkings</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#thinking-21"><span class="nav-text"> Thinking 2.1</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#question"><span class="nav-text"> question</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#answer"><span class="nav-text"> answer</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#thinking-22"><span class="nav-text"> Thinking 2.2</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#question-2"><span class="nav-text"> question</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#answer-2"><span class="nav-text"> answer</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#thinking-23"><span class="nav-text"> Thinking 2.3</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#question-3"><span class="nav-text"> question</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#answer-3"><span class="nav-text"> answer</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#thinking-24"><span class="nav-text"> Thinking 2.4</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#question-4"><span class="nav-text"> question</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#answer-4"><span class="nav-text"> answer</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#thinking-25"><span class="nav-text"> Thinking 2.5</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#question-5"><span class="nav-text"> question</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#answer-5"><span class="nav-text"> answer</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#thinking-26"><span class="nav-text"> Thinking 2.6</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#question-6"><span class="nav-text"> question</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#answer-6"><span class="nav-text"> answer</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lab_difficulties"><span class="nav-text"> lab_difficulties</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E7%A8%8B%E5%BA%8F%E5%90%AF%E5%8A%A8"><span class="nav-text"> 内核程序启动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-text"> 物理内存管理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%A1%B5%E5%BC%8F%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-text"> 页式内存管理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#page%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84"><span class="nav-text"> Page存储结构</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0"><span class="nav-text"> 相关函数</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-text"> 虚拟内存管理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BA%8C%E7%BA%A7%E9%A1%B5%E8%A1%A8%E6%9F%A5%E8%AF%A2%E6%9C%BA%E5%88%B6"><span class="nav-text"> 二级页表查询机制</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%8E%E9%A1%B5%E8%A1%A8%E7%9B%B8%E5%85%B3%E7%9A%84%E5%87%BD%E6%95%B0"><span class="nav-text"> 与页表相关的函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%A1%B5%E8%A1%A8%E9%A1%B9%E5%B8%B8%E8%A7%81%E6%9D%83%E9%99%90%E4%BD%8D"><span class="nav-text"> 页表项常见权限位</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tlb-%E9%87%8D%E5%A1%AB"><span class="nav-text"> TLB 重填</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#tlb-%E7%BB%84%E6%88%90"><span class="nav-text"> TLB 组成</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#tlb%E7%9B%B8%E5%85%B3%E6%8C%87%E4%BB%A4"><span class="nav-text"> TLB相关指令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#tlb%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0"><span class="nav-text"> TLB相关函数</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lab_summary"><span class="nav-text"> lab_summary</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E5%9B%9E%E9%A1%BE"><span class="nav-text"> 整体回顾</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E5%B0%8F%E7%9F%A5%E8%AF%86%E7%82%B9"><span class="nav-text"> 一个小知识点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#lab2%E4%B8%AD%E5%9C%B0%E5%9D%80%E7%9B%B8%E5%85%B3%E7%9A%84%E5%B8%B8%E9%87%8F%E5%AE%8F"><span class="nav-text"> Lab2中地址相关的常量宏</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text"> 总结</span></a></li></ol></li></ol></li></ol>

    </div>
</div>
            </div>
        
    </div>
</div>


                

            </div>
            
            

        </div>

        <div class="main-content-footer">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info">
            &copy;
            
              <span>2022</span>
              -
            
            2023&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">Charles</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv" class="busuanzi_container_site_uv">
                        Visitor Count&nbsp;<span id="busuanzi_value_site_uv" class="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="busuanzi_container_site_pv">
                        Total Page Views&nbsp;<span id="busuanzi_value_site_pv" class="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            <span class="powered-by-container">Powered by Charles</span>
                <br>
            <span class="theme-version-container">Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.2.0</a>
        </div>
        
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
        
            <script async data-pjax>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fa-regular fa-comments"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-expand-width flex-center">
            <i class="fa-regular fa-expand"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="right-bottom-tools rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                <i class="fa-regular fa-rss"></i>
                </a>
            </li>
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    


</main>



  <script src="https://npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/js/utils.js"></script><script src="https://npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/js/main.js"></script><script src="https://npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/js/layouts/navbarShrink.js"></script><script src="https://npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/js/tools/scrollTopBottom.js"></script><script src="https://npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/js/tools/lightDarkSwitch.js"></script>


    <script src="https://npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/js/tools/localSearch.js"></script>



    <script src="https://npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/js/tools/codeBlock.js"></script>



    <script src="https://npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/js/layouts/lazyload.js"></script>



    <script src="https://npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/js/tools/runtime.js"></script>
    <script src="https://npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/js/libs/odometer.min.js"></script>
    <link rel="stylesheet" href="//npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/assets/odometer-theme-minimal.css">



  <script src="https://npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/js/libs/Typed.min.js"></script>
  <script src="https://npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/js/plugins/typed.js"></script>



    <script src="https://npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/js/libs/mermaid.min.js"></script>
    <script src="https://npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/js/plugins/mermaid.js"></script>



    <script src="https://npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/js/libs/minimasonry.min.js"></script>
    <script src="https://npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/js/plugins/masonry.js"></script>


<div class="post-scripts pjax">
    
        <script src="https://npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/js/tools/tocToggle.js"></script><script src="https://npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/js/libs/anime.min.js"></script><script src="https://npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/js/layouts/toc.js"></script><script src="https://npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/js/plugins/tabs.js"></script>
    
</div>


    <script src="https://npm.elemecdn.com/hexo-theme-redefine@2.2.0/source/js/libs/pjax.min.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax',
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            Global.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            Global.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            Global.refresh();
        });
    });
</script>



  
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
</body>

</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/love.js"></script>
